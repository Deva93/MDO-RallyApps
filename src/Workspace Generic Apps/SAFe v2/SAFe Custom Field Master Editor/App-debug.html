<!DOCTYPE html>
<html>
<head>
    <title>SAFe Custom Field Editor</title>


    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk-debug.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.0.1/q.js"></script>

    <script type="text/javascript">
			new Rally.sdk.env.Global().setup();
			var server = Rally.environment.getServer().baseUrl,
				contextPath = Rally.environment.getServer().contextPath,
				defaultWsapiVersion = Rally.environment.getServer().defaultWsapiVersion,
				basePath = server + contextPath + '/webservice/' + defaultWsapiVersion,
				getParams = document.URL.split("?"),
				params = getParams.length === 2 ? Ext.urlDecode(getParams[1]) : {},
				deferred = new Deft.Deferred();
			Ext.data.JsonP.request({
				url: basePath + '/user',
				callbackKey: 'jsonp',
				success: function(resJSON){
					var user = resJSON.User;
					Ext.data.JsonP.request({
						url: user.UserProfile._ref,
						callbackKey: 'jsonp',
						success: function(resJSON){
							var userprofile = resJSON.UserProfile;
							Ext.data.JsonP.request({
								url: user.UserPermissions._ref,
								callbackKey: 'jsonp',
								success: function(resJSON){
									var permissions = resJSON.UserPermissions;
									Ext.data.JsonP.request({
										url: user.Subscription._ref,
										callbackKey: 'jsonp',
										success: function(resJSON){
											var subscription = resJSON.Subscription,
												data = {
													user: user,
													projectScopeUp: params.projectScopeUp === 'true' ? true : false,
													projectScopeDown: params.projectScopeDown === 'true' ? true : false,
													subscription: subscription,
													permissions: permissions
												},
												projectRef = params.project || ('/project/' + userprofile.DefaultProject._ref.split('/project/')[1]);
											Ext.data.JsonP.request({
												url: basePath + projectRef + '?fetch=Workspace,Name,ObjectID,WorkspaceConfiguration,DateFormat',
												callbackKey: 'jsonp',
												success: function(resJSON){
													var project = resJSON.Project;
													data.project = project;
													data.workspace = project.Workspace;
													deferred.resolve(data);
												}
											});
										}
									});
								}
							});
						}
					});
				}
			});
			deferred.promise.then(function(data){
				var sdkEnv = new Rally.sdk.env.Environment(),
					server = sdkEnv.getServer(),
					messageBus = sdkEnv.getMessageBus(),
					ioProvider = new Rally.sdk.env.IoProvider();
				Rally.environment = {
					getServer: function(){ return server; },
					getMessageBus: function(){ return messageBus; },
					getIoProvider: function(){ return ioProvider; },
					getGlobalContext: function(){ return this.getContext(); },
					getContext: function(){
						return {
							getUser: function(){ return data.user; },
							getProject: function(){ return data.project; },
							getWorkspace: function(){ return data.workspace; },
							getProjectScopeUp: function(){ return data.projectScopeUp; },
							getProjectScopeDown: function(){ return data.projectScopeDown; },
							getSubscription: function(){ return data.subscription; },
							getPermissions: function(){ return data.permissions; },
							getWorkspaceRef: function(){ return '/workspace/' + this.getWorkspace()._ref.split('/workspace/')[1]; },
							getProjectRef: function(){ return '/project/' + this.getProject()._ref.split('/project/')[1]; },
							getDataContext: function(){ 
								return {
									workspace: this.getWorkspaceRef(),
									project: this.getProjectRef(),
									projectScopeUp: this.getProjectScopeUp(),
									projectScopeDown: this.getProjectScopeDown()
								};
							},
							getScopeStr: function(projectOid){
								var project = this.getProject(),
									scopeStr = projectOid || (project && project.ObjectID ? project.ObjectID : '');
								scopeStr += this.getProjectScopeUp() ? 'u' : '';
								scopeStr += this.getProjectScopeDown() ? 'd' : '';
								return scopeStr;
							},
							getScope: function() {
								return {
									workspace: this.getWorkspace(),
									project: this.getProject(),
									proejctOid: this.getProject().ObjectID,
									strForHash: this.getProject().ObjectID + 'd',
									up: this.getProjectScopeUp(),
									down: this.getProjectScopeDown()
								};
							},
							getStack: function() {
								return {};
							},
							getAppSdkBaseUrl: function() {
								return '/apps/';
							},
							getApiBaseUrl: function() {
								return;
							},
						};
					}
				};
				rallyEnvironmentSet();
			});
			function rallyEnvironmentSet(){
        Rally.loadScripts(
                [
                      "../../lib/intel-rally-app.js",
                      "../../lib/data/intel-models.js",
                      "../../lib/mixins/window-listener.js",
                      "../../lib/mixins/iframe-resize.js",
                      "../../lib/mixins/pretty-alert.js",
                      "../../lib/mixins/intel-workweek.js",
                      "../../lib/mixins/async-queue.js",
                      "../../lib/mixins/parallel-loader.js",
                      "../../lib/mixins/user-apps-preference.js",
                      "../../lib/components/component-column.js",
                      "../../lib/components/intel-combobox.js",
                      "../../lib/components/intel-fixed-combobox.js",
                      "../../lib/components/intel-release-picker.js",
                      "../../lib/components/intel-textarea.js",
                      "../../lib/overrides/fast-component-column.js",
                      "../../lib/overrides/fast-session-proxy.js",
                      "../../lib/overrides/fast-store.js",
                      "../../lib/overrides/fast-cell-editing.js",
                      "../../lib/overrides/scroll-steady-tableview.js",
                      "../lib/data/intel-safe-models.js",
                      "App.js",
                ],
        function() {
            Rally.launchApp('CustomFieldEditor', {
                name:"SAFe Custom Field Editor"
            });
        }, true);
			}
    </script>

    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css"/>

    <link rel="stylesheet" type="text/css" href="../../lib/css/base.css"/>
    <link rel="stylesheet" type="text/css" href="app.css"/>
</head>
<body>
</body>
</html>
