<!DOCTYPE html>
<html>
<head>
    <title>Scrum Group Portfolio Configuration</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.0.1/q.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext,timeout=12e4;Ext.override(Ext.data.proxy.Ajax,{timeout:timeout}),Ext.override(Ext.data.proxy.JsonP,{timeout:timeout}),Ext.override(Rally.sdk.data.lookback.JsonPProxy,{setException:function(operation,response){var error=operation.getError()||{};operation.setException(Ext.apply(error,{errors:(response||{}).Errors||[]}))}}),Ext.define("IntelRallyApp",{alias:"widget.intelrallyapp",extend:"Rally.app.App",_ScrumGroupConfigPrefName:"intel-portfolio-locations-config",_projectFields:["ObjectID","Releases","Children","Parent","Name","TeamMembers"],_portfolioItemFields:["Name","ObjectID","FormattedID","Release","c_TeamCommits","c_MoSCoW","c_Risks","Project","PlannedEndDate","Parent","Children","PortfolioItemType","Ordinal"],_userStoryFields:["Name","ObjectID","Release","Project","PortfolioItem","PlannedEndDate","ActualEndDate","FormattedID","Predecessors","Successors","c_Dependencies","Iteration","PlanEstimate"],_releaseFields:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project","TeamMembers"],_loadScheduleStates:function(){var me=this,deferred=Q.defer();return Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(records,operation,success){me.ScheduleStates=_.map(records,function(r){return r.data.StringValue}),deferred.resolve()}})}}),deferred.promise},_loadPortfolioItemStatesForEachType:function(){var me=this;return me.PortfolioItemTypeStates=[],Q.all(_.map(me.PortfolioItemTypes,function(portfolioType,ordinal){var store=Ext.create("Rally.data.wsapi.Store",{model:"State",autoLoad:!1,limit:1/0,disableMetaChangeEvent:!0,fetch:["Name","Enabled","OrderIndex"],filters:[{property:"TypeDef.Name",value:portfolioType},{property:"Enabled",value:!0}]});return me._reloadStore(store).then(function(store){me.PortfolioItemTypeStates[ordinal]=store.getRange()})}))},_loadPortfolioItemTypes:function(){var me=this,deferred=Q.defer(),store=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",autoLoad:!0,limit:1/0,disableMetaChangeEvent:!0,fetch:["Ordinal","Name"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Creatable",value:!0}],listeners:{load:function(portfolioTypeStore){me.PortfolioItemTypes=_.map(_.sortBy(_.map(portfolioTypeStore.getRange(),function(item){return{Name:item.data.Name,Ordinal:item.data.Ordinal}}),function(item){return item.Ordinal}),function(item){return item.Name}),deferred.resolve()}}});return deferred.promise},_loadModels:function(){var me=this,promises=[],models={Project:"Project",UserStory:"HierarchicalRequirement",PortfolioItem:"PortfolioItem"};return _.each(me.PortfolioItemTypes,function(name){models[name]="PortfolioItem/"+name}),_.each(models,function(modelType,modelName){var deferred=Q.defer();Rally.data.WsapiModelFactory.getModel({type:modelType,success:function(loadedModel){me[modelName]=loadedModel,deferred.resolve()}}),promises.push(deferred.promise)}),Q.all(promises)},_loadScrumGroupConfig:function(){var me=this,deferred=Q.defer();return Rally.data.PreferenceManager.load({workspace:me.getContext().getWorkspace()._ref,filterByName:me._ScrumGroupConfigPrefName,success:function(prefs){var configString=prefs[me._ScrumGroupConfigPrefName],scrumGroupConfig;try{scrumGroupConfig=JSON.parse(configString)}catch(e){scrumGroupConfig=[]}me.ScrumGroupConfig=scrumGroupConfig,deferred.resolve()},failure:deferred.reject}),deferred.promise},_saveScrumGroupConfig:function(scrumGroupConfig){var me=this,s={},deferred=Q.defer();return s[me._ScrumGroupConfigPrefName]=JSON.stringify(scrumGroupConfig),Rally.data.PreferenceManager.update({workspace:me.getContext().getWorkspace()._ref,filterByName:me._ScrumGroupConfigPrefName,settings:s,success:deferred.resolve,failure:deferred.reject}),deferred.promise},_configureIntelRallyApp:function(){var me=this;return me.BaseUrl=Rally.environment.getServer().getBaseUrl(),Q.all([me._loadPortfolioItemTypes().then(function(){return me._userStoryFields.push(me.PortfolioItemTypes[0]),Q.all([me._loadModels(),me._loadPortfolioItemStatesForEachType()])}),me._loadScrumGroupConfig(),me._loadScheduleStates()])},_reloadStore:function(store){var deferred=Q.defer();return store.load({callback:function(records,operation,success){success?deferred.resolve(store):deferred.reject(operation.getError()||"Could not load data")}}),deferred.promise},_loadProject:function(oid){var me=this,deferred=Q.defer();return oid?me.Project?(me.Project.load(oid,{fetch:me._projectFields,context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:deferred.resolve}),deferred.promise):Q.reject("IntelRallyApp is not configured!"):Q.reject("Invalid arguments: LP")},_loadUserStory:function(oid,projectRecord){var me=this,deferred=Q.defer();return oid?me.UserStory?(me.UserStory.load(oid,{fetch:me._userStoryFields,context:{workspace:projectRecord?null:me.getContext().getWorkspace()._ref,project:projectRecord?projectRecord.data._ref:null},callback:deferred.resolve}),deferred.promise):Q.reject("IntelRallyApp is not configured!"):Q.reject("Invalid arguments: LUS")},_loadPortfolioItemByType:function(oid,type){var me=this,deferred=Q.defer();return oid&&type?(me[type].load(oid,{fetch:me._portfolioItemFields,context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:deferred.resolve}),deferred.promise):Q.reject("Invalid arguments: LPIBT")},_loadPortfolioItemByOrdinal:function(oid,ordinal){var me=this,deferred=Q.defer(),type=me.PortfolioItemTypes[ordinal];return me._loadPortfolioItemByType(oid,type)},_projectInWhichScrumGroup:function(projectRecord){if(projectRecord){var me=this,foundScrumGroupConfig=_.find(me.ScrumGroupConfig,function(scrumGroupConfig){return scrumGroupConfig.ScrumGroupRootProjectOID==projectRecord.data.ObjectID});if(foundScrumGroupConfig)return Q(projectRecord);var parent=projectRecord.data.Parent;return parent?me._loadProject(parent.ObjectID).then(function(parentRecord){return me._projectInWhichScrumGroup(parentRecord)}):Q()}return Q()},_loadScrumGroupPortfolioProject:function(scrumGroupRootProjectRecord){if(!scrumGroupRootProjectRecord)return Q.reject("Invalid arguments: _loadScrumGroupPortfolioProject");var me=this,foundScrumGroupConfig=_.find(me.ScrumGroupConfig,function(scrumGroupConfig){return scrumGroupConfig.ScrumGroupRootProjectOID==scrumGroupRootProjectRecord.data.ObjectID});return foundScrumGroupConfig?foundScrumGroupConfig.ScrumGroupAndPortfolioLocationTheSame?Q(scrumGroupRootProjectRecord):me._loadProject(foundScrumGroupConfig.PortfolioProjectOID):Q.reject("Project "+scrumGroupRootProjectRecord.data.Name+" is not a scrum group!")},_getScrumGroupName:function(scrumGroupRootProjectRecord){if(!scrumGroupRootProjectRecord)throw"Invalid arguments: _getScrumGroupName";var me=this,foundScrumGroupConfig=_.find(me.ScrumGroupConfig,function(scrumGroupConfig){return scrumGroupConfig.ScrumGroupRootProjectOID==scrumGroupRootProjectRecord.data.ObjectID});if(!foundScrumGroupConfig)throw"Project "+scrumGroupRootProjectRecord.data.Name+" is not a scrum-group!";return foundScrumGroupConfig.ScrumGroupName?foundScrumGroupConfig.ScrumGroupName:scrumGroupRootProjectRecord.data.Name},_loadAllScrumGroups:function(){var me=this,filter=_.reduce(me.ScrumGroupConfig,function(filter,scrumGroupConfig){var newFilter=Ext.create("Rally.data.wsapi.Filter",{property:"ObjectID",value:scrumGroupConfig.ScrumGroupRootProjectOID});return filter?filter.or(newFilter):newFilter},null);if(filter){var store=Ext.create("Rally.data.wsapi.Store",{model:"Project",limit:1/0,disableMetaChangeEvent:!0,autoLoad:!1,fetch:me._projectFields,filters:[filter],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})}return Q([])},__getUserStoryInReleaseTimeFrameFilter:function(releaseRecord){var me=this,lowestPortfolioItem=me.PortfolioItemTypes[0],twoWeeks=12096e5,releaseStartPadding=new Date(1*new Date(releaseRecord.data.ReleaseStartDate)+twoWeeks).toISOString(),releaseEndPadding=new Date(1*new Date(releaseRecord.data.ReleaseDate)-twoWeeks).toISOString();return Ext.create("Rally.data.wsapi.Filter",{property:"Release.ReleaseStartDate",operator:"<",value:releaseStartPadding}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Release.ReleaseDate",operator:">",value:releaseEndPadding})).or(Ext.create("Rally.data.wsapi.Filter",{property:"Release.ObjectID",value:null}).and(Ext.create("Rally.data.wsapi.Filter",{property:lowestPortfolioItem+".Release.ReleaseStartDate",operator:"<",value:releaseStartPadding}).and(Ext.create("Rally.data.wsapi.Filter",{property:lowestPortfolioItem+".Release.ReleaseDate",operator:">",value:releaseEndPadding}))))},_loadRandomUserStory:function(projectRecord){if(!projectRecord)return Q.reject("Invalid arguments: LRUS");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1,pageSize:1,disableMetaChangeEvent:!0,fetch:!1,context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID}]});return me._reloadStore(store).then(function(store){return store.getRange().pop()})},_loadRandomUserStoryFromReleaseTimeframe:function(projectRecord,releaseRecord){if(!projectRecord||!releaseRecord)return Q.reject("Invalid arguments: LRUSFR");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:5,pageSize:5,disableMetaChangeEvent:!0,fetch:me._userStoryFields,context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},sorters:[{property:"CreationDate",direction:"DESC"}],filters:[Ext.create("Rally.data.wsapi.Filter",{property:"Project.ObjectID",value:projectRecord.data.ObjectID}).and(me.__getUserStoryInReleaseTimeFrameFilter(releaseRecord))]});return me._reloadStore(store).then(function(store){var records=store.data.items;return records.length?Q(records[Math.floor(Math.random()*records.length)]):Q(void 0)})},_loadUserStoryByFID:function(formattedID,projectRecord){if(!formattedID||!projectRecord)return Q.reject("Invalid arguments: LUSBFID");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1,pageSize:1,disableMetaChangeEvent:!0,fetch:["Name","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},filters:[{property:"FormattedID",value:formattedID},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}]});return me._reloadStore(store).then(function(store){return Q(store.data.items.pop())})},_loadPortfolioItemsOfType:function(portfolioProject,type){if(!portfolioProject||!type)return Q.reject("Invalid arguments: OPIOT");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/"+type,limit:1/0,disableMetaChangeEvent:!0,remoteSort:!1,fetch:me._portfolioItemFields,context:{project:portfolioProject.data._ref,projectScopeDown:!0,projectScopeUp:!1}});return me._reloadStore(store)},_loadPortfolioItemsOfOrdinal:function(portfolioProject,ordinal){if(!portfolioProject||ordinal===void 0)return Q.reject("Invalid arguments: LPIOO");var me=this,type=me.PortfolioItemTypes[ordinal];return type?me._loadPortfolioItemsOfType(portfolioProject,type):Q.reject("Invalid PortfolioItem ordinal")},_portfolioItemTypeToOrdinal:function(type){return this.PortfolioItemTypes.indexOf(type)},_getPortfolioItemTypeStateByOrdinal:function(ordinal,stateName){return _.find(this.PortfolioItemTypeStates[ordinal],function(state){return state.data.Name==stateName})},_getPortfolioItemTypeStateByName:function(portfolioType,stateName){return this._getPortfolioItemTypeStateByOrdinal(this._portfolioItemTypeToOrdinal(portfolioType),stateName)},__storeItemsToProjTree:function(projects){for(var me=this,projTree={},i=0,len=projects.length;len>i;++i){var project=projects[i],thisRef=project.data.ObjectID,parentRef=project.data.Parent?project.data.Parent.ObjectID:void 0;projTree[thisRef]||(projTree[thisRef]={}),projTree[thisRef].ProjectRecord=project,parentRef&&(projTree[parentRef]||(projTree[parentRef]={}),projTree[parentRef][thisRef]=projTree[thisRef])}return projTree},_loadAllProjects:function(){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:me._projectFields,limit:1/0,disableMetaChangeEvent:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){var map=_.reduce(store.getRange(),function(map,project){return map[project.data.ObjectID]=project,map},{});return map})},__addProjectsWithTeamMembersToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;curProj.data.TeamMembers.Count>0&&(hash[curProj.data.ObjectID]=curProj);for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me.__addProjectsWithTeamMembersToList(projTree[childProjRef],hash)},_loadProjectsWithTeamMembers:function(rootProjectRecord){var me=this,projectsWithTeamMembers={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:me._projectFields,limit:1/0,disableMetaChangeEvent:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){if(rootProjectRecord){var projTree=me.__storeItemsToProjTree(store.getRange());return me.__addProjectsWithTeamMembersToList(projTree[rootProjectRecord.data.ObjectID],projectsWithTeamMembers),projectsWithTeamMembers}return _.reduce(_.filter(store.getRange(),function(project){return project.data.TeamMembers.Count>0}),function(map,project){return map[project.data.ObjectID]=project,map},{})})},__allChildProjectToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;hash[curProj.data.ObjectID]=curProj;for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me.__allChildProjectToList(projTree[childProjRef],hash)},_loadAllChildrenProjects:function(rootProjectRecord){var me=this,childrenProjects={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:me._projectFields,limit:1/0,disableMetaChangeEvent:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){if(rootProjectRecord){var projTree=me.__storeItemsToProjTree(store.getRange());return me.__allChildProjectToList(projTree[rootProjectRecord.data.ObjectID],childrenProjects),childrenProjects}return _.reduce(store.getRange(),function(map,project){return map[project.data.ObjectID]=project,map},{})})},__allLeafProjectsToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;0===curProj.data.Children.Count&&(hash[curProj.data.ObjectID]=curProj);for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me.__allLeafProjectsToList(projTree[childProjRef],hash)},_loadAllLeafProjects:function(rootProjectRecord){var me=this,leafProjects={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:me._projectFields,limit:1/0,disableMetaChangeEvent:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){if(rootProjectRecord){var projTree=me.__storeItemsToProjTree(store.getRange());return me.__allLeafProjectsToList(projTree[rootProjectRecord.data.ObjectID],leafProjects),leafProjects}return _.reduce(_.filter(store.getRange(),function(project){return 0===project.data.Children.Count}),function(map,project){return map[project.data.ObjectID]=project,map},{})})},_loadProjectByName:function(projectName){if(!projectName)return Q.reject("Invalid arguments: LPBN");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Project",limit:1,pageSize:1,fetch:["Name","ObjectID"],disableMetaChangeEvent:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:projectName}]});return me._reloadStore(store).then(function(store){return Q(store.data.items.pop())})},_loadAllReleases:function(projectRecord){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,disableMetaChangeEvent:!0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleasesAfterGivenDate:function(projectRecord,givenDate){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,disableMetaChangeEvent:!0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"ReleaseDate",operator:">=",value:new Date(givenDate).toISOString()},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleasesBeforeGivenDate:function(projectRecord,givenDate){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!1,disableMetaChangeEvent:!0,fetch:me._releaseFields,filters:[{property:"ReleaseDate",operator:"<=",value:new Date(givenDate).toISOString()},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleasesBetweenDates:function(projectRecord,startDate,endDate){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!1,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID},{property:"ReleaseDate",operator:">",value:new Date(startDate).toISOString()},{property:"ReleaseStartDate",operator:"<",value:new Date(endDate).toISOString()}]});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleasesInTheFuture:function(projectRecord){return this._loadReleasesAfterGivenDate(projectRecord,new Date)},_loadReleasesByNameUnderProject:function(releaseName,projectRecord){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,disableMetaChangeEvent:!0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"Name",value:releaseName}],context:{project:projectRecord.data._ref,projectScopeDown:!0,projectScopeUp:!1}});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleaseByNameForProject:function(releaseName,projectRecord){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,disableMetaChangeEvent:!0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"Name",value:releaseName},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange().pop()})},_loadReleasesByNameContainsForProject:function(releaseName,projectRecord){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,disableMetaChangeEvent:!0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"Name",operator:"contains",value:releaseName},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})},_getScopedRelease:function(releaseRecords,projectOID,appPrefs){var me=this,d=new Date,rs=releaseRecords,prefOID=appPrefs&&appPrefs.projs&&appPrefs.projs[projectOID]&&appPrefs.projs[projectOID].Release;return prefOID&&_.find(rs,function(r){return r.data.ObjectID==prefOID})||_.find(rs,function(r){return new Date(r.data.ReleaseDate)>=d&&d>=new Date(r.data.ReleaseStartDate)})||_.reduce(rs,function(best,r){if(null===best)return r;var d1=1*new Date(best.data.ReleaseStartDate),d2=1*new Date(r.data.ReleaseStartDate),now=1*new Date;return Math.abs(d1-now)<Math.abs(d2-now)?best:r},null)}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("WorkweekDropdown",{extend:"Ext.data.Model",fields:[{name:"Workweek",type:"string"},{name:"DateVal",type:"number"}]}),Ext.define("ScrumGroupPortfolioConfigItem",{extend:"Ext.data.Model",fields:[{name:"ScrumGroupRootProjectOID",type:"number"},{name:"ScrumGroupName",type:"string"},{name:"ScrumGroupAndPortfolioLocationTheSame",type:"boolean"},{name:"PortfolioProjectOID",type:"number"},{name:"IsTrain",type:"boolean"}]})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("WindowListener",{__initWindowEventListener:function(eventName){var me=this;me._windowListeners||(me._windowListeners={}),me._windowListeners[eventName]=[],window.parent["on"+eventName]=function(event){for(var listeners=me._windowListeners[eventName],i=0,len=listeners.length;len>i;++i)listeners[i](event)}},_addWindowEventListener:function(eventName,fn){var me=this;me._windowListeners&&me._windowListeners[eventName]||me.__initWindowEventListener(eventName),me._windowListeners[eventName].push(fn)},_fireParentWindowEvent:function(eventName){var me=this;if(me._windowListeners&&me._windowListeners[eventName])for(var listeners=me._windowListeners[eventName],i=0,len=listeners.length;len>i;++i)listeners[i]()}})})();
                (function(){var Ext=window.Ext4||window.Ext,TOP_BAR_HEIGHT=40,BOTTOM_BAR_HEIGHT=24,BOTTOM_IFRAME_PADDING=20,TITLE_BAR_HEIGHT=33,IFRAME_HEADER_HEIGHT=28;Ext.define("IframeResize",{requires:["WindowListener"],_fixRallyDashboard:function(){if(window&&window.frameElement){for(var me=this,bottomEl=Ext.get(window.frameElement),portlet=bottomEl.up(".x-portlet"),dashboard=portlet.up("#mydash_portlet"),titleBar=dashboard.down(".titlebar"),domNodeW=bottomEl.dom,domNodeH=bottomEl.dom,innerHeight=window.parent.innerHeight,innerWidth=window.parent.innerWidth;;){if(domNodeW.style.width=innerWidth-4+"px",domNodeW.style.padding="0",domNodeW.style.margin="0","mydash_portlet"===domNodeW.id)break;domNodeW=domNodeW.parentNode}for(;;){if(domNodeH.style.height=innerHeight-(TOP_BAR_HEIGHT+BOTTOM_BAR_HEIGHT+TITLE_BAR_HEIGHT+IFRAME_HEADER_HEIGHT+BOTTOM_IFRAME_PADDING)+"px",domNodeH.classList.contains("x-portlet"))break;domNodeH=domNodeH.parentNode}for(;;){if(domNodeH.style.height=innerHeight-(TOP_BAR_HEIGHT+BOTTOM_BAR_HEIGHT+TITLE_BAR_HEIGHT)+"px","mydash_portlet"==domNodeH.id)break;domNodeH=domNodeH.parentNode}dashboard.dom.style.height=innerHeight-(TOP_BAR_HEIGHT+BOTTOM_BAR_HEIGHT)+"px",dashboard.dom.style.padding="0 2px 0 2px",titleBar.dom.style.padding="2px",titleBar.dom.style.margin="0"}},_initFixRallyDashboard:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me._fixRallyDashboard()}),me._fixRallyDashboard()},_disableResizeHandle:function(){var me=this,handle;window&&window.frameElement&&(handle=Ext.get(window.frameElement).up(".x-portlet").down(".x-resizable-handle"),handle&&(handle.hide(),handle.dom.onshow=function(){handle&&handle.hide()}))},_initDisableResizeHandle:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me._disableResizeHandle()}),me._disableResizeHandle()}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("PrettyAlert",{__getMessageBoxY:function(){var me=this,bottomEl=window.frameElement?Ext.get(window.frameElement):me.el,ph=window.frameElement?window.parent.getWindowHeight():window.innerHeight,ps=window.frameElement?window.parent.getScrollY():window.scrollY,ofy=ps+bottomEl.dom.getBoundingClientRect().top,iyOffset=Math.floor(ph/2-ofy+ps-50);return 0>iyOffset?0:iyOffset},_alert:function(title,message){var me=this;message="string"==typeof message?message:message.message?message.message:JSON.stringify(message,null,"	"),1>arguments.length||(1===arguments.length&&(message=title,title=""),Ext.MessageBox.alert(title,message).setY(me.__getMessageBoxY()),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},50))},_confirm:function(title,message,fn){var me=this;message="string"==typeof message?message:message.message?message.message:JSON.stringify(message,null,"	"),2>arguments.length||(2===arguments.length&&(fn=message,message=title,title=""),"function"!=typeof fn&&(fn=function(){}),Ext.MessageBox.confirm(title,message,fn).setY(me.__getMessageBoxY()),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20))}})})();
                (function(){var Ext=window.Ext4||window.Ext,POLL_INTERVAL_MS=10;Ext.define("Skirtle.CTemplate",{extend:"Ext.XTemplate",statics:{AUTO_ID:0},copyDepth:10,cTpl:'<p id="ctemplate-{0}-{1}"></p>',isCTemplate:!0,constructor:function(){var me=this;me.callParent(arguments),me.id=++me.statics().AUTO_ID,me.reset()},copyValues:function(values,depth){var me=this,id,copy={},copyDepth=depth||me.copyDepth;return 1===copyDepth?values:Ext.isArray(values)?Ext.Array.map(values,function(value){return me.copyValues(value,copyDepth-1)}):Ext.isObject(values)?values.isComponent?(id=values.getId(),me.ids.push(id),Ext.String.format(me.cTpl,id,me.id)):(Ext.Object.each(values,function(key,value){copy[key]="$comp"===key?value:me.copyValues(value,copyDepth-1)}),copy):values},doInsert:function(){var ret=this.callParent(arguments);return this.injectComponents(),ret},doPolling:function(interval){var me=this;me.pollInterval=interval,me.pollId&&clearTimeout(me.pollId),me.pollId=Ext.defer(me.injectComponents,interval,me)},getPlaceholderEl:function(id){return Ext.get("ctemplate-"+id+"-"+this.id)},injectComponents:function(){for(var me=this,ids=me.ids,index=ids.length-1,id,cmp,placeholderEl;index>=0;--index)id=ids[index],cmp=Ext.getCmp(id),placeholderEl=me.getPlaceholderEl(id),(me.renderComponent(cmp,placeholderEl)||!cmp)&&(Ext.Array.splice(ids,index,1),placeholderEl&&placeholderEl.remove());ids.length&&me.doPolling(me.pollInterval)},overwrite:function(el){var dom,firstChild,ret;if(Ext.isIE)for(dom=Ext.getDom(el);dom.firstChild;)dom.removeChild(dom.firstChild);return ret=this.callParent(arguments),this.injectComponents(),ret},renderComponent:function(cmp,placeholderEl){if(cmp&&placeholderEl){var parent=placeholderEl.parent();return cmp.rendered?cmp.getEl().replace(placeholderEl):cmp.render(parent,placeholderEl),Ext.isIE6&&parent.repaint(),!0}return!1},reset:function(){var me=this;me.ids=[],me.pollId&&(clearTimeout(me.pollId),me.pollId=null)}},function(ctemplate){var apply=function(){var me=this,args=Ext.Array.slice(arguments);return args[0]=me.copyValues(args[0]),me.doPolling(POLL_INTERVAL_MS),me.callParent(args)};ctemplate.prototype.applyOut?ctemplate.override({applyOut:apply}):(ctemplate.override({applyTemplate:apply}),ctemplate.createAlias("apply","applyTemplate"))}),Ext.define("Skirtle.grid.column.Component",{alias:"widget.componentcolumn",extend:"Ext.grid.column.Column",requires:["Skirtle.CTemplate"],autoWidthComponents:!0,componentGC:!0,hasCustomRenderer:!0,lastFrameWidth:12,widthUpdateDelay:[10,400],constructor:function(cfg){var me=this;me.callParent(arguments),me.compIds=[],me.dataIndex=me.dataIndex||Ext.id(null,"cc-dataIndex-"),me.tpl=me.createTemplate(me.tpl),me.renderer=me.createRenderer(me.renderer),me.registerColumnListeners()},addRefOwner:function(child){var me=this,fn=me.refOwnerFn||(me.refOwnerFn=function(){return me});40200>me.extVersion?child.getBubbleTarget=fn:child.getRefOwner=fn},applyTemplate:function(data,value){return Ext.isDefined(value)&&(data[this.dataIndex]=value),this.tpl.apply(data)},beforeViewRefresh:function(){if(Ext.isIE)for(var ids=this.compIds,index=0,len=ids.length,item,el,parentEl;len>index;index++)(item=Ext.getCmp(ids[index]))&&(el=item.getEl())&&(el=el.dom)&&(parentEl=el.parentNode)&&parentEl.removeChild(el)},calculateFrameWidth:function(component){var el=component.getEl(),parentDiv=el&&el.parent(),parentTd=parentDiv&&parentDiv.parent();return parentTd?(this.lastFrameWidth=parentDiv.getFrameWidth("lr")+parentTd.getFrameWidth("lr"),this.lastFrameWidth):void 0},createRenderer:function(renderer){var me=this;return function(value,p,record){var data=Ext.apply({},record.data,record.getAssociatedData());return renderer&&(value=renderer.apply(this,arguments)),value=me.processValue(value),me.applyTemplate(data,value)}},createTemplate:function(tpl){return tpl&&tpl.isTemplate?tpl:Ext.create("Skirtle.CTemplate",tpl||["{",this.dataIndex,"}"])},destroyChild:function(child){child.destroy()},getRefItems:function(deep){for(var items=this.callParent([deep]),ids=this.compIds,index=0,len=ids.length,item;len>index;index++)item=Ext.getCmp(ids[index]),item&&(items.push(item),deep&&item.getRefItems&&items.push.apply(items,item.getRefItems(!0)));return items},onChildAfterRender:function(child){this.resizeChild(child)},onChildBoxReady:function(child){this.resizeChild(child,!1)},onChildDestroy:function(child){Ext.Array.remove(this.compIds,child.getId())},onChildResize:function(){this.redoScrollbars()},onColumnResize:function(column){column.resizeAll()},onColumnShow:function(column){column.resizeAll()},onColumnVisibilityChange:function(column){var items=column.getRefItems(),index=0,length=items.length,visible=!column.isHidden();for(Ext.suspendLayouts&&Ext.suspendLayouts();length>index;++index)items[index].setVisible(visible);Ext.resumeLayouts&&Ext.resumeLayouts(!0)},onDestroy:function(){Ext.destroy(this.getRefItems()),this.callParent()},onRender:function(){this.registerViewListeners(),this.callParent(arguments)},onViewChange:function(){var me=this,tpl=me.tpl;me.suspendResizing(),tpl.isCTemplate&&(tpl.injectComponents(),tpl.reset()),me.redoScrollbars(),me.resumeResizing(),me.performGC()},performGC:function(){for(var compIds=this.compIds,index=compIds.length-1,comp,el;index>=0;--index)comp=Ext.getCmp(compIds[index]),el=comp&&comp.getEl(),el&&(!this.componentGC||el.dom&&Ext.getDom(Ext.id(el))===el.dom)||comp&&!comp.isDestroyed&&comp.destroy()},processValue:function(value){var me=this,compIds=me.compIds,id,initialWidth,dom,parent;return Ext.isObject(value)&&!value.isComponent&&value.xtype&&(value=Ext.widget(value.xtype,value)),value&&value.isComponent&&(id=value.getId(),Ext.Array.contains(compIds,id)||compIds.push(id),me.addRefOwner(value),me.registerListeners(value),value.rendered?Ext.isIE&&(dom=value.el.dom,parent=dom.parentNode,parent&&(40101===me.extVersion&&Ext.core.DomHelper.insertBefore(dom,{tag:"p"}),parent.removeChild(dom))):me.autoWidthComponents&&(initialWidth=me.getWidth()-me.lastFrameWidth,initialWidth=initialWidth>4?initialWidth:4,value.setWidth(initialWidth)),(Ext.isIE6||Ext.isIE7)&&me.isHidden()&&value.hide()),value},redoScrollbars:function(){var me=this,grid=me.up("tablepanel");if(grid){if(me.resizeQueue)return me.redoScrollbarsRequired=!0,void 0;40100>me.extVersion?(grid.invalidateScroller(),grid.determineScrollbars()):grid.doLayout()}},registerColumnListeners:function(){var me=this;me.autoWidthComponents&&(me.on("resize",me.onColumnResize),me.on("show",me.onColumnShow)),(Ext.isIE6||Ext.isIE7)&&me.on({hide:me.onColumnVisibilityChange,show:me.onColumnVisibilityChange})},registerListeners:function(component){var me=this;component.on("destroy",me.onChildDestroy,me),me.autoWidthComponents&&(component.on("afterrender",me.onChildAfterRender,me,{single:!0}),me.extVersion>=40100&&component.on("boxready",me.onChildBoxReady,me,{single:!0})),component.on("resize",me.onChildResize,me)},registerViewListeners:function(){var me=this,view=me.up("tablepanel").getView();me.mon(view,"beforerefresh",me.beforeViewRefresh,me),me.mon(view,"refresh",me.onViewChange,me),me.mon(view,"itemupdate",me.onViewChange,me),me.mon(view,"itemadd",me.onViewChange,me),me.mon(view,"itemremove",me.onViewChange,me)},resizeAll:function(){var me=this;me.suspendResizing(),me.resizeQueue=me.getRefItems(),me.resumeResizing()},resizeChild:function(component,defer){var me=this,frameWidth,newWidth,oldWidth,resizeQueue;return me.resizingSuspended?(resizeQueue=me.resizeQueue,Ext.Array.contains(resizeQueue,component)||resizeQueue.push(component),void 0):(frameWidth=me.calculateFrameWidth(component),Ext.isNumber(frameWidth)&&(newWidth=me.getWidth()-frameWidth,oldWidth=component.getWidth(),me.setChildWidth(component,newWidth,oldWidth)&&defer!==!1&&Ext.each(me.widthUpdateDelay,function(delay){Ext.defer(me.resizeChild,delay,me,[component,!1])})),void 0)},resumeResizing:function(){var me=this,index=0,resizeQueue=me.resizeQueue,len=resizeQueue.length;if(!--me.resizingSuspended){for(;len>index;++index)me.resizeChild(resizeQueue[index]);me.resizeQueue=null,me.redoScrollbarsRequired&&me.redoScrollbars()}},setChildWidth:function(component,newWidth,oldWidth){return oldWidth===newWidth?!1:(component.setWidth(newWidth),!0)},suspendResizing:function(){var me=this;me.resizingSuspended=(me.resizingSuspended||0)+1,me.resizeQueue||(me.resizeQueue=[])}},function(cls){var proto=cls.prototype,version=Ext.getVersion();proto.extVersion=100*(100*version.getMajor()+version.getMinor())+version.getPatch(),Ext.Element.prototype.syncContent&&"4.1.0"==""+version&&(proto.extVersion=40101)})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("intel.grid.column.Component.",{alias:"widget.fastgridcolumn",extend:"Skirtle.grid.column.Component",autoWidthComponents:!1,componentGC:!0,hasCustomRenderer:!0,lastFrameWidth:12,constructor:function(cfg){var me=this;me.callParent(arguments)},registerViewListeners:function(){var me=this,view=me.up("tablepanel").getView();me.mon(view,"beforerefresh",me.beforeViewRefresh,me),me.mon(view,"refresh",me.onViewChange,me)},onViewChange:function(){var me=this,tpl=me.tpl;me.suspendResizing(),tpl.isCTemplate&&(tpl.injectComponents(),tpl.reset()),me.resumeResizing(),me.performGC()},resumeResizing:function(){var me=this,index=0,resizeQueue=me.resizeQueue,len=resizeQueue.length;if(!--me.resizingSuspended){for(;len>index;++index)me.resizeChild(resizeQueue[index]);me.resizeQueue=null}},onChildResize:function(){}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("IntelComboBox",{extend:"Ext.form.field.ComboBox",alias:["widget.intelcombo","widget.intelcombobox"],constructor:function(options){options=options||{},options=Ext.merge({enableKeyEvents:!0,queryMode:"local",ignoreNoChange:!0,allowBlank:!0,listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var combo=this;combo.store.clearFilter(),combo.store.filterBy(function(item){return null!==item.data[combo.displayField].match(RegExp(combo.getRawValue(),"i"))})}},focus:function(combo){combo.store.clearFilter(),combo.setValue(""),combo.expand()}}},options),this.callParent([options])}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("ScrumGroupPortfolioConfiguration",{extend:"IntelRallyApp",mixins:["WindowListener","PrettyAlert","IframeResize"],_getStoreData:function(){var me=this;return _.map(me.ScrumGroupConfig,function(scrumGroupConfig){return{ScrumGroupRootProjectOID:scrumGroupConfig.ScrumGroupRootProjectOID||0,ScrumGroupName:scrumGroupConfig.ScrumGroupName||"",ScrumGroupAndPortfolioLocationTheSame:scrumGroupConfig.ScrumGroupAndPortfolioLocationTheSame?!0:!1,PortfolioProjectOID:scrumGroupConfig.PortfolioProjectOID||0,IsTrain:scrumGroupConfig.IsTrain?!0:!1}})},launch:function(){var me=this;return me._initDisableResizeHandle(),me._initFixRallyDashboard(),me.setLoading("Loading Configuration"),me.getContext().getPermissions().isWorkspaceOrSubscriptionAdmin(me.getContext().getWorkspace())?(me._configureIntelRallyApp().then(function(){return me._loadAllProjects()}).then(function(allProjects){me.AllProjects=allProjects,me.ProjectDataForStore=_.sortBy(_.map(me.AllProjects,function(project){return{Name:project.data.Name,ObjectID:project.data.ObjectID}}),function(item){return item.Name}),me.setLoading(!1),me._renderGrid()}).fail(function(reason){me.setLoading(!1),me._alert("ERROR",reason||"")}).done(),void 0):(me.setLoading(!1),me._alert("ERROR","You do not have permissions to edit this workspace's settings!"),void 0)},_renderGrid:function(){var me=this;me.ScrumGroupPortfolioConfigStore=Ext.create("Ext.data.Store",{model:"ScrumGroupPortfolioConfigItem",data:me._getStoreData()});var columnCfgs=[{text:"Scrum Group Root Project",dataIndex:"ScrumGroupRootProjectOID",tdCls:"intel-editor-cell",flex:1,editor:{xtype:"intelcombobox",width:"100%",allowBlank:!0,store:Ext.create("Ext.data.Store",{fields:["Name","ObjectID"],data:me.ProjectDataForStore}),displayField:"Name",valueField:"ObjectID"},resizable:!1,draggable:!1,sortable:!0,renderer:function(pid){return pid?me.AllProjects[pid].data.Name:"-"}},{text:"Scrum Group Name",dataIndex:"ScrumGroupName",tdCls:"intel-editor-cell",flex:1,editor:"textfield",resizable:!1,draggable:!1,sortable:!0},{text:"Scrum Group And Portfolio Location The Same?",xtype:"checkcolumn",dataIndex:"ScrumGroupAndPortfolioLocationTheSame",flex:1,resizable:!1,draggable:!1,sortable:!0},{text:"Portfolio Project",dataIndex:"PortfolioProjectOID",flex:1,editor:{xtype:"intelcombobox",width:"100%",allowBlank:!0,store:Ext.create("Ext.data.Store",{fields:["Name","ObjectID"],data:me.ProjectDataForStore}),displayField:"Name",valueField:"ObjectID"},resizable:!1,draggable:!1,sortable:!0,renderer:function(pid,meta,record){return record.data.ScrumGroupAndPortfolioLocationTheSame||(meta.tdCls+=" intel-editor-cell"),record.data.ScrumGroupAndPortfolioLocationTheSame||!pid?"-":me.AllProjects[pid].data.Name}},{text:"Is Train?",xtype:"checkcolumn",dataIndex:"IsTrain",width:100,resizable:!1,draggable:!1,sortable:!0},{text:"",width:160,xtype:"fastgridcolumn",tdCls:"iconCell",resizable:!1,draggable:!1,renderer:function(value,meta,record){return{xtype:"button",text:"Remove Scrum Group",width:"100%",handler:function(){me.ScrumGroupPortfolioConfigStore.remove(record)}}}}];me.ScrumGroupPortfolioConfigGrid=me.add({xtype:"grid",emptyText:" ",header:{layout:"hbox",items:[{xtype:"text",cls:"grid-header-text",width:500,text:"Scrum Group Portfolio Config"},{xtype:"container",flex:1e3,layout:{type:"hbox",pack:"end"},items:[{xtype:"button",text:"+ Add Scrum Group",width:150,margin:"0 10 0 0",listeners:{click:function(){var model=Ext.create("ScrumGroupPortfolioConfigItem",{ScrumGroupRootProjectOID:0,ScrumGroupName:"",ScrumGroupAndPortfolioLocationTheSame:!0,PortfolioProjectOID:0,IsTrain:!0});me.ScrumGroupPortfolioConfigStore.insert(0,[model])}}},{xtype:"button",text:"Undo changes",width:110,margin:"0 10 0 0",listeners:{click:function(){me.ScrumGroupPortfolioConfigStore.removeAll(),me.ScrumGroupPortfolioConfigStore.add(me._getStoreData())}}},{xtype:"button",text:"Save Config",width:100,listeners:{click:function(){var scrumGroupRecords=me.ScrumGroupPortfolioConfigStore.getRange(),scrumGroupData=_.map(scrumGroupRecords,function(scrumGroupRecord){return{ScrumGroupRootProjectOID:scrumGroupRecord.data.ScrumGroupRootProjectOID,ScrumGroupName:scrumGroupRecord.data.ScrumGroupName,ScrumGroupAndPortfolioLocationTheSame:scrumGroupRecord.data.ScrumGroupAndPortfolioLocationTheSame,PortfolioProjectOID:scrumGroupRecord.data.PortfolioProjectOID,IsTrain:scrumGroupRecord.data.IsTrain}}),badScrumGroupRootOID=_.find(scrumGroupData,function(scrumGroupConfig){return scrumGroupConfig.ScrumGroupRootProjectOID?void 0:!0}),badPortfolioOID=_.find(scrumGroupData,function(scrumGroupConfig){return scrumGroupConfig.ScrumGroupAndPortfolioLocationTheSame||scrumGroupConfig.PortfolioProjectOID?void 0:!0}),badScrumGroupName=_.find(scrumGroupData,function(scrumGroupConfig){return scrumGroupConfig.ScrumGroupName?void 0:!0}),conflictingScrumGroupProject=_.find(scrumGroupData,function(scrumGroup1,idx1){return _.some(scrumGroupData,function(scrumGroup2,idx2){return idx1!==idx2&&scrumGroup1.ScrumGroupRootProjectOID&&scrumGroup1.ScrumGroupRootProjectOID==scrumGroup2.ScrumGroupRootProjectOID})}),conflictingScrumGroupName=_.find(scrumGroupData,function(scrumGroup1,idx1){return _.some(scrumGroupData,function(scrumGroup2,idx2){return idx1!==idx2&&scrumGroup1.ScrumGroupName===scrumGroup2.ScrumGroupName})});badScrumGroupRootOID?me._alert("ERROR","You must select a valid Scrum Group Root Project!"):badPortfolioOID?me._alert("ERROR","You must select a valid Portfolio Project!"):badScrumGroupName?me._alert("ERROR","Found an invalid Scrum Group Name!"):conflictingScrumGroupProject?me._alert("ERROR","A project is used for more than 1 Scrum Group!"):conflictingScrumGroupName?me._alert("ERROR","A Name is used by more than 1 Scrum Group!"):(me.ScrumGroupPortfolioConfigGrid.setLoading("Saving Config"),me._saveScrumGroupConfig(scrumGroupData).fail(function(reason){me._alert(reason)}).then(function(){me.ScrumGroupPortfolioConfigGrid.setLoading(!1)}).done())}}}]}]},margin:"10px 0 0 0",height:600,scroll:"vertical",columns:columnCfgs,disableSelection:!0,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1})],viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0},listeners:{beforeedit:function(editor,e){var record=e.record,field=e.field;return"PortfolioProjectOID"!=field||!record.data.ScrumGroupAndPortfolioLocationTheSame},edit:function(editor,e){var field=e.field,value=e.value,originalValue=e.originalValue,record=e.record;"ScrumGroupName"==field&&value!=originalValue&&record.set("ScrumGroupName",value.trim())}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,store:me.ScrumGroupPortfolioConfigStore})}})})();

            Rally.launchApp('ScrumGroupPortfolioConfiguration', {
                name:"Scrum Group Portfolio Configuration",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .x-grid-cell.intel-editor-cell *,.x4-grid-cell.intel-editor-cell *,.intel-editor-cell{cursor:pointer !important}.fa.fa-md{font-size:1.05rem;line-height:.75em;vertical-align:-15%}
    </style>
    <style type="text/css">
        .grid-header-text{font-size:1.5rem}
    </style>
</head>
<body>
</body>
</html>
