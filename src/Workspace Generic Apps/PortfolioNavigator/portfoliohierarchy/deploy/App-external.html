<!DOCTYPE html>
<html>
<head>
    <title>Portfolio Hierarchy</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.0.1/q.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("IntelRallyApp",{alias:"widget.intelrallyapp",extend:"Rally.app.App",_TrainConfigPrefName:"intel-train-config",_projectFields:["ObjectID","Releases","Children","Parent","Name","TeamMembers"],_portfolioItemFields:["Name","ObjectID","FormattedID","c_TeamCommits","c_MoSCoW","Release","c_Risks","Project","PlannedEndDate","Parent","Children","PortfolioItemType","Ordinal"],_userStoryFields:["Name","ObjectID","Release","Project","PortfolioItem","PlannedEndDate","ActualEndDate","FormattedID","Predecessors","Successors","c_Dependencies","Iteration","PlanEstimate"],_releaseFields:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project","TeamMembers"],_loadScheduleStates:function(){var me=this,deferred=Q.defer();return Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(records,operation,success){me.ScheduleStates=_.map(records,function(r){return r.data.StringValue}),deferred.resolve()}})}}),deferred.promise},_loadPortfolioItemStatesForEachType:function(){var me=this;return me.PortfolioItemTypeStates=[],Q.all(_.map(me.PortfolioItemTypes,function(portfolioType,ordinal){var store=Ext.create("Rally.data.wsapi.Store",{model:"State",autoLoad:!1,limit:1/0,disableMetaChangeEvent:!0,fetch:["Name","Enabled","OrderIndex"],filters:[{property:"TypeDef.Name",value:portfolioType},{property:"Enabled",value:!0}]});return me._reloadStore(store).then(function(store){me.PortfolioItemTypeStates[ordinal]=store.getRange()})}))},_loadPortfolioItemTypes:function(){var me=this,deferred=Q.defer(),store=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",autoLoad:!0,limit:1/0,disableMetaChangeEvent:!0,fetch:["Ordinal","Name"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Creatable",value:!0}],listeners:{load:function(portfolioTypeStore){me.PortfolioItemTypes=_.map(_.sortBy(_.map(portfolioTypeStore.getRange(),function(item){return{Name:item.data.Name,Ordinal:item.data.Ordinal}}),function(item){return item.Ordinal}),function(item){return item.Name}),deferred.resolve()}}});return deferred.promise},_loadModels:function(){var me=this,promises=[],models={Project:"Project",UserStory:"HierarchicalRequirement",PortfolioItem:"PortfolioItem"};return _.each(me.PortfolioItemTypes,function(name){models[name]="PortfolioItem/"+name}),_.each(models,function(modelType,modelName){var deferred=Q.defer();Rally.data.WsapiModelFactory.getModel({type:modelType,success:function(loadedModel){me[modelName]=loadedModel,deferred.resolve()}}),promises.push(deferred.promise)}),Q.all(promises)},_loadTrainConfig:function(){var me=this,deferred=Q.defer();return Rally.data.PreferenceManager.load({workspace:me.getContext().getWorkspace()._ref,filterByName:me._TrainConfigPrefName,success:function(prefs){var workspaceConfigString=prefs[me._TrainConfigPrefName],trainConfig;try{trainConfig=JSON.parse(workspaceConfigString)}catch(e){trainConfig=[]}me.TrainConfig=trainConfig,deferred.resolve()},failure:deferred.reject}),deferred.promise},_saveTrainConfig:function(trainConfig){var me=this,s={},deferred=Q.defer();return s[me._TrainConfigPrefName]=JSON.stringify(trainConfig),Rally.data.PreferenceManager.update({workspace:me.getContext().getWorkspace()._ref,filterByName:me._TrainConfigPrefName,settings:s,success:deferred.resolve,failure:deferred.reject}),deferred.promise},_configureIntelRallyApp:function(){var me=this;return Q.all([me._loadPortfolioItemTypes().then(function(){return Q.all([me._loadModels(),me._loadPortfolioItemStatesForEachType()])}),me._loadTrainConfig(),me._loadScheduleStates()])},_reloadStore:function(store){var deferred=Q.defer();return store.load({callback:function(records,operation,success){success?deferred.resolve(store):deferred.reject(operation.getError()||"Could not load data")}}),deferred.promise},_loadProject:function(oid){var me=this,deferred=Q.defer();return oid?me.Project?(me.Project.load(oid,{fetch:me._projectFields,context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:deferred.resolve}),deferred.promise):Q.reject("IntelRallyApp is not configured!"):Q.reject("Invalid arguments: LP")},_loadUserStory:function(oid,projectRecord){var me=this,deferred=Q.defer();return oid?me.UserStory?(me.UserStory.load(oid,{fetch:me._userStoryFields,context:{workspace:projectRecord?null:me.getContext().getWorkspace()._ref,project:projectRecord?projectRecord.data._ref:null},callback:deferred.resolve}),deferred.promise):Q.reject("IntelRallyApp is not configured!"):Q.reject("Invalid arguments: LUS")},_loadPortfolioItemByType:function(oid,type){var me=this,deferred=Q.defer();return oid&&type?(me[type].load(oid,{fetch:me._portfolioItemFields,context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:deferred.resolve}),deferred.promise):Q.reject("Invalid arguments: LPIBT")},_loadPortfolioItemByOrdinal:function(oid,ordinal){var me=this,deferred=Q.defer(),type=me.PortfolioItemTypes[ordinal];return me._loadPortfolioItemByType(oid,type)},_projectInWhichTrain:function(projectRecord){if(projectRecord){var me=this,foundTrainConfig=_.find(me.TrainConfig,function(trainConfig){return trainConfig.TrainProjectOID==projectRecord.data.ObjectID});if(foundTrainConfig)return Q(projectRecord);var parent=projectRecord.data.Parent;return parent?me._loadProject(parent.ObjectID).then(function(parentRecord){return me._projectInWhichTrain(parentRecord)}):Q()}return Q()},_loadTrainPortfolioProject:function(trainRecord){if(!trainRecord)return Q.reject("Invalid arguments: ltpp");var me=this,foundTrainConfig=_.find(me.TrainConfig,function(trainConfig){return trainConfig.TrainProjectOID==trainRecord.data.ObjectID});return foundTrainConfig?foundTrainConfig.TrainAndPortfolioLocationTheSame?Q(trainRecord):me._loadProject(foundTrainConfig.PortfolioProjectOID):Q.reject("Project "+trainRecord.data.Name+" is not a train!")},_getTrainName:function(trainRecord){if(!trainRecord)throw"Invalid arguments: gtn";var me=this,foundTrainConfig=_.find(me.TrainConfig,function(trainConfig){return trainConfig.TrainProjectOID==trainRecord.data.ObjectID});if(!foundTrainConfig)throw"Project "+trainRecord.data.Name+" is not a train!";return foundTrainConfig.TrainName?foundTrainConfig.TrainName:trainRecord.data.Name},_loadAllTrains:function(){var me=this,filter=_.reduce(me.TrainConfig,function(filter,item){var newFilter=Ext.create("Rally.data.wsapi.Filter",{property:"ObjectID",value:item.TrainProjectOID});return filter?filter.or(newFilter):newFilter},null);if(filter){var store=Ext.create("Rally.data.wsapi.Store",{model:"Project",limit:1/0,disableMetaChangeEvent:!0,autoLoad:!1,fetch:me._projectFields,filters:[filter],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})}return Q([])},__getUserStoryInReleaseTimeFrameFilter:function(releaseRecord){var me=this,twoWeeks=12096e5,releaseStartPadding=new Date(1*new Date(releaseRecord.data.ReleaseStartDate)+twoWeeks).toISOString(),releaseEndPadding=new Date(1*new Date(releaseRecord.data.ReleaseDate)-twoWeeks).toISOString();return Ext.create("Rally.data.wsapi.Filter",{property:"Release.ReleaseStartDate",operator:"<",value:releaseStartPadding}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Release.ReleaseDate",operator:">",value:releaseEndPadding})).or(Ext.create("Rally.data.wsapi.Filter",{property:"Release.ObjectID",value:null}).and(Ext.create("Rally.data.wsapi.Filter",{property:"PortfolioItem.Release.ReleaseStartDate",operator:"<",value:releaseStartPadding}).and(Ext.create("Rally.data.wsapi.Filter",{property:"PortfolioItem.Release.ReleaseDate",operator:">",value:releaseEndPadding}))))},_loadRandomUserStory:function(projectRecord){if(!projectRecord)return Q.reject("Invalid arguments: LRUS");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1,pageSize:1,disableMetaChangeEvent:!0,fetch:!1,context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID}]});return me._reloadStore(store).then(function(store){return store.getRange().pop()})},_loadRandomUserStoryFromReleaseTimeframe:function(projectRecord,releaseRecord){if(!projectRecord||!releaseRecord)return Q.reject("Invalid arguments: LRUSFR");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:5,pageSize:5,disableMetaChangeEvent:!0,fetch:me._userStoryFields,context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},sorters:[{property:"CreationDate",direction:"DESC"}],filters:[Ext.create("Rally.data.wsapi.Filter",{property:"Project.ObjectID",value:projectRecord.data.ObjectID}).and(me.__getUserStoryInReleaseTimeFrameFilter(releaseRecord))]});return me._reloadStore(store).then(function(store){var records=store.data.items;return records.length?Q(records[Math.floor(Math.random()*records.length)]):Q(void 0)})},_loadUserStoryByFID:function(formattedID,projectRecord){if(!formattedID||!projectRecord)return Q.reject("Invalid arguments: LUSBFID");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1,pageSize:1,disableMetaChangeEvent:!0,fetch:["Name","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},filters:[{property:"FormattedID",value:formattedID},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}]});return me._reloadStore(store).then(function(store){return Q(store.data.items.pop())})},_loadPortfolioItemsOfType:function(portfolioProject,type){if(!portfolioProject||!type)return Q.reject("Invalid arguments: OPIOT");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/"+type,limit:1/0,disableMetaChangeEvent:!0,remoteSort:!1,fetch:me._portfolioItemFields,context:{project:portfolioProject.data._ref,projectScopeDown:!0,projectScopeUp:!1}});return me._reloadStore(store)},_loadPortfolioItemsOfOrdinal:function(portfolioProject,ordinal){if(!portfolioProject||ordinal===void 0)return Q.reject("Invalid arguments: LPIOO");var me=this,type=me.PortfolioItemTypes[ordinal];return type?me._loadPortfolioItemsOfType(portfolioProject,type):Q.reject("Invalid PortfolioItem ordinal")},_portfolioItemTypeToOrdinal:function(type){return this.PortfolioItemTypes.indexOf(type)},_getPortfolioItemTypeStateByOrdinal:function(ordinal,stateName){return _.find(this.PortfolioItemTypeStates[ordinal],function(state){return state.data.Name==stateName})},_getPortfolioItemTypeStateByName:function(portfolioType,stateName){return this._getPortfolioItemTypeStateByOrdinal(this._portfolioItemTypeToOrdinal(portfolioType),stateName)},__storeItemsToProjTree:function(projects){for(var me=this,projTree={},i=0,len=projects.length;len>i;++i){var project=projects[i],thisRef=project.data.ObjectID,parentRef=project.data.Parent?project.data.Parent.ObjectID:void 0;projTree[thisRef]||(projTree[thisRef]={}),projTree[thisRef].ProjectRecord=project,parentRef&&(projTree[parentRef]||(projTree[parentRef]={}),projTree[parentRef][thisRef]=projTree[thisRef])}return projTree},_loadAllProjects:function(){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:me._projectFields,limit:1/0,disableMetaChangeEvent:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){var map=_.reduce(store.getRange(),function(map,project){return map[project.data.ObjectID]=project,map},{});return map})},__addProjectsWithTeamMembersToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;curProj.data.TeamMembers.Count>0&&(hash[curProj.data.ObjectID]=curProj);for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me.__addProjectsWithTeamMembersToList(projTree[childProjRef],hash)},_loadProjectsWithTeamMembers:function(rootProjectRecord){var me=this,projectsWithTeamMembers={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:me._projectFields,limit:1/0,disableMetaChangeEvent:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){if(rootProjectRecord){var projTree=me.__storeItemsToProjTree(store.getRange());return me.__addProjectsWithTeamMembersToList(projTree[rootProjectRecord.data.ObjectID],projectsWithTeamMembers),projectsWithTeamMembers}return _.reduce(_.filter(store.getRange(),function(project){return project.data.TeamMembers.Count>0}),function(map,project){return map[project.data.ObjectID]=project,map},{})})},__allChildProjectToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;hash[curProj.data.ObjectID]=curProj;for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me.__allChildProjectToList(projTree[childProjRef],hash)},_loadAllChildrenProjects:function(rootProjectRecord){var me=this,childrenProjects={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:me._projectFields,limit:1/0,disableMetaChangeEvent:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){if(rootProjectRecord){var projTree=me.__storeItemsToProjTree(store.getRange());return me.__allChildProjectToList(projTree[rootProjectRecord.data.ObjectID],childrenProjects),childrenProjects}return _.reduce(store.getRange(),function(map,project){return map[project.data.ObjectID]=project,map},{})})},__allLeafProjectsToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;0===curProj.data.Children.Count&&(hash[curProj.data.ObjectID]=curProj);for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me.__allLeafProjectsToList(projTree[childProjRef],hash)},_loadAllLeafProjects:function(rootProjectRecord){var me=this,leafProjects={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:me._projectFields,limit:1/0,disableMetaChangeEvent:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){if(rootProjectRecord){var projTree=me.__storeItemsToProjTree(store.getRange());return me.__allLeafProjectsToList(projTree[rootProjectRecord.data.ObjectID],leafProjects),leafProjects}return _.reduce(_.filter(store.getRange(),function(project){return 0===project.data.Children.Count}),function(map,project){return map[project.data.ObjectID]=project,map},{})})},_loadProjectByName:function(projectName){if(!projectName)return Q.reject("Invalid arguments: LPBN");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Project",limit:1,pageSize:1,fetch:["Name","ObjectID"],disableMetaChangeEvent:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:projectName}]});return me._reloadStore(store).then(function(store){return Q(store.data.items.pop())})},_loadAllReleases:function(projectRecord){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,disableMetaChangeEvent:!0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleasesAfterGivenDate:function(projectRecord,givenDate){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,disableMetaChangeEvent:!0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"ReleaseDate",operator:">=",value:new Date(givenDate).toISOString()},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleasesBeforeGivenDate:function(projectRecord,givenDate){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!1,disableMetaChangeEvent:!0,fetch:me._releaseFields,filters:[{property:"ReleaseDate",operator:"<=",value:new Date(givenDate).toISOString()},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleasesInTheFuture:function(projectRecord){return this._loadReleasesAfterGivenDate(projectRecord,new Date)},_loadReleasesByNameUnderProject:function(releaseName,projectRecord){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,disableMetaChangeEvent:!0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"Name",value:releaseName}],context:{project:projectRecord.data._ref,projectScopeDown:!0,projectScopeUp:!1}});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleaseByNameForProject:function(releaseName,projectRecord){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,disableMetaChangeEvent:!0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"Name",value:releaseName},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange().pop()})},_loadReleasesByNameContainsForProject:function(releaseName,projectRecord){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,disableMetaChangeEvent:!0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"Name",operator:"contains",value:releaseName},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})},_getScopedRelease:function(releaseRecords,projectOID,appPrefs){var me=this,d=new Date,rs=releaseRecords,prefOID=appPrefs&&appPrefs.projs&&appPrefs.projs[projectOID]&&appPrefs.projs[projectOID].Release;return prefOID&&_.find(rs,function(r){return r.data.ObjectID==prefOID})||_.find(rs,function(r){return new Date(r.data.ReleaseDate)>=d&&d>=new Date(r.data.ReleaseStartDate)})||_.reduce(rs,function(best,r){if(null===best)return r;var d1=new Date(best.data.ReleaseStartDate),d2=new Date(r.data.ReleaseStartDate),now=new Date;return Math.abs(d1-now)<Math.abs(d2-now)?best:r},null)}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("WorkweekDropdown",{extend:"Ext.data.Model",fields:[{name:"Workweek",type:"string"},{name:"DateVal",type:"number"}]}),Ext.define("TrainConfigItem",{extend:"Ext.data.Model",fields:[{name:"TrainProjectOID",type:"number"},{name:"TrainName",type:"string"},{name:"TrainAndPortfolioLocationTheSame",type:"boolean"},{name:"PortfolioProjectOID",type:"number"}]})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("PrettyAlert",{__getMessageBoxY:function(){var me=this,bottomEl=window.frameElement?Ext.get(window.frameElement):me.el,ph=window.frameElement?window.parent.getWindowHeight():window.innerHeight,ps=window.frameElement?window.parent.getScrollY():window.scrollY,ofy=ps+bottomEl.dom.getBoundingClientRect().top,iyOffset=Math.floor(ph/2-ofy+ps-50);return 0>iyOffset?0:iyOffset},_alert:function(title,message){var me=this;message="string"==typeof message?message:message.message?message.message:JSON.stringify(message,null,"	"),1>arguments.length||(1===arguments.length&&(message=title,title=""),Ext.MessageBox.alert(title,message).setY(me.__getMessageBoxY()),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},50))},_confirm:function(title,message,fn){var me=this;message="string"==typeof message?message:message.message?message.message:JSON.stringify(message,null,"	"),2>arguments.length||(2===arguments.length&&(fn=message,message=title,title=""),"function"!=typeof fn&&(fn=function(){}),Ext.MessageBox.confirm(title,message,fn).setY(me.__getMessageBoxY()),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20))}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("AsyncQueue",{QueueOfFuncs:{},_dequeue:function(queueName){var me=this;if(queueName=queueName||"undefined",me.QueueOfFuncs[queueName]){if(me.QueueOfFuncs[queueName].shift(),!me.QueueOfFuncs[queueName].length)return;me.QueueOfFuncs[queueName][0].call(me,me._dequeue.bind(me,queueName))}},_enqueue:function(callback,queueName){var me=this;if(queueName=queueName||"undefined","function"!=typeof callback)throw"ERROR: not a function";me.QueueOfFuncs[queueName]&&me.QueueOfFuncs[queueName].length?me.QueueOfFuncs[queueName].push(callback):(me.QueueOfFuncs[queueName]=[callback],callback.call(me,me._dequeue.bind(me,queueName)))}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("UserAppsPreference",{_userAppsPref:"intel-user-apps-preference",_loadAppsPreference:function(){var me=this,deferred=Q.defer();return Rally.data.PreferenceManager.load({filterByUser:!0,filterByName:me._userAppsPref,success:function(prefs){var appPrefs=prefs[me._userAppsPref];try{appPrefs=JSON.parse(appPrefs)}catch(e){appPrefs={projs:{},refresh:0}}deferred.resolve(appPrefs)},failure:deferred.reject}),deferred.promise},_saveAppsPreference:function(prefs){var me=this,s={},deferred=Q.defer();return prefs={projs:prefs.projs,refresh:prefs.refresh},s[me._userAppsPref]=JSON.stringify(prefs),Rally.data.PreferenceManager.update({filterByUser:!0,filterByName:me._userAppsPref,settings:s,success:deferred.resolve,failure:deferred.reject}),deferred.promise}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("IntelComboBox",{extend:"Ext.form.field.ComboBox",alias:["widget.intelcombo","widget.intelcombobox"],constructor:function(options){options=options||{},options=Ext.merge({enableKeyEvents:!0,queryMode:"local",ignoreNoChange:!0,allowBlank:!0,listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var combo=this;combo.store.clearFilter(),combo.store.filterBy(function(item){return null!==item.data[combo.displayField].match(RegExp(combo.getRawValue(),"i"))})}},focus:function(combo){combo.store.clearFilter(),combo.setValue(""),combo.expand()}}},options),this.callParent([options])}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("IntelFixedComboBox",{extend:"Ext.form.field.ComboBox",alias:["widget.intelfixedcombo","widget.intelfixedcombobox"],constructor:function(options){options=options||{},options=Ext.merge({editable:!1,allowBlank:!0,queryMode:"local",listeners:{change:function(combo,newval,oldval){0===newval.length&&combo.setValue(oldval)},focus:function(combo){combo.setValue(""),combo.expand()}}},options),this.callParent([options])}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.portfoliohierarchy.FittedUserStoryTreeItem",{extend:"Rally.ui.tree.UserStoryTreeItem",alias:"widget.fitteduserstorytreeitem",config:{displayedFields:["Name","Project","ScheduleState"]},getContentTpl:function(){var me=this;return Ext.create("Ext.XTemplate",'<tpl if="this.canDrag()"><div class="icon drag"></div></tpl>',"{[this.getActionsGear()]}",'<div class="textContent ellipses" style="max-width:65%;">',"{[this.getFormattedId()]} - ",'<span title="{Name}\nProject: {[this.getProjectName()]}">{Name}</span>',"</div>",'<div class="rightSide">',"{[this.getScheduleState()]}","</div>",{canDrag:function(){return me.getCanDrag()},getProjectName:function(){return me.getRecord().data.Project.Name},getActionsGear:function(){return me._buildActionsGearHtml()},getScheduleState:function(){return Rally.ui.renderer.RendererFactory.renderRecordField(me.getRecord(),"ScheduleState")},getFormattedId:function(){return Rally.ui.renderer.RendererFactory.renderRecordField(me.getRecord(),"FormattedID")}})}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.portfoliohierarchy.FittedPortfolioItemTreeItem",{extend:"Rally.ui.tree.PortfolioItemTreeItem",alias:"widget.fittedportfolioitemtreeitem",config:{displayedFields:["Name","Plan"]},getContentTpl:function(){var me=this;return Ext.create("Ext.XTemplate",'<tpl if="this.canDrag()"><div class="icon drag"></div></tpl>',"{[this.getActionsGear()]}",'<tpl if="this._renderPlanOnLowestLevelPortfolioItem()">','<div class="textContent ellipses" style="max-width: 65%;">',"{[this.getFormattedId()]} - ",'<span title="{Name}">{Name}</span>','<div class="textContent ellipses">{[this.getPlanData()]}</div>',"</div>","<tpl else>",'<div class="textContent ellipses" style="max-width: 65%;">',"{[this.getFormattedId()]} - ",'<span title="{Name}">{Name}</span>',"</div>","</tpl>",'<div class="rightSide">',"{[this.getPercentDone()]}","</div>",{canDrag:function(){return me.getCanDrag()},getActionsGear:function(){return me._buildActionsGearHtml()},getPercentDone:function(){return Rally.ui.renderer.RendererFactory.renderRecordField(me.getRecord(),"PercentDoneByStoryCount")},getFormattedId:function(){return Rally.ui.renderer.RendererFactory.renderRecordField(me.getRecord(),"FormattedID")},getPlanData:function(){var plan=me.getRecord().data.Plan,planName=plan&&plan.name?plan.name:"";return planName},_renderPlanOnLowestLevelPortfolioItem:function(){return me.getRecord().self.isLowestLevelPortfolioItem()}})}})})();
                (function(){var Ext=window.Ext4||window.Ext,USER_TOKEN=__PROJECT_OID__+"-"+__USER_OID__;Ext.define("IntelPortfolioHierarchy",{extend:"IntelRallyApp",mixins:["Rally.Messageable","PrettyAlert","UserAppsPreference"],layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"container",id:"headerRelease",layout:"hbox"},{xtype:"container",id:"headerProject",layout:"hbox"},{xtype:"container",id:"headerComplete",layout:"hbox"},{xtype:"container",id:"bodyContainer"}],_userAppsPref:"intel-portfolio-nav",config:{defaultSettings:function(){var s={};return s["Type"+USER_TOKEN]="",s["QueryFilter"+USER_TOKEN]="",s["InferPortfolioLocation"+USER_TOKEN]=!0,s["PortfolioLocation"+USER_TOKEN]=0,s}()},getSettingsFields:function(){return[{name:"Type"+USER_TOKEN,xtype:"rallycombobox",editable:!1,queryFilter:!0,displayField:"Name",valueField:"Name",storeConfig:{xtype:"rallywsapidatastore",model:"TypeDefinition",limit:1/0,fetch:["Ordinal","Name"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Creatable",value:!0}],sorters:[{property:"Ordinal",direction:"DESC"}],context:{workspace:Rally.environment.getContext().getWorkspace()._ref,project:null}},listeners:{added:function(field,form){form.down("rallycombobox").value?field.hide():field.show()}},label:"Type",labelWidth:120,width:"100%"},{name:"QueryFilter"+USER_TOKEN,xtype:"textfield",label:"Query Filter",labelWidth:120,width:"100%"},{name:"InferPortfolioLocation"+USER_TOKEN,xtype:"rallycheckboxfield",label:"Infer Portfolio Location",labelWidth:120,width:"100%",bubbleEvents:["change"]},{name:"PortfolioLocation"+USER_TOKEN,xtype:"rallycombobox",editable:!1,queryFilter:!0,displayField:"Name",valueField:"ObjectID",storeConfig:{xtype:"rallywsapidatastore",model:"Project",limit:1/0,fetch:["ObjectID","Name"],sorters:[{property:"Name",direction:"ASC"}],context:{workspace:Rally.environment.getContext().getWorkspace()._ref,project:null}},label:"Portfolio Location",labelWidth:120,width:"100%",listeners:{added:function(field,form){form.down("rallycheckboxfield").value?field.hide():(field.show(),setTimeout(function(){var fieldVal=Rally.getApp().getSetting(field.name);fieldVal&&field.setValue(fieldVal)},50))}},handlesEvents:{change:function(checkbox,isChecked){var field=this;isChecked?field.hide():(field.show(),setTimeout(function(){var fieldVal=Rally.getApp().getSetting(field.name);fieldVal&&field.setValue(fieldVal)},50))}}}]},_refreshTree:function(){var me=this;me.down("#bodyContainer").removeAll(),me._buildPortfolioTree()},_reloadEverything:function(){var me=this;me.setLoading(!1),me._buildFilterOnRelease(),me._buildReleasePicker(),me._buildFilterOnProject(),me._buildFilterOnComplete(),me._buildPortfolioTree()},launch:function(){var me=this;me.setLoading("Loading Configuration"),me._configureIntelRallyApp().then(function(){var scopeProject=me.getContext().getGlobalContext().getProject();return me._loadProject(scopeProject.ObjectID)}).then(function(scopeProjectRecord){return me.ProjectRecord=scopeProjectRecord,Q.all([me._projectInWhichTrain(me.ProjectRecord).then(function(trainRecord){return trainRecord?(me.TrainRecord=trainRecord,me._loadTrainPortfolioProject(me.TrainRecord).then(function(trainPortfolioProject){me.TrainPortfolioProject=trainPortfolioProject})):void 0}),me._loadAppsPreference().then(function(appsPref){me.AppsPref=appsPref;var twelveWeeks=72576e5;return me._loadReleasesAfterGivenDate(me.ProjectRecord,1*new Date-twelveWeeks)}).then(function(releaseRecords){me.ReleaseRecords=releaseRecords,me.ReleaseNames=[];for(var i=0,len=releaseRecords.length;len>i;++i)me.ReleaseNames.push({Name:releaseRecords[i].data.Name})}),me._loadAllProjects().then(function(projects){me.AllProjects=projects}),me._loadRandomUserStory(me.ProjectRecord).then(function(userStory){me.HasUserStories=!!userStory})])}).then(function(){var pid=me.ProjectRecord.data.ObjectID,prefs=me.AppsPref.projs[pid]||{};if(me.PIType=me.getSetting("Type"+USER_TOKEN),!me.PIType){me.PIType=me.PortfolioItemTypes[0];var newSettings={};newSettings["Type"+USER_TOKEN]=me.PIType,me.updateSettingsValues({settings:newSettings})}if(me.QueryFilter=me.getSetting("QueryFilter"+USER_TOKEN),me.InferPortfolioLocation=me.getSetting("InferPortfolioLocation"+USER_TOKEN),me.PortfolioLocation=me.getSetting("PortfolioLocation"+USER_TOKEN),me.FilterOnRelease=prefs.FilterOnRelease||!1,me.FilterReleaseName=prefs.FilterReleaseName||(me.ReleaseNames.length?me.ReleaseNames[0].Name:null),me.FilterOnProject=prefs.FilterOnProject||!1,me.FilterOnComplete=prefs.FilterOnComplete||!1,me.InferPortfolioLocation)me.PortfolioLocation=me.TrainPortfolioProject?me.TrainPortfolioProject:me.ProjectRecord;else if(me.PortfolioLocation&&(me.PortfolioLocation=_.find(me.AllProjects,function(p){return p.data.ObjectID===me.PortfolioLocation})),!me.PortfolioLocation)return Q.reject("Inferring Portfolio Location. You must set the project that the portfolio resides in!");me._reloadEverything()}).fail(function(reason){me.setLoading(!1),me._alert("ERROR",reason||"")}).done()},_onPreferenceChanged:function(field,newValue){var me=this,pid=me.ProjectRecord.data.ObjectID;return me[field]===newValue?Q():(me[field]=newValue,"object"!=typeof me.AppsPref.projs[pid]&&(me.AppsPref.projs[pid]={}),me.AppsPref.projs[pid][field]=newValue,me._saveAppsPreference(me.AppsPref))},_onReleaseSelected:function(combo,records){var me=this;me._onPreferenceChanged("FilterReleaseName",records[0].data.Name).then(function(){me.FilterOnRelease&&me._refreshTree()}).fail(function(reason){me._alert("ERROR:",reason)}).done()},_buildReleasePicker:function(){var me=this;Ext.getCmp("headerRelease").add({xtype:"intelfixedcombo",store:Ext.create("Ext.data.Store",{fields:["Name"],sorters:[function(o1,o2){return o1.data.Name>o2.data.Name?-1:1}],data:me.ReleaseNames}),hidden:!me.FilterOnRelease,displayField:"Name",value:me.FilterReleaseName,listeners:{select:me._onReleaseSelected.bind(me)}})},_onFilterOnReleaseChanged:function(checkBox){var me=this,value=checkBox.getValue(),box=Ext.getCmp("headerRelease").down("intelfixedcombo");value?box.show():box.hide(),me._onPreferenceChanged("FilterOnRelease",value).then(function(){me._refreshTree()}).fail(function(reason){me._alert("ERROR:",reason)}).done()},_buildFilterOnRelease:function(){var me=this;Ext.getCmp("headerRelease").add({xtype:"rallycheckboxfield",boxLabel:"Filter "+me.PortfolioItemTypes[0]+"s in Release",id:"filterOnReleaseCheckbox",value:me.FilterOnRelease,listeners:{change:me._onFilterOnReleaseChanged.bind(me)}})},_onFilterOnProjectChanged:function(checkBox){var me=this;me._onPreferenceChanged("FilterOnProject",checkBox.getValue()).then(function(){me._refreshTree()}).fail(function(reason){me._alert("ERROR:",reason)}).done()},_buildFilterOnProject:function(){var me=this;Ext.getCmp("headerProject").add({xtype:"rallycheckboxfield",boxLabel:"Filter User Stories in Current Project",id:"filterOnProjectCheckbox",hidden:!me.HasUserStories,value:me.FilterOnProject,listeners:{change:me._onFilterOnProjectChanged.bind(me)}})},_onFilterOnCompleteChanged:function(checkBox){var me=this;me._onPreferenceChanged("FilterOnComplete",checkBox.getValue()).then(function(){me._refreshTree()}).fail(function(reason){me._alert("ERROR:",reason)}).done()},_buildFilterOnComplete:function(){var me=this;Ext.getCmp("headerComplete").add({xtype:"rallycheckboxfield",boxLabel:"Hide Completed Items",labelWidth:170,value:me.FilterOnComplete,listeners:{change:me._onFilterOnCompleteChanged.bind(me)}})},_onTreeItemSelected:function(treeItem){"fittedportfolioitemtreeitem"===treeItem.xtype&&this.publish("portfoliotreeitemselected",treeItem)},_getDummyWsapiFilter:function(){return Ext.create("Rally.data.wsapi.Filter",{property:"ObjectID",operator:"!=",value:0})},_getFilterOnCompleteFilter:function(ordinal){var me=this,completeState=me._getPortfolioItemTypeStateByOrdinal(ordinal,"Done")||me._getPortfolioItemTypeStateByOrdinal(ordinal,"Complete")||me._getPortfolioItemTypeStateByOrdinal(ordinal,"Completed");return completeState?Ext.create("Rally.data.wsapi.Filter",{property:"State.OrderIndex",operator:"<",value:completeState.data.Ordinal}).or(Ext.create("Rally.data.wsapi.Filter",{property:"State",value:null})):me._getDummyWsapiFilter()},_getFilterOnReleaseFilter:function(){var me=this;return Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:me.FilterReleaseName})},_getFilterOnQueryFilter:function(){try{return Rally.data.QueryFilter.fromQueryString(this.QueryFilter)}catch(e){return this._getDummyWsapiFilter()}},_getParentRecordFilter:function(parentRecord,ordinal){return Ext.create("Rally.data.wsapi.Filter",{property:(0===ordinal?"PortfolioItem":"Parent")+".ObjectID",value:parentRecord.data.ObjectID})},_getTopLevelStoreConfig:function(ordinal){var me=this,filters=[];return me.FilterOnComplete&&filters.push(me._getFilterOnCompleteFilter(ordinal)),me.FilterOnRelease&&0===ordinal&&filters.push(me._getFilterOnReleaseFilter()),me.QueryFilter&&filters.push(me._getFilterOnQueryFilter()),{limit:1/0,filters:filters,context:{project:me.PortfolioLocation.data._ref,projectScopeDown:!0,projectScopeUp:!1}}},_getChildLevelStoreConfig:function(tree,parentRecord,isPI,ordinal){var me=this,context={project:me.PortfolioLocation.data._ref,projectScopeDown:!0,projectScopeUp:!1},filters=[me._getParentRecordFilter(parentRecord,ordinal)];return me.FilterOnComplete&&isPI&&ordinal>0&&filters.push(me._getFilterOnCompleteFilter(ordinal)),isPI&&0!==ordinal||(me.FilterOnProject?(context.project=me.ProjectRecord.data._ref,context.projectScopeDown=!1):(context.project=null,context.projectScopeDown=!1)),me.FilterOnRelease&&isPI&&1===ordinal&&filters.push(me._getFilterOnReleaseFilter()),me.QueryFilter&&filters.push(me._getFilterOnQueryFilter()),{limit:1/0,fetch:tree._getDefaultTopLevelFetchFields().concat(["Parent","Project","State"]),context:context,filters:filters}},_buildPortfolioTree:function(){var me=this,modelName="PortfolioItem/"+me.PIType,ordinal=me._portfolioItemTypeToOrdinal(me.PIType);me.down("#bodyContainer").add({xtype:"rallyportfoliotree",stateful:!0,stateId:me.getAppId()+"rallyportfoliotree",topLevelModel:modelName,topLevelStoreConfig:me._getTopLevelStoreConfig(ordinal),listeners:{itemselected:me._onTreeItemSelected.bind(me)},childItemsStoreConfigForParentRecordFn:function(parentRecord){var tree=this,isPI=tree._isPortfolioItem(parentRecord),ordinal=parentRecord.self.ordinal;return me._getChildLevelStoreConfig(tree,parentRecord,isPI,ordinal)},treeItemConfigForRecordFn:function(record){var tree=this,config=Rally.ui.tree.PortfolioTree.prototype.treeItemConfigForRecordFn.call(tree,record);return config.xtype=tree._isPortfolioItem(record)?"fittedportfolioitemtreeitem":"fitteduserstorytreeitem",config}})}})})();

            Rally.launchApp('IntelPortfolioHierarchy', {
                name:"Portfolio Hierarchy",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .portfolio-hierarchy-app{width:100% !important}.portfolio-hierarchy-app .rallytree{padding-top:5px;padding-bottom:20px}.portfolio-hierarchy-app .header{border-bottom:1px dotted #c6c6c6}.portfolio-hierarchy-app .filterInfo{float:right;padding-right:1px;border-right:1px solid #CCC;margin-right:5px;margin-top:2px;margin-bottom:2px}.portfolio-hierarchy-app .rally-help-icon{float:right}.portfolio-hierarchy-app .current-project-only-float{float:left}.portfolio-hierarchy-app .filter-on-release-float{float:left;margin-left:10px;margin-right:8px}#filterOnReleaseCheckbox{padding:0 4px 0 0}#filterOnProjectCheckbox{padding:0 4px 0 0}
    </style>
</head>
<body>
</body>
</html>
