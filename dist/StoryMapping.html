<!DOCTYPE html>
<html>
<head>
    <title>StoryMapping</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("StoryMapping",{extend:"Rally.app.App",requires:["Rally.data.wsapi.TreeStoreBuilder","Rally.ui.gridboard.plugin.GridBoardAddNew","Rally.ui.gridboard.plugin.GridBoardOwnerFilter","Rally.ui.gridboard.plugin.GridBoardFilterInfo","Rally.ui.gridboard.plugin.GridBoardArtifactTypeChooser","Rally.ui.gridboard.plugin.GridBoardFieldPicker","Rally.ui.cardboard.plugin.ColumnPolicy","Rally.ui.gridboard.plugin.GridBoardFilterInfo","Rally.ui.gridboard.plugin.GridBoardFilterControl","Rally.ui.gridboard.plugin.GridBoardToggleable","Rally.ui.grid.plugin.TreeGridExpandedRowPersistence","Rally.ui.gridboard.plugin.GridBoardExpandAll","Rally.ui.gridboard.plugin.GridBoardCustomView","Rally.clientmetrics.ClientMetricsRecordable"],componentCls:"app",launch:function(){var me=this;me._loadModels(function(){me._loadValidProjects(function(){var scopeProject=me.getContext().getProject();me._loadProject(scopeProject,function(scopeProjectRecord){me.ProjectRecord=_.find(me.ValidProjects,function(validProject){return validProject.data.ObjectID===scopeProjectRecord.data.ObjectID}),me.ProjectRecord?me._projectInWhichTrain(me.ProjectRecord,function(trainRecord){me.TrainRecord=trainRecord,me._loadReleases(function(){var currentRelease=me._getCurrentOrFirstRelease();currentRelease?(me.ReleaseRecord=currentRelease,me._loadPortfolioItemStore().then({success:function(gridStore){me._loadStoryStore().then({success:function(storyStore){me.add(me._getReleasePickerConfig()),me.add({xtype:"container",region:"center",layout:{type:"hbox",align:"stretch"},items:[me._getFeatureGridBoardConfig(gridStore),{border:0,width:20},me._getStoryGridBoardConfig(storyStore)]})}})},scope:me})):me._showError("This team has no releases")})}):me._showError("Please scope to a valid team for release planning")})})})},_loadStoryStore:function(){return Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:["userstory"],autoLoad:!0,enableHierarchy:!0,filters:[{property:"Iteration",operator:"=",value:null}]})},_loadPortfolioItemStore:function(){var typeStore=Ext.create("Rally.data.wsapi.Store",{autoLoad:!1,model:"TypeDefinition",sorters:[{property:"Ordinal",direction:"ASC"}],filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:!0}]}),deferred=Ext.create("Deft.Deferred");return typeStore.load({scope:this,callback:function(records){this.sModelNames=_.map(records,function(rec){return rec.get("TypePath")}),this.sModelMap=_.transform(records,function(acc,rec){acc[rec.get("TypePath")]=rec},{}),console.log("What is Here: ",records),this._getGridStore().then({success:function(gridStore){deferred.resolve(gridStore);var model=gridStore.model},scope:this})}}),deferred.promise},_loadModels:function(cb){var me=this;Rally.data.ModelFactory.getModel({type:"Project",scope:me,success:function(model){me.Project=model,Rally.data.ModelFactory.getModel({type:"HierarchicalRequirement",scope:me,success:function(model){me.UserStory=model,cb()}})}})},_loadValidProjects:function(cb){function loadChildren(project,_cb){Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,remoteSort:!1,limit:1/0,fetch:["Name","ObjectID","Parent"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Parent.ObjectID",value:project.get("ObjectID")}],listeners:{load:{fn:function(projectStore,projectRecords){if(0===projectRecords.length)scrums.push(project),_cb();else{var finished=0,done=function(){++finished===projectRecords.length&&_cb()};projectRecords.forEach(function(c){loadChildren(c,function(){done()})})}},single:!0}}})}var me=this,scrums=[];Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,remoteSort:!1,pageSize:1,limit:1,fetch:["Name","ObjectID"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:"All Scrums"}],listeners:{load:{fn:function(ps,recs){loadChildren(recs[0],function(){me.ValidProjects=scrums,me.ProjectNames=_.map(scrums,function(s){return{Name:s.get("Name")}}),console.log("valid scrums loaded:",scrums),cb()})},single:!0}}})},_loadProject:function(project,cb){var me=this;me.Project.load(project.ObjectID,{fetch:["ObjectID","Releases","Children","Parent","Name","_ref"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:function(record,operation){operation.wasSuccessful()?cb(record):me._showError("failed to retreive project: "+project.ObjectID)}})},_loadReleases:function(cb){var me=this,filterString=Ext.create("Rally.data.wsapi.Filter",{property:"Project.ObjectID",value:me.ProjectRecord.get("ObjectID")}),filterString2,f2;if(me.TrainRecord){var teamName=me.ProjectRecord.get("Name"),trainName=me.TrainRecord.get("Name").split(" ART ")[0],trainNames=teamName.split(trainName)[1].split("-");trainNames[0]?trainNames.push(trainName):trainNames[0]=trainName,trainNames.forEach(function(trainName){f2=Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"contains",value:trainName}),filterString2=filterString2?filterString2.or(f2):f2}),filterString=filterString.and(filterString2)}else filterString2=Ext.create("Rally.data.wsapi.Filter",{property:"ReleaseDate",operator:">=",value:(new Date).toISOString()}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"!contains",value:" "})),filterString=filterString.and(filterString2);filterString=""+filterString;var store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Dummy",value:"value"}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),me.ReleaseStore=releaseStore,cb()},single:!0}}});store._hydrateModelAndLoad=function(options){var deferred=new Deft.Deferred;this.hydrateModel().then({success:function(model){this.proxy.encodeFilters=function(){return filterString},this.load(options).then({success:Ext.bind(deferred.resolve,deferred),failure:Ext.bind(deferred.reject,deferred)})},scope:this})},store.load()},_projectInWhichTrain:function(projectRecord,cb){var me=this;projectRecord||cb();var split=projectRecord.get("Name").split(" ART ");if(split.length>1)cb(projectRecord);else{var parent=projectRecord.get("Parent");parent?me._loadProject(parent,function(parentRecord){me._projectInWhichTrain(parentRecord,cb)}):cb()}},_getCurrentOrFirstRelease:function(){var me=this,d=new Date,rs=me.ReleaseStore.getRecords();if(rs.length){for(var i=0;rs.length>i;++i)if(new Date(rs[i].get("ReleaseDate"))>=d&&d>=new Date(rs[i].get("ReleaseStartDate")))return rs[i];return rs[0]}},_getReleasePickerConfig:function(){var me=this;return{xtype:"combobox",region:"north",maxWidth:300,store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.ReleaseStore.getRecords(),function(r){return{Name:r.get("Name")}})}),displayField:"Name",fieldLabel:"Release:",editable:!1,value:me.ReleaseRecord.get("Name"),listeners:{select:function(combo,records){me.ReleaseRecord.get("Name")!==records[0].get("Name")&&(me.ReleaseRecord=me.ReleaseStore.findRecord("Name",records[0].get("Name")),setTimeout(function(){me.down("#gridBoard").getGridOrBoard().getStore().load({filters:[{property:"Release.Name",value:me.ReleaseRecord.get("Name")}]})},0))}}}},_getModelNames:function(){return _.union(this.sModelNames,this.eModelNames)},_getGridStore:function(){var query=[];this.getSetting("query")&&query.push(Rally.data.wsapi.Filter.fromQueryString(this.getSetting("query")));var context=this.getContext(),config={models:this._getModelNames(),autoLoad:!0,remoteSort:!0,fetch:["FormattedId","Name","Iteration","PercentDoneByStoryPlanEstimate","ScheduleState","Blocked","LeafStoryPlanEstimateTotal","Discussion"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:this.ReleaseRecord.get("Name")}],root:{expanded:!0},enableHierarchy:!0,expandingNodesRespectProjectScoping:!this.getSetting("ignoreProjectScoping")};return Ext.create("Rally.data.wsapi.TreeStoreBuilder").build(config).then({success:function(store){return store}})},_getFeatureGridBoardConfig:function(gridStore){var me=this,context=me.getContext();return{itemId:"gridBoard",xtype:"rallygridboard",title:"Features in Release",flex:3,stateId:"portfoliotracking-gridboard",context:context,plugins:this._getGridBoardPlugins(),modelNames:this._getModelNames(),gridConfig:this._getFeatureGridConfig(gridStore),addNewPluginConfig:{style:{"float":"left","margin-right":"5px"}},listeners:{scope:this},height:Math.max(this.getHeight(),150)}},_getStoryGridBoardConfig:function(gridStore){var me=this,context=me.getContext();return{itemId:"storyGridBoard",xtype:"rallygridboard",flex:2,stateId:"storytracking-gridboard",context:context,gridConfig:this._getStoryGridConfig(gridStore),addNewPluginConfig:{style:{"float":"left","margin-right":"5px"}},listeners:{scope:this},height:Math.max(this.getHeight(),150)}},_addGridBoard:function(gridStore){var context=this.getContext();this.remove("gridBoard"),this.gridboard=this.add(this._getFeatureGridBoardConfig(gridStore))},_getFeatureGridConfig:function(gridStore){var context=this.getContext(),stateString="portfolio-tracking-treegrid",stateId=context.getScopedStateId(stateString),gridConfig={xtype:"rallytreegrid",store:gridStore,enableRanking:this.getContext().getWorkspace().WorkspaceConfiguration.DragDropRankingEnabled,columnCfgs:null,defaultColumnCfgs:["Name","Iteration","PercentDoneByStoryPlanEstimate","ScheduleState","Blocked","LeafStoryPlanEstimateTotal","Discussion"],plugins:[],stateId:stateId,stateful:!0};return gridConfig},_getStoryGridConfig:function(gridStore){var context=this.getContext(),stateString="story-tracking-treegrid",stateId=context.getScopedStateId(stateString),gridConfig={xtype:"rallytreegrid",store:gridStore,enableRanking:this.getContext().getWorkspace().WorkspaceConfiguration.DragDropRankingEnabled,columnCfgs:null,defaultColumnCfgs:["Name","Iteration","PercentDoneByStoryPlanEstimate","ScheduleState"],plugins:[],stateId:stateId,stateful:!0};return gridConfig},_getGridBoardPlugins:function(){var plugins=[],context=this.getContext(),alwaysSelectedValues=["FormattedID","Name","Owner"];return context.getWorkspace().WorkspaceConfiguration.DragDropRankingEnabled&&alwaysSelectedValues.push("DragAndDropRank"),plugins.push({ptype:"rallygridboardfilterinfo",isGloballyScoped:Ext.isEmpty(this.getSetting("project")),stateId:"portfolio-tracking-owner-filter-"+this.getAppId()}),plugins}});
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.data.wsapi.TreeStoreBuilder",{extend:"Rally.data.DataStoreBuilder",requires:["Rally.data.wsapi.TreeStore","Rally.data.ModelFactory"],build:function(config){return config=_.clone(config||{}),config.storeType="Rally.data.wsapi.TreeStore",this.callParent([config])},loadModels:function(config){return this.callParent([config]).then({success:function(models){var pis=[];return _.each(models,function(model){var typePath=model.typePath.toLowerCase();model.isPortfolioItem()&&(Rally.data.wsapi.TreeStore.expandedCollectionNames[typePath]=["Children"],Rally.data.wsapi.TreeStore.childToParentTypeMap[typePath]=["Parent"],pis[model.ordinal]=model,model.isLowestLevelPortfolioItem()&&(Rally.data.wsapi.TreeStore.expandedCollectionNames[typePath]=["UserStories"],Rally.data.wsapi.TreeStore.parentChildTypeMap[typePath]=[{typePath:"hierarchicalrequirement",collectionName:"UserStories"}]))}),_.each(pis,function(model){if(model){var typePath=model.typePath.toLowerCase(),pm=pis[model.ordinal+1];pm&&(Rally.data.wsapi.TreeStore.parentChildTypeMap[pm.typePath.toLowerCase()]=[{typePath:typePath,collectionName:"Children"}])}}),this._setupTreeModel(this._getComponentModels(models),config)},scope:this})},_getComponentModels:function(models){return _.reduce(models,function(result,model){return _.isFunction(model.getArtifactComponentModels)?result.concat(model.getArtifactComponentModels()):result.concat(model)},[])},_setupTreeModel:function(models,config){var modelsToLoad=[];return config.parentTypes=this._getParentTypes(models,config),config.enableHierarchy&&(modelsToLoad=_.filter(this._getChildModelsToLoad(config),function(m){return void 0!==m})),modelsToLoad.length>0?this._loadChildModels(modelsToLoad,models,config):Deft.Promise.when(models)},_getChildModelsToLoad:function(config){return _.difference(Rally.data.wsapi.TreeStore.getChildModelTypePaths(config.parentTypes),config.parentTypes)},_loadChildModels:function(modelsToLoad,loadedModels,config){return Rally.data.ModelFactory.getModels({context:config.context,types:modelsToLoad,requester:config.requester||this}).then({success:function(newModels){return _.union(loadedModels,_.values(newModels))}})},_getParentTypes:function(models,config){var parentTypes=_.pluck(models,"typePath");return config.enableHierarchy&&(parentTypes=_.filter(parentTypes,Rally.data.wsapi.TreeStore.isParentType,Rally.data.wsapi.TreeStore)),parentTypes}})})();
                (function(){var Ext=window.Ext4||window.Ext,wsapiMaxPageSize=200;Ext.define("Rally.data.wsapi.TreeStore",{requires:["Deft.promise.Deferred","Rally.data.ModelFactory"],extend:"Ext.data.TreeStore",alias:"store.rallywsapitreestore",mixins:{messageable:"Rally.Messageable",findRecords:"Rally.data.WsapiFindRecords",recordUpdatable:"Rally.data.wsapi.RecordUpdatable",clientMetrics:"Rally.clientmetrics.ClientMetricsRecordable"},statics:{wsapiMaxPageSize:wsapiMaxPageSize,expandedCollectionNames:{hierarchicalrequirement:["Children","Defects","Tasks","TestCases"],defect:["Tasks","TestCases"],defectsuite:["Defects","Tasks"],testset:["Tasks","TestCases"]},childToParentTypeMap:{defect:["DefectSuite","Requirement"],hierarchicalrequirement:["Parent","PortfolioItem"],task:["WorkProduct"],testcase:["WorkProduct"]},parentChildTypeMap:{hierarchicalrequirement:[{typePath:"defect",collectionName:"Defects"},{typePath:"hierarchicalrequirement",collectionName:"Children"},{typePath:"task",collectionName:"Tasks"},{typePath:"testcase",collectionName:"TestCases"}],defect:[{typePath:"task",collectionName:"Tasks"},{typePath:"testcase",collectionName:"TestCases"}],defectsuite:[{typePath:"task",collectionName:"Tasks"},{typePath:"testcase",collectionName:"TestCases"}],testset:[{typePath:"task",collectionName:"Tasks"},{typePath:"testcase",collectionName:"TestCases",customTraversal:"TestSet"}]},isParentType:function(parentType){return _.has(this.parentChildTypeMap,parentType)},getChildModelTypePaths:function(parentTypes){return _.reduce(Ext.Array.from(parentTypes),function(childTypes,parentType){return _.union(childTypes,_.pluck(this.parentChildTypeMap[parentType],"typePath"))},[],this)}},currentPage:1,pageSize:25,context:void 0,wsapiVersion:void 0,nodeParam:void 0,model:void 0,parentTypes:[],fetch:void 0,enableHierarchy:!1,childLevelSorters:[],expandingNodesRespectProjectScoping:!0,_getModelFromTypePath:function(typePath){return this.modelTypePathMap||(this.modelTypePathMap=_.transform(this.models,function(r,m){r[m.typePath]=m},{},this)),this.modelTypePathMap[typePath]},constructor:function(config){this.callParent(arguments),0!==this.parentTypes.length&&this.model||Ext.Error.raise("You must configure the tree store with parentTypes and a model"),this.enableHierarchy&&(this.childLevelSorters=[{property:Rally.data.Ranker.getRankField(this.model),direction:"ASC"}]),this.fetch=this._buildFetch(this.fetch,this.model),this.addEvents("error","currentPageReset","parenttypeschange"),this._decorateModels(),this.on("beforeexpand",this.onBeforeExpandNode,this),this.on("load",function(){this.expandingNode=null},this)},onBeforeExpandNode:function(node,eOpts){this.expandingNode=node},isHierarchyEnabled:function(){return this.enableHierarchy===!0},setRootNode:function(root,preventLoad){this.tree.on("rootchange",this._decorateModels,this,{single:!0}),this.callParent([root,preventLoad||!this.autoLoad])},setParentTypes:function(parentTypes){this.parentTypes=_.map(Ext.Array.from(parentTypes),function(t){return t.toLowerCase()}),this.fireEvent("parenttypeschange",this.parentTypes)},remove:function(records){_.invoke(Ext.Array.from(records),"remove")},indexOf:function(record){return this.getRootNode().indexOf(record)},insert:function(index,records){_.each(Ext.Array.from(records),function(record){this.getRootNode().insertChild(index,record)},this)},getAllParentFieldTypes:function(){var parentFieldNames=[];this.enableHierarchy&&_.each(this.getChildTypes(),function(type){parentFieldNames=_.union(parentFieldNames,this.getParentFieldTypesByChildType(type.toLowerCase()))},this);var entp=this.getExpandingNodeTypePath().toLowerCase();return"hierarchicalrequirement"===entp&&(parentFieldNames=_.difference(parentFieldNames,["PortfolioItem"])),entp.indexOf("portfolioitem")>=0&&_.contains(this.getChildTypes(),"hierarchicalrequirement")&&(parentFieldNames=["PortfolioItem"]),parentFieldNames},getParentFieldTypesByChildType:function(childType){var model=this._getModelFromTypePath(childType);return _.filter(this.self.childToParentTypeMap[childType.toLowerCase()],function(field){return _.isFunction(this.model.getArtifactComponentModel)?this.model.getArtifactComponentModel(field)||model.hasField(field):model.hasField(field)},this)},getExpandingNodeTypePath:function(){var r=this.parentTypes[0];return this.expandingNode&&!this.isRootNode(this.expandingNode)&&(r=this.expandingNode.get("_type")),r.toLowerCase()},getChildTypes:function(){return this.enableHierarchy?this.expandingNode&&this.isRootNode(this.expandingNode)?this.parentTypes:this.self.getChildModelTypePaths(Ext.Array.from(this.getExpandingNodeTypePath())):[]},_getModelTypePaths:function(){return _.isFunction(this.model.getArtifactComponentModels)?_.pluck(this.model.getArtifactComponentModels(),"typePath"):[this.model.typePath]},isRootNode:function(node){return _.isEmpty(node)||isNaN(node.get("ObjectID"))},_getCollectionFetchNames:function(){var collectionFetchNames=[];return this.isRootNode(this.expandingNode)?_.each(Ext.Array.from(this.parentTypes),function(type){collectionFetchNames=_.union(collectionFetchNames,this.self.expandedCollectionNames[type.toLowerCase()])},this):_.each(Ext.Array.from(this.getChildTypes()),function(type){collectionFetchNames=_.union(collectionFetchNames,_.pluck(this.self.parentChildTypeMap[type],"collectionName"))},this),collectionFetchNames},_decorateModels:function(){_.isFunction(this.model.getArtifactComponentModels)&&_.each(this.model.getArtifactComponentModels(),Ext.data.NodeInterface.decorate,Ext.data.NodeInterface)},_errors:[],load:function(options){this.recordLoadBegin({description:"tree store load",component:this.requester}),this._hasErrors=!1,this.on("beforeload",function(store,operation){delete operation.id},this,{single:!0}),options=this._configureLoad(options);var deferred=Ext.create("Deft.Deferred"),originalCallback=options.callback,me=this;return options.callback=function(records,operation,success){me.dataLoaded=!0,Ext.callback(originalCallback,options.scope||me,arguments),options.callback=originalCallback,success?deferred.resolve(records,operation):deferred.reject(operation)},this.callParent([options]),deferred.promise},_configureLoad:function(options){if(options=options||{},Ext.isFunction(options)&&(options={callback:options}),this.isRootNode(options.node)?(this._configureProxy(!0),this._configureTopLevelLoad(options)):(this.enableHierarchy||Ext.Error.raise("You cannot load child nodes if hierarchy is not enabled."),this._configureProxy(!1),this._configureChildLoad(options)),options.useShallowFetch=!0,options.fetch=options.fetch||this._buildFetch(this.fetch,this.model),this.expandingNodesRespectProjectScoping||this.isRootNode(this.expandingNode)||_.contains(this.parentTypes,this.getExpandingNodeTypePath())&&!this.expandingNode?options.context=this.context:(options.context=this.context,options.context||(options.context=Rally.getApp().getContext().getDataContext()),options.context.project=null),options.requester=this,options.clearOnLoad===!1){var clearOnLoad=this.clearOnLoad;this.clearOnLoad=!1,this.on("load",function(){this.clearOnLoad=clearOnLoad},this,{single:!0})}return options},_configureChildLoad:function(options){options.filters=this._getChildNodeFilters(options.node),options.sorters=this.childLevelSorters||[{property:Rally.data.Ranker.getRankField(this.model),direction:"ASC"}]},_configureTopLevelLoad:function(options){options.params=options.params||{},options.params.pagesize=this.pageSize,options.params.start=this.pageSize*(this.currentPage-1)},_getChildNodeFilters:function(node){var childItemTypes=this.self.parentChildTypeMap[node.get("_type")],customTraversal=[];return childItemTypes&&_.each(childItemTypes,function(childType){childType.hasOwnProperty("customTraversal")&&customTraversal.push(childType.customTraversal)}),[Rally.data.wsapi.Filter.or(_.map(_.union(this.getAllParentFieldTypes(),customTraversal),function(name){return{property:name,operator:"=",value:node.get("_ref")}}))]},filter:function(filters){this.filters.addAll(filters),this._resetCurrentPage(),this.load()},clearFilter:function(suppressEvent){this._resetCurrentPage(),this.filters.clear(),suppressEvent||this.load()},getAt:function(id){return this.getNodeById(id)},getTotalCount:function(){return this.totalCount},nextPage:function(){this._setCurrentPage(this.currentPage+1),this.load()},previousPage:function(){this._setCurrentPage(this.currentPage-1),this.load()},loadPage:function(pageNum){this._setCurrentPage(pageNum),this.load()},_setCurrentPage:function(pageNum){var maxPage=Math.ceil(this.getTotalCount()/this.pageSize);this.currentPage=Math.min(Math.max(pageNum,1),maxPage)},_resetCurrentPage:function(){this.dataLoaded===!0&&(this.fireEvent("currentpagereset"),this.currentPage=1)},_hasErrors:!1,hasErrors:function(){return this._hasErrors},onProxyLoad:function(operation){if(operation.error&&operation.error.errors&&operation.error.errors.length>0)this._hasErrors=!0,this.fireEvent("error",operation.error.errors);else{var resultSet=operation.getResultSet();if(resultSet&&(_.each(resultSet.records,this._instrumentRecord,this),this.isRootNode(operation.node)&&(this.totalCount=resultSet.total,this.totalCount>0&&0===resultSet.count&&this._attemptingToResetCurrentPage!==!0)))return this._attemptingToResetCurrentPage=!0,this._resetCurrentPage(),this.load(),void 0}if(this._attemptingToResetCurrentPage=!1,!(this.clearOnLoad||operation.node&&operation.node!==this.getRootNode())){var recordsById=_.indexBy(operation.getRecords(),function(record){return record.getId()});_.each(Ext.clone(operation.node.childNodes),function(childNode){var record=recordsById[childNode.getId()];if(record){if(record.get("VersionId")!==childNode.get("VersionId")){var newData=_(record.raw).keys().reduce(function(accum,key){return accum[key]=record.get(key),accum},{});childNode.set(newData),childNode.commit()}}else childNode.remove(!1)})}this.recordLoadEnd(),this.recordLoadBegin({description:"tree store after load callParent"}),this.callParent(arguments),_.each(operation.node.childNodes,function(node){node.childNodes=[],node.data.loaded=!1}),this.recordLoadEnd(),this.ownerTree&&this.ownerTree.fireEvent("afterproxyload")},each:function(fn,scope){this._treeWalkingEach(fn,this.tree.root,scope,!0)},_treeWalkingEach:function(fn,node,scope,ignoreNode){return _.each(node.childNodes,function(childNode){return this._treeWalkingEach(fn,childNode,scope)===!1?!1:void 0},this),ignoreNode!==!0?fn.call(scope||node,node):!0},getNodeById:function(id){return this.callParent(arguments)||this.findExactRecord(id)},findExactRecord:function(record){var recordId=Rally.util.Ref.getOidFromRef(record)||record;return this.getRootNode().findChild(this.model.prototype.idProperty,recordId,!0)},reloadRecord:function(record,options){options=options||{};var deferred=Ext.create("Deft.promise.Deferred"),operationConfig=Ext.merge({action:"read",limit:1,requester:this,context:this.context,filters:[{property:"ObjectID",value:record.getId()}],params:{}},options),modelToLoadFrom,recordTypePath;return _.isFunction(this.model.getArtifactComponentModels)?(recordTypePath=record.self.typePath,this.model.getArtifactComponentModel(recordTypePath.toLowerCase())?(modelToLoadFrom=this.model,operationConfig.params.types=recordTypePath):modelToLoadFrom=record.self):modelToLoadFrom=record.self,operationConfig.useShallowFetch=!0,operationConfig.fetch=this.fetch?_.union(this.fetch,_.pluck(modelToLoadFrom.getAssociationFields(),"name")):this._buildFetch(this.fetch,modelToLoadFrom),record.parentNode===this.getRootNode()&&(operationConfig.filters=operationConfig.filters.concat(this.filters.getRange())),modelToLoadFrom.getProxy().read(Ext.create("Ext.data.Operation",operationConfig),function(op){if(op.wasSuccessful()&&op.getRecords()&&op.getRecords().length){var record=op.getRecords()[0];this._instrumentRecord(record),Ext.callback(options.success,options.scope,[record]),deferred.resolve(record)}else Ext.callback(options.failure,options.scope,[op]),deferred.reject(op)},this),deferred.promise},doesRecordMatchStoreFilters:function(record){var deferred=Ext.create("Deft.promise.Deferred"),operation=new Ext.data.Operation({action:"read",fetch:!1,params:{query:""+Rally.data.wsapi.Filter.and(this.filters.getRange().concat([new Rally.data.wsapi.Filter({property:"ObjectID",operator:"=",value:Rally.util.Ref.getOidFromRef(record)})]))},limit:1,requester:this}),callback=function(operation){deferred.resolve(!_.isEmpty(operation.getRecords()))};return this.proxy.setExtraParam("types",this._getTypesForLevel(!0)),this.model.getProxy().read(operation,callback,this),deferred.promise},doesRecordMatchChildTypes:function(record){return _(this.getChildTypes()).invoke("toLowerCase").contains(record.self.typePath.toLowerCase())},_configureProxy:function(forTopLevel){this.proxy=this.model.getProxy();var types=_.isFunction(this.model.getArtifactComponentModels)?this._getTypesForLevel(forTopLevel):this.model.elementName;this.proxy.setExtraParam("types",types)},_getTypesForLevel:function(forTopLevel){var types;return types=forTopLevel?this.parentTypes.join(","):this.getChildTypes().join(",")},_instrumentRecord:function(record){var leafCount=this._getLeafCount(record),isLeaf=1>leafCount||!this.enableHierarchy;record.set("leaf",isLeaf),record.set("leafCount",leafCount)},_getLeafCount:function(record){var typePath=record.get("_type").toLowerCase(),expandedCollectionNames=Ext.Array.from(this.self.expandedCollectionNames[typePath]);return _.reduce(expandedCollectionNames,function(accumulator,collectionName){var collectionVal=record.get(collectionName);return collectionVal&&collectionVal.Count&&(accumulator+=collectionVal.Count),accumulator},0)},_buildFetch:function(fetch,model){return fetch===!0?fetch:(fetch||(fetch=_.pluck(model.getNonCollectionFields(),"name")),fetch=_.union(_.isArray(fetch)?fetch:fetch.split(","),["ObjectID","VersionId"]),this.enableHierarchy&&fetch!==!0&&(fetch=_.union(fetch,this._getCollectionFetchNames(),this.getAllParentFieldTypes())),_.filter(fetch,function(f){return void 0!==f}))},setFetch:function(fetch){this.fetch=this._buildFetch(fetch)}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.ui.renderer.template.FormattedIDTemplate2",{override:"Rally.ui.renderer.template.FormattedIDTemplate",createIcon:function(data){if(this.showIcon===!1)return"";var className="";switch(data._type.toLowerCase().split("/")[0]){case"userstory":case"hierarchicalrequirement":className="story";break;case"defect":className="defect";break;case"task":className="task";break;case"testcase":className="test-case";break;case"defectsuite":className="defect-suite";break;case"testset":className="test-set";break;case"portfolioitem":className="portfolioitem"}return className?'<span class="artifact-icon icon-'+className+'"></span>':className}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.ui.grid.plugin.TreeViewDragDrop",{extend:"Ext.tree.plugin.TreeViewDragDrop",alias:"plugin.rallytreeviewdragdrop",requires:["Rally.data.Ranker","Rally.ui.grid.dragdrop.TreeDragZone","Rally.ui.grid.dragdrop.TreeDropZone"],config:{rankEnabledCls:"rank-enabled"},clientMetrics:[{beginMethod:"_onInitDrag",endEvent:"drop",description:"treegrid drag and drop"}],init:function(view){this.view=view,this.view.mon(this.view,"storeload",this._onStoreLoad,this),this.view.mon(this.view,"drop",this._onDrop,this),this.callParent(arguments)},destroy:function(){this.view&&this.view.getEl()&&Ext.dd.ScrollManager.unregister(this.view.getEl()),this.callParent(arguments)},enable:function(){this._showRankColumn(),this.callParent(arguments)},disable:function(){this._hideRankColumn(),this.callParent(arguments)},onViewRender:function(){this._setupViewScroll(),this._enableDragDrop()},_setupViewScroll:function(){var el=this.view.getEl();el.ddScrollConfig={vthresh:30,hthresh:-1,frequency:350,increment:50},Ext.dd.ScrollManager.register(el)},_enableDragDrop:function(){var me=this,scrollEl;me.enableDrag&&(me.containerScroll&&(scrollEl=this.view.getEl()),me.dragZone=new Ext.tree.ViewDragZone({view:this.view,ddGroup:me.dragGroup||me.ddGroup,dragText:me.dragText,displayField:me.displayField,repairHighlightColor:me.nodeHighlightColor,repairHighlight:me.nodeHighlightOnRepair,scrollEl:scrollEl})),me.enableDrop&&(me.dropZone=new Ext.tree.ViewDropZone({view:this.view,ddGroup:me.dropGroup||me.ddGroup,allowContainerDrops:me.allowContainerDrops,appendOnly:me.appendOnly,allowParentInserts:me.allowParentInserts,expandDelay:me.expandDelay,dropHighlightColor:me.nodeHighlightColor,dropHighlight:me.nodeHighlightOnDrop,sortOnDrop:me.sortOnDrop,containerScroll:me.containerScroll}))},_getRankColumn:function(){var rankCol=this.view.headerCt.items.getAt(0);return rankCol instanceof Rally.ui.grid.TreeRankDragHandleColumn?rankCol:null},_showRankColumn:function(){this.view.hasCls(this.rankEnabledCls)||this.view.addCls(this.rankEnabledCls)},_hideRankColumn:function(){this.view.removeCls(this.rankEnabledCls)},_onInitDrag:function(){this.dropZone&&this.dropZone.clearRowNodePositions()},_onStoreLoad:function(){Rally.data.Ranker.isDnDRankable(this.view.getTreeStore())?this.enable():this.disable()},_onDrop:function(rowEl,dropData,overModel,dropPosition,opts){var droppedRecord=dropData.records[0];droppedRecord._dragAndDropped=!0,this.view.ownerCt.setLoading(!0),Rally.data.Ranker.rankRelative({recordToRank:droppedRecord,relativeRecord:overModel,position:dropPosition,saveOptions:{callback:this._onRank,scope:this}})},_onRank:function(record,operation){delete record._dragAndDropped,this.view.ownerCt.setLoading(!1)}})})();

            Rally.launchApp('', {
                name:"StoryMapping",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
