<!DOCTYPE html>
<html>
<head>
    <title>Functional CFD Charts</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.0.1/q.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("IntelRallyApp",{alias:"widget.intelrallyapp",extend:"Rally.app.App",_loadModels:function(){var me=this,promises=[],models={Project:"Project",UserStory:"HierarchicalRequirement",Feature:"PortfolioItem/Feature",Milestone:"PortfolioItem/Milestone"};return _.each(models,function(modelType,modelName){var deferred=Q.defer();Rally.data.WsapiModelFactory.getModel({type:modelType,success:function(loadedModel){me[modelName]=loadedModel,deferred.resolve()}}),promises.push(deferred.promise)}),Q.all(promises)},_loadProject:function(oid){var me=this,deferred=Q.defer();return oid?me.Project?(me.Project.load(oid,{fetch:["ObjectID","Releases","Children","Parent","Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:deferred.resolve}),deferred.promise):me._loadModels().then(function(){return me._loadProject(oid)}):Q.resolve()},_loadFeature:function(oid,projectRef){var me=this,deferred=Q.defer();return oid?me.Feature?(me.Feature.load(oid,{fetch:["Name","ObjectID","FormattedID","c_TeamCommits","c_Risks","Project","PlannedEndDate","Parent"],context:{workspace:me.getContext().getWorkspace()._ref,project:projectRef},callback:deferred.resolve}),deferred.promise):me._loadModels().then(function(){return me._loadFeature(oid,projectRef)}):Q.resolve()},_loadUserStory:function(oid,projectRef){var me=this,deferred=Q.defer();return oid?me.UserStory?(me.UserStory.load(oid,{fetch:["Name","ObjectID","Release","Project","Feature","FormattedID","Predecessors","Successors","c_Dependencies","Iteration","PlanEstimate"],context:{workspace:me.getContext().getWorkspace()._ref,project:projectRef},callback:deferred.resolve}),deferred.promise):me._loadModels().then(function(){return me._loadUserStory(oid,projectRef)}):Q.resolve()},_loadMilestone:function(oid,projectRef){var me=this,deferred=Q.defer();return oid?me.Milestone?(me.Milestone.load(oid,{fetch:["ObjectID","Parent","Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:projectRef},callback:deferred.resolve}),deferred.promise):me._loadModels().then(function(){return me._loadMilestone(oid)}):Q.resolve()},_loadRootProject:function(projectRecord){if(!projectRecord)return Q.reject("Invalid arguments: LRP");var me=this,n=projectRecord.data.Name;return"All Scrums"===n||"All Scrums Sandbox"===n?Q(projectRecord):projectRecord.data.Parent?me._loadProject(projectRecord.data.Parent.ObjectID).then(function(parentRecord){return me._loadRootProject(parentRecord)}):Q.reject('You do not have viewer access to "All Scrums"!')},_loadTopProject:function(projectRecord){if(!projectRecord)return Q.reject("Invalid arguments: LTP");var me=this,n=projectRecord.data.Name;return projectRecord.data.Parent?me._loadProject(projectRecord.data.Parent.ObjectID).then(function(parentRecord){return me._loadTopProject(parentRecord)}):Q(projectRecord)},_projectInWhichTrain:function(projectRecord){if(projectRecord){var me=this,split=projectRecord.data.Name.split(" ART");if(split.length>1)return Q(projectRecord);var parent=projectRecord.data.Parent;return parent?me._loadProject(parent.ObjectID).then(function(parentRecord){return me._projectInWhichTrain(parentRecord)}):Q.reject("Project not in a train")}return Q.reject("Invalid arguments: PIWT")},_loadAllTrains:function(rootProjectRecord){if(!rootProjectRecord)return Q.reject("Invalid arguments: LAT");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Project",remoteSort:!1,limit:1/0,fetch:["Name","ObjectID"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",operator:"contains",value:" ART"},{property:"Name",operator:"All Scrums Sandbox"===rootProjectRecord.data.Name?"contains":"!contains",value:"Test"}]});return me._reloadStore(store).then(function(store){return console.log("AllTrainRecords loaded",store.data.items),Q(store)})},_loadRandomUserStory:function(projectRef){if(!projectRef)return Q.reject("Invalid arguments: LRUS");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:5,pageSize:5,fetch:["Name","CreationDate","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},sorters:[{property:"CreationDate",direction:"DESC"}],filters:[{property:"Project",value:projectRef}]});return me._reloadStore(store).then(function(store){var records=store.data.items;return records.length?Q(records[Math.floor(Math.random()*records.length)]):Q(void 0)})},_getUserStoryInReleaseTimeFrameFilter:function(releaseRecord){var me=this,twoWeeks=12096e5,releaseStartPadding=new Date(1*new Date(releaseRecord.data.ReleaseStartDate)+twoWeeks).toISOString(),releaseEndPadding=new Date(1*new Date(releaseRecord.data.ReleaseDate)-twoWeeks).toISOString();return Ext.create("Rally.data.wsapi.Filter",{property:"Release.ReleaseStartDate",operator:"<",value:releaseStartPadding}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Release.ReleaseDate",operator:">",value:releaseEndPadding})).or(Ext.create("Rally.data.wsapi.Filter",{property:"Feature.Release.ReleaseStartDate",operator:"<",value:releaseStartPadding}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Feature.Release.ReleaseDate",operator:">",value:releaseEndPadding})))},_loadRandomUserStoryFromRelease:function(projectRef,releaseName){if(!projectRef||!releaseName)return Q.reject("Invalid arguments: LRUSFR");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:5,pageSize:5,fetch:["Name","CreationDate","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},sorters:[{property:"CreationDate",direction:"DESC"}],filters:[Ext.create("Rally.data.wsapi.Filter",{property:"Project",value:projectRef}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:releaseName}).or(Ext.create("Rally.data.wsapi.Filter",{property:"Feature.Release.Name",value:releaseName})))]});return me._reloadStore(store).then(function(store){var records=store.data.items;return records.length?Q(records[Math.floor(Math.random()*records.length)]):Q(void 0)})},_loadRandomUserStoryFromReleaseTimeframe:function(projectRef,releaseRecord){if(!projectRef||!releaseRecord)return Q.reject("Invalid arguments: LRUSFR");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:5,pageSize:5,fetch:["Name","CreationDate","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},sorters:[{property:"CreationDate",direction:"DESC"}],filters:[Ext.create("Rally.data.wsapi.Filter",{property:"Project",value:projectRef}).and(me._getUserStoryInReleaseTimeFrameFilter(releaseRecord))]});return me._reloadStore(store).then(function(store){var records=store.data.items;return records.length?Q(records[Math.floor(Math.random()*records.length)]):Q(void 0)})},_loadUserStoryByFID:function(formattedID,projectRef){if(!formattedID||!projectRef)return Q.reject("Invalid arguments: LUSBFID");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1,pageSize:1,fetch:["Name","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},filters:[{property:"FormattedID",value:formattedID},{property:"Project",value:projectRef}]});return me._reloadStore(store).then(function(store){return Q(store.data.items.pop())})},_loadProjectByName:function(name){if(!name)return Q.reject("Invalid arguments: LPBN");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Project",limit:1,pageSize:1,fetch:["Name","ObjectID"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:name}]});return me._reloadStore(store).then(function(store){return Q(store.data.items.pop())})},_getFeatureFilter:function(trainRecord,releaseRecord){if(!trainRecord||!releaseRecord)throw"invalid arguments: GFF";var me=this,trainName=trainRecord.data.Name.split(" ART")[0],relSplit=releaseRecord.data.Name.split(" "),coreFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:releaseRecord.data.Name});return trainName=2==relSplit.length?relSplit[1]:trainName,"Test ART (P&E)"==trainRecord.data.Name?Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:"Test ART (P&E)"}).and(coreFilter):Ext.create("Rally.data.wsapi.Filter",{property:"Project.Parent.Name",value:trainName+" POWG Portfolios"}).or(Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:trainName+" POWG Portfolios"})).and(coreFilter)},_getProductFilter:function(trainRecord){if(!trainRecord)throw"invalid arguments: GPF";var me=this,trainName=trainRecord.data.Name.split(" ART")[0];return"Test"===trainName?Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:"Test ART (P&E)"}):Ext.create("Rally.data.wsapi.Filter",{property:"Project.Parent.Name",value:trainName+" POWG Portfolios"}).or(Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:trainName+" POWG Portfolios"}))},_loadProducts:function(trainRecord){if(!trainRecord)return Q.reject("Invalid arguments: LPROD");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Product",limit:1/0,remoteSort:!1,fetch:["Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[me._getProductFilter(trainRecord)]});return me._reloadStore(store).then(function(store){return console.log("Products loaded",store.data.items),Q(store)})},_addValidProjectsToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;curProj.data.TeamMembers.Count>0&&(hash[curProj.data.ObjectID]=curProj);for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me._addValidProjectsToList(projTree[childProjRef],hash)},_loadValidProjects:function(rootProjectRecord){if(!rootProjectRecord)return Q.reject("Invalid arguments: LVP");var me=this,validProjects={},projTree={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","Parent","ObjectID","TeamMembers"],limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){for(var projects=store.data.items,i=0,len=projects.length;len>i;++i){var project=projects[i],thisRef=project.data.ObjectID,parentRef=project.data.Parent?project.data.Parent.ObjectID:void 0;projTree[thisRef]||(projTree[thisRef]={}),projTree[thisRef].ProjectRecord=project,parentRef&&(projTree[parentRef]||(projTree[parentRef]={}),projTree[parentRef][thisRef]=projTree[thisRef])}return me._addValidProjectsToList(projTree[rootProjectRecord.data.ObjectID],validProjects),console.log("valid projects",validProjects),Q(validProjects)})},_allChildProjectToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;hash[curProj.data.ObjectID]=curProj;for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me._allChildProjectToList(projTree[childProjRef],hash)},_loadAllChildrenProjects:function(rootProjectRecord){if(!rootProjectRecord)return Q.reject("Invalid arguments: LACP");var me=this,childrenProjects={},projTree={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","Parent","ObjectID"],limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){for(var projects=store.data.items,i=0,len=projects.length;len>i;++i){var project=projects[i],thisRef=project.data.ObjectID,parentRef=project.data.Parent?project.data.Parent.ObjectID:void 0;projTree[thisRef]||(projTree[thisRef]={}),projTree[thisRef].ProjectRecord=project,parentRef&&(projTree[parentRef]||(projTree[parentRef]={}),projTree[parentRef][thisRef]=projTree[thisRef])}return me._allChildProjectToList(projTree[rootProjectRecord.data.ObjectID],childrenProjects),console.log("childrenProjects",childrenProjects),Q(childrenProjects)})},_allLeafProjectsToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;0===curProj.data.Children.Count&&(hash[curProj.data.ObjectID]=curProj);for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me._allLeafProjectsToList(projTree[childProjRef],hash)},_loadAllLeafProjects:function(rootProjectRecord){if(!rootProjectRecord)return Q.reject("Invalid arguments: LALP");var me=this,childrenProjects={},projTree={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","Parent","ObjectID","Children"],limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){for(var projects=store.data.items,i=0,len=projects.length;len>i;++i){var project=projects[i],thisRef=project.data.ObjectID,parentRef=project.data.Parent?project.data.Parent.ObjectID:void 0;projTree[thisRef]||(projTree[thisRef]={}),projTree[thisRef].ProjectRecord=project,parentRef&&(projTree[parentRef]||(projTree[parentRef]={}),projTree[parentRef][thisRef]=projTree[thisRef])}return me._allLeafProjectsToList(projTree[rootProjectRecord.data.ObjectID],childrenProjects),console.log("childrenProjects",childrenProjects),Q(childrenProjects)})},_reloadStore:function(store){var deferred=Q.defer();return store.load({callback:function(records,operation,success){success?deferred.resolve(store):deferred.reject(operation.getError()||"Could not load data")}}),deferred.promise}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("WorkweekDropdown",{extend:"Ext.data.Model",fields:[{name:"Workweek",type:"string"},{name:"DateVal",type:"number"}]})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("WindowListener",{__initWindowEventListener:function(eventName){var me=this;me._windowListeners||(me._windowListeners={}),me._windowListeners[eventName]=[],window.parent["on"+eventName]=function(event){for(var listeners=me._windowListeners[eventName],i=0,len=listeners.length;len>i;++i)listeners[i](event)}},_addWindowEventListener:function(eventName,fn){var me=this;me._windowListeners&&me._windowListeners[eventName]||me.__initWindowEventListener(eventName),me._windowListeners[eventName].push(fn)},_fireParentWindowEvent:function(eventName){var me=this;if(me._windowListeners&&me._windowListeners[eventName])for(var listeners=me._windowListeners[eventName],i=0,len=listeners.length;len>i;++i)listeners[i]()}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("IframeResize",{requires:["WindowListener"],_applyIframeResizeToContents:function(){for(var w=window,p=w.parent,pd=w.parent.document,l=w.location,iframe=window.frameElement?Ext.get(window.frameElement):me.el,ip1=iframe.parentNode,ip2=iframe.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode,height=0,next=this.down();next;)height+=next.getHeight()+1*next.getEl().getMargin("tb")+1*next.getEl().getPadding("tb"),next=next.next();height+=150,ip1.style.height=height+"px",ip2.style.height=height+"px",iframe.style.height=height+"px"},_initIframeResizeToContents:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me._applyIframeResizeToContents()})},_applyIframeResizeToWindow:function(){var iframe=window.frameElement?Ext.get(window.frameElement):me.el,i=iframe.dom,portlet=iframe.up(".x-portlet"),portalColumn=portlet.up(".x-portal-column"),dashboard=portlet.up("#mydash_portlet");height=window.parent.innerHeight-70,height-=200,iframe.style.height=height+"px",ip1.style.height=height+"px",height+=30,ip2.style.height=height+"px"},_initIframeResizeToWindow:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me._applyIframeResizeToWindow()}),me._applyIframeResizeToWindow()},_fixRallyDashboard:function(){for(var me=this,bottomEl=window.frameElement?Ext.get(window.frameElement):me.el,portlet=bottomEl.up(".x-portlet"),portalColumn=portlet.up(".x-portal-column"),dashboard=portlet.up("#mydash_portlet"),domNodeW=bottomEl.dom,domNodeH=bottomEl.dom,innerHeight=window.parent.innerHeight,innerWidth=window.parent.innerWidth;;){if(domNodeW.style.width=innerWidth-4+"px",domNodeW.style.padding="0",domNodeW.style.margin="0","mydash_portlet"===domNodeW.id)break;domNodeW=domNodeW.parentNode}for(;;){if(domNodeH.style.height=innerHeight-135+"px",domNodeH.classList.contains("x-portlet"))break;domNodeH=domNodeH.parentNode}dashboard.dom.style.height=innerHeight-65+"px",portlet.dom.style.height=innerHeight-105+"px",dashboard.dom.style.padding="0 2px 0 2px"},_initFixRallyDashboard:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me._fixRallyDashboard()}),me._fixRallyDashboard()},_disableResizeHandle:function(){var me=this,handle;handle=window.frameElement?Ext.get(window.frameElement).up(".x-portlet").down(".x-resizable-handle"):me.el.up(".x-portlet").down(".x-resizable-handle"),handle&&(handle.hide(),handle.dom.onshow=function(){handle&&handle.hide()})},_initDisableResizeHandle:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me._disableResizeHandle()}),me._disableResizeHandle()}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("PrettyAlert",{__getMessageBoxY:function(){var me=this,bottomEl=window.frameElement?Ext.get(window.frameElement):me.el,ph=window.parent.getWindowHeight(),ps=window.parent.getScrollY(),ofy=ps+bottomEl.dom.getBoundingClientRect().top,iyOffset=Math.floor(ph/2-ofy+ps-50);return 0>iyOffset?0:iyOffset},_alert:function(title,str){1>arguments.length||(1===arguments.length&&(str=title,title=""),Ext.MessageBox.alert(title,str).setY(this.__getMessageBoxY()),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20))},_confirm:function(title,str,fn){2>arguments.length||(2===arguments.length&&(fn=str,str=title,title=""),"function"!=typeof fn&&(fn=function(){}),Ext.MessageBox.confirm(title,str,fn).setY(this.__getMessageBoxY()),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20))}})})();
                (function(){var Ext=window.Ext4||window.Ext,intel_ww={},SECOND=1e3,MINUTE=60*SECOND,HOUR=60*MINUTE,DAY=24*HOUR,WEEK=7*DAY;Ext.define("IntelWorkweek",{_getWorkweek:function(_date){var date=new Date(_date),yearStart=new Date(date.getFullYear(),0,1),dayIndex=yearStart.getDay(),ww01Start=new Date(yearStart-dayIndex*DAY),utcDateMillis=Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()),ww01Millis=Date.UTC(ww01Start.getFullYear(),ww01Start.getMonth(),ww01Start.getDate()),timeDiff=utcDateMillis-ww01Millis,ww=Math.floor(timeDiff/WEEK)+1,leap=0===date.getFullYear()%4,weekCount=leap&&dayIndex>=5||!leap&&6===dayIndex?53:52;return ww>weekCount?1:ww},_getWeekCount:function(_date){var date=new Date(_date),leap=0===date.getFullYear()%4,day=new Date(date.getFullYear(),0,1).getDay();return leap&&day>=5||!leap&&6===day?53:52},_roundDateDownToWeekStart:function(_date){var date=new Date(_date),day=date.getDay(),monthDate=date.getDate(),month=date.getMonth(),year=date.getFullYear(),sundayMidday=new Date(1*new Date(year,month,monthDate)-(day*DAY-.5*DAY));return new Date(sundayMidday.getFullYear(),sundayMidday.getMonth(),sundayMidday.getDate())},_getWorkweekDates:function(startDate,endDate){for(var startWeekDate=this._roundDateDownToWeekStart(startDate),endWeekDate=this._roundDateDownToWeekStart(endDate),startMillis=Date.UTC(startWeekDate.getFullYear(),startWeekDate.getMonth(),startWeekDate.getDate()),endMillis=Date.UTC(endWeekDate.getFullYear(),endWeekDate.getMonth(),endWeekDate.getDate()),totalWeeks=Math.floor((endMillis-startMillis)/WEEK)+1,weeks=Array(totalWeeks),i=0;totalWeeks>i;++i){var sundayMidday=new Date(1*startWeekDate+(WEEK*i+12*HOUR));weeks[i]=new Date(sundayMidday.getFullYear(),sundayMidday.getMonth(),sundayMidday.getDate())}return weeks},_workweekToDate:function(ww,year){var yearStart=new Date(year,0,1),dayIndex=yearStart.getDay(),ww01StartMidday=new Date(yearStart-(dayIndex*DAY-.5*DAY)),sundayMidday=new Date(1*ww01StartMidday+(ww-1)*WEEK);return new Date(sundayMidday.getFullYear(),sundayMidday.getMonth(),sundayMidday.getDate())},_getWorkWeeksForDropdown:function(releaseStartDate,releaseEndDate){for(var workweeks=this._getWorkweekDates(releaseStartDate,releaseEndDate),data=Array(workweeks.length),i=0,len=workweeks.length;len>i;++i)data[i]={Workweek:"ww"+this._getWorkweek(workweeks[i]),DateVal:1*workweeks[i]};return data}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("ReleaseQuery",{_loadAllReleases:function(projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),deferred.resolve(releaseStore)},single:!0}}}),deferred.promise},_loadReleasesInTheFuture:function(projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID},{property:"ReleaseDate",operator:">=",value:(new Date).toISOString()}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),deferred.resolve(releaseStore)},single:!0}}}),deferred.promise},_loadReleasesWithName:function(releaseName,nameContains){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project","TeamMembers"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:releaseName},{property:"Project.Name",operator:"contains",value:nameContains},{property:"Project.Children.Name",operator:"=",value:""},{property:"Project.Name",operator:"!contains",value:" ART"}],listeners:{load:{fn:function(store,records){console.log("releasesWithName loaded:",records),deferred.resolve(store)},single:!0}}}),deferred.promise},_loadReleaseByNameForProject:function(releaseName,projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:releaseName},{property:"Project",value:projectRecord.data._ref}],listeners:{load:{fn:function(store,records){deferred.resolve(records.pop())},single:!0}}}),deferred.promise},_loadReleasesByNameContainsForProject:function(releaseName,projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",operator:"contains",value:releaseName},{property:"Project",value:projectRecord.data._ref}],listeners:{load:{fn:function(store,records){deferred.resolve(records)},single:!0}}}),deferred.promise},_loadReleasesAfterGivenDate:function(projectRecord,givenDate){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID},{property:"ReleaseDate",operator:">=",value:new Date(givenDate).toISOString()}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),deferred.resolve(releaseStore)},single:!0}}}),deferred.promise},_getScopedRelease:function(releaseRecords,projectOID,appPrefs){var me=this,d=new Date,rs=releaseRecords,prefOID=appPrefs&&appPrefs.projs&&appPrefs.projs[projectOID]&&appPrefs.projs[projectOID].Release;return prefOID&&_.find(rs,function(r){return r.data.ObjectID==prefOID})||_.find(rs,function(r){return new Date(r.data.ReleaseDate)>=d&&d>=new Date(r.data.ReleaseStartDate)})||_.reduce(rs,function(best,r){if(null===best)return r;var d1=new Date(best.data.ReleaseStartDate),d2=new Date(r.data.ReleaseStartDate),now=new Date;return Math.abs(d1-now)<Math.abs(d2-now)?best:r},null)}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Intel.form.field.FixedComboBox",{extend:"Ext.form.field.ComboBox",alias:["widget.intelfixedcombo","widget.intelfixedcombobox"],constructor:function(options){options=options||{},options=Ext.merge({editable:!1,allowBlank:!1,queryMode:"local",listeners:{focus:function(combo){combo.setValue(""),combo.expand()}}},options),this.callParent([options])}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Intel.form.field.ReleasePicker",{extend:"Intel.form.field.FixedComboBox",alias:["widget.intelreleasepicker"],constructor:function(options){options.releases&&options.currentRelease&&(options.displayField="Name",options.value=options.currentRelease.data.Name,options.store=Ext.create("Ext.data.Store",{fields:["Name"],sorters:[function(o1,o2){return o1.data.Name>o2.data.Name?-1:1}],data:_.map(options.releases,function(r){return{Name:r.data.Name}})}),options.fieldLabel=options.fieldLabel||"Release:",options.editable=options.editable||!1,options.width=options.width||240,options.labelWidth=options.labelWidth||50,this.callParent([options]))}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("FastCfdCalculator",{extend:"Rally.data.lookback.SnapshotStore",scheduleStates:["Undefined","Defined","In-Progress","Completed","Accepted"],constructor:function(){this.callParent(arguments)},_getDates:function(){for(var dates=[],curDay=this.startDate,day=864e5;this.endDate>=curDay;){var n=curDay.getDay();0!==n&&6!==n&&dates.push(curDay),curDay=new Date(1*curDay+day)}return dates},_dateToStringDisplay:function(date){return Ext.Date.format(date,"m/d/Y")},_getIndexHelper:function(d,ds){for(var curVal=ds.length/2,curInt=curVal>>0,div=curVal/2,lastInt=-1;curInt!==lastInt;){if(ds[curInt]===d)return curInt;ds[curInt]>d?curVal-=div:curVal+=div,div/=2,lastInt=curInt,curInt=curVal>>0}return curInt},_getIndexOnOrBefore:function(d,ds){if(0===ds.length)return-1;var pos=this._getIndexHelper(d,ds);return 0===pos?d>=ds[pos]?pos:-1:d>=ds[pos]?pos:pos-1},_getIndexOnOrAfter:function(d,ds){if(0===ds.length)return-1;var pos=this._getIndexHelper(d,ds);return pos===ds.length-1?ds[pos]>=d?pos:-1:ds[pos]>=d?pos:pos+1},runCalculation:function(items){if(!this.scheduleStates||!this.startDate||!this.endDate)return console.log("invalid constructor config",this),void 0;for(var dates=this._getDates(),day=864e5,dateMapTemplate=_.map(Array(dates.length),function(){return 0}),totals=_.reduce(this.scheduleStates,function(map,ss){return map[ss]=dateMapTemplate.slice(),map},{}),itemIndex=0,len=items.length;len>itemIndex;++itemIndex){var item=items[itemIndex].raw,iStart=new Date(item._ValidFrom),iEnd=new Date(item._ValidTo),state=item.ScheduleState,pe=item.PlanEstimate;if(pe&&iStart/day>>0!==iEnd/day>>0){var startIndex=this._getIndexOnOrAfter(iStart,dates),endIndex=this._getIndexOnOrBefore(iEnd,dates);if(-1!==startIndex&&-1!==endIndex)for(var i=startIndex;endIndex>=i;++i)totals[state][i]+=pe}}return{categories:_.map(dates,function(d){return this._dateToStringDisplay(d)},this),series:_.reduce(this.scheduleStates,function(ar,ss){return ar.concat([{name:ss,type:"area",dashStyle:"Solid",data:totals[ss]}])},[])}}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("ChartUpdater",{requires:["IntelWorkweek"],_updateChartData:function(data,opts){var me=this,now=new Date;opts&&opts.noDatemap||(window.Datemap=[]);var total=new Date(data.categories[0])>now?0:_.reduce(data.series,function(sum,s){return sum+(s.data[s.data.length-1]||0)},0)||0,idealTrend,ratio;if(opts&&opts.noTrends||(idealTrend={type:"spline",dashStyle:"Solid",name:"Ideal",data:Array(data.categories.length)},ratio=total/(data.categories.length-1)||0,idealTrend.data=_.map(idealTrend.data,function(e,i){return Math.round(100*(0+i*ratio))/100})),_.each(data.categories,function(c,i,a){var d=new Date(c);a[i]="ww"+me._getWorkweek(d),opts&&opts.noDatemap||(window.Datemap[i]=c),d>now&&_.each(data.series,function(s,j){s.data=s.data.slice(0,i).concat(_.map(Array(a.length-i),function(){return 0}))})}),!opts||!opts.noTrends){var s=_.find(data.series,function(s){return"Accepted"===s.name}),i,len,projectedTrend={type:"spline",dashStyle:"Solid",name:"Projected",data:s.data.slice()},begin=0,end=projectedTrend.data.length-1;for(i=1;projectedTrend.data.length>i;++i)if(null!==projectedTrend.data[i]&&0!==projectedTrend.data[i]){begin=i-1;break}for(i=end;i>=begin;--i)if(0!==projectedTrend.data[i]){end=i;break}for(ratio=end===begin?0:(projectedTrend.data[end]-0)/(end-begin),projectedTrend.data=_.map(projectedTrend.data,function(p,j){return j>=begin?Math.round(100*(0+(j-begin)*ratio))/100:p}),i=1,len=projectedTrend.data.length;len>i;++i)if(projectedTrend.data[i]>=total){projectedTrend.data[i]={color:"red",marker:{enabled:!0,lineWidth:4,symbol:"circle",fillColor:"red",lineColor:"red"},y:projectedTrend.data[i]};break}data.series.push(projectedTrend),data.series.push(idealTrend)}return data}})})();
                (function(){var Ext=window.Ext4||window.Ext;console={log:function(){}},Ext.define("FunctionalCFDCharts",{extend:"IntelRallyApp",requires:["FastCfdCalculator"],mixins:["WindowListener","PrettyAlert","IframeResize","IntelWorkweek","ReleaseQuery","ChartUpdater"],_prefName:"intel-ART-CFD",minWidth:910,_chartColors:["#ABABAB","#E57E3A","#E5D038","#0080FF","#3A874F","#000000","#26FF00"],_defaultChartConfig:{chart:{defaultSeriesType:"area",zoomType:"xy"},xAxis:{tickmarkPlacement:"on",title:{text:"Days",margin:10},labels:{y:20}},yAxis:{title:{text:"Points"},labels:{x:-5,y:4}},tooltip:{formatter:function(){for(var sum=0,i=4;i>=this.series.index;--i)sum+=this.series.chart.series[i].data[this.point.x].y;return"<b>"+this.x+"</b> ("+window.Datemap[this.point.x]+")"+"<br /><b>"+this.series.name+"</b>: "+this.y+(4>=this.series.index?"<br /><b>Total</b>: "+sum:"")}},plotOptions:{series:{marker:{enabled:!1,states:{hover:{enabled:!0}}},groupPadding:.01},area:{stacking:"normal",lineColor:"#666666",lineWidth:2,marker:{enabled:!1}}}},_getConfiguredChartTicks:function(startDate,endDate,width){var pixelTickWidth=40,ticks=Math.floor(width/pixelTickWidth),days=Math.floor((1*endDate-1*startDate)/(432e6/7)),interval=5*Math.floor(Math.floor(days/ticks)/5);return 5>interval?5:interval},_getTeamTypeAndNumber:function(scrumName){var name=scrumName.split("-")[0],teamType=name.split(/\d/)[0],number=1*(teamType===name?1:name.split(teamType)[1]);return{TeamType:teamType.trim(),Number:number}},_loadSnapshotStores:function(){var me=this;return me.TeamStores={},me.AllSnapshots=[],Q.all(_.map(me.ReleasesWithName,function(releaseRecords){var deferred=Q.defer();return Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null},sort:{_ValidFrom:1},compress:!0,find:{_TypeHierarchy:-51038,Children:null,PlanEstimate:{$gte:0},Release:{$in:_.map(releaseRecords,function(releaseRecord){return releaseRecord.data.ObjectID})}},fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState","PlanEstimate"],listeners:{load:function(store,records){records.length>0&&(me.TeamStores[releaseRecords[0].data.Project.Name]=records,me.AllSnapshots=me.AllSnapshots.concat(records)),deferred.resolve()},single:!0}}),deferred.promise}))},_loadAllProjectReleases:function(){var me=this,releaseName=me.ReleaseRecord.data.Name.split(" ")[0];return me.ReleasesWithName=[],Q.all(_.map(me.ProjectsOfFunction,function(proj){return me._loadReleasesByNameContainsForProject(releaseName,proj).then(function(releases){releases.length&&me.ReleasesWithName.push(releases)})}))},_loadPreferences:function(){var me=this,deferred=Q.defer();return Rally.data.PreferenceManager.load({filterByUser:!0,filterByName:me._prefName,success:function(prefs){var appPrefs=prefs[me._prefName];try{appPrefs=JSON.parse(appPrefs)}catch(e){appPrefs={projs:{}}}console.log("loaded prefs",appPrefs),deferred.resolve(appPrefs)},failure:deferred.reject}),deferred.promise},_savePreferences:function(prefs){var me=this,s={},deferred=Q.defer();return prefs={projs:prefs.projs},s[me._prefName]=JSON.stringify(prefs),console.log("saving prefs",prefs),Rally.data.PreferenceManager.update({filterByUser:!0,settings:s,success:deferred.resolve,failure:deferred.reject}),deferred.promise},_resizeWhenRendered:function(){var me=this;setTimeout(function(){me._fireParentWindowEvent("resize")},0)},_reloadEverything:function(){var me=this;return me.setLoading(!0),me._loadAllProjectReleases().then(function(){return me._loadSnapshotStores()}).then(function(){me.removeAll(),me.setLoading(!1),me._loadReleasePicker(),me._renderCharts()})},launch:function(){var me=this;me._initDisableResizeHandle(),me._initFixRallyDashboard(),me.setLoading(!0),Rally&&Rally.sdk&&Rally.sdk.dependencies&&Rally.sdk.dependencies.Analytics&&Rally.sdk.dependencies.Analytics.load(function(){me._loadModels().then(function(){var scopeProject=me.getContext().getProject();return me._loadProject(scopeProject.ObjectID)}).then(function(scopeProjectRecord){return me.ProjectRecord=scopeProjectRecord,me._loadRootProject(me.ProjectRecord)}).then(function(rootProject){return me.RootProject=rootProject,me._loadAllLeafProjects(rootProject)}).then(function(leafProjects){return me.LeafProjects=leafProjects,me.LeafProjects[me.ProjectRecord.data.ObjectID]?(me.TeamType=me._getTeamTypeAndNumber(me.ProjectRecord.data.Name).TeamType,me.ProjectsOfFunction=_.filter(me.LeafProjects,function(proj){return me._getTeamTypeAndNumber(proj.data.Name).TeamType==me.TeamType}),me._loadPreferences()):Q.reject("You are not Scoped to a valid Scrum in a Train")}).then(function(appPrefs){me.AppPrefs=appPrefs;var twelveWeeks=10368e5;return me._loadReleasesAfterGivenDate(me.ProjectRecord,1*new Date-twelveWeeks)}).then(function(releaseStore){me.ReleaseStore=releaseStore;var currentRelease=me._getScopedRelease(me.ReleaseStore.data.items,me.ProjectRecord.data.ObjectID,me.AppPrefs);return currentRelease?(me.ReleaseRecord=currentRelease,console.log("release loaded",currentRelease),me._reloadEverything()):Q.reject("This project has no releases.")}).fail(function(reason){me.setLoading(!1),me._alert("ERROR",reason||"")}).done()})},_releasePickerSelected:function(combo,records){var me=this;if(me.ReleaseRecord.data.Name!==records[0].data.Name){me.setLoading(!0),me.ReleaseRecord=me.ReleaseStore.findExactRecord("Name",records[0].data.Name),me._workweekData=me._getWorkWeeksForDropdown(me.ReleaseRecord.data.ReleaseStartDate,me.ReleaseRecord.data.ReleaseDate);var pid=me.ProjectRecord.data.ObjectID;"object"!=typeof me.AppPrefs.projs[pid]&&(me.AppPrefs.projs[pid]={}),me.AppPrefs.projs[pid].Release=me.ReleaseRecord.data.ObjectID,me._savePreferences(me.AppPrefs).then(function(){return me._reloadEverything()}).fail(function(reason){me._alert("ERROR",reason||""),me.setLoading(!1)}).done()}},_loadReleasePicker:function(){var me=this;me.ReleasePicker=me.add({xtype:"intelreleasepicker",labelWidth:80,width:240,releases:me.ReleaseStore.data.items,currentRelease:me.ReleaseRecord,listeners:{change:function(combo,newval,oldval){0===newval.length&&combo.setValue(oldval)},select:me._releasePickerSelected.bind(me)}})},_renderCharts:function(){var me=this;if(0===me.AllSnapshots.length)return me._alert("ERROR",me.TeamType+" has no data for release: "+me.ReleaseRecord.data.Name),void 0;me.panel=me.add({xtype:"container",layout:"column",width:"100%"}),me.aggregatePanel=me.panel.add({xtype:"container",layout:"column",columnWidth:1});var calc=Ext.create("FastCfdCalculator",{startDate:me.ReleaseRecord.data.ReleaseStartDate,endDate:me.ReleaseRecord.data.ReleaseDate});me.aggregatePanel.add({xtype:"panel",html:"",columnWidth:.16}),me.aggregatePanel.add({xtype:"rallychart",columnWidth:.66,loadMask:!1,chartColors:me._chartColors,chartData:me._updateChartData(calc.runCalculation(me.AllSnapshots)),chartConfig:Ext.Object.merge({chart:{height:400},legend:{borderWidth:0,width:500,itemWidth:100},title:{text:me.TeamType},subtitle:{text:me.ReleaseRecord.data.Name.split(" ")[0]},xAxis:{tickInterval:me._getConfiguredChartTicks(me.ReleaseRecord.data.ReleaseStartDate,me.ReleaseRecord.data.ReleaseDate,.66*me.getWidth())}},me._defaultChartConfig),listeners:{afterrender:me._resizeWhenRendered.bind(me)}}),me.aggregatePanel.add({xtype:"panel",html:"",columnWidth:.16});var sortedProjectNames=_.sortBy(Object.keys(me.TeamStores),function(projName){return projName.split("-")[1].trim()+projName});_.each(sortedProjectNames,function(projectName){me.panel.add({xtype:"rallychart",columnWidth:.32,loadMask:!1,height:360,padding:"20px 0 0 0",chartColors:me._chartColors,chartData:me._updateChartData(calc.runCalculation(me.TeamStores[projectName])),chartConfig:Ext.Object.merge({chart:{height:300},legend:{enabled:!1},title:{text:null},subtitle:{text:projectName},xAxis:{tickInterval:me._getConfiguredChartTicks(me.ReleaseRecord.data.ReleaseStartDate,me.ReleaseRecord.data.ReleaseDate,.32*me.getWidth())}},me._defaultChartConfig),listeners:{afterrender:me._resizeWhenRendered.bind(me)}})})}})})();

            Rally.launchApp('FunctionalCFDCharts', {
                name:"Functional CFD Charts",
	            parentRepos:""
            });

        });
    </script>


</head>
<body>
</body>
</html>
