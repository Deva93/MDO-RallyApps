<!DOCTYPE html>
<html>
<head>
    <title>Data Integrity Dashboard</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.js"></script>
    <script type="text/javascript" src="https://mdoproceffrpt/cdn/highcharts/highcharts-v4.0.4-modified.js"></script>
    <script type="text/javascript" src="https://code.highcharts.com/modules/heatmap.src.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.0.1/q.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("IntelRallyApp",{alias:"widget.intelrallyapp",extend:"Rally.app.App",_TrainConfigPrefName:"intel-train-config",_projectFields:["ObjectID","Releases","Children","Parent","Name","TeamMembers"],_portfolioItemFields:["Name","ObjectID","FormattedID","c_TeamCommits","c_MoSCoW","Release","c_Risks","Project","PlannedEndDate","Parent","Children","PortfolioItemType","Ordinal"],_userStoryFields:["Name","ObjectID","Release","Project","PortfolioItem","PlannedEndDate","ActualEndDate","FormattedID","Predecessors","Successors","c_Dependencies","Iteration","PlanEstimate"],_releaseFields:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project","TeamMembers"],_loadScheduleStates:function(){var me=this,deferred=Q.defer();return Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(records,operation,success){me.ScheduleStates=_.map(records,function(r){return r.data.StringValue}),deferred.resolve()}})}}),deferred.promise},_loadPortfolioItemStatesForEachType:function(){var me=this;return me.PortfolioItemTypeStates=[],Q.all(_.map(me.PortfolioItemTypes,function(portfolioType,ordinal){var store=Ext.create("Rally.data.wsapi.Store",{model:"State",autoLoad:!1,limit:1/0,fetch:["Name","Enabled","OrderIndex"],filters:[{property:"TypeDef.Name",value:portfolioType},{property:"Enabled",value:!0}]});return me._reloadStore(store).then(function(store){me.PortfolioItemTypeStates[ordinal]=store.getRange()})}))},_loadPortfolioItemTypes:function(){var me=this,deferred=Q.defer(),store=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",autoLoad:!0,limit:1/0,fetch:["Ordinal","Name"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Creatable",value:!0}],listeners:{load:function(portfolioTypeStore){me.PortfolioItemTypes=_.map(_.sortBy(_.map(portfolioTypeStore.getRange(),function(item){return{Name:item.data.Name,Ordinal:item.data.Ordinal}}),function(item){return item.Ordinal}),function(item){return item.Name}),deferred.resolve()}}});return deferred.promise},_loadModels:function(){var me=this,promises=[],models={Project:"Project",UserStory:"HierarchicalRequirement",PortfolioItem:"PortfolioItem"};return _.each(me.PortfolioItemTypes,function(name){models[name]="PortfolioItem/"+name}),_.each(models,function(modelType,modelName){var deferred=Q.defer();Rally.data.WsapiModelFactory.getModel({type:modelType,success:function(loadedModel){me[modelName]=loadedModel,deferred.resolve()}}),promises.push(deferred.promise)}),Q.all(promises)},_loadTrainConfig:function(){var me=this,deferred=Q.defer();return Rally.data.PreferenceManager.load({workspace:me.getContext().getWorkspace()._ref,filterByName:me._TrainConfigPrefName,success:function(prefs){var workspaceConfigString=prefs[me._TrainConfigPrefName],trainConfig;try{trainConfig=JSON.parse(workspaceConfigString)}catch(e){trainConfig=[]}me.TrainConfig=trainConfig,deferred.resolve()},failure:deferred.reject}),deferred.promise},_saveTrainConfig:function(trainConfig){var me=this,s={},deferred=Q.defer();return s[me._TrainConfigPrefName]=JSON.stringify(trainConfig),Rally.data.PreferenceManager.update({workspace:me.getContext().getWorkspace()._ref,filterByName:me._TrainConfigPrefName,settings:s,success:deferred.resolve,failure:deferred.reject}),deferred.promise},_configureIntelRallyApp:function(){var me=this;return Q.all([me._loadPortfolioItemTypes().then(function(){return Q.all([me._loadModels(),me._loadPortfolioItemStatesForEachType()])}),me._loadTrainConfig(),me._loadScheduleStates()])},_reloadStore:function(store){var deferred=Q.defer();return store.load({callback:function(records,operation,success){success?deferred.resolve(store):deferred.reject(operation.getError()||"Could not load data")}}),deferred.promise},_loadProject:function(oid){var me=this,deferred=Q.defer();return oid?me.Project?(me.Project.load(oid,{fetch:me._projectFields,context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:deferred.resolve}),deferred.promise):Q.reject("IntelRallyApp is not configured!"):Q.reject("Invalid arguments: LP")},_loadUserStory:function(oid,projectRecord){var me=this,deferred=Q.defer();return oid?me.UserStory?(me.UserStory.load(oid,{fetch:me._userStoryFields,context:{workspace:projectRecord?null:me.getContext().getWorkspace()._ref,project:projectRecord?projectRecord.data._ref:null},callback:deferred.resolve}),deferred.promise):Q.reject("IntelRallyApp is not configured!"):Q.reject("Invalid arguments: LUS")},_loadPortfolioItemByType:function(oid,type){var me=this,deferred=Q.defer();return oid&&type?(me[type].load(oid,{fetch:me._portfolioItemFields,context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:deferred.resolve}),deferred.promise):Q.reject("Invalid arguments: LPIBT")},_loadPortfolioItemByOrdinal:function(oid,ordinal){var me=this,deferred=Q.defer(),type=me.PortfolioItemTypes[ordinal];return me._loadPortfolioItemByType(oid,type)},_projectInWhichTrain:function(projectRecord){if(projectRecord){var me=this,foundTrainConfig=_.find(me.TrainConfig,function(trainConfig){return trainConfig.TrainProjectOID==projectRecord.data.ObjectID});if(foundTrainConfig)return Q(projectRecord);var parent=projectRecord.data.Parent;return parent?me._loadProject(parent.ObjectID).then(function(parentRecord){return me._projectInWhichTrain(parentRecord)}):Q()}return Q()},_loadTrainPortfolioProject:function(trainRecord){if(!trainRecord)return Q.reject("Invalid arguments: ltpp");var me=this,foundTrainConfig=_.find(me.TrainConfig,function(trainConfig){return trainConfig.TrainProjectOID==trainRecord.data.ObjectID});return foundTrainConfig?foundTrainConfig.TrainAndPortfolioLocationTheSame?Q(trainRecord):me._loadProject(foundTrainConfig.PortfolioProjectOID):Q.reject("Project "+trainRecord.data.Name+" is not a train!")},_getTrainName:function(trainRecord){if(!trainRecord)throw"Invalid arguments: gtn";var me=this,foundTrainConfig=_.find(me.TrainConfig,function(trainConfig){return trainConfig.TrainProjectOID==trainRecord.data.ObjectID});if(!foundTrainConfig)throw"Project "+trainRecord.data.Name+" is not a train!";return foundTrainConfig.TrainName?foundTrainConfig.TrainName:trainRecord.data.Name},_loadAllTrains:function(){var me=this,filter=_.reduce(me.TrainConfig,function(filter,item){var newFilter=Ext.create("Rally.data.wsapi.Filter",{property:"ObjectID",value:item.TrainProjectOID});return filter?filter.or(newFilter):newFilter},null);if(filter){var store=Ext.create("Rally.data.wsapi.Store",{model:"Project",limit:1/0,autoLoad:!1,fetch:me._projectFields,filters:[filter],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})}return Q([])},__getUserStoryInReleaseTimeFrameFilter:function(releaseRecord){var me=this,twoWeeks=12096e5,releaseStartPadding=new Date(1*new Date(releaseRecord.data.ReleaseStartDate)+twoWeeks).toISOString(),releaseEndPadding=new Date(1*new Date(releaseRecord.data.ReleaseDate)-twoWeeks).toISOString();return Ext.create("Rally.data.wsapi.Filter",{property:"Release.ReleaseStartDate",operator:"<",value:releaseStartPadding}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Release.ReleaseDate",operator:">",value:releaseEndPadding})).or(Ext.create("Rally.data.wsapi.Filter",{property:"Release.ObjectID",value:null}).and(Ext.create("Rally.data.wsapi.Filter",{property:"PortfolioItem.Release.ReleaseStartDate",operator:"<",value:releaseStartPadding}).and(Ext.create("Rally.data.wsapi.Filter",{property:"PortfolioItem.Release.ReleaseDate",operator:">",value:releaseEndPadding}))))},_loadRandomUserStory:function(projectRecord){if(!projectRecord)return Q.reject("Invalid arguments: LRUS");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1,pageSize:1,fetch:!1,context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID}]});return me._reloadStore(store).then(function(store){return store.getRange().pop()})},_loadRandomUserStoryFromReleaseTimeframe:function(projectRecord,releaseRecord){if(!projectRecord||!releaseRecord)return Q.reject("Invalid arguments: LRUSFR");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:5,pageSize:5,fetch:me._userStoryFields,context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},sorters:[{property:"CreationDate",direction:"DESC"}],filters:[Ext.create("Rally.data.wsapi.Filter",{property:"Project.ObjectID",value:projectRecord.data.ObjectID}).and(me.__getUserStoryInReleaseTimeFrameFilter(releaseRecord))]});return me._reloadStore(store).then(function(store){var records=store.data.items;return records.length?Q(records[Math.floor(Math.random()*records.length)]):Q(void 0)})},_loadUserStoryByFID:function(formattedID,projectRecord){if(!formattedID||!projectRecord)return Q.reject("Invalid arguments: LUSBFID");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1,pageSize:1,fetch:["Name","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},filters:[{property:"FormattedID",value:formattedID},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}]});return me._reloadStore(store).then(function(store){return Q(store.data.items.pop())})},_loadPortfolioItemsOfType:function(portfolioProject,type){if(!portfolioProject||!type)return Q.reject("Invalid arguments: OPIOT");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/"+type,limit:1/0,remoteSort:!1,fetch:me._portfolioItemFields,context:{project:portfolioProject.data._ref,projectScopeDown:!0,projectScopeUp:!1}});return me._reloadStore(store)},_loadPortfolioItemsOfOrdinal:function(portfolioProject,ordinal){if(!portfolioProject||ordinal===void 0)return Q.reject("Invalid arguments: LPIOO");var me=this,type=me.PortfolioItemTypes[ordinal];return type?me._loadPortfolioItemsOfType(portfolioProject,type):Q.reject("Invalid PortfolioItem ordinal")},_portfolioItemTypeToOrdinal:function(type){return this.PortfolioItemTypes.indexOf(type)},_getPortfolioItemTypeStateByOrdinal:function(ordinal,stateName){return _.find(this.PortfolioItemTypeStates[ordinal],function(state){return state.data.Name==stateName})},_getPortfolioItemTypeStateByName:function(portfolioType,stateName){return this._getPortfolioItemTypeStateByOrdinal(this._portfolioItemTypeToOrdinal(portfolioType),stateName)},__storeItemsToProjTree:function(projects){for(var me=this,projTree={},i=0,len=projects.length;len>i;++i){var project=projects[i],thisRef=project.data.ObjectID,parentRef=project.data.Parent?project.data.Parent.ObjectID:void 0;projTree[thisRef]||(projTree[thisRef]={}),projTree[thisRef].ProjectRecord=project,parentRef&&(projTree[parentRef]||(projTree[parentRef]={}),projTree[parentRef][thisRef]=projTree[thisRef])}return projTree},_loadAllProjects:function(){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:me._projectFields,limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){var map=_.reduce(store.getRange(),function(map,project){return map[project.data.ObjectID]=project,map},{});return map})},__addProjectsWithTeamMembersToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;curProj.data.TeamMembers.Count>0&&(hash[curProj.data.ObjectID]=curProj);for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me.__addProjectsWithTeamMembersToList(projTree[childProjRef],hash)},_loadProjectsWithTeamMembers:function(rootProjectRecord){var me=this,projectsWithTeamMembers={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:me._projectFields,limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){if(rootProjectRecord){var projTree=me.__storeItemsToProjTree(store.getRange());return me.__addProjectsWithTeamMembersToList(projTree[rootProjectRecord.data.ObjectID],projectsWithTeamMembers),projectsWithTeamMembers}return _.reduce(_.filter(store.getRange(),function(project){return project.data.TeamMembers.Count>0}),function(map,project){return map[project.data.ObjectID]=project,map},{})})},__allChildProjectToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;hash[curProj.data.ObjectID]=curProj;for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me.__allChildProjectToList(projTree[childProjRef],hash)},_loadAllChildrenProjects:function(rootProjectRecord){var me=this,childrenProjects={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:me._projectFields,limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){if(rootProjectRecord){var projTree=me.__storeItemsToProjTree(store.getRange());return me.__allChildProjectToList(projTree[rootProjectRecord.data.ObjectID],childrenProjects),childrenProjects}return _.reduce(store.getRange(),function(map,project){return map[project.data.ObjectID]=project,map},{})})},__allLeafProjectsToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;0===curProj.data.Children.Count&&(hash[curProj.data.ObjectID]=curProj);for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me.__allLeafProjectsToList(projTree[childProjRef],hash)},_loadAllLeafProjects:function(rootProjectRecord){var me=this,leafProjects={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:me._projectFields,limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){if(rootProjectRecord){var projTree=me.__storeItemsToProjTree(store.getRange());return me.__allLeafProjectsToList(projTree[rootProjectRecord.data.ObjectID],leafProjects),leafProjects}return _.reduce(_.filter(store.getRange(),function(project){return 0===project.data.Children.Count}),function(map,project){return map[project.data.ObjectID]=project,map},{})})},_loadProjectByName:function(projectName){if(!projectName)return Q.reject("Invalid arguments: LPBN");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Project",limit:1,pageSize:1,fetch:["Name","ObjectID"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:projectName}]});return me._reloadStore(store).then(function(store){return Q(store.data.items.pop())})},_loadAllReleases:function(projectRecord){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleasesAfterGivenDate:function(projectRecord,givenDate){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"ReleaseDate",operator:">=",value:new Date(givenDate).toISOString()},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleasesBeforeGivenDate:function(projectRecord,givenDate){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"ReleaseDate",operator:"<=",value:new Date(givenDate).toISOString()},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleasesInTheFuture:function(projectRecord){return this._loadReleasesAfterGivenDate(projectRecord,new Date)},_loadReleasesByNameUnderProject:function(releaseName,projectRecord){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"Name",value:releaseName}],context:{project:projectRecord.data._ref,projectScopeDown:!0,projectScopeUp:!1}});return me._reloadStore(store).then(function(store){return store.getRange()})},_loadReleaseByNameForProject:function(releaseName,projectRecord){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"Name",value:releaseName},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange().pop()})},_loadReleasesByNameContainsForProject:function(releaseName,projectRecord){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!1,fetch:me._releaseFields,filters:[{property:"Name",operator:"contains",value:releaseName},{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){return store.getRange()})},_getScopedRelease:function(releaseRecords,projectOID,appPrefs){var me=this,d=new Date,rs=releaseRecords,prefOID=appPrefs&&appPrefs.projs&&appPrefs.projs[projectOID]&&appPrefs.projs[projectOID].Release;return prefOID&&_.find(rs,function(r){return r.data.ObjectID==prefOID})||_.find(rs,function(r){return new Date(r.data.ReleaseDate)>=d&&d>=new Date(r.data.ReleaseStartDate)})||_.reduce(rs,function(best,r){if(null===best)return r;var d1=new Date(best.data.ReleaseStartDate),d2=new Date(r.data.ReleaseStartDate),now=new Date;return Math.abs(d1-now)<Math.abs(d2-now)?best:r},null)}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("WorkweekDropdown",{extend:"Ext.data.Model",fields:[{name:"Workweek",type:"string"},{name:"DateVal",type:"number"}]}),Ext.define("TrainConfigItem",{extend:"Ext.data.Model",fields:[{name:"TrainProjectOID",type:"number"},{name:"TrainName",type:"string"},{name:"TrainAndPortfolioLocationTheSame",type:"boolean"},{name:"PortfolioProjectOID",type:"number"}]})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("WindowListener",{__initWindowEventListener:function(eventName){var me=this;me._windowListeners||(me._windowListeners={}),me._windowListeners[eventName]=[],window.parent["on"+eventName]=function(event){for(var listeners=me._windowListeners[eventName],i=0,len=listeners.length;len>i;++i)listeners[i](event)}},_addWindowEventListener:function(eventName,fn){var me=this;me._windowListeners&&me._windowListeners[eventName]||me.__initWindowEventListener(eventName),me._windowListeners[eventName].push(fn)},_fireParentWindowEvent:function(eventName){var me=this;if(me._windowListeners&&me._windowListeners[eventName])for(var listeners=me._windowListeners[eventName],i=0,len=listeners.length;len>i;++i)listeners[i]()}})})();
                (function(){var Ext=window.Ext4||window.Ext,TOP_BAR_HEIGHT=40,BOTTOM_BAR_HEIGHT=24,TITLE_BAR_HEIGHT=33,IFRAME_HEADER_HEIGHT=28;Ext.define("IframeResize",{requires:["WindowListener"],_fixRallyDashboard:function(){for(var me=this,bottomEl=window.frameElement?Ext.get(window.frameElement):me.el,portlet=bottomEl.up(".x-portlet"),dashboard=portlet.up("#mydash_portlet"),titleBar=dashboard.down(".titlebar"),domNodeW=bottomEl.dom,domNodeH=bottomEl.dom,innerHeight=window.parent.innerHeight,innerWidth=window.parent.innerWidth;;){if(domNodeW.style.width=innerWidth-4+"px",domNodeW.style.padding="0",domNodeW.style.margin="0","mydash_portlet"===domNodeW.id)break;domNodeW=domNodeW.parentNode}for(;;){if(domNodeH.style.height=innerHeight-(TOP_BAR_HEIGHT+BOTTOM_BAR_HEIGHT+TITLE_BAR_HEIGHT+IFRAME_HEADER_HEIGHT)+"px",domNodeH.classList.contains("x-portlet"))break;domNodeH=domNodeH.parentNode}for(;;){if(domNodeH.style.height=innerHeight-(TOP_BAR_HEIGHT+BOTTOM_BAR_HEIGHT+TITLE_BAR_HEIGHT)+"px","mydash_portlet"==domNodeH.id)break;domNodeH=domNodeH.parentNode}dashboard.dom.style.height=innerHeight-(TOP_BAR_HEIGHT+BOTTOM_BAR_HEIGHT)+"px",dashboard.dom.style.padding="0 2px 0 2px",titleBar.dom.style.padding="2px",titleBar.dom.style.margin="0"},_initFixRallyDashboard:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me._fixRallyDashboard()}),me._fixRallyDashboard()},_disableResizeHandle:function(){var me=this,handle;handle=window.frameElement?Ext.get(window.frameElement).up(".x-portlet").down(".x-resizable-handle"):me.el.up(".x-portlet").down(".x-resizable-handle"),handle&&(handle.hide(),handle.dom.onshow=function(){handle&&handle.hide()})},_initDisableResizeHandle:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me._disableResizeHandle()}),me._disableResizeHandle()}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("PrettyAlert",{__getMessageBoxY:function(){var me=this,bottomEl=window.frameElement?Ext.get(window.frameElement):me.el,ph=window.parent.getWindowHeight(),ps=window.parent.getScrollY(),ofy=ps+bottomEl.dom.getBoundingClientRect().top,iyOffset=Math.floor(ph/2-ofy+ps-50);return 0>iyOffset?0:iyOffset},_alert:function(title,message){var me=this;message="string"==typeof message?message:message.message?message.message:JSON.stringify(message,null,"	"),1>arguments.length||(1===arguments.length&&(message=title,title=""),Ext.MessageBox.alert(title,message).setY(me.__getMessageBoxY()),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},50))},_confirm:function(title,message,fn){var me=this;message="string"==typeof message?message:message.message?message.message:JSON.stringify(message,null,"	"),2>arguments.length||(2===arguments.length&&(fn=message,message=title,title=""),"function"!=typeof fn&&(fn=function(){}),Ext.MessageBox.confirm(title,message,fn).setY(me.__getMessageBoxY()),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20))}})})();
                (function(){var Ext=window.Ext4||window.Ext,intel_ww={},SECOND=1e3,MINUTE=60*SECOND,HOUR=60*MINUTE,DAY=24*HOUR,WEEK=7*DAY;Ext.define("IntelWorkweek",{_getWorkweek:function(_date){var date=new Date(_date),yearStart=new Date(date.getFullYear(),0,1),dayIndex=yearStart.getDay(),ww01Start=new Date(yearStart-dayIndex*DAY),utcDateMillis=Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()),ww01Millis=Date.UTC(ww01Start.getFullYear(),ww01Start.getMonth(),ww01Start.getDate()),timeDiff=utcDateMillis-ww01Millis,ww=Math.floor(timeDiff/WEEK)+1,leap=0===date.getFullYear()%4,weekCount=leap&&dayIndex>=5||!leap&&6===dayIndex?53:52;return ww>weekCount?1:ww},_getWeekCount:function(_date){var date=new Date(_date),leap=0===date.getFullYear()%4,day=new Date(date.getFullYear(),0,1).getDay();return leap&&day>=5||!leap&&6===day?53:52},_roundDateDownToWeekStart:function(_date){var date=new Date(_date),day=date.getDay(),monthDate=date.getDate(),month=date.getMonth(),year=date.getFullYear(),sundayMidday=new Date(1*new Date(year,month,monthDate)-(day*DAY-.5*DAY));return new Date(sundayMidday.getFullYear(),sundayMidday.getMonth(),sundayMidday.getDate())},_getWorkweekDates:function(startDate,endDate){for(var startWeekDate=this._roundDateDownToWeekStart(startDate),endWeekDate=this._roundDateDownToWeekStart(endDate),startMillis=Date.UTC(startWeekDate.getFullYear(),startWeekDate.getMonth(),startWeekDate.getDate()),endMillis=Date.UTC(endWeekDate.getFullYear(),endWeekDate.getMonth(),endWeekDate.getDate()),totalWeeks=Math.floor((endMillis-startMillis)/WEEK)+1,weeks=Array(totalWeeks),i=0;totalWeeks>i;++i){var sundayMidday=new Date(1*startWeekDate+(WEEK*i+12*HOUR));weeks[i]=new Date(sundayMidday.getFullYear(),sundayMidday.getMonth(),sundayMidday.getDate())}return weeks},_workweekToDate:function(ww,year){var yearStart=new Date(year,0,1),dayIndex=yearStart.getDay(),ww01StartMidday=new Date(yearStart-(dayIndex*DAY-.5*DAY)),sundayMidday=new Date(1*ww01StartMidday+(ww-1)*WEEK);return new Date(sundayMidday.getFullYear(),sundayMidday.getMonth(),sundayMidday.getDate())},_getWorkWeeksForDropdown:function(releaseStartDate,releaseEndDate){for(var workweeks=this._getWorkweekDates(releaseStartDate,releaseEndDate),data=Array(workweeks.length),i=0,len=workweeks.length;len>i;++i)data[i]={Workweek:"ww"+this._getWorkweek(workweeks[i]),DateVal:1*workweeks[i]};return data}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("UserAppsPreference",{_userAppsPref:"intel-user-apps-preference",_loadAppsPreference:function(){var me=this,deferred=Q.defer();return Rally.data.PreferenceManager.load({filterByUser:!0,filterByName:me._userAppsPref,success:function(prefs){var appPrefs=prefs[me._userAppsPref];try{appPrefs=JSON.parse(appPrefs)}catch(e){appPrefs={projs:{},refresh:0}}deferred.resolve(appPrefs)},failure:deferred.reject}),deferred.promise},_saveAppsPreference:function(prefs){var me=this,s={},deferred=Q.defer();return prefs={projs:prefs.projs,refresh:prefs.refresh},s[me._userAppsPref]=JSON.stringify(prefs),Rally.data.PreferenceManager.update({filterByUser:!0,filterByName:me._userAppsPref,settings:s,success:deferred.resolve,failure:deferred.reject}),deferred.promise}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("ParallelLoader",{__parallelLoadData:function(config){var me=this,pagesize=config.pagesize,url=config.url,params=config.params,promises=[],outputItems=[];return totalRequestsSent=1,_.times(totalRequestsSent,function(pageNum){var thisDeferred=Q.defer(),thisParams=Ext.merge({},params);promises.push(thisDeferred.promise),thisParams.start=config.itemOffset+pagesize*pageNum,Ext.Ajax.request({url:url,method:"GET",params:thisParams,success:function(response){var resJSON=JSON.parse(response.responseText),items=resJSON.QueryResult?resJSON.QueryResult.Results:resJSON.Results,totalCount=resJSON.QueryResult?resJSON.QueryResult.TotalResultCount:resJSON.TotalResultCount,totalPages=(totalCount/pagesize>>0)+(totalCount%pagesize?1:0);if(outputItems=outputItems.concat(items),totalPages>totalRequestsSent){var additionalPromises=[];_.times(totalPages-totalRequestsSent,function(){var nextDeferred=Q.defer(),thisParams=Ext.merge({},params);additionalPromises.push(nextDeferred.promise),thisParams.start=config.itemOffset+pagesize*totalRequestsSent,++totalRequestsSent,Ext.Ajax.request({url:url,method:"GET",params:thisParams,success:function(response){var resJSON=JSON.parse(response.responseText),items=resJSON.QueryResult?resJSON.QueryResult.Results:resJSON.Results;outputItems=outputItems.concat(items),nextDeferred.resolve()},failure:function(response){nextDeferred.reject(response)}})}),Q.all(additionalPromises).then(function(){thisDeferred.resolve()})}else thisDeferred.resolve()},failure:function(response){thisDeferred.reject(response)}})}),Q.all(promises).then(function(){return outputItems})},_parallelLoadWsapiStore:function(config){var me=this;return config.itemOffset=1,config.pagesize=config.pagesize>0&&200>=config.pagesize?config.pagesize:200,me.__parallelLoadData(config).then(function(items){return Ext.create("Rally.data.wsapi.Store",{model:config.model,totalCount:items.length,data:items,load:function(){}})})},_parallelLoadLookbackStore:function(config){var me=this;return config.itemOffset=0,config.pagesize=config.pagesize>0&&2e4>=config.pagesize?config.pagesize:2e4,me.__parallelLoadData(config).then(function(items){return Ext.create("Rally.data.lookback.SnapshotStore",{totalCount:items.length,data:items,model:Ext.define("Rally.data.lookback.SnapshotModel-"+Ext.id(),{extend:"Rally.data.lookback.SnapshotModel",fields:JSON.parse(config.params.fields||"[]")}),load:function(){}})})}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("DataIntegrityDashboardObjectIDPreference",{_dataIntegrityObjectIdPref:"intel-data-integrity-dashboard-objectid",_loadDataIntegrityDashboardObjectID:function(){var me=this,deferred=Q.defer();return Rally.data.PreferenceManager.load({workspace:me.getContext().getWorkspace()._ref,filterByName:me._dataIntegrityObjectIdPref,success:function(prefs){var objectID=1*prefs[me._dataIntegrityObjectIdPref];deferred.resolve(objectID)},failure:deferred.reject}),deferred.promise},_setDataIntegrityDashboardObjectID:function(){var me=this,s={},deferred=Q.defer(),objectID=window.parent.location.hash.split("/").pop();return s[me._dataIntegrityObjectIdPref]=objectID,Rally.data.PreferenceManager.update({workspace:me.getContext().getWorkspace()._ref,filterByName:me._dataIntegrityObjectIdPref,settings:s,success:deferred.resolve,failure:deferred.reject}),deferred.promise}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("IntelComboBox",{extend:"Ext.form.field.ComboBox",alias:["widget.intelcombo","widget.intelcombobox"],constructor:function(options){options=options||{},options=Ext.merge({enableKeyEvents:!0,queryMode:"local",ignoreNoChange:!0,allowBlank:!0,listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var combo=this;combo.store.clearFilter(),combo.store.filterBy(function(item){return null!==item.data[combo.displayField].match(RegExp(combo.getRawValue(),"i"))})}},focus:function(combo){combo.store.clearFilter(),combo.setValue(""),combo.expand()}}},options),this.callParent([options])}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("IntelFixedComboBox",{extend:"Ext.form.field.ComboBox",alias:["widget.intelfixedcombo","widget.intelfixedcombobox"],constructor:function(options){options=options||{},options=Ext.merge({editable:!1,allowBlank:!0,queryMode:"local",listeners:{change:function(combo,newval,oldval){0===newval.length&&combo.setValue(oldval)},focus:function(combo){combo.setValue(""),combo.expand()}}},options),this.callParent([options])}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("IntelReleasePicker",{extend:"IntelFixedComboBox",alias:["widget.intelreleasepicker"],constructor:function(options){options.releases&&options.currentRelease&&(options.displayField="Name",options.value=options.currentRelease.data.Name,options.store=Ext.create("Ext.data.Store",{fields:["Name"],sorters:[function(o1,o2){return o1.data.Name>o2.data.Name?-1:1}],data:_.map(options.releases,function(r){return{Name:r.data.Name}})}),options.fieldLabel=options.fieldLabel||"Release:",options.editable=options.editable||!1,options.width=options.width||240,options.labelWidth=options.labelWidth||50,this.callParent([options]))}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("DataIntegrityDashboard",{extend:"IntelRallyApp",cls:"app",mixins:["WindowListener","PrettyAlert","IframeResize","IntelWorkweek","ParallelLoader","UserAppsPreference","DataIntegrityDashboardObjectIDPreference"],minWidth:1100,items:[{xtype:"container",id:"controlsContainer",layout:"hbox"},{xtype:"container",id:"ribbon",cls:"ribbon",layout:"column",items:[{xtype:"container",width:480,id:"pie"},{xtype:"container",columnWidth:.999,id:"heatmap"}]},{xtype:"container",id:"gridsContainer",cls:"grids-container",layout:"column",items:[{xtype:"container",columnWidth:.495,id:"gridsLeft",cls:"grids-left"},{xtype:"container",columnWidth:.495,id:"gridsRight",cls:"grids-right"}]}],_colors:["#AAAAAA","#2ECC40","#7FDBFF","#DDDDDD","#39CCCC","#FF851B","#3D9970","#01FF70","#FFDC00","#0074D9"],_userAppsPref:"intel-SAFe-apps-preference",_getUserStoryFilter:function(){var me=this,releaseName=me.ReleaseRecord.data.Name,releaseDate=new Date(me.ReleaseRecord.data.ReleaseDate).toISOString(),releaseStartDate=new Date(me.ReleaseRecord.data.ReleaseStartDate).toISOString(),releaseNameFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:releaseName}),inIterationButNotReleaseFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.StartDate",operator:"<",value:releaseDate}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.EndDate",operator:">",value:releaseStartDate})).and(Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:null})),userStoryProjectFilter;if(me.TrainRecord){if(!me.LeafProjects||!Object.keys(me.LeafProjects).length)throw"Train has no Scrums!";userStoryProjectFilter=_.reduce(me.LeafProjects,function(filter,projectData,projectOID){var newFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Project.ObjectID",value:projectOID});return filter?filter.or(newFilter):newFilter},null)}else userStoryProjectFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Project.ObjectID",value:me.CurrentScrum.data.ObjectID});return userStoryProjectFilter.and(inIterationButNotReleaseFilter.or(releaseNameFilter))},_getStories:function(){var me=this,config={model:me.UserStory,url:"https://rally1.rallydev.com/slm/webservice/v2.0/HierarchicalRequirement",params:{pagesize:200,query:""+me._getUserStoryFilter(),fetch:["Name","ObjectID","Project","PlannedEndDate","ActualEndDate","StartDate","EndDate","Iteration","Release","Description","Tasks","PlanEstimate","FormattedID","ScheduleState","Blocked","BlockedReason","Blocker","CreationDate","PortfolioItem"].join(","),workspace:me.getContext().getWorkspace()._ref,includePermissions:!0}};return me._parallelLoadWsapiStore(config).then(function(store){return me.UserStoryStore=store,store})},_getLowestPortfolioItemFilter:function(){var me=this,releaseName=me.ReleaseRecord.data.Name,releaseNameFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:releaseName});return releaseNameFilter},_getLowestPortfolioItems:function(){var me=this;if(!me.TrainRecord)return Q();var config={model:me[me.PortfolioItemTypes[0]],url:"https://rally1.rallydev.com/slm/webservice/v2.0/PortfolioItem/"+me.PortfolioItemTypes[0],params:{project:me.TrainPortfolioProject.data._ref,projectScopeUp:!1,projectScopeDown:!0,pagesize:200,query:""+me._getLowestPortfolioItemFilter(),fetch:["Name","ObjectID","Project","PlannedEndDate","ActualEndDate","Release","Description","FormattedID","UserStories"].join(","),includePermissions:!0}};return me._parallelLoadWsapiStore(config).then(function(store){return me.LowestPortfolioItemStore=store,store})},_removeAllItems:function(){var me=this;Ext.getCmp("pie").removeAll(),Ext.getCmp("heatmap").removeAll(),Ext.getCmp("gridsLeft").removeAll(),Ext.getCmp("gridsRight").removeAll();var indicator=Ext.getCmp("integrityIndicator");indicator&&indicator.destroy()},_redrawEverything:function(){var me=this;return me._removeAllItems(),me.setLoading("Loading Grids and Charts"),me._buildGrids().then(function(){return Q.all([me._buildRibbon(),me._buildIntegrityIndicator()])}).fail(function(reason){return Q.reject(reason)}).then(function(){me.setLoading(!1)})},_reloadEverything:function(){var me=this;return me.ReleasePicker||me._loadReleasePicker(),me.ScrumPicker||me._loadScrumPicker(),me.setLoading("Loading Stores"),Q.all([me._getStories(),me._getLowestPortfolioItems()]).then(function(){me._redrawEverything()}).fail(function(reason){return Q.reject(reason)}).then(function(){me.setLoading(!1)})},_clearToolTip:function(){var me=this;me.tooltip&&(me.tooltip.panel.hide(),me.tooltip.triangle.hide(),me.tooltip.panel.destroy(),me.tooltip.triangle.destroy(),me.tooltip=null)},_addScrollEventListener:function(){var me=this;me.getEl().dom.addEventListener("scroll",function(){me._clearToolTip()})},launch:function(){var me=this;me._initDisableResizeHandle(),me._initFixRallyDashboard(),me._addScrollEventListener(),me._setDataIntegrityDashboardObjectID(),me.setLoading("Loading Configuration"),me._configureIntelRallyApp().then(function(){var scopeProject=me.getContext().getProject();return me._loadProject(scopeProject.ObjectID)}).then(function(scopeProjectRecord){return me.ProjectRecord=scopeProjectRecord,Q.all([me._projectInWhichTrain(me.ProjectRecord).then(function(trainRecord){return trainRecord?(me._isScopedToTrain=trainRecord.data.ObjectID!=me.ProjectRecord.data.ObjectID?!1:!0,me.TrainRecord=trainRecord,Q.all([me._loadAllLeafProjects(me.TrainRecord).then(function(leftProjects){me.LeafProjects=leftProjects,me.CurrentScrum=me._isScopedToTrain?null:me.ProjectRecord}),me._loadTrainPortfolioProject(me.TrainRecord).then(function(trainPortfolioProject){me.TrainPortfolioProject=trainPortfolioProject;var topPortfolioItemType=me.PortfolioItemTypes[me.PortfolioItemTypes.length-1];return me._loadPortfolioItemsOfType(trainPortfolioProject,topPortfolioItemType)}).then(function(topPortfolioItemStore){me.TopPortfolioItems=topPortfolioItemStore.getRange()})])):(me.CurrentScrum=me.ProjectRecord,me._isScopedToTrain=!1,void 0)}),me._loadAppsPreference().then(function(appsPref){me.AppsPref=appsPref;var twelveWeeks=72576e5;return me._loadReleasesAfterGivenDate(me.ProjectRecord,1*new Date-twelveWeeks)}).then(function(releaseRecords){me.ReleaseRecords=releaseRecords;var currentRelease=me._getScopedRelease(releaseRecords,me.ProjectRecord.data.ObjectID,me.AppsPref);return currentRelease?(me.ReleaseRecord=currentRelease,void 0):Q.reject("This project has no releases.")})])}).then(function(){return me._reloadEverything()}).fail(function(reason){me.setLoading(!1),me._alert("ERROR",reason||"")}).done()},_releasePickerSelected:function(combo,records){var me=this,pid=me.ProjectRecord.data.ObjectID;me.ReleaseRecord.data.Name!==records[0].data.Name&&(me.setLoading(!0),me.ReleaseRecord=_.find(me.ReleaseRecords,function(rr){return rr.data.Name==records[0].data.Name}),"object"!=typeof me.AppsPref.projs[pid]&&(me.AppsPref.projs[pid]={}),me.AppsPref.projs[pid].Release=me.ReleaseRecord.data.ObjectID,me._saveAppsPreference(me.AppsPref).then(function(){return me._reloadEverything()}).fail(function(reason){me._alert("ERROR",reason||""),me.setLoading(!1)}).done())},_loadReleasePicker:function(){var me=this;me.ReleasePicker=Ext.getCmp("controlsContainer").add({xtype:"intelreleasepicker",labelWidth:80,width:240,releases:me.ReleaseRecords,currentRelease:me.ReleaseRecord,listeners:{change:function(combo,newval,oldval){0===newval.length&&combo.setValue(oldval)},select:me._releasePickerSelected.bind(me)}})},_scrumPickerSelected:function(combo,records){var me=this,recordName=records[0].data.Name;if(!(!me.CurrentScrum&&"All"==recordName||me.CurrentScrum&&me.CurrentScrum.data.Name==recordName))return me.CurrentScrum="All"==recordName?null:_.find(me.LeafProjects,function(p){return p.data.Name==recordName}),me._redrawEverything()},_loadScrumPicker:function(){var me=this;me.TrainRecord&&(me.ScrumPicker=Ext.getCmp("controlsContainer").add({xtype:"intelcombobox",width:200,padding:"0 0 0 40px",fieldLabel:"Scrum:",labelWidth:50,store:Ext.create("Ext.data.Store",{fields:["Name"],data:[{Name:"All"}].concat(_.map(_.sortBy(me.LeafProjects,function(s){return s.data.Name}),function(p){return{Name:p.data.Name}}))}),displayField:"Name",value:me.CurrentScrum?me.CurrentScrum.data.Name:"All",listeners:{select:me._scrumPickerSelected.bind(me)}}))},_getProjectStoriesForGrid:function(project,grid){return _.filter(grid.originalConfig.data,function(story){return story.data.Project.ObjectID==project.data.ObjectID})},_getProjectStoriesForRelease:function(project,grid){return _.filter(grid.originalConfig.totalStories,function(story){return story.data.Project.ObjectID==project.data.ObjectID})},_getProjectPointsForGrid:function(project,grid){return _.reduce(this._getProjectStoriesForGrid(project,grid),function(sum,story){return sum+story.data.PlanEstimate},0)},_getProjectPointsForRelease:function(project,grid){return _.reduce(this._getProjectStoriesForRelease(project,grid),function(sum,story){return sum+story.data.PlanEstimate},0)},_buildIntegrityIndicator:function(){var me=this,userStoryGrids=_.filter(Ext.getCmp("gridsContainer").query("rallygrid"),function(grid){return"UserStory"==grid.originalConfig.model}).reverse(),storyNum={},storyDen=userStoryGrids[0].originalConfig.totalCount,pointNum,pointDen=userStoryGrids[0].originalConfig.totalPoints,storyPer,pointPer;_.each(userStoryGrids,function(grid){_.each(grid.originalConfig.data,function(item){storyNum[item.data.ObjectID]=item.data.PlanEstimate})}),pointNum=(100*(pointDen-_.reduce(storyNum,function(sum,planEstimate){return sum+planEstimate},0))>>0)/100,storyNum=storyDen-Object.keys(storyNum).length,storyPer=(1e4*(storyNum/storyDen)>>0)/100,pointPer=(1e4*(pointNum/pointDen)>>0)/100,me.IntegrityIndicator=Ext.getCmp("controlsContainer").add({xtype:"container",id:"integrityIndicator",padding:"5px 20px 0 0",flex:1,layout:{type:"hbox",pack:"end"},items:[{xtype:"container",html:'<span class="integrity-inticator-title">'+(me.CurrentScrum?me.CurrentScrum.data.Name:me.TrainRecord.data.Name)+" Integrity <em>(% Correct)</em></span><br/>"+'<span class="integrity-indicator-value"><b>Stories: </b>'+storyNum+"/"+storyDen+" <em>("+storyPer+"%)</em></span><br/>"+'<span class="integrity-indicator-value"><b>Points: </b>'+pointNum+"/"+pointDen+" <em>("+pointPer+"%)<em/></span>"}]})},_onHeatmapClick:function(point,scrum,grid){var me=this,panelWidth=320,rect=point.graphic.element.getBoundingClientRect(),leftSide=rect.left,topSide=rect.top,x=point.x,y=point.y,storyDen=me._getProjectStoriesForRelease(scrum,grid).length,storyNum=me._getProjectStoriesForGrid(scrum,grid).length,pointDen=(100*me._getProjectPointsForRelease(scrum,grid)>>0)/100,pointNum=(100*me._getProjectPointsForGrid(scrum,grid)>>0)/100,storyPer=(1e4*storyNum/storyDen>>0)/100,pointPer=(1e4*pointNum/pointDen>>0)/100;return me.tooltip&&me.tooltip.x==x&&me.tooltip.y==y?me._clearToolTip():(me._clearToolTip(),me.tooltip={x:x,y:y,panel:Ext.widget("container",{floating:!0,width:panelWidth,autoScroll:!1,id:"HeatmapTooltipPanel",cls:"intel-tooltip",focusOnToFront:!1,shadow:!1,renderTo:Ext.getBody(),items:[{xtype:"container",layout:"hbox",cls:"intel-tooltip-inner-container",items:[{xtype:"container",cls:"intel-tooltip-inner-left-container",flex:1,items:[{xtype:"rallygrid",columnCfgs:[{dataIndex:"Label",width:60,draggable:!1,sortable:!1,resizable:!1,editable:!1},{text:"Outstanding",dataIndex:"Outstanding",width:85,draggable:!1,sortable:!1,resizable:!1,editable:!1},{text:"Total",dataIndex:"Total",width:60,draggable:!1,sortable:!1,resizable:!1,editable:!1},{text:"% Problem",dataIndex:"Percent",width:70,draggable:!1,sortable:!1,resizable:!1,editable:!1}],store:Ext.create("Rally.data.custom.Store",{data:[{Label:"Stories",Outstanding:storyNum,Total:storyDen,Percent:storyPer+"%"},{Label:"Points",Outstanding:pointNum,Total:pointDen,Percent:pointPer+"%"}]}),showPagingToolbar:!1,showRowActionsColumn:!1},{xtype:"button",id:"heatmap-tooltip-goto-button",text:"GO TO THIS GRID",handler:function(){me._clearToolTip(),me.CurrentScrum&&me.CurrentScrum.data.ObjectID==scrum.data.ObjectID?Ext.get(grid.originalConfig.id).scrollIntoView(me.el):(me.CurrentScrum=scrum,me.ScrumPicker.setValue(scrum.data.Name),me._redrawEverything().then(function(){Ext.get(grid.originalConfig.id).scrollIntoView(me.el)}).done())}}]},{xtype:"button",cls:"intel-tooltip-close",text:"X",width:20,handler:function(){me._clearToolTip()}}]}],listeners:{afterrender:function(panel){panel.setPosition(leftSide-panelWidth,topSide)}}})},me.tooltip.triangle=Ext.widget("container",{floating:!0,width:0,height:0,focusOnToFront:!1,shadow:!1,renderTo:Ext.getBody(),listeners:{afterrender:function(panel){setTimeout(function(){panel.addCls("intel-tooltip-triangle"),panel.setPosition(leftSide-10,topSide)},10)}}}),void 0)},_getHeatMapConfig:function(){var me=this,highestNum=0,userStoryGrids=_.filter(Ext.getCmp("gridsContainer").query("rallygrid"),function(grid){return"UserStory"==grid.originalConfig.model}).reverse(),chartData=[],selectScrumFunctionName="_selectScrum"+(1e4*Math.random()>>0),selectIdFunctionName="_selectId"+(1e4*Math.random()>>0);return _.each(userStoryGrids,function(grid,gindex){_.each(_.sortBy(me.LeafProjects,function(p){return p.data.Name}),function(project,pindex){var gridCount=me._getProjectStoriesForGrid(project,grid).length;highestNum=Math.max(gridCount,highestNum),chartData.push([pindex,gindex,gridCount])})}),window[selectScrumFunctionName]=function(value){var scrum=_.find(me.LeafProjects,function(p){return p.data.Name.split("-")[0].trim()===value});me.CurrentScrum&&scrum.data.ObjectID==me.CurrentScrum.data.ObjectID?(me.CurrentScrum=null,me.ScrumPicker.setValue("All")):(me.CurrentScrum=scrum,me.ScrumPicker.setValue(scrum.data.Name)),me._clearToolTip(),me._redrawEverything()},window[selectIdFunctionName]=function(gridId){Ext.get(gridId).scrollIntoView(me.el)},{chart:{type:"heatmap",height:420,marginTop:10,marginLeft:140,marginBottom:80},colors:["#AAAAAA"],title:{text:null},xAxis:{categories:_.sortBy(_.map(me.LeafProjects,function(project){return project.data.Name.split("-")[0].trim()}),function(p){return p}),labels:{style:{width:100},formatter:function(){var text=this.value;return me.CurrentScrum&&0===me.CurrentScrum.data.Name.indexOf(this.value)&&(text='<span class="curscrum">'+this.value+"</span>"),'<a class="heatmap-xlabel" onclick="'+selectScrumFunctionName+"('"+this.value+"');\">"+text+"</a>"},useHTML:!0,rotation:-45}},yAxis:{categories:_.map(userStoryGrids,function(grid){return grid.originalConfig.title}),title:null,labels:{formatter:function(){var text=this.value,index=_.indexOf(this.axis.categories,text),gridID=userStoryGrids[index].originalConfig.id,styleAttr='style="background-color:'+me._colors[userStoryGrids.length-index-1]+'"';return'<div class="heatmap-ylabel"'+styleAttr+' onclick="'+selectIdFunctionName+"('"+gridID+"')\">"+text+"</div>"},useHTML:!0}},colorAxis:{min:0,minColor:"#FFFFFF",maxColor:highestNum?"#ec5b5b":"#FFFFFF"},plotOptions:{series:{point:{events:{click:function(e){var point=this,scrum=_.sortBy(me.LeafProjects,function(p){return p.data.Name})[point.x],grid=userStoryGrids[point.y];me._onHeatmapClick(point,scrum,grid)}}}}},legend:{enabled:!1},tooltip:{enabled:!1},series:[{name:"Errors per Violation per Scrum",borderWidth:1,data:chartData,dataLabels:{enabled:!0,color:"black",style:{textShadow:"none"}}}]}},_getPieChartConfig:function(){var me=this,chartData=_.map(Ext.getCmp("gridsContainer").query("rallygrid"),function(grid){return{name:grid.originalConfig.title,y:grid.originalConfig.data.length,totalCount:grid.originalConfig.totalCount,gridID:grid.originalConfig.id,model:grid.originalConfig.model}});return _.every(chartData,function(item){return 0===item.y})&&(chartData=[{name:"Everything is correct!",y:1,totalCount:1,color:"#2ECC40",model:""}]),{chart:{height:420,marginLeft:-15,plotBackgroundColor:null,plotBorderWidth:0,plotShadow:!1},colors:me._colors,title:{text:null},tooltip:{enabled:!1},plotOptions:{pie:{dataLabels:{enabled:!0,distance:25,crop:!1,overflow:"none",formatter:function(){var str="<b>"+this.point.name+"</b>: "+this.point.y;return str+"/"+this.point.totalCount},style:{cursor:"pointer",color:"black"}},startAngle:10,endAngle:170,center:["0%","50%"]}},series:[{type:"pie",name:"Grid Count",innerSize:"25%",size:260,point:{events:{click:function(e){e.point.gridID&&Ext.get(e.point.gridID).scrollIntoView(me.el),e.preventDefault()}}},data:chartData}]}},_hideHighchartsLinks:function(){$(".highcharts-container > svg > text:last-child").hide()},_buildRibbon:function(){var me=this;$("#pie").highcharts(me._getPieChartConfig()),me.TrainRecord?($("#heatmap").highcharts(me._getHeatMapConfig()),me._hideHighchartsLinks()):me._hideHighchartsLinks()},_getFilteredStories:function(){var me=this;return me.TrainRecord?me.CurrentScrum?_.filter(me.UserStoryStore.getRange(),function(item){return item.data.Project.ObjectID==me.CurrentScrum.data.ObjectID}):me.UserStoryStore.getRange():me.UserStoryStore.getRange()},_getFilteredLowestPortfolioItems:function(){return this.LowestPortfolioItemStore?this.LowestPortfolioItemStore.getRange():[]},_addGrid:function(gridConfig){var me=this,lowestPortfolioItemType=me.PortfolioItemTypes[0],randFunctionName="_scrollToTop"+(1e4*Math.random()>>0);window[randFunctionName]=function(){Ext.get("controlsContainer").scrollIntoView(me.el)};var getGridTitleLink=function(data,model){var storyNum=data&&data.length,storyDen=gridConfig.totalCount,pointNum=data&&(100*_.reduce(data,function(sum,item){return sum+item.data.PlanEstimate},0)>>0)/100,pointDen=gridConfig.totalPoints,type="UserStory"===model?"Stories":lowestPortfolioItemType+"s";return'<span class="data-integrity-grid-header-left">'+gridConfig.title+(data?"<br>":"")+'<span class="data-integrity-grid-header-stats">'+(data?"<b>"+type+":</b> "+storyNum+"/"+storyDen+" ("+(1e4*(storyNum/storyDen)>>0)/100+"%)":"")+(data&&"UserStory"==model?"<br><b>Points:</b> "+pointNum+"/"+pointDen+"  ("+(1e4*(pointNum/pointDen)>>0)/100+"%)":"")+"</span>"+"</span>"+'<span class="data-integrity-grid-header-top-link"><a onclick="'+randFunctionName+'()">Top</a></span>'},storeModel="UserStory"==gridConfig.model?me.UserStoryStore.model:me.LowestPortfolioItemStore.model,grid=Ext.getCmp("grids"+gridConfig.side).add(gridConfig.data.length?Ext.create("Rally.ui.grid.Grid",{title:getGridTitleLink(gridConfig.data,gridConfig.model),id:gridConfig.id,cls:"grid-unhealthy data-integrity-grid rally-grid",columnCfgs:gridConfig.columns,showPagingToolbar:!0,showRowActionsColumn:!0,enableBulkEdit:!0,emptyText:" ",originalConfig:gridConfig,gridContainer:Ext.getCmp("grids"+gridConfig.side),pagingToolbarCfg:{pageSizes:[10,15,25,100],autoRender:!0,resizable:!1},store:Ext.create("Rally.data.custom.Store",{model:storeModel,pageSize:10,data:gridConfig.data})}):Ext.create("Rally.ui.grid.Grid",{xtype:"rallygrid",title:getGridTitleLink(),id:gridConfig.id,cls:" data-integrity-grid grid-healthy",showPagingToolbar:!1,showRowActionsColumn:!1,emptyText:"0 Problems!",originalConfig:gridConfig,gridContainer:Ext.getCmp("grids"+gridConfig.side),store:Ext.create("Rally.data.custom.Store",{data:[]})}));return grid},_buildGrids:function(){var me=this,filteredStories=me._getFilteredStories(),filteredLowestPortfolioItems=me._getFilteredLowestPortfolioItems(),lowestPortfolioItemType=me.PortfolioItemTypes[0],releaseName=me.ReleaseRecord.data.Name,releaseDate=new Date(me.ReleaseRecord.data.ReleaseDate),releaseStartDate=new Date(me.ReleaseRecord.data.ReleaseStartDate),now=new Date,defaultUserStoryColumns=[{text:"FormattedID",dataIndex:"FormattedID",editor:!1},{text:"Name",dataIndex:"Name",editor:!1}].concat(me.CurrentScrum?[]:[{text:"Scrum",dataIndex:"Project",editor:!1}]),defaultLowestPortfolioItemColumns=[{text:"FormattedID",dataIndex:"FormattedID",editor:!1},{text:"Name",dataIndex:"Name",editor:!1},{text:"PlannedEndDate",dataIndex:"PlannedEndDate",editor:!1}],gridConfigs=[{showIfLeafProject:!0,title:"Blocked Stories",id:"grid-blocked-stories",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"Blocked",dataIndex:"Blocked"},{text:"BlockedReason",dataIndex:"BlockedReason",tdCls:"editor-cell"},{text:"Days Blocked",tdCls:"editor-cell",editor:!1,renderer:function(val,meta,record){var day=864e5;return(1*new Date-1*new Date(record.data.Blocker.CreationDate))/day>>0}}]),side:"Left",filterFn:function(item){return item.data.Release&&item.data.Release.Name==releaseName?item.data.Blocked:!1}},{showIfLeafProject:!0,title:"Unsized Stories",id:"grid-unsized-stories",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"PlanEstimate",dataIndex:"PlanEstimate",tdCls:"editor-cell"}]),side:"Left",filterFn:function(item){return item.data.Release&&item.data.Release.Name==releaseName?null===item.data.PlanEstimate:!1}},{showIfLeafProject:!0,title:"Improperly Sized Stories",id:"grid-improperly-sized-stories",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"PlanEstimate",dataIndex:"PlanEstimate",tdCls:"editor-cell"}]),side:"Left",filterFn:function(item){if(!item.data.Release||item.data.Release.Name!=releaseName)return!1;if(0===item.data.Children.Count)return!1;var pe=item.data.PlanEstimate;return 0!==pe&&1!==pe&&2!==pe&&4!==pe&&8!==pe&&16!==pe}},{showIfLeafProject:!0,title:"Stories in Release without Iteration",id:"grid-stories-in-release-without-iteration",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"Iteration",dataIndex:"Iteration",tdCls:"editor-cell"}]),side:"Left",filterFn:function(item){return item.data.Release&&item.data.Release.Name==releaseName?!item.data.Iteration:!1}},{showIfLeafProject:!0,title:"Stories in Current Sprint With No Description",id:"grid-stories-no-description-current-sprint",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"Description",dataIndex:"Description",tdCls:"editor-cell"}]),side:"Left",filterFn:function(item){return item.data.Release&&item.data.Release.Name==releaseName?item.data.Iteration?now>=new Date(item.data.Iteration.StartDate)&&new Date(item.data.Iteration.EndDate)>=now&&!item.data.Description:!1:!1}},{showIfLeafProject:!0,title:"Stories in Iteration not attached to Release",id:"grid-stories-in-iteration-not-attached-to-release",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"Iteration",dataIndex:"Iteration",tdCls:"editor-cell"},{text:"Release",dataIndex:"Release",tdCls:"editor-cell"}]),side:"Right",filterFn:function(item){return!item.data.Iteration||item.data.Release?!1:releaseDate>new Date(item.data.Iteration.StartDate)&&new Date(item.data.Iteration.EndDate)>releaseStartDate}},{showIfLeafProject:!0,title:"Unaccepted Stories in Past Iterations",id:"grid-unaccepted-stories-in-past-iterations",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"Iteration",dataIndex:"Iteration",editor:!1},{text:"ScheduleState",dataIndex:"ScheduleState",tdCls:"editor-cell"}]),side:"Right",filterFn:function(item){return item.data.Release&&item.data.Release.Name==releaseName?item.data.Iteration?now>new Date(item.data.Iteration.EndDate)&&"Accepted"!=item.data.ScheduleState:!1:!1}},{showIfLeafProject:!0,title:"Stories with End Date past "+lowestPortfolioItemType+" End Date",id:"grid-stories-with-end-past-"+lowestPortfolioItemType+"-end",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"Iteration",dataIndex:"Iteration",editor:!1},{text:lowestPortfolioItemType,dataIndex:"PortfolioItem",editor:!1}]),side:"Right",filterFn:function(item){return item.data.Release&&item.data.Release.Name==releaseName?item.data.Iteration&&item.data.PortfolioItem&&(item.data.PortfolioItem.PlannedEndDate||item.data.PortfolioItem.ActualEndDate)&&item.data.Iteration.EndDate?new Date(item.data.PortfolioItem.PlannedEndDate||item.data.PortfolioItem.ActualEndDate)<new Date(item.data.Iteration.EndDate):!1:!1}},{showIfLeafProject:!0,title:"Stories in Current Sprint With No Task",id:"grid-stories-no-task-current-sprint",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"",renderer:function(value,meta,record){return'<a target="_blank" href="https://rally1.rallydev.com/#/'+record.data.Project.ObjectID+"ud/detail/task/new?WorkProduct=/hierarchicalrequirement/"+record.data.ObjectID+'">Add Task</a>'}}]),side:"Right",filterFn:function(item){return item.data.Release&&item.data.Release.Name==releaseName?item.data.Iteration?now>=new Date(item.data.Iteration.StartDate)&&new Date(item.data.Iteration.EndDate)>=now&&0===item.data.Tasks.Count:!1:!1}},{showIfLeafProject:!1,title:"Features with No Stories",id:"grid-features-with-no-stories",model:"PortfolioItem/"+lowestPortfolioItemType,columns:defaultLowestPortfolioItemColumns,side:"Right",filterFn:function(item){return item.data.Release&&item.data.Release.Name==releaseName?0===item.data.UserStories.Count:!1}}];return Q.all(_.map(gridConfigs,function(gridConfig){if(me.CurrentScrum&&!gridConfig.showIfLeafProject)return Q();var list="UserStory"==gridConfig.model?filteredStories:filteredLowestPortfolioItems;return gridConfig.data=_.filter(list,gridConfig.filterFn),gridConfig["total"+("UserStory"==gridConfig.model?"Stories":lowestPortfolioItemType+"s")]=list,gridConfig.totalCount=list.length,gridConfig.totalPoints=(100*_.reduce(list,function(sum,item){return sum+item.data.PlanEstimate},0)>>0)/100,me._addGrid(gridConfig)})).fail(function(reason){me._alert("ERROR:",reason)})}})})();

            Rally.launchApp('DataIntegrityDashboard', {
                name:"Data Integrity Dashboard",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .x-grid-cell.intel-editor-cell *,.x4-grid-cell.intel-editor-cell *,.intel-editor-cell{cursor:pointer !important}.fa.fa-md{font-size:1.05rem;line-height:.75em;vertical-align:-15%}
    </style>
    <style type="text/css">
        .intel-tooltip{padding:10px;background-color:#C0D9FA;border-radius:8px;z-index:500;box-shadow:-3px 3px 3px}.intel-tooltip p{margin:2px 0 2px 0}.intel-tooltip ol{margin:2px 0 2px 0;padding-left:20px}.intel-tooltip-triangle{border-left:10px solid transparent;border-right:10px solid transparent;border-top:10px solid #C0D9FA;height:0px;width:0px;z-index:500}.intel-tooltip-triangle-up{border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:10px solid #C0D9FA;height:0px;width:0px;z-index:500}.intel-tooltip-close{padding:0 0 2px 0;font-weight:bold;margin-left:5px;margin-top:-5px;border-radius:10px}.intel-tooltip-inner-container,.intel-tooltip-inner-container *{overflow:visible}.intel-tooltip-inner-left-container{overflow:hidden}
    </style>
    <style type="text/css">
        .app{margin:0;padding:0;width:100%;overflow-x:hidden !important}.ribbon{margin:10px 0 0 0;padding:0;width:98%;height:430px;border:1px solid #AAA}.grids-container{margin:10px 0 0 0;padding:0;position:relative !important;width:98%}.grids-container .grids-left{margin-right:5px;position:absolute !important;left:0}.grids-container .grids-right{margin-left:5px;position:absolute !important;right:0}.data-integrity-grid{border:2px solid #AAA;padding:0;margin:0 0 5px 0}.grid-healthy.data-integrity-grid .x-panel-header,.grid-healthy.data-integrity-grid .x4-panel-header{font-weight:bold;background-color:rgba(0,255,0,0.4) !important}.grid-unhealthy.data-integrity-grid .x-panel-header,.grid-unhealthy.data-integrity-grid .x4-panel-header{font-weight:bold;background-color:rgba(255,0,0,0.4) !important}.data-integrity-grid .grid-pager{margin:3px !important}.data-integrity-grid .editor-cell,.data-integrity-grid .editor-cell *{cursor:pointer !important}.data-integrity-grid.rally-grid .x-grid-row-over .editable.rally-edit-cell:not(.editor-cell):hover,.data-integrity-grid.rally-grid .x4-grid-row-over .editable.rally-edit-cell:not(.editor-cell):hover{background-image:none}.data-integrity-grid-header-left{float:left;font-size:1rem}.data-integrity-grid-header-stats{font-size:12px}.data-integrity-grid-header-top-link{float:right;cursor:pointer;font-weight:bold;font-size:0.8rem}.data-integrity-grid .x-grid-cell-inner,.data-integrity-grid .x4-grid-cell-inner{white-space:normal}.highcharts-container{overflow:visible !important}.my-heatmap-tooltip{z-index:10000;border-radius:2px;padding:5px;border:1px solid gray;background:lightgray}.heatmap-xlabel{white-space:nowrap;z-index:100;cursor:pointer}.heatmap-xlabel:hover{color:blue}.heatmap-xlabel .curscrum{font-weight:bolder;font-size:1.1em}.heatmap-ylabel{white-space:normal;width:134px;height:35px;text-align:center;display:flex;border-bottom-left-radius:5px;border-top-left-radius:5px;justify-content:center;align-items:center;font-size:0.65rem;cursor:pointer;padding:0 2px 0 2px;margin:0}.integrity-inticator-title{font-size:1.1rem;padding-right:5px;text-decoration:underline}.integrity-indicator-value{font-size:1rem}#heatmap-tooltip-goto-button{margin-top:5px}
    </style>
</head>
<body>
</body>
</html>
