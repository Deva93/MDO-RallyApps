<!DOCTYPE html>
<html>
<head>
    <title>Random App Name70221</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Skirtle.CTemplate",{extend:"Ext.XTemplate",statics:{AUTO_ID:0},copyDepth:10,cTpl:'<p id="ctemplate-{0}-{1}"></p>',isCTemplate:!0,constructor:function(){var me=this;me.callParent(arguments),me.id=++me.statics().AUTO_ID,me.reset()},copyValues:function(values,depth){var me=this,id,copy={},copyDepth=depth||me.copyDepth;return 1===copyDepth?values:Ext.isArray(values)?Ext.Array.map(values,function(value){return me.copyValues(value,copyDepth-1)}):Ext.isObject(values)?values.isComponent?(id=values.getId(),me.ids.push(id),Ext.String.format(me.cTpl,id,me.id)):(Ext.Object.each(values,function(key,value){copy[key]="$comp"===key?value:me.copyValues(value,copyDepth-1)}),copy):values},doInsert:function(){var ret=this.callParent(arguments);return this.injectComponents(),ret},doPolling:function(interval){var me=this;me.pollInterval=interval,me.pollId&&clearTimeout(me.pollId),me.pollId=Ext.defer(me.injectComponents,interval,me)},getPlaceholderEl:function(id){return Ext.get("ctemplate-"+id+"-"+this.id)},injectComponents:function(){for(var me=this,ids=me.ids,index=ids.length-1,id,cmp,placeholderEl;index>=0;--index)id=ids[index],cmp=Ext.getCmp(id),placeholderEl=me.getPlaceholderEl(id),(me.renderComponent(cmp,placeholderEl)||!cmp)&&(Ext.Array.splice(ids,index,1),placeholderEl&&placeholderEl.remove());ids.length&&me.doPolling(1.5*me.pollInterval)},overwrite:function(el){var dom,firstChild,ret;if(Ext.isIE)for(dom=Ext.getDom(el);dom.firstChild;)dom.removeChild(dom.firstChild);return ret=this.callParent(arguments),this.injectComponents(),ret},renderComponent:function(cmp,placeholderEl){if(cmp&&placeholderEl){var parent=placeholderEl.parent();return cmp.rendered?cmp.getEl().replace(placeholderEl):cmp.render(parent,placeholderEl),Ext.isIE6&&parent.repaint(),!0}return!1},reset:function(){var me=this;me.ids=[],me.pollId&&(clearTimeout(me.pollId),me.pollId=null)}},function(ctemplate){var apply=function(){var me=this,args=Ext.Array.slice(arguments);return args[0]=me.copyValues(args[0]),me.doPolling(10),me.callParent(args)};ctemplate.prototype.applyOut?ctemplate.override({applyOut:apply}):(ctemplate.override({applyTemplate:apply}),ctemplate.createAlias("apply","applyTemplate"))}),Ext.define("Skirtle.grid.column.Component",{alias:"widget.componentcolumn",extend:"Ext.grid.column.Column",requires:["Skirtle.CTemplate"],autoWidthComponents:!0,componentGC:!0,hasCustomRenderer:!0,lastFrameWidth:12,widthUpdateDelay:[10,400],constructor:function(cfg){var me=this;me.callParent(arguments),me.compIds=[],me.dataIndex=me.dataIndex||Ext.id(null,"cc-dataIndex-"),me.tpl=me.createTemplate(me.tpl),me.renderer=me.createRenderer(me.renderer),me.registerColumnListeners()},addRefOwner:function(child){var me=this,fn=me.refOwnerFn||(me.refOwnerFn=function(){return me});40200>me.extVersion?child.getBubbleTarget=fn:child.getRefOwner=fn},applyTemplate:function(data,value){return Ext.isDefined(value)&&(data[this.dataIndex]=value),this.tpl.apply(data)},beforeViewRefresh:function(){if(Ext.isIE)for(var ids=this.compIds,index=0,len=ids.length,item,el,parentEl;len>index;index++)(item=Ext.getCmp(ids[index]))&&(el=item.getEl())&&(el=el.dom)&&(parentEl=el.parentNode)&&parentEl.removeChild(el)},calculateFrameWidth:function(component){var el=component.getEl(),parentDiv=el&&el.parent(),parentTd=parentDiv&&parentDiv.parent();return parentTd?this.lastFrameWidth=parentDiv.getFrameWidth("lr")+parentTd.getFrameWidth("lr"):void 0},createRenderer:function(renderer){var me=this;return function(value,p,record){var data=Ext.apply({},record.data,record.getAssociatedData());return renderer&&(value=renderer.apply(this,arguments)),value=me.processValue(value),me.applyTemplate(data,value)}},createTemplate:function(tpl){return tpl&&tpl.isTemplate?tpl:Ext.create("Skirtle.CTemplate",tpl||["{",this.dataIndex,"}"])},destroyChild:function(child){child.destroy()},getRefItems:function(deep){for(var items=this.callParent([deep]),ids=this.compIds,index=0,len=ids.length,item;len>index;index++)item=Ext.getCmp(ids[index]),item&&(items.push(item),deep&&item.getRefItems&&items.push.apply(items,item.getRefItems(!0)));return items},onChildAfterRender:function(child){this.resizeChild(child)},onChildBoxReady:function(child){this.resizeChild(child,!1)},onChildDestroy:function(child){Ext.Array.remove(this.compIds,child.getId())},onChildResize:function(){this.redoScrollbars()},onColumnResize:function(column){column.resizeAll()},onColumnShow:function(column){column.resizeAll()},onColumnVisibilityChange:function(column){var items=column.getRefItems(),index=0,length=items.length,visible=!column.isHidden();for(Ext.suspendLayouts&&Ext.suspendLayouts();length>index;++index)items[index].setVisible(visible);Ext.resumeLayouts&&Ext.resumeLayouts(!0)},onDestroy:function(){Ext.destroy(this.getRefItems()),this.callParent()},onRender:function(){this.registerViewListeners(),this.callParent(arguments)},onViewChange:function(){var me=this,tpl=me.tpl;me.suspendResizing(),tpl.isCTemplate&&(tpl.injectComponents(),tpl.reset()),me.redoScrollbars(),me.resumeResizing(),me.performGC()},performGC:function(){for(var compIds=this.compIds,index=compIds.length-1,comp,el;index>=0;--index)comp=Ext.getCmp(compIds[index]),el=comp&&comp.getEl(),el&&(!this.componentGC||el.dom&&Ext.getDom(Ext.id(el))===el.dom)||comp&&!comp.isDestroyed&&comp.destroy()},processValue:function(value){var me=this,compIds=me.compIds,id,initialWidth,dom,parent;return Ext.isObject(value)&&!value.isComponent&&value.xtype&&(value=Ext.widget(value.xtype,value)),value&&value.isComponent&&(id=value.getId(),Ext.Array.contains(compIds,id)||compIds.push(id),me.addRefOwner(value),me.registerListeners(value),value.rendered?Ext.isIE&&(dom=value.el.dom,parent=dom.parentNode,parent&&(40101===me.extVersion&&Ext.core.DomHelper.insertBefore(dom,{tag:"p"}),parent.removeChild(dom))):me.autoWidthComponents&&(initialWidth=me.getWidth()-me.lastFrameWidth,initialWidth=initialWidth>4?initialWidth:4,value.setWidth(initialWidth)),(Ext.isIE6||Ext.isIE7)&&me.isHidden()&&value.hide()),value},redoScrollbars:function(){var me=this,grid=me.up("tablepanel");if(grid){if(me.resizeQueue)return me.redoScrollbarsRequired=!0,void 0;40100>me.extVersion?(grid.invalidateScroller(),grid.determineScrollbars()):grid.doLayout()}},registerColumnListeners:function(){var me=this;me.autoWidthComponents&&(me.on("resize",me.onColumnResize),me.on("show",me.onColumnShow)),(Ext.isIE6||Ext.isIE7)&&me.on({hide:me.onColumnVisibilityChange,show:me.onColumnVisibilityChange})},registerListeners:function(component){var me=this;component.on("destroy",me.onChildDestroy,me),me.autoWidthComponents&&(component.on("afterrender",me.onChildAfterRender,me,{single:!0}),me.extVersion>=40100&&component.on("boxready",me.onChildBoxReady,me,{single:!0})),component.on("resize",me.onChildResize,me)},registerViewListeners:function(){var me=this,view=me.up("tablepanel").getView();me.mon(view,"beforerefresh",me.beforeViewRefresh,me),me.mon(view,"refresh",me.onViewChange,me),me.mon(view,"itemupdate",me.onViewChange,me),me.mon(view,"itemadd",me.onViewChange,me),me.mon(view,"itemremove",me.onViewChange,me)},resizeAll:function(){var me=this;me.suspendResizing(),me.resizeQueue=me.getRefItems(),me.resumeResizing()},resizeChild:function(component,defer){var me=this,frameWidth,newWidth,oldWidth,resizeQueue;return me.resizingSuspended?(resizeQueue=me.resizeQueue,Ext.Array.contains(resizeQueue,component)||resizeQueue.push(component),void 0):(frameWidth=me.calculateFrameWidth(component),Ext.isNumber(frameWidth)&&(newWidth=me.getWidth()-frameWidth,oldWidth=component.getWidth(),me.setChildWidth(component,newWidth,oldWidth)&&defer!==!1&&Ext.each(me.widthUpdateDelay,function(delay){Ext.defer(me.resizeChild,delay,me,[component,!1])})),void 0)},resumeResizing:function(){var me=this,index=0,resizeQueue=me.resizeQueue,len=resizeQueue.length;if(!--me.resizingSuspended){for(;len>index;++index)me.resizeChild(resizeQueue[index]);me.resizeQueue=null,me.redoScrollbarsRequired&&me.redoScrollbars()}},setChildWidth:function(component,newWidth,oldWidth){return oldWidth===newWidth?!1:(component.setWidth(newWidth),!0)},suspendResizing:function(){var me=this;me.resizingSuspended=(me.resizingSuspended||0)+1,me.resizeQueue||(me.resizeQueue=[])}},function(cls){var proto=cls.prototype,version=Ext.getVersion();proto.extVersion=100*(100*version.getMajor()+version.getMinor())+version.getPatch(),Ext.Element.prototype.syncContent&&"4.1.0"==""+version&&(proto.extVersion=40101)}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:"absolute",height:1320,width:1320,_showError:function(text){this.errMessage&&this.remove(this.errMessage),this.errMessage=this.add({xtype:"text",text:text})},_loadModels:function(cb){var me=this;Rally.data.ModelFactory.getModel({type:"Project",scope:me,success:function(model){me.Project=model,Rally.data.ModelFactory.getModel({type:"HierarchicalRequirement",scope:me,success:function(model){me.UserStory=model,cb()}})}})},_loadProject:function(project,cb){var me=this;me.Project.load(project.ObjectID,{fetch:["ObjectID","Releases","Children","Parent","Name","_ref"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:function(record,operation){operation.wasSuccessful()?cb(record):me._showError("failed to retreive project: "+project.ObjectID)}})},_loadReleases:function(cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,limit:1/0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:me.TrainRecord.data.ObjectID},{property:"Name",operator:"contains",value:me.TrainRecord.data.Name.split(" ART ")[0]}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),me.ReleaseStore=releaseStore,cb()},single:!0}}})},_projectInWhichTrain:function(projectRecord,cb){var me=this;projectRecord||cb();var split=projectRecord.get("Name").split(" ART ");if(split.length>1)cb(projectRecord);else{var parent=projectRecord.get("Parent");parent?me._loadProject(parent,function(parentRecord){me._projectInWhichTrain(parentRecord,cb)}):cb()}},_getCurrentOrFirstRelease:function(){var me=this,d=new Date,rs=me.ReleaseStore.getRecords();if(rs.length){for(var i=0;rs.length>i;++i)if(new Date(rs[i].get("ReleaseDate"))>=d&&d>=new Date(rs[i].get("ReleaseStartDate")))return rs[i];return rs[0]}},_loadValidProjects:function(cb){function loadChildren(project,_cb){Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,remoteSort:!1,limit:1/0,fetch:["Name","ObjectID","Parent"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Parent.ObjectID",value:project.get("ObjectID")}],listeners:{load:{fn:function(projectStore,projectRecords){if(0===projectRecords.length)scrums.push(project),_cb();else{var finished=0,done=function(){++finished===projectRecords.length&&_cb()};projectRecords.forEach(function(c){loadChildren(c,function(){done()})})}},single:!0}}})}var me=this,scrums=[];Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,remoteSort:!1,pageSize:1,limit:1,fetch:["Name","ObjectID"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:"All Scrums"}],listeners:{load:{fn:function(ps,recs){loadChildren(recs[0],function(){me.ValidProjects=scrums,me.ProjectNames=_.map(scrums,function(s){return{Name:s.get("Name")}}),console.log("valid scrums loaded:",scrums),cb()})},single:!0}}})},_loadRisksFeatures:function(cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,limit:1/0,remoteSort:!1,fetch:["Name","ObjectID","FormattedID","c_Risks"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:me.ReleaseRecord.get("Name")}],listeners:{load:{fn:function(featureStore,featureRecords){console.log("risks features loaded:",featureRecords),me.RisksFeatureStore=featureStore,me._parseRisksData(),cb()},single:!0}}})},_parseRisksData:function(){function getRisks(featureRecord){var risks=featureRecord.get("c_Risks");try{risks=JSON.parse(risks)||{}}catch(e){risks={}}return risks}function getProject(projectID){return _.find(me.ValidProjects,function(project){return project.get("ObjectID")==projectID})}var me=this,array=[];_.each(me.RisksFeatureStore.getRecords(),function(featureRecord){var risks=getRisks(featureRecord);for(var projectID in risks){var project=getProject(projectID);for(var riskID in risks[projectID]){var risk=risks[projectID][riskID];array.push({ProjectName:project.get("Name"),RiskID:riskID,FormattedID:featureRecord.get("FormattedID"),FeatureName:featureRecord.get("Name"),Description:risk.Desc,Impact:risk.Imp,Status:risk.Sta,Contact:risk.Cont,Checkpoint:risk.CP,Edited:!1})}}}),me.RisksParsedData=array},_loadDependenciesUserStories:function(cb){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1/0,remoteSort:!1,autoLoad:!0,fetch:["Name","ObjectID","Release","Project","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:me.ReleaseRecord.get("Name")},{property:"c_Dependencies",operator:"!=",value:""}],listeners:{load:{fn:function(userStoryStore,userStoryRecords){console.log("dependencies release user stories loaded:",userStoryRecords),me.DependenciesUserStoryStore=userStoryStore,me._buildDependenciesData(),cb()},single:!0}}})},_getDependencies:function(userStoryRecord){var me=this,dependencies,dependencyString=userStoryRecord.get("c_Dependencies");if(""===dependencyString)dependencies={Preds:{},Succs:[]};else try{dependencies=JSON.parse(dependencyString)}catch(e){dependencies={Preds:{},Succs:[]}}return dependencies},_buildDependenciesData:function(){var me=this,predDepsList=[];_.each(me.DependenciesUserStoryStore.getRecords(),function(userStoryRecord){var projectName=userStoryRecord.get("Project").Name,deps=me._getDependencies(userStoryRecord),preds=deps.Preds;for(var predDepID in preds){var predDep=preds[predDepID];predDepsList.push({ProjectName:projectName,DependencyID:predDepID,FormattedID:userStoryRecord.get("FormattedID"),UserStoryName:userStoryRecord.get("Name"),Description:predDep.Desc,Checkpoint:predDep.CP,Status:predDep.Sta,Predecessors:predDep.Preds||[],Edited:!1})}}),me.DependenciesParsedData={Predecessors:predDepsList}},_defineModels:function(){Ext.define("IntelRisk",{extend:"Ext.data.Model",fields:[{name:"ProjectName",type:"string"},{name:"RiskID",type:"string"},{name:"FormattedID",type:"string"},{name:"FeatureName",type:"string"},{name:"Description",type:"string"},{name:"Impact",type:"string"},{name:"Status",type:"string"},{name:"Contact",type:"string"},{name:"Checkpoint",type:"string"},{name:"Edited",type:"boolean"}]}),Ext.define("IntelDepTeam",{extend:"Ext.data.Model",fields:[{name:"TID",type:"string"},{name:"PID",type:"string"},{name:"Sup",type:"string"},{name:"USID",type:"string"},{name:"USName",type:"string"},{name:"A",type:"boolean"}]}),Ext.define("IntelPredDep",{extend:"Ext.data.Model",fields:[{name:"ProjectName",type:"string"},{name:"DependencyID",type:"string"},{name:"FormattedID",type:"string"},{name:"UserStoryName",type:"string"},{name:"Description",type:"string"},{name:"Checkpoint",type:"string"},{name:"Status",type:"string"},{name:"Predecessors",type:"auto"},{name:"Edited",type:"boolean"}]})},_loadRisksStores:!0,_loadDependenciesStores:!0,_isEditing:!1,_reloadRisksStores:function(){var me=this;me.RisksFeatureStore&&me._loadRisksStores&&me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData(),me._isEditing||me.CustomRisksStore&&me._loadRisksStores&&me.CustomRisksStore.load()}})},_reloadDependenciesStores:function(){var me=this;me.DependenciesUserStoryStore&&me._loadDependenciesStores&&me.DependenciesUserStoryStore.load({callback:function(records,operation){me._buildDependenciesData(),me._isEditing||(me.CustomPredDepStore&&me._loadDependenciesStores&&me.CustomPredDepStore.load(),me.CustomSuccDepStore&&me._loadDependenciesStores&&me.CustomSuccDepStore.load())}})},_reloadEverything:function(){var me=this;me.removeAll(),me._loadRisksStores=!0,me._loadDependenciesStores=!0,me._isEditing=!1,me._loadReleasePicker(),me._loadRisksFeatures(function(){me._loadRisksGrid()}),me._loadDependenciesUserStories(function(){me._loadDependenciesGrids()})},launch:function(){var me=this;me._showError("Loading Data..."),me._defineModels(),setInterval(function(){me._reloadRisksStores()},1e4),setInterval(function(){me._reloadDependenciesStores()},15e3),me._loadModels(function(){me._loadValidProjects(function(){var scopeProject=me.getContext().getProject();me._loadProject(scopeProject,function(scopeProjectRecord){me._projectInWhichTrain(scopeProjectRecord,function(trainRecord){trainRecord?(me.TrainRecord=trainRecord,console.log("train loaded:",trainRecord),me._loadReleases(function(){var currentRelease=me._getCurrentOrFirstRelease();currentRelease?(me.ReleaseRecord=currentRelease,console.log("release loaded",currentRelease),me._reloadEverything()):(me.removeAll(),console.log("This team has no releases"))})):(me.removeAll(),me._showError("Please scope to a valid team for release planning"))})})})})},_loadReleasePicker:function(){var me=this;me.ReleasePicker=me.add({xtype:"combobox",x:0,y:0,store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.ReleaseStore.getRecords(),function(r){return{Name:r.get("Name")}})}),displayField:"Name",fieldLabel:"Release:",editable:!1,value:me.ReleaseRecord.get("Name"),listeners:{select:function(combo,records){me.ReleaseRecord.get("Name")!==records[0].get("Name")&&(me.ReleaseRecord=me.ReleaseStore.findRecord("Name",records[0].get("Name")),setTimeout(function(){me._reloadEverything()},0))}}})},_loadRisksGrid:function(){function getWorkweeks(){var i,oneDay=864e5,startDate=me.ReleaseRecord.get("ReleaseStartDate"),endDate=me.ReleaseRecord.get("ReleaseDate"),sd_year=new Date(startDate.getFullYear(),0,0),sd_diff=startDate-sd_year,sd_day=sd_diff/oneDay,sd_week=Math.ceil(sd_day/7),ed_year=new Date(endDate.getFullYear(),0,0),ed_diff=endDate-ed_year,ed_day=ed_diff/oneDay,ed_week=Math.ceil(ed_day/7),weeks=[];if(sd_week>ed_week){for(i=sd_week;52>=i;++i)weeks.push({Week:"ww"+i});for(i=0;ed_week>=i;++i)weeks.push({Week:"ww"+i})}else for(i=sd_week;ed_week>=i;++i)weeks.push({Week:"ww"+i});return weeks}function removeRiskFromList(riskID,riskList){for(var i=0;riskList.length>i;++i)if(riskList[i].RiskID==riskID)return riskList.splice(i,1)[0]}function getRisks(featureRecord){var risks=featureRecord.get("c_Risks");try{risks=JSON.parse(risks)||{}}catch(e){risks={}}return risks}function removeRisk(featureRecord,riskData,cb){var risks=getRisks(featureRecord),project=_.find(me.ValidProjects,function(project){return project.get("Name")===riskData.ProjectName}),projectID=project.get("ObjectID");risks[projectID]&&(delete risks[projectID][riskData.RiskID],featureRecord.set("c_Risks",JSON.stringify(risks,null,"	")),featureRecord.save({callback:function(){console.log("removed risk from feature:",featureRecord,riskData,risks),cb()}}))}function addRisk(featureRecord,riskData,cb){var risks=getRisks(featureRecord),project=_.find(me.ValidProjects,function(project){return project.get("Name")===riskData.ProjectName}),projectID=project.get("ObjectID");risks[projectID]||(risks[projectID]={});var copy={CP:riskData.Checkpoint,Cont:riskData.Contact,Desc:riskData.Description,Imp:riskData.Impact,Sta:riskData.Status};risks[projectID][riskData.RiskID]=copy,featureRecord.set("c_Risks",JSON.stringify(risks,null,"	")),featureRecord.save({callback:function(){console.log("added risk to feature:",featureRecord,riskData,risks),cb()}})}function getDirtyType(localRiskRecord,realRiskData){var riskData=localRiskRecord.data;return realRiskData?riskData.Edited?"Edited":"Unchanged":riskData.Edited?"New":"Deleted"}var me=this,workweeks=getWorkweeks();me.CustomRisksStore=Ext.create("Ext.data.Store",{data:Ext.clone(me.RisksParsedData),autoSync:!0,model:"IntelRisk",limit:1/0,proxy:{type:"sessionstorage",id:"RiskProxy"+Math.random()},listeners:{load:function(customRisksStore,currentRisksRecords){var realRisksDatas=me.RisksParsedData.slice(0);console.log("syncing risks with current features",currentRisksRecords,realRisksDatas);for(var i=0;currentRisksRecords.length>i;++i){var currentRisksRecord=currentRisksRecords[i],realRiskData=removeRiskFromList(currentRisksRecord.get("RiskID"),realRisksDatas),dirtyType=getDirtyType(currentRisksRecord,realRiskData);if("New"!==dirtyType&&"Edited"!==dirtyType)if("Deleted"==dirtyType)customRisksStore.remove(currentRisksRecord);else for(var key in realRiskData)currentRisksRecord.set(key,realRiskData[key])}realRisksDatas.forEach(function(realRiskData){console.log("adding real risk",realRiskData),customRisksStore.add(Ext.create("IntelRisk",Ext.clone(realRiskData)))})}}});var columnCfgs=[{text:"F#",dataIndex:"FormattedID",width:80,editor:!1,resizable:!1,sortable:!0},{text:"Feature",dataIndex:"FeatureName",width:240,editor:!1,resizable:!1,sortable:!0},{text:"Team",dataIndex:"ProjectName",width:120,editor:!1,resizable:!1,sortable:!0},{text:"Risk Description",dataIndex:"Description",tdCls:"intel-editor-cell",editor:"textfield",width:195,resizable:!1,sortable:!0,renderer:function(val,meta){return val||"-"}},{text:"Impact",dataIndex:"Impact",tdCls:"intel-editor-cell",editor:"textfield",width:200,resizable:!1,sortable:!0,renderer:function(val,meta){return val||"-"}},{text:"Status",dataIndex:"Status",tdCls:"intel-editor-cell",width:100,editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Status"],data:[{Status:"Undefined"},{Status:"Resolved"},{Status:"Owned"},{Status:"Accepted"},{Status:"Mitigated"}]}),editable:!1,displayField:"Status",listeners:{focus:function(combo){combo.expand()}}},resizable:!1,sortable:!0,renderer:function(val,meta){return val||"-"}},{text:"Contact",dataIndex:"Contact",tdCls:"intel-editor-cell",width:160,editor:"textfield",sortable:!0,resizable:!1,renderer:function(val,meta){return val||"-"}},{text:"Checkpoint",dataIndex:"Checkpoint",tdCls:"intel-editor-cell",width:80,resizable:!1,editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["Week"],data:workweeks}),editable:!1,displayField:"Week",listeners:{focus:function(combo){combo.expand()}}},sortable:!0,renderer:function(val,meta){return val||"-"}},{text:"",width:80,xtype:"componentcolumn",resizable:!1,renderer:function(value,meta,riskRecord){var realRiskData=removeRiskFromList(riskRecord.get("RiskID"),me.RisksParsedData.slice(0)),dirtyType=getDirtyType(riskRecord,realRiskData);return"Edited"!==dirtyType?void 0:{xtype:"button",text:"Undo",width:70,handler:function(){if(me._loadRisksStores){var realRiskData=removeRiskFromList(riskRecord.get("RiskID"),me.RisksParsedData.slice(0));for(var key in realRiskData)riskRecord.set(key,realRiskData[key])}}}}},{text:"",width:80,xtype:"componentcolumn",resizable:!1,renderer:function(value,meta,riskRecord){var realRiskData=removeRiskFromList(riskRecord.get("RiskID"),me.RisksParsedData.slice(0)),dirtyType=getDirtyType(riskRecord,realRiskData);if("New"===dirtyType)dirtyType="Save";else{if("Edited"!==dirtyType)return;dirtyType="Resave"}return{xtype:"button",text:dirtyType,width:70,handler:function(){if(me._loadRisksStores){if(!riskRecord.get("Checkpoint"))return alert("You must set the Checkpoint for this risk"),void 0;if(!riskRecord.get("Description"))return alert("You must set the Description for this risk"),void 0;if(!riskRecord.get("Impact"))return alert("You must set the Impact for this risk"),void 0;if(!riskRecord.get("Status"))return alert("You must set the Status for this risk"),void 0;if(!riskRecord.get("Contact"))return alert("You must set the Contact for this risk"),void 0;me._loadRisksStores=!1,me.RisksGrid.setLoading(!0),me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData();var riskRecordData=riskRecord.data,realRiskData=removeRiskFromList(riskRecordData.RiskID,me.RisksParsedData.slice(0)),lastAction=function(){riskRecord.set("Edited",!1),me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData(),me.CustomRisksStore.load({callback:function(){me._loadRisksStores=!0,me.RisksGrid.setLoading(!1)}})}})},nextAction=function(){var newFeatureRecord=me.RisksFeatureStore.findRecord("FormattedID",riskRecordData.FormattedID,0,!1,!0,!0);newFeatureRecord?addRisk(newFeatureRecord,riskRecordData,lastAction):lastAction()};if(realRiskData&&realRiskData.FormattedID!=riskRecordData.FormattedID){console.log("moving risk to new feature",realRiskData.FormattedID,riskRecordData.FormattedID);var oldFeatureRecord=me.RisksFeatureStore.findRecord("FormattedID",realRiskData.FormattedID,0,!1,!0,!0);oldFeatureRecord?removeRisk(oldFeatureRecord,realRiskData,nextAction):nextAction()}else nextAction()}})}}}}}];me.RisksGrid=me.add({xtype:"rallygrid",title:"Risks",width:_.reduce(columnCfgs,function(sum,c){return sum+c.width},20),height:400,x:0,y:50,scroll:"vertical",columnCfgs:columnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0,getRowClass:function(){return"intel-row-35px"}},listeners:{beforeedit:function(){me._isEditing=!0},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var grid=e.grid,risksRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;me._isEditing=!1,value!==originalValue&&risksRecord.set("Edited",!0)}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomRisksStore})},_loadDependenciesGrids:function(){function getWorkweeks(){var i,oneDay=864e5,startDate=me.ReleaseRecord.get("ReleaseStartDate"),endDate=me.ReleaseRecord.get("ReleaseDate"),sd_year=new Date(startDate.getFullYear(),0,0),sd_diff=startDate-sd_year,sd_day=sd_diff/oneDay,sd_week=Math.ceil(sd_day/7),ed_year=new Date(endDate.getFullYear(),0,0),ed_diff=endDate-ed_year,ed_day=ed_diff/oneDay,ed_week=Math.ceil(ed_day/7),weeks=[];if(sd_week>ed_week){for(i=sd_week;52>=i;++i)weeks.push({Week:"ww"+i});for(i=0;ed_week>=i;++i)weeks.push({Week:"ww"+i})}else for(i=sd_week;ed_week>=i;++i)weeks.push({Week:"ww"+i});return weeks}function removeDepFromList(dependencyID,dependencyList){for(var i=0;dependencyList.length>i;++i)if(dependencyList[i].DependencyID==dependencyID)return dependencyList.splice(i,1)[0]}function addPredDep(userStoryRecord,predDepData,cb){var dependencies=me._getDependencies(userStoryRecord),copy={Desc:predDepData.Description,CP:predDepData.Checkpoint,Sta:predDepData.Status,Preds:predDepData.Predecessors};dependencies.Preds[predDepData.DependencyID]=copy,userStoryRecord.set("c_Dependencies",JSON.stringify(dependencies,null,"	")),userStoryRecord.save({callback:function(){console.log("added predecessor to userStory:",userStoryRecord,predDepData,dependencies),cb&&cb()}})}function getDirtyType(localDepRecord,realDepData){var localDepData=localDepRecord.data;return realDepData?localDepData.Edited?"Edited":"Unchanged":localDepData.Edited?"New":"Deleted"}var me=this,workweeks=getWorkweeks();me.PredDepTeamStores={},me.PredDepContainers={},me.CustomPredDepStore=Ext.create("Ext.data.Store",{data:Ext.clone(me.DependenciesParsedData.Predecessors),autoSync:!0,model:"IntelPredDep",proxy:{type:"sessionstorage",id:"PredDepProxy"+Math.random()},limit:1/0,listeners:{load:function(customPredDepStore,customPredDepRecs){var realPredDepsData=me.DependenciesParsedData.Predecessors.slice(0);console.log("syncing predDeps with current userStories",customPredDepRecs,realPredDepsData);for(var i=0;customPredDepRecs.length>i;++i){var depRec=customPredDepRecs[i],depID=depRec.get("DependencyID"),realDep=removeDepFromList(depID,realPredDepsData),dirtyType=getDirtyType(depRec,realDep);if("New"===dirtyType||"Edited"===dirtyType);else if("Deleted"==dirtyType)customPredDepStore.remove(depRec),delete me.PredDepTeamStores[depID],delete me.PredDepContainers[depID];else for(var key in realDep)"Predecessors"===key?depRec.set(key,Ext.clone(realDep[key])||[newTeamDep()]):depRec.set(key,realDep[key]);var preds=depRec.get("Predecessors");preds.length||(depRec.set("Predecessors",[newTeamDep()]),depRec.set("Edited",!0)),me.PredDepTeamStores[depID]&&me.PredDepTeamStores[depID].load()}realPredDepsData.forEach(function(realDep){console.log("adding predDep",realDep),customPredDepStore.add(Ext.create("IntelPredDep",Ext.clone(realDep)));var depID=realDep.DependencyID;me.PredDepTeamStores[depID]&&me.PredDepTeamStores[depID].load()})}}});var predDepColumnCfgs=[{text:"US#",dataIndex:"FormattedID",width:80,resizable:!1,editor:!1,sortable:!0},{text:"UserStory",dataIndex:"UserStoryName",width:160,resizable:!1,editor:!1,sortable:!0},{text:"Owning Team",dataIndex:"ProjectName",width:160,resizable:!1,editor:!1,sortable:!0},{text:"Dependency Description",dataIndex:"Description",width:160,resizable:!1,editor:!1,sortable:!0},{dataIndex:"Checkpoint",width:80,resizable:!1,text:"Checkpoint",editor:!1,sortable:!0},{text:"Teams Depended On",html:'<div class="pred-dep-header" style="width:200px !important;">Team Name</div><div class="pred-dep-header" style="width:80px  !important;">Supported</div><div class="pred-dep-header" style="width:80px  !important;">US#</div><div class="pred-dep-header" style="width:140px !important;">User Story</div>',dataIndex:"DependencyID",width:520,resizable:!1,sortable:!1,xtype:"componentcolumn",renderer:function(depID){var predDepRecord=me.CustomPredDepStore.findRecord("DependencyID",depID),predecessors=predDepRecord.get("Predecessors");if(me.PredDepTeamStores[depID]||(me.PredDepTeamStores[depID]=Ext.create("Ext.data.Store",{model:"IntelDepTeam",data:predecessors,autoSync:!0,limit:1/0,proxy:{type:"sessionstorage",id:"TeamDep-"+depID+"-proxy"+Math.random()},listeners:{load:function(depTeamStore,depTeamRecords){predDepRecord=me.CustomPredDepStore.findRecord("DependencyID",depID);var predecessors=predDepRecord.get("Predecessors").slice(0);Outer:for(var i=0;depTeamRecords.length>i;++i){for(var depTeamRecord=depTeamRecords[i],realTeamDep,j=0;predecessors.length>j;++j)if(predecessors[j].TID===depTeamRecord.get("TID")){realTeamDep=predecessors.splice(j,1)[0];for(var key in realTeamDep)"id"!==key&&depTeamRecord.set(key,realTeamDep[key]);continue Outer}depTeamStore.suspendEvents(),depTeamStore.remove(depTeamRecord),depTeamStore.resumeEvents()}predecessors.forEach(function(realTeamDep){depTeamStore.add(Ext.create("IntelDepTeam",realTeamDep))})}}})),me.PredDepContainers[depID])return me.PredDepContainers[depID];var defaultHandler={element:"el",fn:function(a){a.stopPropagation()}},teamColumnCfgs=[{dataIndex:"PID",width:200,resizable:!1,renderer:function(val,meta,depTeamRecord){var projectRecord=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("ObjectID")==val});return val&&projectRecord?projectRecord.get("Name"):"-"},editor:!1},{dataIndex:"Sup",width:80,resizable:!1,editor:!1,renderer:function(val,meta,depTeamRecord){return meta.tdCls="No"==val?"intel-not-supported-cell":"intel-supported-cell",val}},{dataIndex:"USID",width:80,resizable:!1,editor:!1,renderer:function(val,meta,depTeamRecord){return depTeamRecord.get("A")?val:"-"}},{dataIndex:"USName",width:160,resizable:!1,editor:!1,renderer:function(val,meta,depTeamRecord){return depTeamRecord.get("A")?val:"-"}}];return{xtype:"container",layout:"hbox",pack:"start",align:"stretch",border:!1,items:[{xtype:"rallygrid",bodyCls:"blend-in-grid",width:_.reduce(teamColumnCfgs,function(sum,i){return sum+i.width},0),rowLines:!1,flex:1,columnCfgs:teamColumnCfgs,viewConfig:{stripeRows:!1,getRowClass:function(teamDepRecord,index,rowParams,store){return teamDepRecord.get("PID")?"intel-row-35px":"intel-row-35px intel-no-team-dep-selected"}},hideHeaders:!0,showRowActionsColumn:!1,scroll:!1,showPagingToolbar:!1,enableEditing:!1,context:me.getContext(),store:me.PredDepTeamStores[depID]}],listeners:{mousedown:defaultHandler,mousemove:defaultHandler,mouseout:defaultHandler,mouseover:defaultHandler,mouseup:defaultHandler,mousewheel:defaultHandler,scroll:defaultHandler,click:defaultHandler,dblclick:defaultHandler,render:function(){me.PredDepContainers[depID]=this
}}}}},{dataIndex:"Status",width:80,resizable:!1,tdCls:"intel-editor-cell",text:"Disposition",editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["Status"],data:[{Status:"Done"},{Status:"Not Done"}]}),editable:!1,displayField:"Status",listeners:{focus:function(combo){combo.expand()}}},renderer:function(val,meta){return meta.tdCls+="Done"===val?" intel-supported-cell":" intel-not-supported-cell",val||"Not Done"},sortable:!0}];me.PredDepGrid=me.add({xtype:"rallygrid",title:"Dependencies",width:_.reduce(predDepColumnCfgs,function(sum,c){return sum+c.width},20),height:800,x:0,y:500,scroll:"vertical",columnCfgs:predDepColumnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0,getRowClass:function(predDepRecord){var cls="intel-row-"+(10+(35*predDepRecord.get("Predecessors").length||35))+"px";return cls}},listeners:{beforeedit:function(){me._isEditing=!0},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var grid=e.grid,predDepRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;console.log("predDep edit:",predDepRecord,field,value,originalValue),value!==originalValue&&me._loadDependenciesStores&&(predDepRecord.set("Edited",!0),me._loadDependenciesStores=!1,me.PredDepGrid.setLoading(!0),me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData();var predDepData=predDepRecord.data,realPredDeps=me.DependenciesParsedData.Predecessors.slice(0),realDepData=removeDepFromList(predDepData.DependencyID,realPredDeps)||{},lastAction=function(){predDepRecord.set("Edited",!1),me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData(),me.CustomPredDepStore.load({callback:function(){me._isEditing=!1,me._loadDependenciesStores=!0,me.PredDepGrid.setLoading(!1)}})}})},nextAction=function(){var newUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",predDepData.FormattedID,0,!1,!0,!0);newUserStoryRecord?addPredDep(newUserStoryRecord,predDepData,lastAction):lastAction()};if(realDepData&&realDepData.FormattedID!=predDepData.FormattedID){console.log("moving predDep to new user story",realDepData.FormattedID,predDepData.FormattedID);var oldUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",realDepData.FormattedID,0,!1,!0,!0);oldUserStoryRecord?removePredDep(oldUserStoryRecord,realDepData,nextAction):nextAction()}else nextAction()}}))}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomPredDepStore})}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name70221",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .x-grid-row.intel-row-35px>.x-grid-cell{height:35px !important}.x-grid-row.intel-row-45px>.x-grid-cell{height:45px !important}.x-grid-row.intel-row-80px>.x-grid-cell{height:80px !important}.x-grid-row.intel-row-115px>.x-grid-cell{height:115px !important}.x-grid-row.intel-row-150px>.x-grid-cell{height:150px !important}.x-grid-row.intel-row-185px>.x-grid-cell{height:185px !important}.x-grid-row.intel-row-220px>.x-grid-cell{height:220px !important}.x-grid-row.intel-row-255px>.x-grid-cell{height:255px !important}.x-grid-row.intel-row-290px>.x-grid-cell{height:290px !important}.x-grid-row.intel-row-325px>.x-grid-cell{height:325px !important}.x-grid-row.intel-row-360px>.x-grid-cell{height:360px !important}.x-grid-row .intel-editor-cell{cursor:pointer !important}.x-grid-row .intel-editor-cell *{cursor:pointer !important}.pred-dep-header{display:inline-block !important;line-height:100% !important;font-weight:500 !important}.grey-row .x-grid-cell{background-color:rgba(224,224,224,0.15) !important}.grey-row.x-grid-row-selected .x-grid-cell{background-color:rgba(224,224,224,0.25) !important}.red-row .x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.red-row.x-grid-row-selected .x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.green-row .x-grid-cell{background-color:rgba(0,255,0,0.15) !important}.green-row.x-grid-row-selected .x-grid-cell{background-color:rgba(0,255,0,0.25) !important}.x-grid-row .red-cell.x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.x-grid-row-selected .red-cell.x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.intel-team-dep-not-selected .x-grid-cell,.x-grid-row-selected .intel-team-dep-not-selected .x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.intel-team-dep-not-selected.x-grid-row-selected .x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.x-grid-row.intel-no-team-dep-selected .x-grid-cell{background-color:rgba(224,224,224,0.15) !important}.x-grid-row-hover.intel-no-team-dep-selected .x-grid-cell,.x-grid-row-selected.intel-no-team-dep-selected .x-grid-cell{background-color:rgba(224,224,224,0.25) !important}.x-grid-row .intel-not-supported-cell.x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.x-grid-row-selected .intel-not-supported-cell.x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.x-grid-row .intel-supported-cell.x-grid-cell{background-color:rgba(0,255,0,0.15) !important}.x-grid-row-selected .intel-supported-cell.x-grid-cell{background-color:rgba(0,255,0,0.25) !important}.blend-in-grid{background-color:rgba(0,0,0,0)}
    </style>
</head>
<body>
</body>
</html>
