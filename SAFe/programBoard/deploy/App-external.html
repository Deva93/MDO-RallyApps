<!DOCTYPE html>
<html>
<head>
    <title>Random App Name70221</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Skirtle.CTemplate",{extend:"Ext.XTemplate",statics:{AUTO_ID:0},copyDepth:10,cTpl:'<p id="ctemplate-{0}-{1}"></p>',isCTemplate:!0,constructor:function(){var me=this;me.callParent(arguments),me.id=++me.statics().AUTO_ID,me.reset()},copyValues:function(values,depth){var me=this,id,copy={},copyDepth=depth||me.copyDepth;return 1===copyDepth?values:Ext.isArray(values)?Ext.Array.map(values,function(value){return me.copyValues(value,copyDepth-1)}):Ext.isObject(values)?values.isComponent?(id=values.getId(),me.ids.push(id),Ext.String.format(me.cTpl,id,me.id)):(Ext.Object.each(values,function(key,value){copy[key]="$comp"===key?value:me.copyValues(value,copyDepth-1)}),copy):values},doInsert:function(){var ret=this.callParent(arguments);return this.injectComponents(),ret},doPolling:function(interval){var me=this;me.pollInterval=interval,me.pollId&&clearTimeout(me.pollId),me.pollId=Ext.defer(me.injectComponents,interval,me)},getPlaceholderEl:function(id){return Ext.get("ctemplate-"+id+"-"+this.id)},injectComponents:function(){for(var me=this,ids=me.ids,index=ids.length-1,id,cmp,placeholderEl;index>=0;--index)id=ids[index],cmp=Ext.getCmp(id),placeholderEl=me.getPlaceholderEl(id),(me.renderComponent(cmp,placeholderEl)||!cmp)&&(Ext.Array.splice(ids,index,1),placeholderEl&&placeholderEl.remove());ids.length&&me.doPolling(1.5*me.pollInterval)},overwrite:function(el){var dom,firstChild,ret;if(Ext.isIE)for(dom=Ext.getDom(el);dom.firstChild;)dom.removeChild(dom.firstChild);return ret=this.callParent(arguments),this.injectComponents(),ret},renderComponent:function(cmp,placeholderEl){if(cmp&&placeholderEl){var parent=placeholderEl.parent();return cmp.rendered?cmp.getEl().replace(placeholderEl):cmp.render(parent,placeholderEl),Ext.isIE6&&parent.repaint(),!0}return!1},reset:function(){var me=this;me.ids=[],me.pollId&&(clearTimeout(me.pollId),me.pollId=null)}},function(ctemplate){var apply=function(){var me=this,args=Ext.Array.slice(arguments);return args[0]=me.copyValues(args[0]),me.doPolling(10),me.callParent(args)};ctemplate.prototype.applyOut?ctemplate.override({applyOut:apply}):(ctemplate.override({applyTemplate:apply}),ctemplate.createAlias("apply","applyTemplate"))}),Ext.define("Skirtle.grid.column.Component",{alias:"widget.componentcolumn",extend:"Ext.grid.column.Column",requires:["Skirtle.CTemplate"],autoWidthComponents:!0,componentGC:!0,hasCustomRenderer:!0,lastFrameWidth:12,widthUpdateDelay:[10,400],constructor:function(cfg){var me=this;me.callParent(arguments),me.compIds=[],me.dataIndex=me.dataIndex||Ext.id(null,"cc-dataIndex-"),me.tpl=me.createTemplate(me.tpl),me.renderer=me.createRenderer(me.renderer),me.registerColumnListeners()},addRefOwner:function(child){var me=this,fn=me.refOwnerFn||(me.refOwnerFn=function(){return me});40200>me.extVersion?child.getBubbleTarget=fn:child.getRefOwner=fn},applyTemplate:function(data,value){return Ext.isDefined(value)&&(data[this.dataIndex]=value),this.tpl.apply(data)},beforeViewRefresh:function(){if(Ext.isIE)for(var ids=this.compIds,index=0,len=ids.length,item,el,parentEl;len>index;index++)(item=Ext.getCmp(ids[index]))&&(el=item.getEl())&&(el=el.dom)&&(parentEl=el.parentNode)&&parentEl.removeChild(el)},calculateFrameWidth:function(component){var el=component.getEl(),parentDiv=el&&el.parent(),parentTd=parentDiv&&parentDiv.parent();return parentTd?this.lastFrameWidth=parentDiv.getFrameWidth("lr")+parentTd.getFrameWidth("lr"):void 0},createRenderer:function(renderer){var me=this;return function(value,p,record){var data=Ext.apply({},record.data,record.getAssociatedData());return renderer&&(value=renderer.apply(this,arguments)),value=me.processValue(value),me.applyTemplate(data,value)}},createTemplate:function(tpl){return tpl&&tpl.isTemplate?tpl:Ext.create("Skirtle.CTemplate",tpl||["{",this.dataIndex,"}"])},destroyChild:function(child){child.destroy()},getRefItems:function(deep){for(var items=this.callParent([deep]),ids=this.compIds,index=0,len=ids.length,item;len>index;index++)item=Ext.getCmp(ids[index]),item&&(items.push(item),deep&&item.getRefItems&&items.push.apply(items,item.getRefItems(!0)));return items},onChildAfterRender:function(child){this.resizeChild(child)},onChildBoxReady:function(child){this.resizeChild(child,!1)},onChildDestroy:function(child){Ext.Array.remove(this.compIds,child.getId())},onChildResize:function(){this.redoScrollbars()},onColumnResize:function(column){column.resizeAll()},onColumnShow:function(column){column.resizeAll()},onColumnVisibilityChange:function(column){var items=column.getRefItems(),index=0,length=items.length,visible=!column.isHidden();for(Ext.suspendLayouts&&Ext.suspendLayouts();length>index;++index)items[index].setVisible(visible);Ext.resumeLayouts&&Ext.resumeLayouts(!0)},onDestroy:function(){Ext.destroy(this.getRefItems()),this.callParent()},onRender:function(){this.registerViewListeners(),this.callParent(arguments)},onViewChange:function(){var me=this,tpl=me.tpl;me.suspendResizing(),tpl.isCTemplate&&(tpl.injectComponents(),tpl.reset()),me.redoScrollbars(),me.resumeResizing(),me.performGC()},performGC:function(){for(var compIds=this.compIds,index=compIds.length-1,comp,el;index>=0;--index)comp=Ext.getCmp(compIds[index]),el=comp&&comp.getEl(),el&&(!this.componentGC||el.dom&&Ext.getDom(Ext.id(el))===el.dom)||comp&&!comp.isDestroyed&&comp.destroy()},processValue:function(value){var me=this,compIds=me.compIds,id,initialWidth,dom,parent;return Ext.isObject(value)&&!value.isComponent&&value.xtype&&(value=Ext.widget(value.xtype,value)),value&&value.isComponent&&(id=value.getId(),Ext.Array.contains(compIds,id)||compIds.push(id),me.addRefOwner(value),me.registerListeners(value),value.rendered?Ext.isIE&&(dom=value.el.dom,parent=dom.parentNode,parent&&(40101===me.extVersion&&Ext.core.DomHelper.insertBefore(dom,{tag:"p"}),parent.removeChild(dom))):me.autoWidthComponents&&(initialWidth=me.getWidth()-me.lastFrameWidth,initialWidth=initialWidth>4?initialWidth:4,value.setWidth(initialWidth)),(Ext.isIE6||Ext.isIE7)&&me.isHidden()&&value.hide()),value},redoScrollbars:function(){var me=this,grid=me.up("tablepanel");if(grid){if(me.resizeQueue)return me.redoScrollbarsRequired=!0,void 0;40100>me.extVersion?(grid.invalidateScroller(),grid.determineScrollbars()):grid.doLayout()}},registerColumnListeners:function(){var me=this;me.autoWidthComponents&&(me.on("resize",me.onColumnResize),me.on("show",me.onColumnShow)),(Ext.isIE6||Ext.isIE7)&&me.on({hide:me.onColumnVisibilityChange,show:me.onColumnVisibilityChange})},registerListeners:function(component){var me=this;component.on("destroy",me.onChildDestroy,me),me.autoWidthComponents&&(component.on("afterrender",me.onChildAfterRender,me,{single:!0}),me.extVersion>=40100&&component.on("boxready",me.onChildBoxReady,me,{single:!0})),component.on("resize",me.onChildResize,me)},registerViewListeners:function(){var me=this,view=me.up("tablepanel").getView();me.mon(view,"beforerefresh",me.beforeViewRefresh,me),me.mon(view,"refresh",me.onViewChange,me),me.mon(view,"itemupdate",me.onViewChange,me),me.mon(view,"itemadd",me.onViewChange,me),me.mon(view,"itemremove",me.onViewChange,me)},resizeAll:function(){var me=this;me.suspendResizing(),me.resizeQueue=me.getRefItems(),me.resumeResizing()},resizeChild:function(component,defer){var me=this,frameWidth,newWidth,oldWidth,resizeQueue;return me.resizingSuspended?(resizeQueue=me.resizeQueue,Ext.Array.contains(resizeQueue,component)||resizeQueue.push(component),void 0):(frameWidth=me.calculateFrameWidth(component),Ext.isNumber(frameWidth)&&(newWidth=me.getWidth()-frameWidth,oldWidth=component.getWidth(),me.setChildWidth(component,newWidth,oldWidth)&&defer!==!1&&Ext.each(me.widthUpdateDelay,function(delay){Ext.defer(me.resizeChild,delay,me,[component,!1])})),void 0)},resumeResizing:function(){var me=this,index=0,resizeQueue=me.resizeQueue,len=resizeQueue.length;if(!--me.resizingSuspended){for(;len>index;++index)me.resizeChild(resizeQueue[index]);me.resizeQueue=null,me.redoScrollbarsRequired&&me.redoScrollbars()}},setChildWidth:function(component,newWidth,oldWidth){return oldWidth===newWidth?!1:(component.setWidth(newWidth),!0)},suspendResizing:function(){var me=this;me.resizingSuspended=(me.resizingSuspended||0)+1,me.resizeQueue||(me.resizeQueue=[])}},function(cls){var proto=cls.prototype,version=Ext.getVersion();proto.extVersion=100*(100*version.getMajor()+version.getMinor())+version.getPatch(),Ext.Element.prototype.syncContent&&"4.1.0"==""+version&&(proto.extVersion=40101)}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:"absolute",height:1620,width:1320,_showError:function(text){this.errMessage&&this.remove(this.errMessage),this.errMessage=this.add({xtype:"text",text:text})},_loadModels:function(cb){var me=this;Rally.data.ModelFactory.getModel({type:"Project",scope:me,success:function(model){me.Project=model,Rally.data.ModelFactory.getModel({type:"HierarchicalRequirement",scope:me,success:function(model){me.UserStory=model,cb()}})}})},_loadProject:function(project,cb){var me=this;me.Project.load(project.ObjectID,{fetch:["ObjectID","Releases","Children","Parent","Name","_ref"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:function(record,operation){operation.wasSuccessful()?cb(record):me._showError("failed to retreive project: "+project.ObjectID)}})},_loadReleases:function(cb){var me=this,filterString=Ext.create("Rally.data.wsapi.Filter",{property:"Project.ObjectID",value:me.ProjectRecord.get("ObjectID")}),filterString2,f2;if(me.TrainRecord){var teamName=me.ProjectRecord.get("Name"),trainName=me.TrainRecord.get("Name").split(" ART ")[0],trainNames=teamName.split(trainName)[1].split("-");trainNames[0]?trainNames.push(trainName):trainNames[0]=trainName,trainNames.forEach(function(trainName){f2=Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"contains",value:trainName}),filterString2=filterString2?filterString2.or(f2):f2}),filterString=filterString.and(filterString2)}else filterString2=Ext.create("Rally.data.wsapi.Filter",{property:"ReleaseDate",operator:">=",value:(new Date).toISOString()}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"!contains",value:" "})),filterString=filterString.and(filterString2);filterString=""+filterString;var store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Dummy",value:"value"}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),me.ReleaseStore=releaseStore,cb()},single:!0}}});store._hydrateModelAndLoad=function(options){var deferred=new Deft.Deferred;this.hydrateModel().then({success:function(model){this.proxy.encodeFilters=function(){return filterString},this.load(options).then({success:Ext.bind(deferred.resolve,deferred),failure:Ext.bind(deferred.reject,deferred)})},scope:this})},store.load()},_projectInWhichTrain:function(projectRecord,cb){var me=this;projectRecord||cb();var split=projectRecord.get("Name").split(" ART ");if(split.length>1)cb(projectRecord);else{var parent=projectRecord.get("Parent");parent?me._loadProject(parent,function(parentRecord){me._projectInWhichTrain(parentRecord,cb)}):cb()}},_getCurrentOrFirstRelease:function(){var me=this,d=new Date,rs=me.ReleaseStore.getRecords();if(rs.length){for(var i=0;rs.length>i;++i)if(new Date(rs[i].get("ReleaseDate"))>=d&&d>=new Date(rs[i].get("ReleaseStartDate")))return rs[i];return rs[0]}},_loadValidProjects:function(cb){function loadChildren(project,_cb){Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,remoteSort:!1,limit:1/0,fetch:["Name","ObjectID","Parent"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Parent.ObjectID",value:project.get("ObjectID")}],listeners:{load:{fn:function(projectStore,projectRecords){if(0===projectRecords.length)scrums.push(project),_cb();else{var finished=0,done=function(){++finished===projectRecords.length&&_cb()};projectRecords.forEach(function(c){loadChildren(c,function(){done()})})}},single:!0}}})}var me=this,scrums=[];Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,remoteSort:!1,pageSize:1,limit:1,fetch:["Name","ObjectID"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:"All Scrums"}],listeners:{load:{fn:function(ps,recs){loadChildren(recs[0],function(){me.ValidProjects=scrums,me.ProjectNames=_.map(scrums,function(s){return{Name:s.get("Name")}}),console.log("valid scrums loaded:",scrums),cb()})},single:!0}}})},_loadTeamCommitsUserStories:function(cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",fetch:["ObjectID","Feature","Name","_ref"],limit:1/0,autoLoad:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:me.ReleaseRecord.get("Name")},{property:"Feature",operator:"!=",value:null},{property:"Project.Name",value:me.ProjectRecord.get("Name")}],listeners:{load:{fn:function(storyStore,storyRecords){console.log("Stories loaded:",storyRecords),me.TeamCommitsStoryStore=storyStore,cb()},single:!0}}})},_loadTeamCommitsFeatures:function(cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,limit:1/0,remoteSort:!1,fetch:["Name","ObjectID","FormattedID","c_TeamCommits","Project"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:me.ReleaseRecord.get("Name")}],listeners:{load:{fn:function(featureStore,featureRecords){console.log("features loaded:",featureRecords),me.TeamCommitsFeatureStore=featureStore,cb()},single:!0}}})},_loadVelocityIterations:function(cb){var me=this,startDate=Rally.util.DateTime.toIsoString(me.ReleaseRecord.get("ReleaseStartDate")),endDate=Rally.util.DateTime.toIsoString(me.ReleaseRecord.get("ReleaseDate"));Ext.create("Rally.data.WsapiDataStore",{model:"Iteration",autoLoad:!0,limit:1/0,fetch:["Name","EndDate","StartDate","PlannedVelocity","Project"],context:{workspace:me.getContext().getWorkspace()._ref,project:me.getContext().getProject()._ref},filters:[{property:"EndDate",operator:">=",value:startDate},{property:"StartDate",operator:"<=",value:endDate},{}],remoteSort:!1,listeners:{load:function(store){console.log("VelocityIterations loaded:",store.getRecords()),me.VelocityIterationStore=store,cb()},single:!0}})},_loadVelocityUserStories:function(cb){var me=this,startDate=Rally.util.DateTime.toIsoString(me.ReleaseRecord.get("ReleaseStartDate")),endDate=Rally.util.DateTime.toIsoString(me.ReleaseRecord.get("ReleaseDate"));Ext.create("Rally.data.WsapiDataStore",{model:"HierarchicalRequirement",autoLoad:!0,limit:1/0,fetch:["Name","Iteration","PlanEstimate"],context:{workspace:me.getContext().getWorkspace()._ref,project:me.getContext().getProject()._ref},filters:[{property:"Iteration.EndDate",operator:">=",value:startDate},{property:"Iteration.StartDate",operator:"<=",value:endDate},{property:"PlanEstimate",operator:"!=",value:null}],remoteSort:!1,listeners:{load:function(store){console.log("VelocityUserStoryStore loaded:",store.getRecords()),me.VelocityUserStoryStore=store,cb()},single:!0}})},_loadRisksFeatures:function(cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,limit:1/0,remoteSort:!1,fetch:["Name","ObjectID","FormattedID","c_Risks"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:me.ReleaseRecord.get("Name")}],listeners:{load:{fn:function(featureStore,featureRecords){console.log("risks features loaded:",featureRecords),me.RisksFeatureStore=featureStore,me._parseRisksData(),cb()},single:!0}}})},_parseRisksData:function(){function getRisks(featureRecord){var risks=featureRecord.get("c_Risks");try{risks=JSON.parse(risks)||{}}catch(e){risks={}}return risks}var me=this,projectID=me.ProjectRecord.get("ObjectID"),array=[];_.each(me.RisksFeatureStore.getRecords(),function(featureRecord){var risks=getRisks(featureRecord);if(risks[projectID])for(var riskID in risks[projectID]){var risk=risks[projectID][riskID];array.push({RiskID:riskID,FormattedID:featureRecord.get("FormattedID"),FeatureName:featureRecord.get("Name"),Description:risk.Desc,Impact:risk.Imp,Status:risk.Sta,Contact:risk.Cont,Checkpoint:risk.CP,Edited:!1})}}),me.RisksParsedData=array},_loadRandomUserStory:function(ProjectRef,cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",autoLoad:!0,limit:1,pageSize:1,fetch:["Name","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:ProjectRef},listeners:{load:{fn:function(userStoryStore,userStoryRecords){cb(userStoryRecords.pop())},single:!0}}})},_loadUserStoryByFID:function(FormattedID,ProjectRef,cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",autoLoad:!0,limit:1,pageSize:1,fetch:["Name","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:ProjectRef},filters:[{property:"FormattedID",value:FormattedID}],listeners:{load:{fn:function(userStoryStore,userStoryRecords){cb(userStoryRecords.pop())},single:!0}}})},_loadDependenciesUserStories:function(cb){var me=this,f1=Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:me.ProjectRecord.get("Name")}).and(Ext.create("Rally.data.wsapi.Filter",{property:"c_Dependencies",operator:"!=",value:""})),f2=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:me.ReleaseRecord.get("Name")}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:me.ProjectRecord.get("Name")})),filterString=""+f1.or(f2),store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1/0,remoteSort:!1,fetch:["Name","ObjectID","Release","Project","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Dummy",value:"value"}],listeners:{load:{fn:function(userStoryStore,userStoryRecords){console.log("dependencies release user stories loaded:",userStoryRecords),me.DependenciesUserStoryStore=userStoryStore,me._buildDependenciesData(),cb()},single:!0}}});store._hydrateModelAndLoad=function(options){var deferred=new Deft.Deferred;this.hydrateModel().then({success:function(model){this.proxy.encodeFilters=function(){return filterString},this.load(options).then({success:Ext.bind(deferred.resolve,deferred),failure:Ext.bind(deferred.reject,deferred)})},scope:this})},store.load()},_getDependencies:function(userStoryRecord){var me=this,dependencies,dependencyString=userStoryRecord.get("c_Dependencies");if(""===dependencyString)dependencies={Preds:{},Succs:[]};else try{dependencies=JSON.parse(dependencyString)}catch(e){dependencies={Preds:{},Succs:[]}}return dependencies},_buildDependenciesData:function(){var me=this,startDate=new Date(me.ReleaseRecord.get("ReleaseStartDate")),endDate=new Date(me.ReleaseRecord.get("ReleaseDate"));me.DependenciesReleaseUserStories=_.filter(me.DependenciesUserStoryStore.getRecords(),function(usr){return usr.get("Release")&&usr.get("Release").Name===me.ReleaseRecord.get("Name")});var predDepsList=[],succDepsList=[];_.each(me.DependenciesUserStoryStore.getRecords(),function(userStoryRecord){var deps=me._getDependencies(userStoryRecord),preds=deps.Preds,succs=deps.Succs;if(_.find(me.DependenciesReleaseUserStories,function(goodUS){return goodUS.get("ObjectID")===userStoryRecord.get("ObjectID")}))for(var predDepID in preds){var predDep=preds[predDepID];predDepsList.push({DependencyID:predDepID,FormattedID:userStoryRecord.get("FormattedID"),UserStoryName:userStoryRecord.get("Name"),Description:predDep.Desc,Checkpoint:predDep.CP,Status:predDep.Sta,Predecessors:predDep.Preds||[],Edited:!1})}for(var i=0;succs.length>i;++i){var succDep=succs[i];if(new Date(succDep.REL)>=startDate&&endDate>=new Date(succDep.REL_S)){var FormattedID,UserStoryName;succDep.A?(FormattedID=userStoryRecord.get("FormattedID"),UserStoryName=userStoryRecord.get("Name")):FormattedID=UserStoryName="",succDepsList.push({DependencyID:succDep.ID,PredUserStoryName:succDep.PUSName,PredFormattedID:succDep.PUSID,PredProjectName:succDep.PPID,ReleaseDate:succDep.REL,ReleaseStartDate:succDep.REL_S,Description:succDep.Desc,Checkpoint:succDep.CP,Supported:succDep.Sup,Assigned:succDep.A,FormattedID:FormattedID,UserStoryName:UserStoryName,_realFormattedID:userStoryRecord.get("FormattedID"),_realUserStoryName:userStoryRecord.get("Name"),Edited:!1})}}}),me.DependenciesParsedData={Predecessors:predDepsList,Successors:succDepsList}},_defineModels:function(){Ext.define("IntelVelocity",{extend:"Ext.data.Model",fields:[{name:"Name",type:"string"},{name:"PlannedVelocity",type:"string"},{name:"RealVelocity",type:"string"}]}),Ext.define("IntelTeamCommits",{extend:"Ext.data.Model",fields:[{name:"Name",type:"string"},{name:"ObjectID",type:"string"},{name:"FormattedID",type:"string"},{name:"Commitment",type:"string"},{name:"Objective",type:"string"}]}),Ext.define("IntelRisk",{extend:"Ext.data.Model",fields:[{name:"RiskID",type:"string"},{name:"FormattedID",type:"string"},{name:"FeatureName",type:"string"},{name:"Description",type:"string"},{name:"Impact",type:"string"},{name:"Status",type:"string"},{name:"Contact",type:"string"},{name:"Checkpoint",type:"string"},{name:"Edited",type:"boolean"}]}),Ext.define("IntelDepTeam",{extend:"Ext.data.Model",fields:[{name:"TID",type:"string"},{name:"PID",type:"string"},{name:"Sup",type:"string"},{name:"USID",type:"string"},{name:"USName",type:"string"},{name:"A",type:"boolean"}]}),Ext.define("IntelPredDep",{extend:"Ext.data.Model",fields:[{name:"DependencyID",type:"string"},{name:"FormattedID",type:"string"},{name:"UserStoryName",type:"string"},{name:"Description",type:"string"},{name:"Checkpoint",type:"string"},{name:"Status",type:"string"},{name:"Predecessors",type:"auto"},{name:"Edited",type:"boolean"}]}),Ext.define("IntelSuccDep",{extend:"Ext.data.Model",fields:[{name:"DependencyID",type:"string"},{name:"PredUserStoryName",type:"string"},{name:"PredFormattedID",type:"string"},{name:"PredProjectName",type:"string"},{name:"UserStoryName",type:"string"},{name:"FormattedID",type:"string"},{name:"ReleaseStartDate",type:"string"},{name:"ReleaseDate",type:"string"},{name:"_realUserStoryName",type:"string"},{name:"_realFormattedID",type:"string"},{name:"Description",type:"string"},{name:"Checkpoint",type:"string"},{name:"Supported",type:"string"},{name:"Assigned",type:"boolean"},{name:"Edited",type:"boolean"}]})},_loadRisksStores:!0,_loadTeamCommitsStores:!0,_loadDependenciesStores:!0,_loadVelocityStores:!0,_isEditing:!1,_reloadVelocityStores:function(){var me=this;me.VelocityIterationStore&&me._loadVelocityStores&&me.VelocityIterationStore.load({callback:function(records,operation){me.VelocityUserStoryStore&&me._loadVelocityStores&&me.VelocityUserStoryStore.load({callback:function(records,operation){me._isEditing||me.CustomVelocityStore&&me._loadVelocityStores&&me.CustomVelocityStore.load()}})}})},_reloadTeamCommitsStores:function(){var me=this;me.TeamCommitsFeatureStore&&me._loadTeamCommitsStores&&me.TeamCommitsFeatureStore.load({callback:function(records,operation){me._isEditing||me.CustomTeamCommitsStore&&me._loadTeamCommitsStores&&me.CustomTeamCommitsStore.load()}})},_reloadRisksStores:function(){var me=this;me.RisksFeatureStore&&me._loadRisksStores&&me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData(),me._isEditing||me.CustomRisksStore&&me._loadRisksStores&&me.CustomRisksStore.load()}})},_reloadDependenciesStores:function(){var me=this;me.DependenciesUserStoryStore&&me._loadDependenciesStores&&me.DependenciesUserStoryStore.load({callback:function(records,operation){me._buildDependenciesData(),me._isEditing||(me.CustomPredDepStore&&me._loadDependenciesStores&&me.CustomPredDepStore.load(),me.CustomSuccDepStore&&me._loadDependenciesStores&&me.CustomSuccDepStore.load())}})},_reloadEverything:function(){var me=this;me.removeAll(),me._loadRisksStores=!0,me._loadTeamCommitsStores=!0,me._loadDependenciesStores=!0,me._loadVelocityStores=!0,me._isEditing=!1,me._loadReleasePicker(),me._loadTeamCommitsUserStories(function(){me._loadTeamCommitsFeatures(function(){me._loadTeamCommitsGrid()})}),me._loadVelocityUserStories(function(){me._loadVelocityIterations(function(){me._loadVelocityGrid()})}),me._loadRisksFeatures(function(){me._loadRisksGrid()}),me._loadDependenciesUserStories(function(){me._loadDependenciesGrids()})},launch:function(){var me=this;me._showError("Loading Data..."),me._defineModels(),setInterval(function(){me._reloadVelocityStores()},1e4),setInterval(function(){me._reloadTeamCommitsStores()},1e4),setInterval(function(){me._reloadRisksStores()},1e4),setInterval(function(){me._reloadDependenciesStores()},15e3),me._loadModels(function(){me._loadValidProjects(function(){var scopeProject=me.getContext().getProject();me._loadProject(scopeProject,function(scopeProjectRecord){me.ProjectRecord=_.find(me.ValidProjects,function(validProject){return validProject.data.ObjectID===scopeProjectRecord.data.ObjectID}),me.ProjectRecord?me._projectInWhichTrain(me.ProjectRecord,function(trainRecord){me.TrainRecord=trainRecord,console.log("train loaded:",trainRecord),me._loadReleases(function(){var currentRelease=me._getCurrentOrFirstRelease();currentRelease?(me.ReleaseRecord=currentRelease,console.log("release loaded",currentRelease),me._reloadEverything()):(me.removeAll(),console.log("This team has no releases"))})}):(me.removeAll(),me._showError("Please scope to a valid team for release planning"))})})})},_getWorkweek:function(date){var oneDay=864e5,yearStart=new Date(date.getFullYear(),0,0),dayIndex=yearStart.getDay(),ww01Start=yearStart-dayIndex*oneDay,timeDiff=date-ww01Start,dayDiff=timeDiff/oneDay;return Math.floor(dayDiff/7)+1},_getWeekCount:function(date){var leap=0===date.getFullYear()%4,day=new Date(date.getFullYear(),0,0).getDay();return leap&&day>=5||!leap&&6===day?53:52},_getWorkweeks:function(){var me=this,i,start=me.ReleaseRecord.get("ReleaseStartDate"),end=me.ReleaseRecord.get("ReleaseDate"),sd_week=me._getWorkweek(start),ed_week=me._getWorkweek(end),week_count=me._getWeekCount(start),weeks=[];if(sd_week>ed_week){for(i=sd_week;week_count>=i;++i)weeks.push({Week:"ww"+i});for(i=1;ed_week>=i;++i)weeks.push({Week:"ww"+i})}else for(i=sd_week;ed_week>=i;++i)weeks.push({Week:"ww"+i});return weeks},_loadReleasePicker:function(){var me=this;me.ReleasePicker=me.add({xtype:"combobox",x:0,y:0,store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.ReleaseStore.getRecords(),function(r){return{Name:r.get("Name")}})}),displayField:"Name",fieldLabel:"Release:",editable:!1,value:me.ReleaseRecord.get("Name"),listeners:{select:function(combo,records){me.ReleaseRecord.get("Name")!==records[0].get("Name")&&(me.ReleaseRecord=me.ReleaseStore.findRecord("Name",records[0].get("Name")),setTimeout(function(){me._reloadEverything()},0))}}})},_loadTeamCommitsGrid:function(){function getTeamCommit(featureRecord){var tcs=featureRecord.get("c_TeamCommits"),projectID=me.ProjectRecord.get("ObjectID"),this_tc;try{this_tc=JSON.parse(tcs)[projectID]||{}}catch(e){this_tc={}}return this_tc}function setTeamCommit(featureRecord,tc,cb){var tcs=featureRecord.get("c_TeamCommits"),projectID=me.ProjectRecord.get("ObjectID");try{tcs=JSON.parse(tcs)||{}}catch(e){tcs={}}tcs[projectID]||(tcs[projectID]={}),tcs[projectID].Commitment=tc.Commitment,tcs[projectID].Objective=tc.Objective,featureRecord.set("c_TeamCommits",JSON.stringify(tcs,null,"	")),featureRecord.save({callback:cb})}function getStoryCount(FID){if(me.TeamCommitsHash[FID])return me.TeamCommitsHash[FID];var count=0,uss=me.TeamCommitsStoryStore.getRecords();return uss.forEach(function(us){us.get("Feature")&&us.get("Feature").ObjectID==FID&&++count}),me.TeamCommitsHash[FID]=count,count}var me=this;me.TeamCommitsHash={};var customTeamCommitsRecords=_.map(me.TeamCommitsFeatureStore.getRecords(),function(featureRecord){var tc=getTeamCommit(featureRecord);return{Commitment:tc.Commitment||"Undecided",Objective:tc.Objective||"",Name:featureRecord.get("Name"),FormattedID:featureRecord.get("FormattedID"),ObjectID:featureRecord.get("ObjectID")}});me.CustomTeamCommitsStore=Ext.create("Ext.data.Store",{data:customTeamCommitsRecords,model:"IntelTeamCommits",autoSync:!0,limit:1/0,proxy:{type:"sessionstorage",id:"TeamCommitsProxy"+Math.random()},listeners:{load:function(customTeamCommitsStore,currentTeamCommitsRecords){console.log("syncing teamCommits with features",currentTeamCommitsRecords,me.TeamCommitsFeatureStore.getRecords()),currentTeamCommitsRecords.forEach(function(teamCommitsRecord){var featureRecord=me.TeamCommitsFeatureStore.findRecord("ObjectID",teamCommitsRecord.get("ObjectID"));if(featureRecord){var newVal=getTeamCommit(featureRecord);teamCommitsRecord.set("Commitment",newVal.Commitment||"Undecided"),teamCommitsRecord.set("Objective",newVal.Objective||"")}})}}});var columnCfgs=[{text:"F#",dataIndex:"FormattedID",width:80,editor:!1,sortable:!0,resizable:!1,renderer:function(FID,meta,teamCommitsRecord){var feature=me.TeamCommitsFeatureStore.findRecord("FormattedID",FID);return feature.get("Project")?'<a href="https://rally1.rallydev.com/#/'+feature.get("Project").ObjectID+"d/detail/portfolioitem/feature/"+feature.get("ObjectID")+'">'+FID+"</a>":FID}},{text:"Feature",dataIndex:"Name",width:240,editor:!1,resizable:!1},{text:"Stories",dataIndex:"ObjectID",sortable:!0,editor:!1,resizable:!1,doSort:function(direction){var ds=this.up("grid").getStore(),field=this.getSortParam();ds.sort({sorterFn:function(f1,f2){var diff=getStoryCount(f1.get("ObjectID"))-getStoryCount(f2.get("ObjectID"));return 0===diff?0:("ASC"==direction?1:-1)*(diff>0?1:-1)}})},width:80,renderer:function(oid){return getStoryCount(oid)}},{dataIndex:"Commitment",text:"Status",width:130,tdCls:"intel-editor-cell",sortable:!0,resizable:!1,doSort:function(direction){var ds=this.up("grid").getStore();ds.sort({sorterFn:function(f1,f2){var oid1=f1.get("ObjectID"),oid2=f2.get("ObjectID"),realF1=me.TeamCommitsFeatureStore.findRecord("ObjectID",oid1,0,!1,!0,!0),realF2=me.TeamCommitsFeatureStore.findRecord("ObjectID",oid2,0,!1,!0,!0),r1=getTeamCommit(realF1),r2=getTeamCommit(realF2);return r1==r2?0:("ASC"==direction?1:-1)*(r2>r1?-1:1)}})},editor:{xtype:"combobox",width:160,store:Ext.create("Ext.data.Store",{fields:["Status"],data:[{Status:"Undecided"},{Status:"N/A"},{Status:"Committed"},{Status:"Not Committed"}]}),editable:!1,displayField:"Status",listeners:{focus:function(combo){combo.expand()}}}},{text:"Objective",dataIndex:"Objective",width:240,editor:"textfield",resizable:!1,sortable:!1,renderer:function(val){return val||"-"}}];me.TeamCommitsGrid=me.add({xtype:"rallygrid",title:"Team Commits",width:790,height:300,x:0,y:50,scroll:"vertical",columnCfgs:columnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0,getRowClass:function(customTeamCommitsRecords,index,rowParams,store){var val=customTeamCommitsRecords.get("Commitment")||"Undecided";return"N/A"==val?"grey-row":"Committed"==val?"green-row":"Not Committed"==val?"red-row":void 0}},listeners:{beforeedit:function(){me._isEditing=!0},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var grid=e.grid,tcRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;if(me._isEditing=!1,value!=originalValue&&me._loadTeamCommitsStores){var tc={Commitment:tcRecord.get("Commitment"),Objective:tcRecord.get("Objective")};me._isEditing=!0,me._loadTeamCommitsStores=!1,me.TeamCommitsGrid.setLoading(!0),me.TeamCommitsFeatureStore.load({callback:function(records,operation){var oid=tcRecord.get("ObjectID"),realFeature=me.TeamCommitsFeatureStore.findRecord("ObjectID",oid,0,!1,!0,!0);
realFeature?setTeamCommit(realFeature,tc,function(){me.TeamCommitsFeatureStore.load({callback:function(records,operation){me._isEditing=!1,me._loadTeamCommitsStores=!0,me.TeamCommitsGrid.setLoading(!1)}})}):console.log("ERROR: realFeature not found, ObjectID: "+oid)}})}}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomTeamCommitsStore})},_loadVelocityGrid:function(){var me=this,iterationGroups=_.groupBy(me.VelocityUserStoryStore.getRecords(),function(us){return us.get("Iteration").Name}),iterationGroupTotals=_.sortBy(_.map(me.VelocityIterationStore.getRecords(),function(iteration){var iName=iteration.get("Name");return{Name:iName,PlannedVelocity:iteration.get("PlannedVelocity")||0,RealVelocity:_.reduce(iterationGroups[iName]||[],function(sum,us){return sum+us.get("PlanEstimate")},0)}}),"Name");me.CustomVelocityStore=Ext.create("Ext.data.Store",{data:iterationGroupTotals,model:"IntelVelocity",autoSync:!0,limit:1/0,proxy:{type:"sessionstorage",id:"VelocityProxy"+Math.random()},listeners:{load:function(customVelocityStore,velocityRecords){console.log("syncing velocity with current iterations",velocityRecords,me.VelocityIterationStore.getRecords()),velocityRecords.forEach(function(velocityRecord){var iterationName=velocityRecord.get("Name"),iteration=me.VelocityIterationStore.findRecord("Name",iterationName,0,!1,!0,!0),newVal=iteration.get("PlannedVelocity")||0;newVal!=velocityRecord.get("PlannedVelocity")&&(velocityRecord.set("PlannedVelocity",iteration.get("PlannedVelocity")||0),velocityRecord.commit(),console.log("velocity record update",velocityRecord))})}}});var columnCfgs=[{text:"Iteration",dataIndex:"Name",width:240,editor:!1,resizable:!1,sortable:!0,renderer:function(name,meta,velocityRecord){var iteration=me.VelocityIterationStore.findRecord("Name",name);if(iteration.get("Project")){var pid=iteration.get("Project")._ref.split("/project/")[1];return'<a href="https://rally1.rallydev.com/#/'+pid+"d/detail/iteration/"+iteration.get("ObjectID")+'">'+name+"</a>"}return name}},{text:"Target",dataIndex:"PlannedVelocity",width:100,tdCls:"intel-editor-cell",xtype:"numbercolumn",editor:"textfield",resizable:!1,sortable:!0},{text:"Actual",dataIndex:"RealVelocity",xtype:"numbercolumn",width:100,editor:!1,resizable:!1,sortable:!0}];me.VelocityGrid=me.add({xtype:"rallygrid",title:"Velocity",scroll:"vertical",width:_.reduce(columnCfgs,function(sum,c){return sum+c.width},20),height:300,x:850,y:50,showPagingToolbar:!1,showRowActionsColumn:!1,viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0},listeners:{beforeedit:function(editor,e){return me._isEditing=!0,!0},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var grid=e.grid,velocityRecord=e.record,value=e.value,originalValue=e.originalValue;if(me._isEditing=!1,value&&value!==originalValue){value=1*value||0;var iterationName=velocityRecord.get("Name"),iteration=me.VelocityIterationStore.findRecord("Name",iterationName,0,!1,!0,!0);iteration.set("PlannedVelocity",value),iteration.save()}}},plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],enableEditing:!1,context:this.getContext(),columnCfgs:columnCfgs,store:me.CustomVelocityStore})},_loadRisksGrid:function(){function removeRiskFromList(riskID,riskList){for(var i=0;riskList.length>i;++i)if(riskList[i].RiskID==riskID)return riskList.splice(i,1)[0]}function getRisks(featureRecord){var risks=featureRecord.get("c_Risks");try{risks=JSON.parse(risks)||{}}catch(e){risks={}}return risks}function removeRisk(featureRecord,riskData,cb){var risks=getRisks(featureRecord);risks[projectID]&&(delete risks[projectID][riskData.RiskID],featureRecord.set("c_Risks",JSON.stringify(risks,null,"	")),featureRecord.save({callback:function(){console.log("removed risk from feature:",featureRecord,riskData,risks),cb()}}))}function addRisk(featureRecord,riskData,cb){var risks=getRisks(featureRecord);risks[projectID]||(risks[projectID]={});var copy={CP:riskData.Checkpoint,Cont:riskData.Contact,Desc:riskData.Description,Imp:riskData.Impact,Sta:riskData.Status};risks[projectID][riskData.RiskID]=copy,featureRecord.set("c_Risks",JSON.stringify(risks,null,"	")),featureRecord.save({callback:function(){console.log("added risk to feature:",featureRecord,riskData,risks),cb()}})}function getDirtyType(localRiskRecord,realRiskData){var riskData=localRiskRecord.data;return realRiskData?riskData.Edited?"Edited":"Unchanged":riskData.Edited?"New":"Deleted"}var me=this,projectID=me.ProjectRecord.get("ObjectID"),workweeks=me._getWorkweeks();me.CustomRisksStore=Ext.create("Ext.data.Store",{data:Ext.clone(me.RisksParsedData),autoSync:!0,model:"IntelRisk",limit:1/0,proxy:{type:"sessionstorage",id:"RiskProxy"+Math.random()},listeners:{load:function(customRisksStore,currentRisksRecords){var realRisksDatas=me.RisksParsedData.slice(0);console.log("syncing risks with current features",currentRisksRecords,realRisksDatas);for(var i=0;currentRisksRecords.length>i;++i){var currentRisksRecord=currentRisksRecords[i],realRiskData=removeRiskFromList(currentRisksRecord.get("RiskID"),realRisksDatas),dirtyType=getDirtyType(currentRisksRecord,realRiskData);if("New"!==dirtyType&&"Edited"!==dirtyType)if("Deleted"==dirtyType)customRisksStore.remove(currentRisksRecord);else for(var key in realRiskData)currentRisksRecord.set(key,realRiskData[key])}realRisksDatas.forEach(function(realRiskData){console.log("adding real risk",realRiskData),customRisksStore.add(Ext.create("IntelRisk",Ext.clone(realRiskData)))})}}});var columnCfgs=[{text:"F#",dataIndex:"FormattedID",tdCls:"intel-editor-cell",width:80,editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["FormattedID"],data:_.map(me.RisksFeatureStore.getRecords(),function(fr){return{FormattedID:fr.get("FormattedID")}})}),enableKeyEvents:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filterBy(function(item){return 0===item.get("FormattedID").indexOf(me.getRawValue())})}},focus:function(combo){combo.expand()}},displayField:"FormattedID"},resizable:!1,sortable:!0},{text:"Feature",dataIndex:"FeatureName",tdCls:"intel-editor-cell",width:240,editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.RisksFeatureStore.getRecords(),function(fr){return{Name:fr.get("Name")}})}),enableKeyEvents:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filterBy(function(item){return 0===item.get("Name").indexOf(me.getRawValue())})}},focus:function(combo){combo.expand()}},displayField:"Name"},resizable:!1,sortable:!0},{text:"Risk Description",dataIndex:"Description",tdCls:"intel-editor-cell",width:195,editor:"textfield",resizable:!1,sortable:!0,renderer:function(val,meta){return val||"-"}},{text:"Impact",dataIndex:"Impact",tdCls:"intel-editor-cell",width:200,resizable:!1,sortable:!0,editor:"textfield",renderer:function(val,meta){return val||"-"}},{text:"Status",dataIndex:"Status",tdCls:"intel-editor-cell",width:100,editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Status"],data:[{Status:"Undefined"},{Status:"Resolved"},{Status:"Owned"},{Status:"Accepted"},{Status:"Mitigated"}]}),editable:!1,displayField:"Status",listeners:{focus:function(combo){combo.expand()}}},resizable:!1,sortable:!0,renderer:function(val,meta){return val||"-"}},{text:"Contact",dataIndex:"Contact",tdCls:"intel-editor-cell",width:160,editor:"textfield",sortable:!0,resizable:!1,renderer:function(val,meta){return val||"-"}},{text:"Checkpoint",dataIndex:"Checkpoint",tdCls:"intel-editor-cell",width:80,resizable:!1,editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["Week"],data:workweeks}),editable:!1,displayField:"Week",listeners:{focus:function(combo){combo.expand()}}},sortable:!0,renderer:function(val,meta){return val||"-"}},{text:"",width:80,xtype:"componentcolumn",resizable:!1,renderer:function(value,meta,riskRecord){var realRiskData=removeRiskFromList(riskRecord.get("RiskID"),me.RisksParsedData.slice(0)),dirtyType=getDirtyType(riskRecord,realRiskData);return"Edited"!==dirtyType?void 0:{xtype:"button",text:"Undo",width:70,handler:function(){if(me._loadRisksStores){var realRiskData=removeRiskFromList(riskRecord.get("RiskID"),me.RisksParsedData.slice(0));for(var key in realRiskData)riskRecord.set(key,realRiskData[key])}}}}},{text:"",width:80,xtype:"componentcolumn",resizable:!1,renderer:function(value,meta,riskRecord){var realRiskData=removeRiskFromList(riskRecord.get("RiskID"),me.RisksParsedData.slice(0)),dirtyType=getDirtyType(riskRecord,realRiskData);if("New"===dirtyType)dirtyType="Save";else{if("Edited"!==dirtyType)return;dirtyType="Resave"}return{xtype:"button",text:dirtyType,width:70,handler:function(){if(me._loadRisksStores){if(!riskRecord.get("Checkpoint"))return alert("You must set the Checkpoint date for this risk"),void 0;if(!riskRecord.get("Description"))return alert("You must set the Description date for this risk"),void 0;if(!riskRecord.get("Impact"))return alert("You must set the Impact date for this risk"),void 0;if(!riskRecord.get("Status"))return alert("You must set the Status date for this risk"),void 0;if(!riskRecord.get("Contact"))return alert("You must set the Contact date for this risk"),void 0;me._loadRisksStores=!1,me.RisksGrid.setLoading(!0),me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData();var riskRecordData=riskRecord.data,realRiskData=removeRiskFromList(riskRecordData.RiskID,me.RisksParsedData.slice(0)),lastAction=function(){riskRecord.set("Edited",!1),me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData(),me.CustomRisksStore.load({callback:function(){me._loadRisksStores=!0,me.RisksGrid.setLoading(!1)}})}})},nextAction=function(){var newFeatureRecord=me.RisksFeatureStore.findRecord("FormattedID",riskRecordData.FormattedID,0,!1,!0,!0);newFeatureRecord?addRisk(newFeatureRecord,riskRecordData,lastAction):lastAction()};if(realRiskData&&realRiskData.FormattedID!=riskRecordData.FormattedID){console.log("moving risk to new feature",realRiskData.FormattedID,riskRecordData.FormattedID);var oldFeatureRecord=me.RisksFeatureStore.findRecord("FormattedID",realRiskData.FormattedID,0,!1,!0,!0);oldFeatureRecord?removeRisk(oldFeatureRecord,realRiskData,nextAction):nextAction()}else nextAction()}})}}}}},{text:"",width:80,xtype:"componentcolumn",resizable:!1,renderer:function(value,meta,riskRecord){return{xtype:"button",text:"Delete",width:70,handler:function(){me._loadRisksStores&&confirm("Confirm Risk Deletion")&&(me._loadRisksStores=!1,me.RisksGrid.setLoading(!0),me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData();var riskRecordData=riskRecord.data,realRiskData=removeRiskFromList(riskRecordData.RiskID,me.RisksParsedData.slice(0)),lastAction=function(){me.CustomRisksStore.remove(riskRecord),me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData(),me.CustomRisksStore.load({callback:function(){me._loadRisksStores=!0,me.RisksGrid.setLoading(!1)}})}})},nextAction=function(){var newFeatureRecord=me.RisksFeatureStore.findRecord("FormattedID",riskRecordData.FormattedID,0,!1,!0,!0);newFeatureRecord?removeRisk(newFeatureRecord,riskRecordData,lastAction):lastAction()};if(realRiskData&&realRiskData.FormattedID!=riskRecordData.FormattedID){var oldFeatureRecord=me.RisksFeatureStore.findRecord("FormattedID",realRiskData.FormattedID,0,!1,!0,!0);oldFeatureRecord?removeRisk(oldFeatureRecord,realRiskData,nextAction):nextAction()}else nextAction()}}))}}}}];me.AddRiskButton=me.add({xtype:"button",text:"+ Add Risk",x:0,y:380,width:80,style:"margin-bottom:10px",listeners:{click:function(){var randomFeature=me.RisksFeatureStore.first();if(randomFeature){if(me.CustomRisksStore){var model=Ext.create("IntelRisk",{RiskID:1*new Date+""+1e7*Math.random(),FormattedID:randomFeature.get("FormattedID"),FeatureName:randomFeature.get("Name"),Description:"",Impact:"",Status:"",Contact:"",Checkpoint:"",Edited:!0});me.CustomRisksStore.add(model)}}else alert("No Features for this Release!")}}}),me.RisksGrid=me.add({xtype:"rallygrid",title:"Risks",width:_.reduce(columnCfgs,function(sum,c){return sum+c.width},20),height:260,x:0,y:420,scroll:"vertical",columnCfgs:columnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0,getRowClass:function(){return"intel-row-35px"}},listeners:{beforeedit:function(){me._isEditing=!0},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var grid=e.grid,risksRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;if(me._isEditing=!1,value!==originalValue){var previousEdit=risksRecord.get("Edited");risksRecord.set("Edited",!0);var featureRecord;"FeatureName"===field?(featureRecord=me.RisksFeatureStore.findRecord("Name",value,0,!1,!0,!0),featureRecord?risksRecord.set("FormattedID",featureRecord.get("FormattedID")):(risksRecord.set("FeatureName",originalValue),risksRecord.set("Edited",previousEdit))):"FormattedID"===field&&(featureRecord=me.RisksFeatureStore.findRecord("FormattedID",value,0,!1,!0,!0),featureRecord?risksRecord.set("FeatureName",featureRecord.get("Name")):(risksRecord.set("FormattedID",originalValue),risksRecord.set("Edited",previousEdit)))}}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomRisksStore})},_loadDependenciesGrids:function(){function newTeamDep(){return{TID:1*new Date+""+1e7*Math.random(),PID:"",Sup:"No",USID:"",USName:"",A:!1}}function removeDepFromList(dependencyID,dependencyList){for(var i=0;dependencyList.length>i;++i)if(dependencyList[i].DependencyID==dependencyID)return dependencyList.splice(i,1)[0]}function removePredDep(userStoryRecord,predDepData,cb){var dependencies=me._getDependencies(userStoryRecord);delete dependencies.Preds[predDepData.DependencyID],userStoryRecord.set("c_Dependencies",JSON.stringify(dependencies,null,"	")),userStoryRecord.save({callback:function(){console.log("removed pred from userStory:",userStoryRecord,predDepData,dependencies),cb&&cb()}})}function removeSuccDep(userStoryRecord,succDepData,cb){for(var dependencies=me._getDependencies(userStoryRecord),succs=dependencies.Succs,i=0;succs.length>i;++i)if(succs[i].ID===succDepData.DependencyID)return succs.splice(i,1),userStoryRecord.set("c_Dependencies",JSON.stringify(dependencies,null,"	")),userStoryRecord.save({callback:function(){console.log("removed succ from userStory:",userStoryRecord,succDepData,dependencies),cb&&cb()}}),void 0}function addPredDep(userStoryRecord,predDepData,cb){var dependencies=me._getDependencies(userStoryRecord),copy={Desc:predDepData.Description,CP:predDepData.Checkpoint,Sta:predDepData.Status,Preds:predDepData.Predecessors};dependencies.Preds[predDepData.DependencyID]=copy,userStoryRecord.set("c_Dependencies",JSON.stringify(dependencies,null,"	")),userStoryRecord.save({callback:function(){console.log("added predecessor to userStory:",userStoryRecord,predDepData,dependencies),cb&&cb()}})}function addSuccDep(userStoryRecord,succDepData,cb){for(var dependencies=me._getDependencies(userStoryRecord),succs=dependencies.Succs,copy={ID:succDepData.DependencyID,PUSID:succDepData.PredFormattedID,PUSName:succDepData.PredUserStoryName,PPID:succDepData.PredProjectName,Desc:succDepData.Description,CP:succDepData.Checkpoint,Sup:succDepData.Supported,A:succDepData.Assigned,REL:succDepData.ReleaseDate,REL_S:succDepData.ReleaseStartDate},replaced=!1,i=0;succs.length>i;++i)if(succs[i].ID===copy.ID){succs[i]=copy,replaced=!0;break}replaced||succs.push(copy),userStoryRecord.set("c_Dependencies",JSON.stringify(dependencies,null,"	")),userStoryRecord.save({callback:function(){console.log("added succ to userStory:",userStoryRecord,succDepData,dependencies),cb&&cb()}})}function getDirtyType(localDepRecord,realDepData){var localDepData=localDepRecord.data;return realDepData?localDepData.Edited?"Edited":"Unchanged":localDepData.Edited?"New":"Deleted"}var me=this,workweeks=me._getWorkweeks();me.PredDepTeamStores={},me.PredDepContainers={},me.CustomPredDepStore=Ext.create("Ext.data.Store",{data:Ext.clone(me.DependenciesParsedData.Predecessors),autoSync:!0,model:"IntelPredDep",proxy:{type:"sessionstorage",id:"PredDepProxy"+Math.random()},limit:1/0,listeners:{load:function(customPredDepStore,customPredDepRecs){var realPredDepsData=me.DependenciesParsedData.Predecessors.slice(0);console.log("syncing predDeps with current userStories",customPredDepRecs,realPredDepsData);for(var i=0;customPredDepRecs.length>i;++i){var depRec=customPredDepRecs[i],depID=depRec.get("DependencyID"),realDep=removeDepFromList(depID,realPredDepsData),dirtyType=getDirtyType(depRec,realDep);if("New"===dirtyType||"Edited"===dirtyType);else if("Deleted"==dirtyType)customPredDepStore.remove(depRec),delete me.PredDepTeamStores[depID],delete me.PredDepContainers[depID];else for(var key in realDep)"Predecessors"===key?depRec.set(key,Ext.clone(realDep[key])||[newTeamDep()]):depRec.set(key,realDep[key]);var preds=depRec.get("Predecessors");preds.length||(depRec.set("Predecessors",[newTeamDep()]),depRec.set("Edited",!0)),me.PredDepTeamStores[depID]&&me.PredDepTeamStores[depID].load()}realPredDepsData.forEach(function(realDep){console.log("adding predDep",realDep),customPredDepStore.add(Ext.create("IntelPredDep",Ext.clone(realDep)));var depID=realDep.DependencyID;me.PredDepTeamStores[depID]&&me.PredDepTeamStores[depID].load()})}}});var predDepColumnCfgs=[{text:"US#",dataIndex:"FormattedID",tdCls:"intel-editor-cell",width:80,resizable:!1,editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["FormattedID"],data:_.map(me.DependenciesReleaseUserStories,function(usr){return{FormattedID:usr.get("FormattedID")}}),sorters:{property:"FormattedID"}}),enableKeyEvents:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filters.getRange().forEach(function(filter){me.store.removeFilter(filter)}),me.store.filterBy(function(item){return item.get("FormattedID").indexOf(me.getRawValue())>-1})}},focus:function(combo){combo.expand()}},displayField:"FormattedID"},sortable:!0},{text:"UserStory",dataIndex:"UserStoryName",width:155,resizable:!1,tdCls:"intel-editor-cell",editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.DependenciesReleaseUserStories,function(usr){return{Name:usr.get("Name")}}),sorters:{property:"Name"}}),enableKeyEvents:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filters.getRange().forEach(function(filter){me.store.removeFilter(filter)}),me.store.filterBy(function(item){return item.get("Name").indexOf(me.getRawValue())>-1})}},focus:function(combo){combo.expand()}},displayField:"Name"},sortable:!0},{text:"Dependency Description",dataIndex:"Description",width:160,resizable:!1,tdCls:"intel-editor-cell",editor:"textfield",sortable:!0,renderer:function(val){return val||"-"}},{dataIndex:"Checkpoint",width:80,resizable:!1,tdCls:"intel-editor-cell",text:"Checkpoint",editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["Week"],data:workweeks}),editable:!1,displayField:"Week",listeners:{focus:function(combo){combo.expand()}}},renderer:function(val){return val||"-"},sortable:!0},{text:"Teams Depended On",html:'<div class="pred-dep-header" style="width:80px !important;"></div><div class="pred-dep-header" style="width:155px !important;">Team Name</div><div class="pred-dep-header" style="width:65px  !important;">Supported</div><div class="pred-dep-header" style="width:55px  !important;">US#</div><div class="pred-dep-header" style="width:130px !important;">User Story</div>',dataIndex:"DependencyID",width:580,resizable:!1,sortable:!1,xtype:"componentcolumn",renderer:function(depID){var predDepRecord=me.CustomPredDepStore.findRecord("DependencyID",depID),predecessors=predDepRecord.get("Predecessors");if(me.PredDepTeamStores[depID]||(me.PredDepTeamStores[depID]=Ext.create("Ext.data.Store",{model:"IntelDepTeam",data:predecessors,autoSync:!0,limit:1/0,proxy:{type:"sessionstorage",id:"TeamDep-"+depID+"-proxy"+Math.random()},listeners:{load:function(depTeamStore,depTeamRecords){predDepRecord=me.CustomPredDepStore.findRecord("DependencyID",depID);var predecessors=predDepRecord.get("Predecessors").slice(0);Outer:for(var i=0;depTeamRecords.length>i;++i){for(var depTeamRecord=depTeamRecords[i],realTeamDep,j=0;predecessors.length>j;++j)if(predecessors[j].TID===depTeamRecord.get("TID")){realTeamDep=predecessors.splice(j,1)[0];for(var key in realTeamDep)"id"!==key&&depTeamRecord.set(key,realTeamDep[key]);continue Outer}depTeamStore.suspendEvents(),depTeamStore.remove(depTeamRecord),depTeamStore.resumeEvents()}predecessors.forEach(function(realTeamDep){depTeamStore.add(Ext.create("IntelDepTeam",realTeamDep))})}}})),me.PredDepContainers[depID])return me.PredDepContainers[depID];var defaultHandler={element:"el",fn:function(a){a.stopPropagation()}},teamColumnCfgs=[{dataIndex:"PID",width:160,resizable:!1,renderer:function(val,meta,depTeamRecord){var projectRecord=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("ObjectID")==val});return val&&projectRecord?projectRecord.get("Name"):(meta.tdCls+="intel-editor-cell","Select Team")},editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Name"],data:me.ProjectNames,sorters:{property:"Name"}}),enableKeyEvents:!0,ignoreNoChange:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filters.getRange().forEach(function(filter){me.store.removeFilter(filter)}),me.store.filterBy(function(item){return item.get("Name").indexOf(me.getRawValue())>-1})}},focus:function(combo){combo.expand()}},displayField:"Name"}},{dataIndex:"Sup",width:50,resizable:!1,editor:!1,renderer:function(val,meta,depTeamRecord){return meta.tdCls="No"==val?"intel-not-supported-cell":"intel-supported-cell",val}},{dataIndex:"USID",width:60,resizable:!1,editor:!1,renderer:function(val,meta,depTeamRecord){return depTeamRecord.get("A")?val:"-"}},{dataIndex:"USName",width:138,resizable:!1,editor:!1,renderer:function(val,meta,depTeamRecord){return depTeamRecord.get("A")?val:"-"}},{width:80,resizable:!1,xtype:"componentcolumn",renderer:function(val,meta,depTeamRecord){return{xtype:"button",width:70,text:"Delete",handler:function(){if(me._loadDependenciesStores){predDepRecord=me.CustomPredDepStore.findRecord("DependencyID",depID);for(var predecessors=predDepRecord.get("Predecessors"),i=0;predecessors.length>i;++i)if(predecessors[i].TID===depTeamRecord.get("TID")){predecessors.splice(i,1);break}if(me.PredDepTeamStores[depID].remove(depTeamRecord),!predecessors.length){var newItem=newTeamDep();me.PredDepTeamStores[depID].add(Ext.create("IntelDepTeam",newItem)),predecessors.push(newItem)}predDepRecord.set("Edited",!0)}}}}}];return{xtype:"container",layout:"hbox",bodyCls:"blend-in-grid",pack:"start",align:"stretch",border:!1,items:[{xtype:"button",text:"+ Add Team",width:76,padding:3,margin:"0 4 0 0",handler:function(){if(me.PredDepTeamStores[depID]&&me._loadDependenciesStores){predDepRecord=me.CustomPredDepStore.findRecord("DependencyID",depID);var newItem=newTeamDep();me.PredDepTeamStores[depID].add(Ext.create("IntelDepTeam",newItem)),predDepRecord.data.Predecessors.push(newItem),predDepRecord.set("Edited",!0)}}},{xtype:"rallygrid",width:_.reduce(teamColumnCfgs,function(sum,i){return sum+i.width},0),rowLines:!1,flex:1,columnCfgs:teamColumnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{stripeRows:!1,getRowClass:function(teamDepRecord,index,rowParams,store){return teamDepRecord.get("PID")?"intel-row-35px":"intel-row-35px intel-no-team-dep-selected"}},listeners:{beforeedit:function(editor,e){return e.value?!1:(me._isEditing=!0,void 0)},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var depTeamRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue,i;me._isEditing=!1,predDepRecord=me.CustomPredDepStore.findRecord("DependencyID",depID),console.log("teamDepEdit",field,value,originalValue);var previousEdit=predDepRecord.get("Edited");predDepRecord.set("Edited",!0);var predecessors=predDepRecord.get("Predecessors");if("PID"===field){var projectRecord=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("Name")==value});if(!projectRecord)return depTeamRecord.set("PID",originalValue),predDepRecord.set("Edited",previousEdit),void 0;for(i=0;predecessors.length>i;++i)if(predecessors[i].PID===""+projectRecord.get("ObjectID"))return alert(value+" already included in this dependency"),depTeamRecord.set("PID",originalValue),predDepRecord.set("Edited",previousEdit),void 0;if(projectRecord.get("ObjectID")===me.ProjectRecord.get("ObjectID"))return alert("You cannot depend on yourself"),depTeamRecord.set("PID",originalValue),predDepRecord.set("Edited",previousEdit),void 0;depTeamRecord.set("PID",projectRecord.get("ObjectID"))}for(i=0;predecessors.length>i;++i)if(predecessors[i].TID===depTeamRecord.get("TID")){predecessors[i].PID=depTeamRecord.get("PID");break}}},hideHeaders:!0,showRowActionsColumn:!1,scroll:!1,showPagingToolbar:!1,enableEditing:!1,context:me.getContext(),store:me.PredDepTeamStores[depID]}],listeners:{mousedown:defaultHandler,mousemove:defaultHandler,mouseout:defaultHandler,mouseover:defaultHandler,mouseup:defaultHandler,mousewheel:defaultHandler,scroll:defaultHandler,click:defaultHandler,dblclick:defaultHandler,render:function(){me.PredDepContainers[depID]=this}}}}},{text:"",dataIndex:"Edited",width:80,xtype:"componentcolumn",resizable:!1,renderer:function(value,meta,predDepRecord){var realDepData=removeDepFromList(predDepRecord.get("DependencyID"),me.DependenciesParsedData.Predecessors.slice(0)),dirtyType=getDirtyType(predDepRecord,realDepData);return"Edited"!==dirtyType?"":{xtype:"button",text:"Undo",handler:function(){if(me._loadDependenciesStores){var depID=predDepRecord.get("DependencyID"),realDep=removeDepFromList(depID,me.DependenciesParsedData.Predecessors.slice(0));for(var key in realDep)"Predecessors"===key?predDepRecord.set(key,Ext.clone(realDep[key])):predDepRecord.set(key,realDep[key]);me.PredDepTeamStores[depID].load()}}}}},{text:"",dataIndex:"Edited",width:80,xtype:"componentcolumn",resizable:!1,renderer:function(value,meta,predDepRecord){var realDepData=removeDepFromList(predDepRecord.get("DependencyID"),me.DependenciesParsedData.Predecessors.slice(0)),dirtyType=getDirtyType(predDepRecord,realDepData);if("New"===dirtyType)dirtyType="Save";else{if("Edited"!==dirtyType)return"";dirtyType="Resave"}return{xtype:"button",text:dirtyType,handler:function(){if(me._loadDependenciesStores){if(""===predDepRecord.get("Description"))return alert("Cannot Save: Description is empty"),void 0;if(""===predDepRecord.get("Checkpoint"))return alert("Cannot Save: Checkpoint is empty"),void 0;var predecessors=predDepRecord.get("Predecessors");if(0===predecessors.length)return alert("Cannot Save: Must specify a team you depend on"),void 0;for(var i=0;predecessors.length>i;++i)if(""===predecessors[i].PID)return alert("Cannot Save: All Team Names must be valid"),void 0;me._loadDependenciesStores=!1,me.PredDepGrid.setLoading(!0),me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData();var predDepData=predDepRecord.data,realPredDeps=me.DependenciesParsedData.Predecessors.slice(0),realDepData=removeDepFromList(predDepData.DependencyID,realPredDeps)||{},addedTeamDeps=[],removedTeamDeps=[],updatedTeamDeps=[],localPredTeams=predDepData.Predecessors,realPredTeams=realDepData.Predecessors||[];Outer:for(var i=0;localPredTeams.length>i;++i){for(var j=0;realPredTeams.length>j;++j)if(localPredTeams[i].TID===realPredTeams[j].TID){updatedTeamDeps.push(realPredTeams.splice(j,1)[0]);continue Outer}addedTeamDeps.push(localPredTeams[i])}removedTeamDeps=realPredTeams;var addedTeamDepsFinished=-1,addedTeamDepsCallbacks=[],addedTeamDepsDone=function(){if(++addedTeamDepsFinished===addedTeamDeps.length){var updatedTeamDepsFinished=-1,updatedTeamDepsCallbacks=[],updatedTeamDepsDone=function(){if(++updatedTeamDepsFinished===updatedTeamDeps.length){removedTeamDeps.forEach(function(teamDepData){var project=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("ObjectID")==teamDepData.PID});me._loadUserStoryByFID(teamDepData.USID,project.get("_ref"),function(us){us&&removeSuccDep(us,predDepData)})}),addedTeamDepsCallbacks.forEach(function(cb){cb()}),updatedTeamDepsCallbacks.forEach(function(cb){cb()}),predDepData.Predecessors=localPredTeams;var lastAction=function(){predDepRecord.set("Edited",!1),me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData(),me.CustomPredDepStore.load({callback:function(){me._loadDependenciesStores=!0,me.PredDepGrid.setLoading(!1)}})}})},nextAction=function(){var newUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",predDepData.FormattedID,0,!1,!0,!0);newUserStoryRecord?addPredDep(newUserStoryRecord,predDepData,lastAction):lastAction()};if(realDepData&&realDepData.FormattedID!=predDepData.FormattedID){console.log("moving predDep to new user story",realDepData.FormattedID,predDepData.FormattedID);var oldUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",realDepData.FormattedID,0,!1,!0,!0);oldUserStoryRecord?removePredDep(oldUserStoryRecord,realDepData,nextAction):nextAction()}else nextAction()}};updatedTeamDepsDone(),updatedTeamDeps.forEach(function(teamDepData){var project=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("ObjectID")==teamDepData.PID});me._loadUserStoryByFID(teamDepData.USID,project.get("_ref"),function(us){us?(updatedTeamDepsCallbacks.push(function(){for(var deps=me._getDependencies(us),succs=deps.Succs,i=0;succs.length>i;++i)if(succs[i].ID==predDepData.DependencyID)return succs[i].PUSName=predDepData.UserStoryName,succs[i].PUSID=predDepData.FormattedID,succs[i].CP=predDepData.Checkpoint,succs[i].Desc=predDepData.Description,us.set("c_Dependencies",JSON.stringify(deps,null,"	")),us.save(),void 0;var succDep={DependencyID:predDepData.DependencyID,PredUserStoryName:predDepData.UserStoryName,PredFormattedID:predDepData.FormattedID,PredProjectName:me.ProjectRecord.get("Name"),Description:predDepData.Description,Checkpoint:predDepData.Checkpoint,UserStoryName:teamDepData.USName,FormattedID:teamDepData.USID,Supported:teamDepData.Sup,Assigned:teamDepData.A,ReleaseStartDate:me.ReleaseRecord.get("ReleaseStartDate"),ReleaseDate:me.ReleaseRecord.get("ReleaseDate"),Edited:!1};addSuccDep(us,succDep)}),updatedTeamDepsDone()):me._loadRandomUserStory(project.get("_ref"),function(us){return us?(updatedTeamDepsCallbacks.push(function(){for(var i=0;localPredTeams.length>i;++i)if(localPredTeams[i].TID===teamDepData.TID){localPredTeams[i].USID=us.get("FormattedID"),localPredTeams[i].USName=us.get("Name"),localPredTeams[i].A=!1;break}var succDep={DependencyID:predDepData.DependencyID,PredUserStoryName:predDepData.UserStoryName,PredFormattedID:predDepData.FormattedID,PredProjectName:me.ProjectRecord.get("Name"),Description:predDepData.Description,Checkpoint:predDepData.Checkpoint,UserStoryName:"",FormattedID:"",Supported:teamDepData.Sup,Assigned:!1,ReleaseStartDate:me.ReleaseRecord.get("ReleaseStartDate"),ReleaseDate:me.ReleaseRecord.get("ReleaseDate"),Edited:!1};addSuccDep(us,succDep)}),updatedTeamDepsDone(),void 0):(me._loadDependenciesStores=!0,me.PredDepGrid.setLoading(!1),alert("Project "+project.get("Name")+" has no user stories, cannot continue"),void 0)})})})}};addedTeamDepsDone(),addedTeamDeps.forEach(function(teamDepData){var project=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("ObjectID")==teamDepData.PID});me._loadRandomUserStory(project.get("_ref"),function(us){return us?(addedTeamDepsCallbacks.push(function(){teamDepData.USID=us.get("FormattedID"),teamDepData.USName=us.get("Name");
var succDep={DependencyID:predDepData.DependencyID,PredUserStoryName:predDepData.UserStoryName,PredFormattedID:predDepData.FormattedID,PredProjectName:me.ProjectRecord.get("Name"),UserStoryName:"",FormattedID:"",Description:predDepData.Description,Checkpoint:predDepData.Checkpoint,Supported:"No",Assigned:!1,ReleaseStartDate:me.ReleaseRecord.get("ReleaseStartDate"),ReleaseDate:me.ReleaseRecord.get("ReleaseDate"),Edited:!1};addSuccDep(us,succDep)}),addedTeamDepsDone(),void 0):(me._loadDependenciesStores=!0,me.PredDepGrid.setLoading(!1),alert("Project "+project.get("Name")+" has no user stories, cannot continue"),void 0)})})}})}}}}},{text:"",width:80,xtype:"componentcolumn",resizable:!1,renderer:function(value,meta,predDepRecord){return{xtype:"button",text:"Delete",handler:function(){me._loadDependenciesStores&&confirm("Confirm Dependency Deletion")&&(me.PredDepGrid.setLoading(!0),me._loadDependenciesStores=!1,me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData();var predDeps=me.DependenciesParsedData.Predecessors.slice(0),predDepData=predDepRecord.data,realDepData=removeDepFromList(predDepData.DependencyID,predDeps)||{},realTeamDeps=realDepData.Predecessors||[];realTeamDeps.forEach(function(teamDepData){if(""!==teamDepData.PID){var project=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("ObjectID")==teamDepData.PID});me._loadUserStoryByFID(teamDepData.USID,project.get("_ref"),function(us){us&&removeSuccDep(us,predDepData)})}});var lastAction=function(){me.CustomPredDepStore.remove(predDepRecord),me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData(),me.CustomPredDepStore.load({callback:function(){me._loadDependenciesStores=!0,me.PredDepGrid.setLoading(!1)}})}})},nextAction=function(){var newUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",predDepData.FormattedID,0,!1,!0,!0);newUserStoryRecord?removePredDep(newUserStoryRecord,predDepData,lastAction):lastAction()};if(realDepData&&realDepData.FormattedID!=predDepData.FormattedID){console.log("moving predDep to new user story",realDepData.FormattedID,predDepData.FormattedID);var oldUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",realDepData.FormattedID,0,!1,!0,!0);oldUserStoryRecord?removePredDep(oldUserStoryRecord,realDepData,nextAction):nextAction()}else nextAction()}}))}}}}];me.AddPredDepButton=me.add({xtype:"button",text:"+ Add Dependency",style:"margin-bottom:10px",x:0,y:720,listeners:{click:function(){var randomUserStory=me.DependenciesReleaseUserStories[0];if(randomUserStory){if(me.CustomPredDepStore){var model=Ext.create("IntelPredDep",{DependencyID:1*new Date+""+1e7*Math.random(),FormattedID:randomUserStory.get("FormattedID"),UserStoryName:randomUserStory.get("Name"),Description:"",Checkpoint:"",Predecessors:[newTeamDep()],Edited:!0});me.CustomPredDepStore.add(model)}}else alert("No User Stories for this Release!")}}}),me.PredDepGrid=me.add({xtype:"rallygrid",title:"Predecessor Dependencies",width:_.reduce(predDepColumnCfgs,function(sum,c){return sum+c.width},20),height:400,x:0,y:760,scroll:"vertical",columnCfgs:predDepColumnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0,getRowClass:function(predDepRecord){var cls="intel-row-"+(10+(35*predDepRecord.get("Predecessors").length||35))+"px";return cls}},listeners:{beforeedit:function(){me._isEditing=!0},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var grid=e.grid,predDepRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;if(me._isEditing=!1,console.log("predDep edit:",predDepRecord,field,value,originalValue),value!==originalValue){var previousEdit=predDepRecord.get("Edited");predDepRecord.set("Edited",!0);var userStoryRecord;"UserStoryName"===field?(userStoryRecord=_.find(me.DependenciesReleaseUserStories,function(us){return us.get("Name")===value}),userStoryRecord?predDepRecord.set("FormattedID",userStoryRecord.get("FormattedID")):(predDepRecord.set("UserStoryName",originalValue),predDepRecord.set("Edited",previousEdit))):"FormattedID"===field&&(userStoryRecord=_.find(me.DependenciesReleaseUserStories,function(us){return us.get("FormattedID")===value}),userStoryRecord?predDepRecord.set("UserStoryName",userStoryRecord.get("Name")):(predDepRecord.set("FormattedID",originalValue),predDepRecord.set("Edited",previousEdit)))}}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomPredDepStore}),me.CustomSuccDepStore=Ext.create("Ext.data.Store",{data:Ext.clone(me.DependenciesParsedData.Successors.slice(0)),autoSync:!0,model:"IntelSuccDep",proxy:{type:"sessionstorage",id:"SuccDepProxy"+Math.random()},limit:1/0,listeners:{load:function(customSuccDepStore,customSuccDepRecs){var realSuccDepsData=me.DependenciesParsedData.Successors.slice(0);console.log("syncing succDeps with current userStories",customSuccDepRecs,realSuccDepsData);for(var i=0;customSuccDepRecs.length>i;++i){var depRec=customSuccDepRecs[i],depID=depRec.get("DependencyID"),realDep=removeDepFromList(depID,realSuccDepsData),dirtyType=getDirtyType(depRec,realDep);if("New"!==dirtyType&&"Edited"!==dirtyType)if("Deleted"===dirtyType)customSuccDepStore.suspendEvents(),customSuccDepStore.remove(depRec),customSuccDepStore.resumeEvents();else for(var key in realDep)depRec.set(key,realDep[key])}realSuccDepsData.forEach(function(realDep){console.log("adding succDep",realDep),customSuccDepStore.add(Ext.create("IntelSuccDep",Ext.clone(realDep)))})}}});var succDepColumnCfgs=[{text:"Predecesor Project",dataIndex:"PredProjectName",width:160,resizable:!1,sortable:!0},{text:"Pred US#",dataIndex:"PredFormattedID",width:85,resizable:!1,sortable:!0},{text:"Pred UserStory",dataIndex:"PredUserStoryName",width:160,resizable:!1,sortable:!0},{text:"Dependency Description",dataIndex:"Description",width:160,resizable:!1,editor:!1,sortable:!0},{text:"Checkpoint",dataIndex:"Checkpoint",width:80,resizable:!1,editor:!1,sortable:!0},{text:"Supported",dataIndex:"Supported",width:80,resizable:!1,tdCls:"intel-editor-cell",editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["Sup"],data:[{Sup:"Yes"},{Sup:"No"}]}),editable:!1,displayField:"Sup",listeners:{focus:function(combo){combo.expand()}}},renderer:function(val,meta){return meta.tdCls="No"==val?"intel-not-supported-cell":"intel-supported-cell",val},sortable:!0},{text:"Supporting US#",dataIndex:"FormattedID",tdCls:"intel-editor-cell",width:120,resizable:!1,editor:{xtype:"combobox",width:120,store:Ext.create("Ext.data.Store",{fields:["FormattedID"],data:_.map(me.DependenciesReleaseUserStories,function(usr){return{FormattedID:usr.get("FormattedID")}}),sorters:{property:"FormattedID"}}),enableKeyEvents:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filters.getRange().forEach(function(filter){me.store.removeFilter(filter)}),me.store.filterBy(function(item){return item.get("FormattedID").indexOf(me.getRawValue())>-1})}},focus:function(combo){combo.expand()}},displayField:"FormattedID"},sortable:!0,renderer:function(val){return val?val:"-"}},{text:"UserStory",dataIndex:"UserStoryName",width:160,resizable:!1,tdCls:"intel-editor-cell",editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.DependenciesReleaseUserStories,function(usr){return{Name:usr.get("Name")}}),sorters:{property:"Name"}}),enableKeyEvents:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filters.getRange().forEach(function(filter){me.store.removeFilter(filter)}),me.store.filterBy(function(item){return item.get("Name").indexOf(me.getRawValue())>-1})}},focus:function(combo){combo.expand()}},displayField:"Name"},sortable:!0,renderer:function(val){return val?val:"-"}},{text:"",width:130,xtype:"componentcolumn",resizable:!1,renderer:function(value,meta,succDepRecord){return succDepRecord.get("FormattedID")?{xtype:"button",text:"Remove UserStory",padding:2,handler:function(){succDepRecord.set("Edited",!0),succDepRecord.set("Assigned",!1),succDepRecord.set("FormattedID",""),succDepRecord.set("UserStoryName","")}}:""}},{text:"",width:80,xtype:"componentcolumn",resizable:!1,renderer:function(value,meta,succDepRecord){var realDepData=removeDepFromList(succDepRecord.get("DependencyID"),me.DependenciesParsedData.Successors.slice(0)),dirtyType=getDirtyType(succDepRecord,realDepData);return"Edited"!==dirtyType?"":{xtype:"button",text:"Undo",handler:function(){if(me._loadDependenciesStores){var depID=succDepRecord.get("DependencyID"),realDep=removeDepFromList(depID,me.DependenciesParsedData.Successors.slice(0));for(var key in realDep)succDepRecord.set(key,realDep[key])}}}}},{text:"",width:80,xtype:"componentcolumn",resizable:!1,renderer:function(value,meta,succDepRecord){var realDepData=removeDepFromList(succDepRecord.get("DependencyID"),me.DependenciesParsedData.Successors.slice(0)),dirtyType=getDirtyType(succDepRecord,realDepData);return"Edited"!==dirtyType?"":{xtype:"button",text:"Save",handler:function(){me._loadDependenciesStores&&(me._loadDependenciesStores=!1,me.SuccDepGrid.setLoading(!0),me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData();var succDepData=succDepRecord.data,realSuccDeps=me.DependenciesParsedData.Successors.slice(0),realDepData=removeDepFromList(succDepData.DependencyID,realSuccDeps),project=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("Name")==succDepData.PredProjectName});if(!project)return me._loadDependenciesStores=!0,me.SuccDepGrid.setLoading(!1),alert("could not find project "+succDepData.PredProjectName),void 0;succDepData.FormattedID&&(succDepData._realFormattedID=succDepData.FormattedID,succDepData._realUserStoryName=succDepData.UserStoryName);var reloadDeps=function(){succDepRecord.set("Edited",!1),me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData(),me._loadDependenciesStores=!0,me.SuccDepGrid.setLoading(!1)}})},alertAndDelete=function(msg){alert(msg),console.log("removing succDep from user story",realDepData._realFormattedID,succDepData._realFormattedID);var userStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",realDepData._realFormattedID,0,!1,!0,!0);userStoryRecord&&removeSuccDep(userStoryRecord,realDepData,function(){me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData(),me._loadDependenciesStores=!0,me.SuccDepGrid.setLoading(!1),me.CustomSuccDepStore.remove(succDepRecord)}})})};me._loadUserStoryByFID(succDepData.PredFormattedID,project.get("_ref"),function(us){if(us){var deps=me._getDependencies(us),preds=deps.Preds,predDep=preds[succDepData.DependencyID];if(predDep){for(var predecessors=predDep.Preds,i=0;predecessors.length>i;++i)if(predecessors[i].PID==me.ProjectRecord.get("ObjectID")){predecessors[i].Sup=succDepData.Supported,predecessors[i].USID=succDepData._realFormattedID,predecessors[i].USName=succDepData._realUserStoryName,predecessors[i].A=succDepData.Assigned,us.set("c_Dependencies",JSON.stringify(deps,null,"	")),us.save();var nextAction=function(){var newUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",succDepData._realFormattedID,0,!1,!0,!0);newUserStoryRecord?addSuccDep(newUserStoryRecord,succDepData,reloadDeps):reloadDeps()};if(realDepData&&realDepData._realFormattedID!=succDepData._realFormattedID){console.log("moving succDep to new user story",realDepData._realFormattedID,succDepData._realFormattedID);var oldUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",realDepData._realFormattedID,0,!1,!0,!0);oldUserStoryRecord?removeSuccDep(oldUserStoryRecord,realDepData,nextAction):nextAction()}else nextAction();return}alertAndDelete("Successor removed your dependency. Deleting this dependency now")}else alertAndDelete("Successor removed this dependency. Deleting your dependency now")}else alertAndDelete("Successor UserStory has been deleted. Deleting Dependency Now")})}}))}}}}];me.SuccDepGrid=me.add({xtype:"rallygrid",title:"Successor Dependencies",width:_.reduce(succDepColumnCfgs,function(sum,c){return sum+c.width},20),height:400,x:0,y:1200,scroll:"vertical",columnCfgs:succDepColumnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0,getRowClass:function(predDepRecord){return"intel-row-35px"}},listeners:{beforeedit:function(editor,e){return"No"==e.record.get("Supported")&&"Supported"!=e.field?!1:(me._isEditing=!0,!0)},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var grid=e.grid,succDepRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;if(me._isEditing=!1,console.log("succDep edit:",succDepRecord,field,value,originalValue),value!==originalValue){var previousEdit=succDepRecord.get("Edited");succDepRecord.set("Edited",!0);var userStoryRecord;"UserStoryName"===field?(userStoryRecord=_.find(me.DependenciesReleaseUserStories,function(us){return us.get("Name")===value}),userStoryRecord?(succDepRecord.set("FormattedID",userStoryRecord.get("FormattedID")),succDepRecord.set("Assigned",!0)):(succDepRecord.set("UserStoryName",originalValue),succDepRecord.set("Edited",previousEdit))):"FormattedID"===field?(userStoryRecord=_.find(me.DependenciesReleaseUserStories,function(us){return us.get("FormattedID")===value}),userStoryRecord?(succDepRecord.set("UserStoryName",userStoryRecord.get("Name")),succDepRecord.set("Assigned",!0)):(succDepRecord.set("FormattedID",originalValue),succDepRecord.set("Edited",previousEdit))):"Supported"===field&&"No"==value&&(succDepRecord.set("Edited",!0),succDepRecord.set("Assigned",!1),succDepRecord.set("FormattedID",""),succDepRecord.set("UserStoryName",""))}}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomSuccDepStore})}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name70221",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .x-grid-row.intel-row-35px>.x-grid-cell{height:35px !important}.x-grid-row.intel-row-45px>.x-grid-cell{height:45px !important}.x-grid-row.intel-row-80px>.x-grid-cell{height:80px !important}.x-grid-row.intel-row-115px>.x-grid-cell{height:115px !important}.x-grid-row.intel-row-150px>.x-grid-cell{height:150px !important}.x-grid-row.intel-row-185px>.x-grid-cell{height:185px !important}.x-grid-row.intel-row-220px>.x-grid-cell{height:220px !important}.x-grid-row.intel-row-255px>.x-grid-cell{height:255px !important}.x-grid-row.intel-row-290px>.x-grid-cell{height:290px !important}.x-grid-row.intel-row-325px>.x-grid-cell{height:325px !important}.x-grid-row.intel-row-360px>.x-grid-cell{height:360px !important}.x-grid-row .intel-editor-cell{cursor:pointer !important}.x-grid-row .intel-editor-cell *{cursor:pointer !important}.pred-dep-header{display:inline-block !important;line-height:100% !important;font-weight:500 !important}.grey-row .x-grid-cell{background-color:rgba(224,224,224,0.15) !important}.grey-row.x-grid-row-selected .x-grid-cell{background-color:rgba(224,224,224,0.25) !important}.red-row .x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.red-row.x-grid-row-selected .x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.green-row .x-grid-cell{background-color:rgba(0,255,0,0.15) !important}.green-row.x-grid-row-selected .x-grid-cell{background-color:rgba(0,255,0,0.25) !important}.x-grid-row .red-cell.x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.x-grid-row-selected .red-cell.x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.intel-team-dep-not-selected .x-grid-cell,.x-grid-row-selected .intel-team-dep-not-selected .x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.intel-team-dep-not-selected.x-grid-row-selected .x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.x-grid-row.intel-no-team-dep-selected .x-grid-cell{background-color:rgba(224,224,224,0.15) !important}.x-grid-row-hover.intel-no-team-dep-selected .x-grid-cell,.x-grid-row-selected.intel-no-team-dep-selected .x-grid-cell{background-color:rgba(224,224,224,0.25) !important}.x-grid-row .intel-not-supported-cell.x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.x-grid-row-selected .intel-not-supported-cell.x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.x-grid-row .intel-supported-cell.x-grid-cell{background-color:rgba(0,255,0,0.15) !important}.x-grid-row-selected .intel-supported-cell.x-grid-cell{background-color:rgba(0,255,0,0.25) !important}.blend-in-grid{background-color:rgba(0,0,0,0)}
    </style>
</head>
<body>
</body>
</html>
