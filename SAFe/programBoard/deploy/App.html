<!DOCTYPE html>
<html>
<head>
    <title>Random App Name70221</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.0.1/q.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Skirtle.CTemplate",{extend:"Ext.XTemplate",statics:{AUTO_ID:0},copyDepth:10,cTpl:'<p id="ctemplate-{0}-{1}"></p>',isCTemplate:!0,constructor:function(){var me=this;me.callParent(arguments),me.id=++me.statics().AUTO_ID,me.reset()},copyValues:function(values,depth){var me=this,id,copy={},copyDepth=depth||me.copyDepth;return 1===copyDepth?values:Ext.isArray(values)?Ext.Array.map(values,function(value){return me.copyValues(value,copyDepth-1)}):Ext.isObject(values)?values.isComponent?(id=values.getId(),me.ids.push(id),Ext.String.format(me.cTpl,id,me.id)):(Ext.Object.each(values,function(key,value){copy[key]="$comp"===key?value:me.copyValues(value,copyDepth-1)}),copy):values},doInsert:function(){var ret=this.callParent(arguments);return this.injectComponents(),ret},doPolling:function(interval){var me=this;me.pollInterval=interval,me.pollId&&clearTimeout(me.pollId),me.pollId=Ext.defer(me.injectComponents,interval,me)},getPlaceholderEl:function(id){return Ext.get("ctemplate-"+id+"-"+this.id)},injectComponents:function(){for(var me=this,ids=me.ids,index=ids.length-1,id,cmp,placeholderEl;index>=0;--index)id=ids[index],cmp=Ext.getCmp(id),placeholderEl=me.getPlaceholderEl(id),(me.renderComponent(cmp,placeholderEl)||!cmp)&&(Ext.Array.splice(ids,index,1),placeholderEl&&placeholderEl.remove());ids.length&&me.doPolling(1.5*me.pollInterval)},overwrite:function(el){var dom,firstChild,ret;if(Ext.isIE)for(dom=Ext.getDom(el);dom.firstChild;)dom.removeChild(dom.firstChild);return ret=this.callParent(arguments),this.injectComponents(),ret},renderComponent:function(cmp,placeholderEl){if(cmp&&placeholderEl){var parent=placeholderEl.parent();return cmp.rendered?cmp.getEl().replace(placeholderEl):cmp.render(parent,placeholderEl),Ext.isIE6&&parent.repaint(),!0}return!1},reset:function(){var me=this;me.ids=[],me.pollId&&(clearTimeout(me.pollId),me.pollId=null)}},function(ctemplate){var apply=function(){var me=this,args=Ext.Array.slice(arguments);return args[0]=me.copyValues(args[0]),me.doPolling(10),me.callParent(args)};ctemplate.prototype.applyOut?ctemplate.override({applyOut:apply}):(ctemplate.override({applyTemplate:apply}),ctemplate.createAlias("apply","applyTemplate"))}),Ext.define("Skirtle.grid.column.Component",{alias:"widget.componentcolumn",extend:"Ext.grid.column.Column",requires:["Skirtle.CTemplate"],autoWidthComponents:!0,componentGC:!0,hasCustomRenderer:!0,lastFrameWidth:12,widthUpdateDelay:[10,400],constructor:function(cfg){var me=this;me.callParent(arguments),me.compIds=[],me.dataIndex=me.dataIndex||Ext.id(null,"cc-dataIndex-"),me.tpl=me.createTemplate(me.tpl),me.renderer=me.createRenderer(me.renderer),me.registerColumnListeners()},addRefOwner:function(child){var me=this,fn=me.refOwnerFn||(me.refOwnerFn=function(){return me});40200>me.extVersion?child.getBubbleTarget=fn:child.getRefOwner=fn},applyTemplate:function(data,value){return Ext.isDefined(value)&&(data[this.dataIndex]=value),this.tpl.apply(data)},beforeViewRefresh:function(){if(Ext.isIE)for(var ids=this.compIds,index=0,len=ids.length,item,el,parentEl;len>index;index++)(item=Ext.getCmp(ids[index]))&&(el=item.getEl())&&(el=el.dom)&&(parentEl=el.parentNode)&&parentEl.removeChild(el)},calculateFrameWidth:function(component){var el=component.getEl(),parentDiv=el&&el.parent(),parentTd=parentDiv&&parentDiv.parent();return parentTd?this.lastFrameWidth=parentDiv.getFrameWidth("lr")+parentTd.getFrameWidth("lr"):void 0},createRenderer:function(renderer){var me=this;return function(value,p,record){var data=Ext.apply({},record.data,record.getAssociatedData());return renderer&&(value=renderer.apply(this,arguments)),value=me.processValue(value),me.applyTemplate(data,value)}},createTemplate:function(tpl){return tpl&&tpl.isTemplate?tpl:Ext.create("Skirtle.CTemplate",tpl||["{",this.dataIndex,"}"])},destroyChild:function(child){child.destroy()},getRefItems:function(deep){for(var items=this.callParent([deep]),ids=this.compIds,index=0,len=ids.length,item;len>index;index++)item=Ext.getCmp(ids[index]),item&&(items.push(item),deep&&item.getRefItems&&items.push.apply(items,item.getRefItems(!0)));return items},onChildAfterRender:function(child){this.resizeChild(child)},onChildBoxReady:function(child){this.resizeChild(child,!1)},onChildDestroy:function(child){Ext.Array.remove(this.compIds,child.getId())},onChildResize:function(){this.redoScrollbars()},onColumnResize:function(column){column.resizeAll()},onColumnShow:function(column){column.resizeAll()},onColumnVisibilityChange:function(column){var items=column.getRefItems(),index=0,length=items.length,visible=!column.isHidden();for(Ext.suspendLayouts&&Ext.suspendLayouts();length>index;++index)items[index].setVisible(visible);Ext.resumeLayouts&&Ext.resumeLayouts(!0)},onDestroy:function(){Ext.destroy(this.getRefItems()),this.callParent()},onRender:function(){this.registerViewListeners(),this.callParent(arguments)},onViewChange:function(){var me=this,tpl=me.tpl;me.suspendResizing(),tpl.isCTemplate&&(tpl.injectComponents(),tpl.reset()),me.redoScrollbars(),me.resumeResizing(),me.performGC()},performGC:function(){for(var compIds=this.compIds,index=compIds.length-1,comp,el;index>=0;--index)comp=Ext.getCmp(compIds[index]),el=comp&&comp.getEl(),el&&(!this.componentGC||el.dom&&Ext.getDom(Ext.id(el))===el.dom)||comp&&!comp.isDestroyed&&comp.destroy()},processValue:function(value){var me=this,compIds=me.compIds,id,initialWidth,dom,parent;return Ext.isObject(value)&&!value.isComponent&&value.xtype&&(value=Ext.widget(value.xtype,value)),value&&value.isComponent&&(id=value.getId(),Ext.Array.contains(compIds,id)||compIds.push(id),me.addRefOwner(value),me.registerListeners(value),value.rendered?Ext.isIE&&(dom=value.el.dom,parent=dom.parentNode,parent&&(40101===me.extVersion&&Ext.core.DomHelper.insertBefore(dom,{tag:"p"}),parent.removeChild(dom))):me.autoWidthComponents&&(initialWidth=me.getWidth()-me.lastFrameWidth,initialWidth=initialWidth>4?initialWidth:4,value.setWidth(initialWidth)),(Ext.isIE6||Ext.isIE7)&&me.isHidden()&&value.hide()),value},redoScrollbars:function(){var me=this,grid=me.up("tablepanel");if(grid){if(me.resizeQueue)return me.redoScrollbarsRequired=!0,void 0;40100>me.extVersion?(grid.invalidateScroller(),grid.determineScrollbars()):grid.doLayout()}},registerColumnListeners:function(){var me=this;me.autoWidthComponents&&(me.on("resize",me.onColumnResize),me.on("show",me.onColumnShow)),(Ext.isIE6||Ext.isIE7)&&me.on({hide:me.onColumnVisibilityChange,show:me.onColumnVisibilityChange})},registerListeners:function(component){var me=this;component.on("destroy",me.onChildDestroy,me),me.autoWidthComponents&&(component.on("afterrender",me.onChildAfterRender,me,{single:!0}),me.extVersion>=40100&&component.on("boxready",me.onChildBoxReady,me,{single:!0})),component.on("resize",me.onChildResize,me)},registerViewListeners:function(){var me=this,view=me.up("tablepanel").getView();me.mon(view,"beforerefresh",me.beforeViewRefresh,me),me.mon(view,"refresh",me.onViewChange,me),me.mon(view,"itemupdate",me.onViewChange,me),me.mon(view,"itemadd",me.onViewChange,me),me.mon(view,"itemremove",me.onViewChange,me)},resizeAll:function(){var me=this;me.suspendResizing(),me.resizeQueue=me.getRefItems(),me.resumeResizing()},resizeChild:function(component,defer){var me=this,frameWidth,newWidth,oldWidth,resizeQueue;return me.resizingSuspended?(resizeQueue=me.resizeQueue,Ext.Array.contains(resizeQueue,component)||resizeQueue.push(component),void 0):(frameWidth=me.calculateFrameWidth(component),Ext.isNumber(frameWidth)&&(newWidth=me.getWidth()-frameWidth,oldWidth=component.getWidth(),me.setChildWidth(component,newWidth,oldWidth)&&defer!==!1&&Ext.each(me.widthUpdateDelay,function(delay){Ext.defer(me.resizeChild,delay,me,[component,!1])})),void 0)},resumeResizing:function(){var me=this,index=0,resizeQueue=me.resizeQueue,len=resizeQueue.length;if(!--me.resizingSuspended){for(;len>index;++index)me.resizeChild(resizeQueue[index]);me.resizeQueue=null,me.redoScrollbarsRequired&&me.redoScrollbars()}},setChildWidth:function(component,newWidth,oldWidth){return oldWidth===newWidth?!1:(component.setWidth(newWidth),!0)},suspendResizing:function(){var me=this;me.resizingSuspended=(me.resizingSuspended||0)+1,me.resizeQueue||(me.resizeQueue=[])}},function(cls){var proto=cls.prototype,version=Ext.getVersion();proto.extVersion=100*(100*version.getMajor()+version.getMinor())+version.getPatch(),Ext.Element.prototype.syncContent&&"4.1.0"==""+version&&(proto.extVersion=40101)});
                Ext.define("intel.grid.column.Component.",{alias:"widget.fastgridcolumn",extend:"Skirtle.grid.column.Component",autoWidthComponents:!1,componentGC:!0,hasCustomRenderer:!0,lastFrameWidth:12,constructor:function(cfg){var me=this;me.callParent(arguments)},onViewChange:function(){var me=this,tpl=me.tpl;me.suspendResizing(),tpl.isCTemplate&&(tpl.injectComponents(),tpl.reset()),me.resumeResizing(),me.performGC()},resumeResizing:function(){var me=this,index=0,resizeQueue=me.resizeQueue,len=resizeQueue.length;if(!--me.resizingSuspended){for(;len>index;++index)me.resizeChild(resizeQueue[index]);me.resizeQueue=null}},onChildResize:function(){}});
                Ext.define("Intel.data.proxy.SessionStorage",{extend:"Ext.data.proxy.SessionStorage",alias:"proxy.fastsessionproxy",constructor:function(cfg){var me=this;me.callParent(arguments)},update:function(operation,callback,scope){var records=operation.records,length=records.length,ids=this.getIds(),record,id,i;for(operation.setStarted(),i=0;length>i;i++)record=records[i],this.setRecord(record),record.commit(!0),id=record.getId(),void 0!==id&&-1==Ext.Array.indexOf(ids,id)&&ids.push(id);this.setIds(ids),operation.setCompleted(),operation.setSuccessful(),"function"==typeof callback&&callback.call(scope||this,operation)}});
                Ext.define("Intel.data.FastStore",{extend:"Ext.data.Store",alias:"store.faststore",constructor:function(cfg){var me=this;me.callParent(arguments)},afterEdit:function(record,modifiedFieldNames){var me=this,i,shouldSync;if(me.autoSync&&!me.autoSyncSuspended)for(i=modifiedFieldNames.length;i--;)if(record.fields.get(modifiedFieldNames[i]).persist){me.sync();break}me.onUpdate(record,Ext.data.Model.EDIT,modifiedFieldNames)}});
                Ext.define("Intel.form.field.ComboBox",{extend:"Ext.form.field.ComboBox",alias:["widget.intelcombo","widget.intelcombobox"],constructor:function(){this.callParent(arguments)},enableKeyEvents:!0,queryMode:"local",ignoreNoChange:!0,listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var combo=this;combo.store.filters.getRange().forEach(function(filter){combo.store.removeFilter(filter)}),combo.store.filterBy(function(item){return 0===item.get(combo.displayField).indexOf(combo.getRawValue())})}},focus:function(combo){combo.store.filters.getRange().forEach(function(filter){combo.store.removeFilter(filter)}),combo.setValue(""),combo.expand()}}});
                Ext.define("Intel.grid.plugin.CellEditing",{alias:"plugin.fastcellediting",extend:"Ext.grid.plugin.CellEditing",constructor:function(){this.callParent(arguments)},triggerEvent:"cellclick",onEditComplete:function(ed,value,startValue){var me=this,activeColumn=me.getActiveColumn(),context=me.context,record;if(activeColumn){if(record=context.record,me.setActiveEditor(null),me.setActiveColumn(null),me.setActiveRecord(null),context.value=value,!me.validateEdit())return me.editing=!1,void 0;record.beginEdit(),record.isEqual(value,startValue)||record.set(activeColumn.dataIndex,value),context.view.focusRow(context.rowIdx,100),me.fireEvent("edit",me,context),me.editing=!1,record.endEdit()}}});
                Ext.define("Intel.view.ScrollTable",{extend:"Ext.view.Table",alias:"widget.scrolltableview",constructor:function(cfg){var me=this;me.callParent(arguments)},refresh:function(){var me=this,targetEl,targetParent,oldDisplay,nextSibling,dom,records,el=me.getEl(),scroll=el&&el.getScrollTop();me.rendered&&!me.isDestroyed&&(me.hasListeners.beforerefresh&&me.fireEvent("beforerefresh",me)===!1||(targetEl=me.getTargetEl(),records=me.getViewRange(),dom=targetEl.dom,me.preserveScrollOnRefresh||(targetParent=dom.parentNode,oldDisplay=dom.style.display,dom.style.display="none",nextSibling=dom.nextSibling,targetParent.removeChild(dom)),me.refreshCounter?me.clearViewEl():(me.fixedNodes=targetEl.dom.childNodes.length,me.refreshCounter=1),me.tpl.append(targetEl,me.collectData(records,me.all.startIndex)),1>records.length?(this.store.loading||me.deferEmptyText&&!me.hasFirstRefresh||Ext.core.DomHelper.insertHtml("beforeEnd",targetEl.dom,me.emptyText),me.all.clear()):(me.collectNodes(targetEl.dom),me.updateIndexes(0)),me.hasFirstRefresh&&(me.refreshSelmodelOnRefresh!==!1?me.selModel.refresh():me.selModel.pruneIf()),me.hasFirstRefresh=!0,me.preserveScrollOnRefresh||(targetParent.insertBefore(dom,nextSibling),dom.style.display=oldDisplay),this.refreshSize(),me.fireEvent("refresh",me),me.viewReady||(me.viewReady=!0,me.fireEvent("viewready",me))),scroll&&me.preserveScrollOnRefresh&&el.setScrollTop(scroll))},onRemove:function(ds,records,indexes){var me=this,fireItemRemove=me.hasListeners.itemremove,i,record,index,el=me.getEl(),scroll=el&&el.getScrollTop();if(me.all.getCount()){if(0===me.dataSource.getCount()){if(fireItemRemove)for(i=indexes.length-1;i>=0;--i)me.fireEvent("itemremove",records[i],indexes[i]);me.refresh()}else{for(i=indexes.length-1;i>=0;--i)record=records[i],index=indexes[i],me.doRemove(record,index),fireItemRemove&&me.fireEvent("itemremove",record,index);me.updateIndexes(indexes[0])}this.refreshSize(),scroll&&me.preserveScrollOnRefresh&&el.setScrollTop(scroll)}},onUpdate:function(ds,record){var me=this,index,node,el=me.getEl(),scroll=el&&el.getScrollTop();if(me.viewReady){if(index=me.dataSource.indexOf(record),index>-1&&(node=me.bufferRender([record],index)[0],me.getNode(record)))return me.all.replaceElement(index,node,!0),me.updateIndexes(index,index),me.selModel.onUpdate(record),me.hasListeners.itemupdate&&me.fireEvent("itemupdate",record,index,node),node;scroll&&me.preserveScrollOnRefresh&&el.setScrollTop(scroll)}},onAdd:function(store,records,index){var me=this,nodes,el=me.getEl(),scroll=el&&el.getScrollTop();me.rendered&&(0===me.all.getCount()?(me.refresh(),nodes=me.all.slice()):(nodes=me.doAdd(records,index),me.refreshSelmodelOnRefresh!==!1&&me.selModel.refresh(),me.updateIndexes(index),me.refreshSize()),me.hasListeners.itemadd&&me.fireEvent("itemadd",records,index,nodes),scroll&&me.preserveScrollOnRefresh&&el.setScrollTop(scroll))}});
                preferenceName="intel-program-board",Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"container",layout:{type:"hbox",align:"stretch",pack:"start"},height:45,itemId:"navbox",items:[{xtype:"container",flex:3,itemId:"navbox_left",layout:{type:"hbox"}},{xtype:"container",flex:2,itemId:"navbox_right",layout:{type:"hbox",pack:"end"}}]},{xtype:"container",layout:{type:"hbox",align:"stretch",pack:"start"},height:320,itemId:"tc_vel_box"}],minWidth:910,_showMessage:function(text){this.ShowMessageText&&this.remove(this.ShowMessageText),this.ShowMessageText=this.add({xtype:"text",text:text})},_loadModels:function(cb){var promises=[],models={Project:"Project",UserStory:"HierarchicalRequirement",Feature:"PortfolioItem/Feature",Milestone:"PortfolioItem/Milestone"};_.each(models,function(modelType,modelName){var defered=Q.defer();Rally.data.WsapiModelFactory.getModel({type:modelType,scope:this,success:function(loadedModel){this[modelName]=loadedModel,defered.resolve()}}),promises.push(defered.promise)},this),Q.all(promises).then(cb)},_loadProject:function(project,cb){this.Project.load(project.ObjectID,{fetch:["ObjectID","Releases","Children","Parent","Name"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},callback:cb,scope:this})},_loadFeature:function(oid,cb){return oid?(this.Feature.load(oid,{fetch:["Name","ObjectID","FormattedID","c_TeamCommits","c_Risks","Project","PlannedEndDate","Parent"],context:{workspace:this.getContext().getWorkspace()._ref,project:this.ProjectRecord.get("_ref")},callback:cb,scope:this}),void 0):(cb(),void 0)},_loadUserStory:function(oid,cb){return oid?(this.UserStory.load(oid,{fetch:["Name","ObjectID","Release","Project","Feature","FormattedID","Predecessors","Successors","c_Dependencies","Iteration","PlanEstimate"],context:{workspace:this.getContext().getWorkspace()._ref,project:this.ProjectRecord.get("_ref")},callback:cb,scope:this}),void 0):(cb(),void 0)},_loadMilestone:function(milestone,cb){this.Milestone.load(milestone.ObjectID,{fetch:["ObjectID","Parent","Name"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},callback:cb,scope:this})},_getReleaseFilterString:function(){var filterString=Ext.create("Rally.data.wsapi.Filter",{property:"Project.ObjectID",value:this.ProjectRecord.get("ObjectID")}),filterString2,f2;return filterString2=Ext.create("Rally.data.wsapi.Filter",{property:"ReleaseDate",operator:">=",value:(new Date).toISOString()}),filterString=filterString.and(filterString2),""+filterString},_loadReleases:function(cb){var filterString=this._getReleaseFilterString();this.ReleaseStore=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Dummy",value:"value"}]}),this.ReleaseStore._hydrateModelAndLoad=function(options){var deferred=new Deft.Deferred;this.hydrateModel().then({success:function(model){this.proxy.encodeFilters=function(){return filterString},this.load(options).then({success:Ext.bind(deferred.resolve,deferred),failure:Ext.bind(deferred.reject,deferred)})},scope:this})},this.ReleaseStore.load({scope:this,callback:function(releaseRecords,releaseStore){console.log("releases loaded:",releaseRecords),cb(),cb=null}})},_loadRootProject:function(projectRecord,cb){var n=projectRecord.get("Name");"All Scrums"!==n&&"All Scrums Sandbox"!==n&&projectRecord.get("Parent")?this._loadProject(projectRecord.get("Parent"),function(parentRecord){this._loadRootProject(parentRecord,cb)}.bind(this)):(this.RootProjectRecord=projectRecord,cb())},_projectInWhichTrain:function(projectRecord,cb){projectRecord||cb();var split=projectRecord.get("Name").split(" ART ");if(split.length>1)cb(projectRecord);else{var parent=projectRecord.get("Parent");parent?this._loadProject(parent,function(parentRecord){this._projectInWhichTrain(parentRecord,cb)}.bind(this)):cb()}},_allValidProjectsLoaded:function(scrums,cb){this.ValidProjects=_.indexBy(scrums,function(scrum){return scrum.data.ObjectID}),this.ProjectNames=_.map(scrums,function(s){return{Name:s.get("Name")}}),console.log("valid scrums loaded:",scrums),cb()},_loadAllTrains:function(cb){Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,remoteSort:!1,limit:1/0,fetch:["Name","ObjectID"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",operator:"contains",value:" ART "},{property:"Name",operator:"!contains",value:"Test"}],listeners:{load:{fn:function(projectStore,projectRecords){this.AllTrainRecordsStore=projectStore,this.TrainNames=_.map(projectRecords,function(pr){return{Name:pr.get("Name").split(" ART ")[0]}}),console.log("AllTrainRecords loaded",projectRecords),cb()},single:!0,scope:this}}})},_loadValidProjects:function(cb){var scrums=[],loadChildren=function(project,_cb){project.data.TeamMembers.Count>0&&scrums.push(project),Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,remoteSort:!1,limit:1/0,fetch:["Name","ObjectID","Parent","TeamMembers"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Parent.ObjectID",value:project.get("ObjectID")}],listeners:{load:{fn:function(projectStore,projectRecords){var promises=[];projectRecords.forEach(function(c){var defered=Q.defer();loadChildren(c,defered.resolve),promises.push(defered.promise)}),Q.all(promises).then(_cb)},single:!0,scope:this}}})}.bind(this);Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,remoteSort:!1,pageSize:1,limit:1,fetch:["Name","ObjectID","TeamMembers"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:this.RootProjectRecord.get("Name")}],listeners:{load:{fn:function(ps,recs){loadChildren(recs[0],this._allValidProjectsLoaded.bind(this,scrums,cb))},single:!0,scope:this}}})},_loadRandomUserStory:function(ProjectRef,cb){Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",autoLoad:!0,limit:1,pageSize:1,fetch:["Name","CreationDate","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:this.getContext().getWorkspace()._ref,project:ProjectRef},sorters:[{property:"CreationDate",direction:"DESC"}],listeners:{load:{fn:function(userStoryStore,userStoryRecords){cb(userStoryRecords.pop())},single:!0}}})},_loadUserStoryByFID:function(FormattedID,ProjectRef,cb){Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",autoLoad:!0,limit:1,pageSize:1,fetch:["Name","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:this.getContext().getWorkspace()._ref,project:ProjectRef},filters:[{property:"FormattedID",value:FormattedID}],listeners:{load:{fn:function(userStoryStore,userStoryRecords){cb(userStoryRecords.pop())},single:!0}}})},_milestoneLoaded:function(frData,defered,milestoneRecord){var p=milestoneRecord.data.Parent;this.FeatureProductHash[frData.ObjectID]=p&&p.Name?p.Name:"",defered.resolve()},_getFeatureFilterString:function(){var coreFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:this.ReleaseRecord.get("Name")});if(this.TrainRecord){var prodString=this.TrainRecord.get("Name").match(/\((.*)\)/)[1];return""+_.reduce(prodString.split("/"),function(filter,product){var newFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:product.trim().split(" ")[0]+" Portfolio"});return filter?filter.or(newFilter):newFilter},null).and(coreFilter)}throw"You should have a train here"},_loadFeatures:function(cb){var filterString=this._getFeatureFilterString();this.FeatureStore=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",limit:1/0,remoteSort:!1,fetch:["Name","ObjectID","FormattedID","c_TeamCommits","c_Risks","Project","PlannedEndDate","Parent"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Dummy",value:"value"}]}),this.FeatureStore._hydrateModelAndLoad=function(options){var deferred=new Deft.Deferred;this.hydrateModel().then({success:function(model){this.proxy.encodeFilters=function(){return filterString},this.load(options).then({success:Ext.bind(deferred.resolve,deferred),failure:Ext.bind(deferred.reject,deferred)})},scope:this})},this.FeatureStore.load({scope:this,callback:function(featureRecords){console.log("features loaded:",featureRecords);var promises=[];this.FeatureProductHash={},featureRecords.forEach(function(fr){var defered=Q.defer(),frData=fr.data;frData.Parent?this._loadMilestone(frData.Parent,this._milestoneLoaded.bind(this,frData,defered)):(this.FeatureProductHash[frData.ObjectID]="",defered.resolve()),promises.push(defered.promise)},this),Q.all(promises).then(cb)}})},_loadIterations:function(cb){var startDate=Rally.util.DateTime.toIsoString(this.ReleaseRecord.get("ReleaseStartDate")),endDate=Rally.util.DateTime.toIsoString(this.ReleaseRecord.get("ReleaseDate"));this.IterationStore=Ext.create("Rally.data.WsapiDataStore",{model:"Iteration",autoLoad:!0,remoteSort:!1,limit:1/0,fetch:["Name","EndDate","StartDate","PlannedVelocity","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:this.getContext().getProject()._ref},filters:[{property:"EndDate",operator:">=",value:startDate},{property:"StartDate",operator:"<=",value:endDate}],listeners:{load:function(store){console.log("Iterations loaded:",store.getRecords()),cb()},scope:this,single:!0}})},_loadUserStories:function(cb){var startDate=Rally.util.DateTime.toIsoString(this.ReleaseRecord.get("ReleaseStartDate")),endDate=Rally.util.DateTime.toIsoString(this.ReleaseRecord.get("ReleaseDate")),coreFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:this.ReleaseRecord.get("Name")}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:this.ProjectRecord.get("Name")})),depFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:this.ProjectRecord.get("Name")}).and(Ext.create("Rally.data.wsapi.Filter",{property:"c_Dependencies",operator:"!=",value:""})),filterString=""+coreFilter.or(depFilter);this.UserStoryStore=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1/0,remoteSort:!1,fetch:["Name","ObjectID","Release","Project","Feature","FormattedID","Predecessors","Successors","c_Dependencies","Iteration","PlanEstimate"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Dummy",value:"value"}],listeners:{load:{fn:function(userStoryStore,userStoryRecords){console.log("user stories loaded:",userStoryRecords),cb()},single:!0}}}),this.UserStoryStore._hydrateModelAndLoad=function(options){var deferred=new Deft.Deferred;this.hydrateModel().then({success:function(model){this.proxy.encodeFilters=function(){return filterString},this.load(options).then({success:Ext.bind(deferred.resolve,deferred),failure:Ext.bind(deferred.reject,deferred)})},scope:this})},this.UserStoryStore.load()},_getTeamCommit:function(featureRecord){var tcs=featureRecord.get("c_TeamCommits"),projectID=this.ProjectRecord.get("ObjectID");try{tcs=JSON.parse(atob(tcs))[projectID]||{}}catch(e){tcs={}}return tcs},_setTeamCommit:function(featureRecord,tc,cb){var tcs=featureRecord.get("c_TeamCommits"),projectID=this.ProjectRecord.get("ObjectID");try{tcs=JSON.parse(atob(tcs))||{}}catch(e){tcs={}}tcs[projectID]||(tcs[projectID]={}),tcs[projectID].Commitment=tc.Commitment,tcs[projectID].Objective=tc.Objective;var str=btoa(JSON.stringify(tcs,null,"	"));str.length>=32768&&(this._alert("ERROR","TeamCommits field for "+featureRecord.get("FormattedID")+" ran out of space! Cannot save"),cb&&cb()),featureRecord.set("c_TeamCommits",str),featureRecord.save({callback:cb})},_TeamCommitsCountHash:{},_getStoryCount:function(FID){if(this._TeamCommitsCountHash[FID])return this._TeamCommitsCountHash[FID];var count=_.reduce(this.UserStoryStore.getRecords(),function(total,us){return 1*(us.get("Feature")&&us.get("Feature").ObjectID==FID)+total},0);return this._TeamCommitsCountHash[FID]=count,count},_TeamCommitsEstimateHash:{},_getStoriesEstimate:function(FID){if(this._TeamCommitsEstimateHash[FID])return this._TeamCommitsEstimateHash[FID];var estimate=_.reduce(this.UserStoryStore.getRecords(),function(total,us){return 1*(us.get("Feature")&&us.get("Feature").ObjectID==FID?us.get("PlanEstimate"):0)+total},0);return this._TeamCommitsEstimateHash[FID]=estimate,estimate},_getRisks:function(featureRecord){var risks=featureRecord.get("c_Risks");try{risks=JSON.parse(atob(risks))||{}}catch(e){risks={}}return risks},_parseRisksFromFeature:function(featureRecord){var array=[],projectID=this.ProjectRecord.get("ObjectID"),risks=this._getRisks(featureRecord),ObjectID=featureRecord.get("ObjectID"),FormattedID=featureRecord.get("FormattedID"),FeatureName=featureRecord.get("Name");if(risks[projectID])for(var riskID in risks[projectID]){var risk=risks[projectID][riskID];array.push({ObjectID:ObjectID,FormattedID:FormattedID,FeatureName:FeatureName,RiskID:riskID,Description:risk.Desc,Impact:risk.Imp,Status:risk.Sta,Contact:risk.Cont,Checkpoint:risk.CP,Edited:!1})}return array},_parseRisksData:function(){var array=[];_.each(this.FeatureStore.getRecords(),function(featureRecord){array=array.concat(this._parseRisksFromFeature(featureRecord))},this),this.RisksParsedData=array},_removeRiskFromList:function(riskID,riskList){for(var i=0;riskList.length>i;++i)if(riskList[i].RiskID==riskID)return riskList.splice(i,1)[0]},_removeRisk:function(featureRecord,riskData,cb){var risks=this._getRisks(featureRecord),projectID=this.ProjectRecord.get("ObjectID");if(risks[projectID]){delete risks[projectID][riskData.RiskID],this.RisksParsedData=_.reject(this.RisksParsedData,function(rpd){return rpd.RiskID===riskData.RiskID&&rpd.FormattedID===riskData.FormattedID});var str=btoa(JSON.stringify(risks,null,"	"));str.length>=32768&&(this._alert("ERROR","Risks field for "+featureRecord.get("FormattedID")+" ran out of space! Cannot save"),cb&&cb()),featureRecord.set("c_Risks",str),featureRecord.save({callback:function(){console.log("removed risk from feature:",featureRecord,riskData,risks),cb()}})}else cb()},_addRisk:function(featureRecord,riskData,cb){var risks=this._getRisks(featureRecord),projectID=this.ProjectRecord.get("ObjectID");riskData=Ext.clone(riskData),riskData.Edited=!1,risks[projectID]||(risks[projectID]={});var copy={CP:riskData.Checkpoint,Cont:riskData.Contact,Desc:riskData.Description,Imp:riskData.Impact,Sta:riskData.Status};risks[projectID][riskData.RiskID]=copy;for(var parseDataAdded=!1,i=0;this.RisksParsedData.length>i;++i){var rpd=this.RisksParsedData[i];if(rpd.RiskID===riskData.RiskID&&rpd.FormattedID===riskData.FormattedID){this.RisksParsedData[i]=riskData,parseDataAdded=!0;break}}parseDataAdded||this.RisksParsedData.push(riskData);var str=btoa(JSON.stringify(risks,null,"	"));str.length>=32768&&(this._alert("ERROR","Risks field for "+featureRecord.get("FormattedID")+" ran out of space! Cannot save"),cb&&cb()),featureRecord.set("c_Risks",str),featureRecord.save({callback:function(){console.log("added risk to feature:",featureRecord,riskData,risks),cb()}})},_isInRelease:function(usr){return usr.get("Release")&&usr.get("Release").Name===this.ReleaseRecord.get("Name")},_getDependencies:function(userStoryRecord){var dependencies,dependencyString=userStoryRecord.get("c_Dependencies");if(""===dependencyString)dependencies={Preds:{},Succs:[]};else try{dependencies=JSON.parse(atob(dependencyString))}catch(e){dependencies={Preds:{},Succs:[]}}return dependencies},_parseDependenciesFromUserStory:function(userStoryRecord){var deps=this._getDependencies(userStoryRecord),preds=deps.Preds,succs=deps.Succs,predDepsList=[],succDepsList=[],startDate=new Date(this.ReleaseRecord.get("ReleaseStartDate")),endDate=new Date(this.ReleaseRecord.get("ReleaseDate")),ObjectID=userStoryRecord.get("ObjectID");if(this._isInRelease(userStoryRecord))for(var predDepID in preds){var predDep=preds[predDepID];predDepsList.push({DependencyID:predDepID,ObjectID:ObjectID,FormattedID:userStoryRecord.get("FormattedID"),UserStoryName:userStoryRecord.get("Name"),Description:predDep.Desc,Checkpoint:predDep.CP,Status:predDep.Sta,Predecessors:predDep.Preds||[],Edited:!1})}for(var i=0;succs.length>i;++i){var succDep=succs[i];if(new Date(succDep.REL)>=startDate&&endDate>=new Date(succDep.REL_S)){var FormattedID,UserStoryName;succDep.A?(FormattedID=userStoryRecord.get("FormattedID"),UserStoryName=userStoryRecord.get("Name")):FormattedID=UserStoryName="",succDepsList.push({DependencyID:succDep.ID,SuccUserStoryName:succDep.SUSName,SuccFormattedID:succDep.SUSID,SuccProjectID:succDep.SPID,ReleaseDate:succDep.REL,ReleaseStartDate:succDep.REL_S,Description:succDep.Desc,Checkpoint:succDep.CP,Supported:succDep.Sup,Assigned:succDep.A,FormattedID:FormattedID,UserStoryName:UserStoryName,ObjectID:ObjectID,Edited:!1})}}return{Predecessors:predDepsList,Successors:succDepsList}},_buildDependenciesData:function(){this.DependenciesReleaseUserStories=_.filter(this.UserStoryStore.getRecords(),function(usr){return this._isInRelease(usr)},this);var predDepsList=[],succDepsList=[];_.each(this.UserStoryStore.getRecords(),function(userStoryRecord){var usrData=this._parseDependenciesFromUserStory(userStoryRecord);predDepsList=predDepsList.concat(usrData.Predecessors),succDepsList=succDepsList.concat(usrData.Successors)},this),this.DependenciesParsedData={Predecessors:predDepsList,Successors:succDepsList}},_newTeamDep:function(){return{TID:1*new Date+""+1e7*Math.random(),PID:"",Sup:"No",USID:"",USName:"",A:!1}},_removeDepFromList:function(dependencyID,dependencyList){for(var i=0;dependencyList.length>i;++i)if(dependencyList[i].DependencyID==dependencyID)return dependencyList.splice(i,1)[0]},_syncCollection:function(userStoryRecord,usAddList,usRemoveList,type,callback){var me=this,collectionStore,collectionRecords,finished=-1,syncCollectionProxy=!1;userStoryRecord.getCollection(type).load({fetch:["FormattedID"],callback:function(){function collectionFuncDone(){++finished==usAddList.length&&(syncCollectionProxy?collectionStore.sync({callback:callback}):callback())}collectionStore=this,collectionRecords=collectionStore.getRange(),usAddList.forEach(function(dep){_.find(collectionRecords,function(cr){return cr.get("FormattedID")===dep.USID})?collectionFuncDone():(project=me.ValidProjects[dep.PID],me._loadUserStoryByFID(dep.USID,project.get("_ref"),function(us){us&&(syncCollectionProxy=!0,collectionStore.add(us)),collectionFuncDone()}))}),usRemoveList.forEach(function(dep){var realDep=_.find(collectionRecords,function(cr){return cr.data.FormattedID===dep.USID});realDep&&(collectionStore.remove(realDep),syncCollectionProxy=!0)}),collectionFuncDone()}})},_collectionSynced:function(userStoryRecord,msg,depData,dependencies,cb){var str=btoa(JSON.stringify(dependencies,null,"	"));str.length>=32768&&(this._alert("ERROR","Dependencies field for "+userStoryRecord.get("FormattedID")+" ran out of space! Cannot save"),cb&&cb()),userStoryRecord.set("c_Dependencies",str),userStoryRecord.save({callback:function(){console.log(msg,userStoryRecord,depData,dependencies),cb&&cb()}})},_removePredDep:function(userStoryRecord,predDepData,cb){var dependencies=this._getDependencies(userStoryRecord),cachePreds=this.DependenciesParsedData.Predecessors,addUSlist=[],removeUSlist=[],depID=predDepData.DependencyID,i;if(removeUSlist=dependencies.Preds[depID].Preds||[],delete dependencies.Preds[depID],userStoryRecord.get("Project").ObjectID===this.ProjectRecord.get("ObjectID"))for(i=0;cachePreds.length>i;++i)if(cachePreds[i].DependencyID===depID){cachePreds.splice(i,1);break}_.each(dependencies.Preds,function(predDep){_.each(predDep.Preds,function(pred){if(pred.A){for(i=0;removeUSlist.length>i;++i)removeUSlist[i].USID===pred.USID&&removeUSlist.splice(i,1);for(i=0;addUSlist.length>i;++i)if(addUSlist[i].USID===pred.USID)return;addUSlist.push(pred)}})}),this._syncCollection(userStoryRecord,addUSlist,removeUSlist,"Predecessors",this._collectionSynced.bind(this,userStoryRecord,"removed predDep",predDepData,dependencies,cb))},_removeSuccDep:function(userStoryRecord,succDepData,cb){var dependencies=this._getDependencies(userStoryRecord),cacheSuccs=this.DependenciesParsedData.Successors,dpds,addUSlist=[],removeUSlist=[],succDep,i;for(i=0;dependencies.Succs.length>i;++i)if(dependencies.Succs[i].ID===succDepData.DependencyID){succDep=dependencies.Succs.splice(i,1)[0];break}if(removeUSlist=succDep?[{USID:succDep.SUSID,PID:succDep.SPID}]:[],userStoryRecord.get("Project").ObjectID===this.ProjectRecord.get("ObjectID"))for(i=0;cacheSuccs.length>i;++i)if(dpds=cacheSuccs[i],dpds.DependencyID===succDepData.DependencyID&&dpds.FormattedID===succDepData.FormattedID){cacheSuccs.splice(i,1);break}_.each(dependencies.Succs,function(succ){if(succ.A){for(i=0;removeUSlist.length>i;++i)removeUSlist[i].USID===succ.SUSID&&removeUSlist.splice(i,1);for(i=0;addUSlist.length>i;++i)if(addUSlist[i].USID===succ.SUSID)return;addUSlist.push({USID:succ.SUSID,PID:succ.SPID})}}),this._syncCollection(userStoryRecord,addUSlist,removeUSlist,"Successors",this._collectionSynced.bind(this,userStoryRecord,"removed succdep",succDepData,dependencies,cb))},_addPredDep:function(userStoryRecord,predDepData,cb){function appendPred(pred){if(pred.A){for(i=0;predUSlist.length>i;++i)if(predUSlist[i].USID===pred.USID)return;predUSlist.push(pred)}}var dependencies=this._getDependencies(userStoryRecord),cachePreds=this.DependenciesParsedData.Predecessors,dpdp,predUSlist=[],parseDataAdded=!1,depID,i;if(predDepData=Ext.clone(predDepData),predDepData.Edited=!1,dependencies.Preds[predDepData.DependencyID]={Desc:predDepData.Description,CP:predDepData.Checkpoint,Sta:predDepData.Status,Preds:predDepData.Predecessors},userStoryRecord.get("Project").ObjectID===this.ProjectRecord.get("ObjectID")){for(i=0;cachePreds.length>i;++i)if(dpdp=cachePreds[i],dpdp.DependencyID===predDepData.DependencyID){cachePreds[i]=predDepData,parseDataAdded=!0;break}parseDataAdded||cachePreds.push(predDepData)}for(depID in dependencies.Preds)_.each(dependencies.Preds[depID].Preds,appendPred);this._syncCollection(userStoryRecord,predUSlist,[],"Predecessors",this._collectionSynced.bind(this,userStoryRecord,"added predDep",predDepData,dependencies,cb))},_addSuccDep:function(userStoryRecord,succDepData,cb){var dependencies=this._getDependencies(userStoryRecord),cacheSuccs=this.DependenciesParsedData.Successors,dpds,replaced=!1,succUSlist=[],parseDataAdded=!1,i,newSucc;for(succDepData=Ext.clone(succDepData),succDepData.Edited=!1,newSucc={ID:succDepData.DependencyID,SUSID:succDepData.SuccFormattedID,SUSName:succDepData.SuccUserStoryName,SPID:succDepData.SuccProjectID,Desc:succDepData.Description,CP:succDepData.Checkpoint,Sup:succDepData.Supported,A:succDepData.Assigned,REL:succDepData.ReleaseDate,REL_S:succDepData.ReleaseStartDate},i=0;dependencies.Succs.length>i;++i)if(dependencies.Succs[i].ID===newSucc.ID){dependencies.Succs[i]=newSucc,replaced=!0;break}if(replaced||dependencies.Succs.push(newSucc),userStoryRecord.get("Project").ObjectID===this.ProjectRecord.get("ObjectID")){for(i=0;cacheSuccs.length>i;++i)if(dpds=cacheSuccs[i],dpds.DependencyID===succDepData.DependencyID&&dpds.FormattedID===succDepData.FormattedID){cacheSuccs[i]=succDepData,parseDataAdded=!0;break}parseDataAdded||cacheSuccs.push(succDepData)}_.each(dependencies.Succs,function(succ){if(succ.A){for(i=0;succUSlist.length>i;++i)if(succUSlist[i].USID===succ.SUSID)return;succUSlist.push({USID:succ.SUSID,PID:succ.SPID})}}),this._syncCollection(userStoryRecord,succUSlist,[],"Successors",this._collectionSynced.bind(this,userStoryRecord,"added succdep",succDepData,dependencies,cb))},_defineModels:function(){Ext.define("IntelVelocity",{extend:"Ext.data.Model",fields:[{name:"Name",type:"string"},{name:"PlannedVelocity",type:"string"},{name:"RealVelocity",type:"string"}]}),Ext.define("IntelTeamCommits",{extend:"Ext.data.Model",fields:[{name:"Name",type:"string"},{name:"ObjectID",type:"string"},{name:"FormattedID",type:"string"},{name:"Commitment",type:"string"},{name:"Objective",type:"string"},{name:"Product",type:"string"},{name:"PlannedEnd",type:"string"}]}),Ext.define("IntelRisk",{extend:"Ext.data.Model",fields:[{name:"RiskID",type:"string"},{name:"ObjectID",type:"number"},{name:"FormattedID",type:"string"},{name:"FeatureName",type:"string"},{name:"Description",type:"string"},{name:"Impact",type:"string"},{name:"Status",type:"string"},{name:"Contact",type:"string"},{name:"Checkpoint",type:"string"},{name:"Edited",type:"boolean"}]}),Ext.define("IntelDepTeam",{extend:"Ext.data.Model",fields:[{name:"TID",type:"string"},{name:"PID",type:"string"},{name:"Sup",type:"string"},{name:"USID",type:"string"},{name:"USName",type:"string"},{name:"A",type:"boolean"}]}),Ext.define("IntelPredDep",{extend:"Ext.data.Model",fields:[{name:"ObjectID",type:"number"},{name:"DependencyID",type:"string"},{name:"FormattedID",type:"string"},{name:"UserStoryName",type:"string"},{name:"Description",type:"string"},{name:"Checkpoint",type:"string"},{name:"Status",type:"string"},{name:"Predecessors",type:"auto"},{name:"Edited",type:"boolean"}]}),Ext.define("IntelSuccDep",{extend:"Ext.data.Model",fields:[{name:"ObjectID",type:"number"},{name:"DependencyID",type:"string"},{name:"SuccUserStoryName",type:"string"},{name:"SuccFormattedID",type:"string"},{name:"SuccProjectID",type:"string"},{name:"UserStoryName",type:"string"},{name:"FormattedID",type:"string"},{name:"ReleaseStartDate",type:"string"},{name:"ReleaseDate",type:"string"},{name:"Description",type:"string"},{name:"Checkpoint",type:"string"},{name:"Supported",type:"string"},{name:"Assigned",type:"boolean"},{name:"Edited",type:"boolean"}]})},_alert:function(title,str){Ext.MessageBox.alert(title,str).setY(this._msgBoxY),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},10)},_confirm:function(title,str,fn){Ext.MessageBox.confirm(title,str,fn).setY(this._msgBoxY),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},10)},_applyMessageBoxConfig:function(){var w=window,p=w.parent,pd=w.parent.document,l=w.location,iframe=pd.querySelector('iframe[src="'+l.pathname+l.search+'"]'),ph=p.getWindowHeight(),ps=p.getScrollY(),ofy=ps+iframe.getBoundingClientRect().top,iyOffset=Math.floor(ph/2-ofy+ps-50);this._msgBoxY=0>iyOffset?0:iyOffset},_getWorkweek:function(date){var oneDay=864e5,yearStart=new Date(date.getFullYear(),0,1),dayIndex=yearStart.getDay(),ww01Start=yearStart-dayIndex*oneDay,timeDiff=date-ww01Start,dayDiff=timeDiff/oneDay,ww=Math.floor(dayDiff/7)+1,leap=0===date.getFullYear()%4,weekCount=leap&&dayIndex>=5||!leap&&6===dayIndex?53:52;return ww>weekCount?1:ww},_getWeekCount:function(date){var leap=0===date.getFullYear()%4,day=new Date(date.getFullYear(),0,1).getDay();return leap&&day>=5||!leap&&6===day?53:52},_getWorkweeks:function(){var i,start=this.ReleaseRecord.get("ReleaseStartDate"),end=this.ReleaseRecord.get("ReleaseDate"),sd_week=this._getWorkweek(start),ed_week=this._getWorkweek(end),week_count=this._getWeekCount(start),weeks=[];if(sd_week>ed_week){for(i=sd_week;week_count>=i;++i)weeks.push({Week:"ww"+i});for(i=1;ed_week>=i;++i)weeks.push({Week:"ww"+i})}else for(i=sd_week;ed_week>=i;++i)weeks.push({Week:"ww"+i});return weeks},_loadPreferences:function(cb){var uid=this.getContext().getUser().ObjectID;Rally.data.PreferenceManager.load({appID:this.getAppId(),filterByName:preferenceName+uid,success:function(prefs){var appPrefs=prefs[preferenceName+uid];try{appPrefs=JSON.parse(appPrefs)}catch(e){appPrefs={projs:{},refresh:30}}this.AppPrefs=appPrefs,console.log("loaded prefs",appPrefs),cb()},scope:this})},_savePreferences:function(prefs,cb){var s={},uid=this.getContext().getUser().ObjectID;s[preferenceName+uid]=JSON.stringify(prefs),console.log("saving prefs",prefs),Rally.data.PreferenceManager.update({appID:this.getAppId(),settings:s,success:cb,scope:this})},_htmlEscape:function(str){return(str+"").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},_getDirtyType:function(localRecord,realData){var localData=localRecord.data;return realData?localData.Edited?"Edited":"Unchanged":localData.Edited?"New":"Deleted"},_getScopedRelease:function(){var d=new Date,r,rs=this.ReleaseStore.getRecords(),pid=this.ProjectRecord.get("ObjectID"),prefOID=this.AppPrefs.projs[pid]&&this.AppPrefs.projs[pid].Release;return prefOID&&_.find(rs,function(r){return r.get("ObjectID")==prefOID})||_.find(rs,function(r){return new Date(r.get("ReleaseDate"))>=d&&d>=new Date(r.get("ReleaseStartDate"))})||_.reduce(rs,function(best,r){if(null===best)return r;var d1=new Date(best.get("ReleaseStartDate")),d2=new Date(r.get("ReleaseStartDate")),now=new Date;return Math.abs(d1-now)<Math.abs(d2-now)?best:r},null)},_applyIframeResize:function(){for(var w=window,p=w.parent,pd=w.parent.document,l=w.location,iframe=pd.querySelector('iframe[src="'+l.pathname+l.search+'"]'),ip1=iframe.parentNode,ip2=iframe.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode,height=0,next=this.down();next;)height+=next.getHeight(),next=next.next();ip1.style.height=height+"px",ip2.style.height=height+"px"},_windowResize:function(){this._applyMessageBoxConfig(),this._applyIframeResize()},_isEditingTeamCommits:!1,_isEditingVelocity:!1,_isEditing:function(store){return store?_.find(store.getRange(),function(r){return r.get("Edited")})?!0:!1:!1},_updateAllGrids:function(){var isEditingRisks=this._isEditing(this.CustomRisksStore),isEditingDeps=this._isEditing(this.CustomPredDepStore)||this._isEditing(this.CustomSuccDepStore);!this._isEditingVelocity&&this.IterationStore&&this.UserStoryStore&&this.CustomVelocityStore&&this.CustomVelocityStore.intelUpdate(),!this._isEditingTeamCommits&&this.FeatureStore&&this.UserStoryStore&&this.CustomTeamCommitsStore&&this.CustomTeamCommitsStore.intelUpdate(),!isEditingRisks&&this.FeatureStore&&(this._parseRisksData(),this.CustomRisksStore&&this.CustomRisksStore.intelUpdate()),!isEditingDeps&&this.UserStoryStore&&this.FeatureStore&&(this._buildDependenciesData(),this.CustomPredDepStore&&this.CustomPredDepStore.intelUpdate(),this.CustomSuccDepStore&&this.CustomSuccDepStore.intelUpdate())},_reloadStores:function(cb){var isEditingRisks=this._isEditing(this.CustomRisksStore),isEditingDeps=this._isEditing(this.CustomPredDepStore)||this._isEditing(this.CustomSuccDepStore),promises=[];if(!this._isEditingVelocity){var def1=Q.defer();this.IterationStore?this.IterationStore.load({callback:def1.resolve}):this._loadIterations(def1.resolve),promises.push(def1.promise)}if(!this._isEditingTeamCommits&&!isEditingRisks){var def2=Q.defer();this.FeatureStore?this.FeatureStore.load({callback:def2.resolve}):this._loadFeatures(def2.resolve),promises.push(def2.promise)}if(!this._isEditingVelocity&&!this._isEditingTeamCommits&&!isEditingDeps){var def3=Q.defer();this.UserStoryStore?this.UserStoryStore.load({callback:def3.resolve}):this._loadUserStories(def3.resolve),promises.push(def3.promise)}Q.all(promises).then(function(){this._updateAllGrids(),cb&&cb()}.bind(this))},_storesReloaded:function(){this._loadTeamCommitsGrid(),this._loadVelocityGrid(),this._loadRisksGrid(),this._loadDependenciesGrids(),setTimeout(this._windowResize.bind(this),0)},_reloadEverything:function(){this._isEditingTeamCommits=!1,this._isEditingVelocity=!1,delete this.ShowMessageText,delete this.UserStoryStore,delete this.FeatureStore,delete this.IterationStore,delete this.PredDepGrid,delete this.SuccDepGrid,delete this.RisksGrid,delete this.VelocityGrid,delete this.TeamCommitsGrid,delete this.CustomPredDepStore,delete this.CustomSuccDepStore,delete this.CustomTeamCommitsStore,delete this.CustomVelocityStore,this.setLoading(!0);for(var toRemove=this.down("#tc_vel_box").next(),tmp;toRemove;)tmp=toRemove.next(),toRemove.up().remove(toRemove),toRemove=tmp;this.down("#tc_vel_box").removeAll(),this.ReleasePicker||(this._loadReleasePicker(),this._loadTrainPicker(),this._loadRefreshIntervalCombo(),this._loadManualRefreshButton()),this._reloadStores(function(){this._storesReloaded(),this.setLoading(!1)
}.bind(this))},_refreshDataFunc:function(){this._reloadStores(this._windowResize.bind(this))},_setRefreshInterval:function(){this.RefreshInterval&&(clearInterval(this.RefreshInterval),delete this.RefreshInterval),"Off"!==this.AppPrefs.refresh&&(this.RefreshInterval=setInterval(this._refreshDataFunc.bind(this),1e3*this.AppPrefs.refresh))},_releasesLoaded:function(){var currentRelease=this._getScopedRelease();currentRelease?(this.ReleaseRecord=currentRelease,console.log("release loaded",currentRelease),this._setRefreshInterval(),this._reloadEverything()):(this.removeAll(),this._alert("This team has no releases"))},_trainRecordLoaded:function(trainRecord){if(trainRecord)this.TrainRecord=trainRecord;else{this.ProjectNotInTrain=!0;var pid=this.ProjectRecord.get("ObjectID");this.AppPrefs.projs[pid]&&this.AppPrefs.projs[pid].Train?(this.TrainRecord=this.AllTrainRecordsStore.findExactRecord("ObjectID",this.AppPrefs.projs[pid].Train),this.TrainRecord||(this.TrainRecord=this.AllTrainRecordsStore.first())):this.TrainRecord=this.AllTrainRecordsStore.first()}console.log("train loaded:",trainRecord),this._loadReleases(this._releasesLoaded.bind(this))},_allTrainRecordsLoaded:function(){this._projectInWhichTrain(this.ProjectRecord,this._trainRecordLoaded.bind(this))},_preferencesLoaded:function(){this._loadAllTrains(this._allTrainRecordsLoaded.bind(this))},_validProjectsLoaded:function(){this.ProjectRecord=this.ValidProjects[this.ProjectRecord.get("ObjectID")],this.ProjectRecord?this._loadPreferences(this._preferencesLoaded.bind(this)):(this.removeAll(),this._alert("Please scope to a valid team for release planning"))},_rootProjectLoaded:function(){this._loadValidProjects(this._validProjectsLoaded.bind(this))},_currentProjectLoaded:function(scopeProjectRecord){this.ProjectRecord=scopeProjectRecord,this._loadRootProject(scopeProjectRecord,this._rootProjectLoaded.bind(this))},_modelsLoaded:function(){var scopeProject=this.getContext().getProject();this._loadProject(scopeProject,this._currentProjectLoaded.bind(this))},launch:function(){this._showMessage("Loading Data..."),window.parent.onresize=this._windowResize.bind(this),window.parent.onscroll=this._applyMessageBoxConfig.bind(this),this.getContext().getPermissions().isProjectEditor(this.getContext().getProject())?(this._defineModels(),this._loadModels(this._modelsLoaded.bind(this))):(this.removeAll(),this._alert("You do not have permissions to edit this project"))},_releasePickerSelected:function(combo,records){if(this.ReleaseRecord.get("Name")!==records[0].get("Name")){this.ReleaseRecord=this.ReleaseStore.findExactRecord("Name",records[0].get("Name"));var pid=this.ProjectRecord.get("ObjectID");this.AppPrefs.projs[pid]||(this.AppPrefs.projs[pid]={}),this.AppPrefs.projs[pid].Release=this.ReleaseRecord.get("ObjectID"),this._savePreferences(this.AppPrefs,this._reloadEverything.bind(this))}},_loadReleasePicker:function(){this.ReleasePicker=this.down("#navbox_left").add({xtype:"combobox",width:240,padding:"0 10px 0 0",labelWidth:50,store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(this.ReleaseStore.getRecords(),function(r){return{Name:r.get("Name")}})}),displayField:"Name",fieldLabel:"Release:",editable:!1,value:this.ReleaseRecord.get("Name"),listeners:{select:this._releasePickerSelected.bind(this)}})},_trainPickerSelected:function(combo,records){if(0!==this.TrainRecord.get("Name").indexOf(records[0].get("Name"))){this.TrainRecord=this.AllTrainRecordsStore.findRecord("Name",records[0].get("Name"));var pid=this.ProjectRecord.get("ObjectID");this.AppPrefs.projs[pid]||(this.AppPrefs.projs[pid]={}),this.AppPrefs.projs[pid].Train=this.TrainRecord.get("ObjectID"),this._savePreferences(this.AppPrefs,this._reloadEverything.bind(this))}},_loadTrainPicker:function(){this.ProjectNotInTrain&&this.down("#navbox_left").add({xtype:"combobox",width:240,labelWidth:40,store:Ext.create("Ext.data.Store",{fields:["Name"],data:this.TrainNames}),displayField:"Name",fieldLabel:"Train:",editable:!1,value:this.TrainRecord.get("Name").split(" ART ")[0],listeners:{select:this._trainPickerSelected.bind(this)}})},_refreshComboSelected:function(combo,records){var rate=records[0].get("Rate");this.AppPrefs.refresh!==rate&&(this.AppPrefs.refresh=rate,this._setRefreshInterval(),this._savePreferences(this.AppPrefs))},_loadRefreshIntervalCombo:function(){this.down("#navbox_right").add({xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Rate"],data:[{Rate:"Off"},{Rate:"10"},{Rate:"15"},{Rate:"30"},{Rate:"60"},{Rate:"120"}]}),displayField:"Rate",fieldLabel:"Refresh Rate (seconds):",editable:!1,value:this.AppPrefs.refresh,listeners:{select:this._refreshComboSelected.bind(this)}})},_loadManualRefreshButton:function(){this.down("#navbox_right").add({xtype:"button",text:"Refresh Data",style:"margin: 5px 0 0 5px",width:100,listeners:{click:this._refreshDataFunc.bind(this)}})},_loadTeamCommitsGrid:function(){var me=this;me._TeamCommitsCountHash={},me._TeamCommitsEstimateHash={};var customTeamCommitsRecords=_.map(me.FeatureStore.getRecords(),function(featureRecord){var tc=me._getTeamCommit(featureRecord),ed=featureRecord.get("PlannedEndDate");return{Commitment:tc.Commitment||"Undecided",Objective:tc.Objective||"",Name:featureRecord.get("Name"),FormattedID:featureRecord.get("FormattedID"),ObjectID:featureRecord.get("ObjectID"),Product:me.FeatureProductHash[featureRecord.get("ObjectID")],PlannedEnd:ed?"WW"+me._getWorkweek(new Date(ed)):"-"}});me.CustomTeamCommitsStore=Ext.create("Intel.data.FastStore",{data:customTeamCommitsRecords,model:"IntelTeamCommits",autoSync:!0,limit:1/0,proxy:{type:"fastsessionproxy",id:"TeamCommitsProxy"+Math.random()},intelUpdate:function(){var tcStore=me.CustomTeamCommitsStore,tcRecords=tcStore.getRange();tcStore.suspendEvents(!0),console.log("syncing teamCommits with features",tcRecords,me.FeatureStore.getRecords()),tcRecords.forEach(function(tcRecord){var featureRecord=me.FeatureStore.findRecord("ObjectID",tcRecord.get("ObjectID"));if(featureRecord){var newVal=me._getTeamCommit(featureRecord);tcRecord.get("Commitment")!=newVal.Commitment&&tcRecord.set("Commitment",newVal.Commitment||"Undecided"),tcRecord.get("Objective")!=(newVal.Objective||"")&&tcRecord.set("Objective",newVal.Objective||"")}}),tcStore.resumeEvents()}}),me.CustomTeamCommitsStore.intelUpdate();var columnCfgs=[{text:"F#",dataIndex:"FormattedID",width:60,editor:!1,sortable:!0,resizable:!1,renderer:function(FID){var feature=me.FeatureStore.findExactRecord("FormattedID",FID);return feature.get("Project")?'<a href="https://rally1.rallydev.com/#/'+feature.get("Project").ObjectID+"d/detail/portfolioitem/feature/"+feature.get("ObjectID")+'" target="_blank">'+FID+"</a>":FID}},{text:"Feature",dataIndex:"Name",flex:1,editor:!1,resizable:!1},{text:"Product",dataIndex:"Product",width:70,editor:!1,resizable:!1},{text:"Stories",dataIndex:"ObjectID",sortable:!0,editor:!1,resizable:!1,doSort:function(direction){var ds=this.up("grid").getStore(),field=this.getSortParam();ds.sort({sorterFn:function(f1,f2){var diff=me._getStoryCount(f1.get("ObjectID"))-me._getStoryCount(f2.get("ObjectID"));return 0===diff?0:("ASC"==direction?1:-1)*(diff>0?1:-1)}})},width:70,renderer:function(oid){return me._getStoryCount(oid)}},{text:"Plan Estimate",dataIndex:"ObjectID",sortable:!0,editor:!1,resizable:!1,doSort:function(direction){var ds=this.up("grid").getStore(),field=this.getSortParam();ds.sort({sorterFn:function(f1,f2){var diff=me._getStoriesEstimate(f1.get("ObjectID"))-me._getStoriesEstimate(f2.get("ObjectID"));return 0===diff?0:("ASC"==direction?1:-1)*(diff>0?1:-1)}})},width:70,renderer:function(oid){return me._getStoriesEstimate(oid)}},{text:"Planned End",dataIndex:"PlannedEnd",sortable:!0,editor:!1,resizable:!1,width:70},{dataIndex:"Commitment",text:"Status",width:100,tdCls:"intel-editor-cell",sortable:!0,resizable:!1,editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Status"],data:[{Status:"Undecided"},{Status:"N/A"},{Status:"Committed"},{Status:"Not Committed"}]}),editable:!1,displayField:"Status",listeners:{focus:function(combo){combo.expand()}}}},{text:"Objective",dataIndex:"Objective",flex:1,editor:{xtype:"textarea",grow:!0,growMin:20,growMax:160,enterIsSpecial:!0},resizable:!1,sortable:!0,renderer:function(val){return val||"-"}}];me.TeamCommitsGrid=me.down("#tc_vel_box").add({xtype:"rallygrid",title:"Team Commits",height:300,flex:2,padding:"0 20px 0 0",scroll:"vertical",columnCfgs:columnCfgs,plugins:["fastcellediting"],viewConfig:{xtype:"scrolltableview",stripeRows:!0,preserveScrollOnRefresh:!0,getRowClass:function(tcRecord,index,rowParams,store){var val=tcRecord.get("Commitment")||"Undecided";return"N/A"==val?"grey-row":"Committed"==val?"green-row":"Not Committed"==val?"red-row":void 0}},listeners:{beforeedit:function(){me._isEditingTeamCommits=!0},canceledit:function(){me._isEditingTeamCommits=!1},edit:function(editor,e){var grid=e.grid,tcRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;if(me._isEditingTeamCommits=!1,value!==originalValue){"Objective"===field&&(value=me._htmlEscape(value),tcRecord.set(field,value));var tc={Commitment:tcRecord.get("Commitment"),Objective:tcRecord.get("Objective")};me._isEditingTeamCommits=!0,me.TeamCommitsGrid.setLoading(!0),me._loadFeature(tcRecord.get("ObjectID"),function(realFeature){realFeature?me._setTeamCommit(realFeature,tc,function(){me._isEditingTeamCommits=!1,me.TeamCommitsGrid.setLoading(!1)}):(console.log("ERROR: realFeature not found, ObjectID: "+oid),me._isEditingTeamCommits=!1,me.TeamCommitsGrid.setLoading(!1))})}}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomTeamCommitsStore})},_loadVelocityGrid:function(){var me=this,iterationGroups=_.groupBy(me.UserStoryStore.getRecords(),function(us){return us.get("Iteration")?us.get("Iteration").Name:"__DELETE__"});delete iterationGroups.__DELETE__;var iterationGroupTotals=_.sortBy(_.map(me.IterationStore.getRecords(),function(iteration){var iName=iteration.get("Name");return{Name:iName,PlannedVelocity:iteration.get("PlannedVelocity")||0,RealVelocity:_.reduce(iterationGroups[iName]||[],function(sum,us){return sum+us.get("PlanEstimate")},0)}}),"Name");me.CustomVelocityStore=Ext.create("Intel.data.FastStore",{data:iterationGroupTotals,model:"IntelVelocity",autoSync:!0,limit:1/0,proxy:{type:"fastsessionproxy",id:"VelocityProxy"+Math.random()},intelUpdate:function(){var velStore=me.CustomVelocityStore,velRecords=velStore.getRange();velStore.suspendEvents(!0),console.log("syncing velocity with current iterations",velRecords,me.IterationStore.getRecords()),velRecords.forEach(function(velRecord){var iterationName=velRecord.get("Name"),iteration=me.IterationStore.findExactRecord("Name",iterationName),newVal=iteration.get("PlannedVelocity")||0;newVal!=velRecord.get("PlannedVelocity")&&(velRecord.set("PlannedVelocity",iteration.get("PlannedVelocity")||0),console.log("velocity record update",velRecord))}),velStore.resumeEvents()}}),me.CustomVelocityStore.intelUpdate();var columnCfgs=[{text:"Iteration",dataIndex:"Name",flex:2,editor:!1,resizable:!1,sortable:!0,renderer:function(name,meta,velocityRecord){var iteration=me.IterationStore.findExactRecord("Name",name);if(iteration.get("Project")){var pid=iteration.get("Project")._ref.split("/project/")[1];return'<a href="https://rally1.rallydev.com/#/'+pid+"d/detail/iteration/"+iteration.get("ObjectID")+'" target="_blank">'+name+"</a>"}return name}},{text:"Target Capacity (Planned Velocity)",dataIndex:"PlannedVelocity",flex:1,tdCls:"intel-editor-cell",editor:"textfield",resizable:!1,sortable:!0,renderer:function(n,m){return m.tdCls+=0===1*n?" red-cell":"",n}},{text:"Actual Load (Plan Estimate)",dataIndex:"RealVelocity",flex:1,editor:!1,resizable:!1,sortable:!0,renderer:function(realVel,m,r){return m.tdCls+=.9*r.data.PlannedVelocity>1*realVel?" yellow-cell":"",m.tdCls+=0===1*realVel||1*realVel>1*r.data.PlannedVelocity?" red-cell":"",realVel}}];me.VelocityGrid=me.down("#tc_vel_box").add({xtype:"rallygrid",title:"Velocity",scroll:"vertical",height:300,flex:1,showPagingToolbar:!1,showRowActionsColumn:!1,viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0},listeners:{beforeedit:function(editor,e){return me._isEditingVelocity=!0,!0},canceledit:function(){me._isEditingVelocity=!1},edit:function(editor,e){var grid=e.grid,velocityRecord=e.record,value=e.value,originalValue=e.originalValue;if(!value||value===originalValue)return me._isEditingVelocity=!1,void 0;value=1*value||0;var iterationName=velocityRecord.get("Name"),iteration=me.IterationStore.findExactRecord("Name",iterationName);iteration.set("PlannedVelocity",value),me.VelocityGrid.setLoading(!0),iteration.save({callback:function(){me._isEditingVelocity=!1,me.VelocityGrid.setLoading(!1)}})}},plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],enableEditing:!1,columnCfgs:columnCfgs,store:me.CustomVelocityStore})},_loadRisksGrid:function(){var me=this,workweeks=me._getWorkweeks(),riskSorter=function(o1,o2){return o1.data.RiskID>o2.data.RiskID?-1:1};me.CustomRisksStore=Ext.create("Intel.data.FastStore",{data:Ext.clone(me.RisksParsedData),autoSync:!0,model:"IntelRisk",limit:1/0,proxy:{type:"fastsessionproxy",id:"RiskProxy"+Math.random()},sorters:[riskSorter],intelUpdate:function(){var riskStore=me.CustomRisksStore,riskRecords=riskStore.getRange(),realRisksDatas=me.RisksParsedData.slice(0),remoteChanged=!1,key;console.log("syncing risks with current features",riskRecords,realRisksDatas),riskStore.suspendEvents(!0);for(var i=0;riskRecords.length>i;++i){var riskRecord=riskRecords[i],realRiskData=me._removeRiskFromList(riskRecord.get("RiskID"),realRisksDatas),dirtyType=me._getDirtyType(riskRecord,realRiskData);if("New"!==dirtyType&&"Edited"!==dirtyType)if("Deleted"==dirtyType)riskStore.remove(riskRecord);else{for(key in realRiskData)if(!_.isEqual(riskRecord.get(key),realRiskData[key])){remoteChanged=!0;break}if(remoteChanged){riskRecord.beginEdit();for(key in realRiskData)riskRecord.set(key,realRiskData[key]);riskRecord.endEdit()}}}realRisksDatas.forEach(function(realRiskData){console.log("adding real risk",realRiskData),riskStore.add(Ext.create("IntelRisk",Ext.clone(realRiskData)))}),riskStore.resumeEvents()}}),me.CustomRisksStore.intelUpdate();var columnCfgs=[{text:"F#",dataIndex:"FormattedID",tdCls:"intel-editor-cell",width:80,editor:{xtype:"intelcombobox",width:80,store:Ext.create("Ext.data.Store",{fields:["FormattedID"],data:_.map(me.FeatureStore.getRecords(),function(fr){return{FormattedID:fr.get("FormattedID")}}),sorters:{property:"FormattedID"}}),displayField:"FormattedID"},resizable:!1,sortable:!0,renderer:function(val){return val||"-"}},{text:"Feature",dataIndex:"FeatureName",tdCls:"intel-editor-cell",flex:1,editor:{xtype:"intelcombobox",store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.FeatureStore.getRecords(),function(fr){return{Name:fr.get("Name")}}),sorters:{property:"Name"}}),displayField:"Name"},resizable:!1,sortable:!0,renderer:function(val){return val||"-"}},{text:"Risk Description",dataIndex:"Description",tdCls:"intel-editor-cell",flex:1,editor:{xtype:"textarea",grow:!0,growMin:20,growMax:160,enterIsSpecial:!0},resizable:!1,sortable:!0,renderer:function(val){return val||"-"}},{text:"Impact",dataIndex:"Impact",tdCls:"intel-editor-cell",flex:1,resizable:!1,sortable:!0,editor:{xtype:"textarea",grow:!0,growMin:20,growMax:160,enterIsSpecial:!0},renderer:function(val){return val||"-"}},{text:"Status(ROAM)",dataIndex:"Status",tdCls:"intel-editor-cell",width:100,editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Status"],data:[{Status:"Undefined"},{Status:"Resolved"},{Status:"Owned"},{Status:"Accepted"},{Status:"Mitigated"}]}),editable:!1,displayField:"Status",listeners:{focus:function(combo){combo.expand()}}},resizable:!1,sortable:!0,renderer:function(val,meta){return meta.tdCls+="Undefined"===val?" red-cell":"",val||"-"}},{text:"Contact",dataIndex:"Contact",tdCls:"intel-editor-cell",flex:1,editor:{xtype:"textarea",grow:!0,growMin:20,growMax:160,enterIsSpecial:!0},sortable:!0,resizable:!1,renderer:function(val){return val||"-"}},{text:"Checkpoint",dataIndex:"Checkpoint",tdCls:"intel-editor-cell",width:80,resizable:!1,editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["Week"],data:workweeks}),editable:!1,displayField:"Week",listeners:{focus:function(combo){combo.expand()}}},sortable:!0,renderer:function(val){return val||"-"}},{text:"",width:30,xtype:"fastgridcolumn",tdCls:"iconCell",resizable:!1,renderer:function(value,meta,riskRecord){var realRiskData=me._removeRiskFromList(riskRecord.get("RiskID"),me.RisksParsedData.slice(0)),dirtyType=me._getDirtyType(riskRecord,realRiskData);return"Edited"===dirtyType?(meta.tdAttr='data-qtip="Undo"',{xtype:"container",width:20,cls:"undo-button intel-editor-cell",listeners:{click:{element:"el",fn:function(){var realRiskData=me._removeRiskFromList(riskRecord.get("RiskID"),me.RisksParsedData.slice(0));riskRecord.beginEdit();for(var key in realRiskData)riskRecord.set(key,realRiskData[key]);riskRecord.endEdit()}}}}):void 0}},{text:"",xtype:"fastgridcolumn",tdCls:"iconCell",width:30,resizable:!1,renderer:function(value,meta,riskRecord){var realRiskData=me._removeRiskFromList(riskRecord.get("RiskID"),me.RisksParsedData.slice(0)),dirtyType=me._getDirtyType(riskRecord,realRiskData);if("New"===dirtyType)dirtyType="Save";else{if("Edited"!==dirtyType)return;dirtyType="Resave"}return meta.tdAttr='data-qtip="'+dirtyType+' Risk"',{xtype:"container",width:20,cls:"save-button intel-editor-cell",listeners:{click:{element:"el",fn:function(){function loadOriginalParent(){me._loadFeature(riskRecord.get("ObjectID"),function(oldFeatureRecord){newFeatureRecord=newFeatureRecord||oldFeatureRecord;var lastAction=function(){riskRecord.beginEdit(),riskRecord.set("Edited",!1),riskRecord.set("ObjectID",newFeatureRecord.get("ObjectID")),riskRecord.endEdit(),me.RisksGrid.setLoading(!1)},nextAction=function(){me._addRisk(newFeatureRecord,riskRecordData,lastAction)};if(!oldFeatureRecord)return nextAction(),void 0;var oldRealRisksData=me._parseRisksFromFeature(oldFeatureRecord),oldRealRiskData=me._removeRiskFromList(riskRecordData.RiskID,oldRealRisksData);oldFeatureRecord.get("ObjectID")!==newFeatureRecord.get("ObjectID")&&oldRealRiskData?me._removeRisk(oldFeatureRecord,oldRealRiskData,nextAction):nextAction()})}if(!riskRecord.get("FormattedID")||!riskRecord.get("FeatureName"))return me._alert("ERROR","You must set the Feature affected by this risk"),void 0;if(!riskRecord.get("Checkpoint"))return me._alert("ERROR","You must set the Checkpoint date for this risk"),void 0;if(!riskRecord.get("Description"))return me._alert("ERROR","You must set the Description date for this risk"),void 0;if(!riskRecord.get("Impact"))return me._alert("ERROR","You must set the Impact date for this risk"),void 0;if(!riskRecord.get("Status"))return me._alert("ERROR","You must set the Status date for this risk"),void 0;if(!riskRecord.get("Contact"))return me._alert("ERROR","You must set the Contact date for this risk"),void 0;me.RisksGrid.setLoading(!0);var riskRecordData=riskRecord.data,tmpNewFeatureRecord=me.FeatureStore.findExactRecord("FormattedID",riskRecordData.FormattedID),newFeatureRecord;tmpNewFeatureRecord.get("ObjectID")!=riskRecord.get("ObjectID")?me._loadFeature(tmpNewFeatureRecord.get("ObjectID"),function(featureRecord){newFeatureRecord=featureRecord,loadOriginalParent()}):loadOriginalParent()}}}}}},{text:"",width:30,xtype:"fastgridcolumn",tdCls:"iconCell",resizable:!1,renderer:function(value,meta,riskRecord){return meta.tdAttr='data-qtip="Delete Risk"',{xtype:"container",width:20,cls:"delete-button intel-editor-cell",listeners:{click:{element:"el",fn:function(){me._confirm("Confirm","Delete Risk?",function(msg){"yes"===msg.toLowerCase()&&(me.RisksGrid.setLoading(!0),me._loadFeature(riskRecord.get("ObjectID"),function(featureRecord){var lastAction=function(){me.CustomRisksStore.remove(riskRecord),me.RisksGrid.setLoading(!1)};if(!featureRecord)return lastAction(),void 0;var realRisksData=me._parseRisksFromFeature(featureRecord),realRiskData=me._removeRiskFromList(riskRecord.get("RiskID"),realRisksData);realRiskData?me._removeRisk(featureRecord,realRiskData,lastAction):lastAction()}))})}}}}}}];me.AddRiskButton=me.add({xtype:"container",items:[{xtype:"button",text:"+ Add Risk",width:80,style:"margin:10px 0 10px 0",listeners:{click:function(){if(me.FeatureStore.first()){if(me.CustomRisksStore){var model=Ext.create("IntelRisk",{RiskID:1*new Date+""+1e7*Math.random(),ObjectID:"",FormattedID:"",FeatureName:"",Description:"",Impact:"",Status:"",Contact:"",Checkpoint:"",Edited:!0});me.CustomRisksStore.insert(0,[model]),me.RisksGrid.view.getEl().setScrollTop(0),me.RisksGrid.getSelectionModel().select(model)}}else me._alert("ERROR","No Features for this Release!")}}}]}),me.RisksGrid=me.add({xtype:"rallygrid",title:"Risks",minHeight:150,maxHeight:700,scroll:"vertical",columnCfgs:columnCfgs,plugins:["fastcellediting"],viewConfig:{xtype:"scrolltableview",stripeRows:!0,preserveScrollOnRefresh:!0,getRowClass:function(){return"intel-row-35px"}},listeners:{edit:function(editor,e){var grid=e.grid,risksRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;if(value!==originalValue){["Description","Impact","Contact"].indexOf(field)>-1&&(value=me._htmlEscape(value),risksRecord.set(field,value));var previousEdit=risksRecord.get("Edited");risksRecord.set("Edited",!0);var featureRecord;"FeatureName"===field?(featureRecord=me.FeatureStore.findExactRecord("Name",value),featureRecord?risksRecord.set("FormattedID",featureRecord.get("FormattedID")):(risksRecord.set("FeatureName",originalValue),risksRecord.set("Edited",previousEdit))):"FormattedID"===field&&(featureRecord=me.FeatureStore.findExactRecord("FormattedID",value),featureRecord?risksRecord.set("FeatureName",featureRecord.get("Name")):(risksRecord.set("FormattedID",originalValue),risksRecord.set("Edited",previousEdit)))}}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomRisksStore})},_loadDependenciesGrids:function(){function depSorter(o1,o2){return o1.data.DependencyID>o2.data.DependencyID?-1:1}function depTeamSorter(o1,o2){return o1.data.TID>o2.data.TID?-1:1}var me=this,workweeks=me._getWorkweeks();me.PredDepTeamStores={},me.PredDepContainers={},me.CustomPredDepStore=Ext.create("Intel.data.FastStore",{data:Ext.clone(me.DependenciesParsedData.Predecessors),autoSync:!0,model:"IntelPredDep",limit:1/0,proxy:{type:"fastsessionproxy",id:"PredDepProxy"+Math.random()},sorters:[depSorter],intelUpdate:function(){var predDepStore=me.CustomPredDepStore,predDepRecs=predDepStore.getRange(),realPredDepsData=me.DependenciesParsedData.Predecessors.slice(),remoteChanged=!1,key;console.log("syncing predDeps with current userStories",predDepRecs,realPredDepsData),predDepStore.suspendEvents(!0);for(var i=0;predDepRecs.length>i;++i){var depRec=predDepRecs[i],depID=depRec.get("DependencyID"),realDep=me._removeDepFromList(depID,realPredDepsData),dirtyType=me._getDirtyType(depRec,realDep),teamStore=me.PredDepTeamStores[depID],teamCont=me.PredDepContainers[depID];if("New"===dirtyType||"Edited"===dirtyType);else if("Deleted"==dirtyType)predDepStore.remove(depRec),teamStore&&delete me.PredDepTeamStores[depID],teamCont&&delete me.PredDepContainers[depID];else{for(key in realDep)if(!_.isEqual(depRec.get(key),realDep[key])){remoteChanged=!0;break}if(remoteChanged){depRec.beginEdit();for(key in realDep)"Predecessors"===key?depRec.set(key,Ext.clone(realDep[key])||[me._newTeamDep()]):depRec.set(key,realDep[key]);depRec.endEdit()}}var preds=depRec.get("Predecessors");preds.length||depRec.set("Predecessors",[me._newTeamDep()]),remoteChanged&&teamStore&&setTimeout(teamStore.intelUpdate.bind(teamStore),0)}realPredDepsData.forEach(function(realDep){console.log("adding predDep",realDep),predDepStore.add(Ext.create("IntelPredDep",Ext.clone(realDep)));var depID=realDep.DependencyID,teamStore=me.PredDepTeamStores[depID];teamStore&&setTimeout(teamStore.intelUpdate.bind(teamStore),0)}),predDepStore.resumeEvents()}}),me.CustomPredDepStore.intelUpdate();var predDepColumnCfgs=[{text:"US#",dataIndex:"FormattedID",tdCls:"intel-editor-cell",width:80,resizable:!1,editor:{xtype:"intelcombobox",width:80,store:Ext.create("Ext.data.Store",{fields:["FormattedID"],data:_.map(me.DependenciesReleaseUserStories,function(usr){return{FormattedID:usr.get("FormattedID")}}),sorters:{property:"FormattedID"}}),displayField:"FormattedID"},sortable:!0,renderer:function(val){return val||"-"}},{text:"UserStory",dataIndex:"UserStoryName",flex:1,resizable:!1,tdCls:"intel-editor-cell",editor:{xtype:"intelcombobox",store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.DependenciesReleaseUserStories,function(usr){return{Name:usr.get("Name")}}),sorters:{property:"Name"}}),displayField:"Name"},sortable:!0,renderer:function(val){return val||"-"}},{text:"Dependency Description",dataIndex:"Description",flex:1,resizable:!1,tdCls:"intel-editor-cell",editor:{xtype:"textarea",grow:!0,growMin:20,growMax:160,enterIsSpecial:!0},sortable:!0,renderer:function(val){return val||"-"}},{dataIndex:"Checkpoint",width:80,resizable:!1,tdCls:"intel-editor-cell",text:"Needed By",editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["Week"],data:workweeks}),editable:!1,displayField:"Week",listeners:{focus:function(combo){combo.expand()}}},sortable:!0,renderer:function(val){return val||"-"}},{text:"Teams Depended On",html:'<div class="pred-dep-header" style="width:30px !important;"></div><div class="pred-dep-header" style="width:140px !important;">Team Name</div><div class="pred-dep-header" style="width:65px  !important;">Supported</div><div class="pred-dep-header" style="width:70px  !important;">US#</div><div class="pred-dep-header" style="width:130px !important;">User Story</div>',dataIndex:"DependencyID",width:480,resizable:!1,sortable:!1,xtype:"fastgridcolumn",renderer:function(depID){var predDepRecord=me.CustomPredDepStore.findRecord("DependencyID",depID),predecessors=predDepRecord.get("Predecessors");if(me.PredDepTeamStores[depID]||(me.PredDepTeamStores[depID]=Ext.create("Intel.data.FastStore",{model:"IntelDepTeam",data:predecessors,autoSync:!0,limit:1/0,proxy:{type:"fastsessionproxy",id:"TeamDep-"+depID+"-proxy"+Math.random()},sorters:[depTeamSorter],intelUpdate:function(){var depTeamStore=me.PredDepTeamStores[depID],depTeamRecords=depTeamStore.getRange(),predDepRecord=me.CustomPredDepStore.findRecord("DependencyID",depID),predecessors=predDepRecord.get("Predecessors").slice(0);depTeamStore.suspendEvents(!0);Outer:for(var i=0;depTeamRecords.length>i;++i){for(var depTeamRecord=depTeamRecords[i],realTeamDep,j=0;predecessors.length>j;++j)if(predecessors[j].TID===depTeamRecord.get("TID")){realTeamDep=predecessors.splice(j,1)[0],depTeamRecord.beginEdit();for(var key in realTeamDep)depTeamRecord.set(key,realTeamDep[key]);depTeamRecord.endEdit();continue Outer}depTeamStore.remove(depTeamRecord)}predecessors.forEach(function(realTeamDep){depTeamStore.add(Ext.create("IntelDepTeam",realTeamDep))}),0===depTeamStore.getRange().length&&depTeamStore.add(me._newTeamDep()),depTeamStore.resumeEvents()}})),me.PredDepContainers[depID])return me.PredDepContainers[depID];var defaultHandler={element:"el",fn:function(a){a.stopPropagation()}},teamColumnCfgs=[{dataIndex:"PID",width:145,resizable:!1,renderer:function(val,meta,depTeamRecord){var projectRecord=me.ValidProjects[val];return val&&projectRecord?projectRecord.get("Name"):(meta.tdCls+="intel-editor-cell","-")},editor:{xtype:"intelcombobox",store:Ext.create("Ext.data.Store",{fields:["Name"],data:me.ProjectNames,sorters:{property:"Name"}}),displayField:"Name"}},{dataIndex:"Sup",width:50,resizable:!1,editor:!1,renderer:function(val,meta,depTeamRecord){return meta.tdCls="No"==val?"intel-not-supported-cell":"intel-supported-cell",val}},{dataIndex:"USID",width:75,resizable:!1,editor:!1,renderer:function(val,meta,depTeamRecord){return depTeamRecord.get("A")?val:"-"}},{dataIndex:"USName",width:140,resizable:!1,editor:!1,renderer:function(val,meta,depTeamRecord){return depTeamRecord.get("A")?val:"-"}},{resizable:!1,width:30,xtype:"fastgridcolumn",tdCls:"iconCell",renderer:function(val,meta,depTeamRecord){return{xtype:"container",width:20,cls:"minus-button intel-editor-cell",listeners:{click:{element:"el",fn:function(){var predDepRecord=me.CustomPredDepStore.findRecord("DependencyID",depID),predecessors=predDepRecord.get("Predecessors"),teamStore=me.PredDepTeamStores[depID];teamStore.suspendEvents(!0);for(var i=0;predecessors.length>i;++i)if(predecessors[i].TID===depTeamRecord.get("TID")){predecessors.splice(i,1);break}if(teamStore.remove(depTeamRecord),!predecessors.length){var newItem=me._newTeamDep();teamStore.add(Ext.create("IntelDepTeam",newItem)),predecessors.push(newItem)}predDepRecord.set("Edited",!0),me.PredDepGrid.view.refreshNode(me.CustomPredDepStore.indexOf(predDepRecord)),teamStore.resumeEvents()}}}}}}];return{xtype:"container",layout:"hbox",bodyCls:"blend-in-grid",pack:"start",align:"stretch",border:!1,items:[{xtype:"container",width:20,cls:"plus-button intel-editor-cell",listeners:{click:{element:"el",fn:function(){if(me.PredDepTeamStores[depID]){var scroll=me.PredDepGrid.view.getEl().getScrollTop(),predDepRecord=me.CustomPredDepStore.findRecord("DependencyID",depID),newItem=me._newTeamDep();me.PredDepTeamStores[depID].insert(0,[Ext.create("IntelDepTeam",newItem)]),predDepRecord.data.Predecessors.push(newItem),predDepRecord.set("Edited",!0),me.PredDepGrid.view.getEl().setScrollTop(scroll)}}}}},{xtype:"rallygrid",width:_.reduce(teamColumnCfgs,function(sum,i){return sum+i.width},0),rowLines:!1,flex:1,columnCfgs:teamColumnCfgs,plugins:["fastcellediting"],viewConfig:{stripeRows:!1,getRowClass:function(teamDepRecord,index,rowParams,store){return teamDepRecord.get("PID")?"intel-row-35px":"intel-row-35px intel-team-dep-row"}},listeners:{beforeedit:function(editor,e){return e.value?!1:void 0},edit:function(editor,e){var depTeamRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue,predDepRecord=me.CustomPredDepStore.findRecord("DependencyID",depID),predecessors=predDepRecord.get("Predecessors"),i;if(value!==originalValue){if("PID"===field){var projectRecord=_.find(me.ValidProjects,function(vp){return vp.data.Name===value});if(!projectRecord)return depTeamRecord.set("PID",originalValue),void 0;for(i=0;predecessors.length>i;++i)if(predecessors[i].PID==projectRecord.get("ObjectID"))return me._alert("ERROR",value+" already included in this dependency"),depTeamRecord.set("PID",originalValue),void 0;if(projectRecord.get("ObjectID")===me.ProjectRecord.get("ObjectID"))return me._alert("ERROR","You cannot depend on yourself"),depTeamRecord.set("PID",originalValue),void 0;depTeamRecord.set("PID",projectRecord.get("ObjectID"))}for(i=0;predecessors.length>i;++i)if(predecessors[i].TID===depTeamRecord.get("TID")){predecessors[i].PID=depTeamRecord.get("PID");break}predDepRecord.set("Edited",!0)}},selectionchange:function(){this.getSelectionModel().deselectAll()}},hideHeaders:!0,showRowActionsColumn:!1,scroll:!1,showPagingToolbar:!1,enableEditing:!1,context:me.getContext(),store:me.PredDepTeamStores[depID]}],listeners:{mousedown:defaultHandler,mousemove:defaultHandler,mouseout:defaultHandler,mouseover:defaultHandler,mouseup:defaultHandler,mousewheel:defaultHandler,scroll:defaultHandler,click:defaultHandler,dblclick:defaultHandler,contextmenu:defaultHandler,render:function(){me.PredDepContainers[depID]=this}}}}},{text:"",dataIndex:"Edited",width:30,xtype:"fastgridcolumn",tdCls:"iconCell",resizable:!1,renderer:function(value,meta,predDepRecord){var realDepData=me._removeDepFromList(predDepRecord.get("DependencyID"),me.DependenciesParsedData.Predecessors.slice(0)),dirtyType=me._getDirtyType(predDepRecord,realDepData);return"Edited"!==dirtyType?"":(meta.tdAttr='data-qtip="Undo"',{xtype:"container",width:20,cls:"undo-button intel-editor-cell",listeners:{click:{element:"el",fn:function(){var depID=predDepRecord.get("DependencyID"),realDep=me._removeDepFromList(depID,me.DependenciesParsedData.Predecessors.slice(0));
predDepRecord.beginEdit();for(var key in realDep)"Predecessors"===key?predDepRecord.set(key,Ext.clone(realDep[key])||[me._newTeamDep()]):predDepRecord.set(key,realDep[key]);predDepRecord.endEdit(),me.PredDepTeamStores[depID].intelUpdate()}}}})}},{text:"",dataIndex:"Edited",width:30,xtype:"fastgridcolumn",tdCls:"iconCell",resizable:!1,renderer:function(value,meta,predDepRecord){var realDepData=me._removeDepFromList(predDepRecord.get("DependencyID"),me.DependenciesParsedData.Predecessors.slice(0)),dirtyType=me._getDirtyType(predDepRecord,realDepData);if("New"===dirtyType)dirtyType="Save";else{if("Edited"!==dirtyType)return"";dirtyType="Resave"}return meta.tdAttr='data-qtip="'+dirtyType+' Dependency"',{xtype:"container",width:20,cls:"save-button intel-editor-cell",listeners:{click:{element:"el",fn:function(){function loadOriginalParent(){me._loadUserStory(predDepRecord.get("ObjectID"),function(oldUSRecord){var addedTeamDeps=[],removedTeamDeps=[],updatedTeamDeps=[],localPredTeams=predDepData.Predecessors;if(oldUSRecord){var oldRealDepsData=me._parseDependenciesFromUserStory(oldUSRecord).Predecessors,oldRealDepData=me._removeDepFromList(predDepData.DependencyID,oldRealDepsData),oldRealPredTeams=oldRealDepData?oldRealDepData.Predecessors||[]:[];newUSRecord=newUSRecord||oldUSRecord;Outer:for(var i=0;localPredTeams.length>i;++i){for(var j=0;oldRealPredTeams.length>j;++j)if(localPredTeams[i].TID===oldRealPredTeams[j].TID){updatedTeamDeps.push(oldRealPredTeams.splice(j,1)[0]);continue Outer}addedTeamDeps.push(localPredTeams[i])}removedTeamDeps=oldRealPredTeams}else addedTeamDeps=predDepData.Predecessors;var addedTeamDepsFinished=-1,addedTeamDepsCallbacks=[],addedTeamDepsDone=function(){if(++addedTeamDepsFinished===addedTeamDeps.length){var updatedTeamDepsFinished=-1,updatedTeamDepsCallbacks=[],updatedTeamDepsDone=function(){if(++updatedTeamDepsFinished===updatedTeamDeps.length){removedTeamDeps.forEach(function(teamDepData){var project=me.ValidProjects[teamDepData.PID];me._loadUserStoryByFID(teamDepData.USID,project.get("_ref"),function(us){if(us){var succDepData={FormattedID:teamDepData.USID,DependencyID:predDepData.DependencyID};me._removeSuccDep(us,succDepData)}})}),addedTeamDepsCallbacks.forEach(function(cb){cb()}),updatedTeamDepsCallbacks.forEach(function(cb){cb()}),predDepRecord.beginEdit(),predDepRecord.set("ObjectID",newUSRecord.get("ObjectID")),predDepRecord.set("Predecessors",localPredTeams);var lastAction=function(){predDepRecord.set("Edited",!1),predDepRecord.endEdit(),me.PredDepGrid.setLoading(!1)},nextAction=function(){me._addPredDep(newUSRecord,predDepData,lastAction)};oldRealDepData&&oldUSRecord.get("ObjectID")!==newUSRecord.get("ObjectID")?me._removePredDep(oldUSRecord,oldRealDepData,nextAction):nextAction()}};updatedTeamDepsDone(),updatedTeamDeps.forEach(function(teamDepData){var project=me.ValidProjects[teamDepData.PID];me._loadUserStoryByFID(teamDepData.USID,project.get("_ref"),function(us){us?(updatedTeamDepsCallbacks.push(function(){var succDep={DependencyID:predDepData.DependencyID,SuccUserStoryName:predDepData.UserStoryName,SuccFormattedID:predDepData.FormattedID,SuccProjectID:me.ProjectRecord.get("ObjectID"),Description:predDepData.Description,Checkpoint:predDepData.Checkpoint,UserStoryName:teamDepData.USName,FormattedID:teamDepData.USID,Supported:teamDepData.Sup,Assigned:teamDepData.A,ReleaseStartDate:me.ReleaseRecord.get("ReleaseStartDate"),ReleaseDate:me.ReleaseRecord.get("ReleaseDate"),Edited:!1};me._addSuccDep(us,succDep)}),updatedTeamDepsDone()):me._loadRandomUserStory(project.get("_ref"),function(us){return us?(updatedTeamDepsCallbacks.push(function(){for(var i=0;localPredTeams.length>i;++i)if(localPredTeams[i].TID===teamDepData.TID){localPredTeams[i].USID=us.get("FormattedID"),localPredTeams[i].USName=us.get("Name"),localPredTeams[i].A=!1;break}var succDep={DependencyID:predDepData.DependencyID,SuccUserStoryName:predDepData.UserStoryName,SuccFormattedID:predDepData.FormattedID,SuccProjectID:me.ProjectRecord.get("ObjectID"),Description:predDepData.Description,Checkpoint:predDepData.Checkpoint,UserStoryName:"",FormattedID:"",Supported:teamDepData.Sup,Assigned:!1,ReleaseStartDate:me.ReleaseRecord.get("ReleaseStartDate"),ReleaseDate:me.ReleaseRecord.get("ReleaseDate"),Edited:!1};me._addSuccDep(us,succDep)}),updatedTeamDepsDone(),void 0):(me.PredDepGrid.setLoading(!1),me._alert("ERROR","Project "+project.get("Name")+" has no user stories, cannot continue"),void 0)})})})}};addedTeamDepsDone(),addedTeamDeps.forEach(function(teamDepData){var project=me.ValidProjects[teamDepData.PID];me._loadRandomUserStory(project.get("_ref"),function(us){return us?(addedTeamDepsCallbacks.push(function(){teamDepData.USID=us.get("FormattedID"),teamDepData.USName=us.get("Name");var succDep={DependencyID:predDepData.DependencyID,SuccUserStoryName:predDepData.UserStoryName,SuccFormattedID:predDepData.FormattedID,SuccProjectID:me.ProjectRecord.get("ObjectID"),UserStoryName:"",FormattedID:"",Description:predDepData.Description,Checkpoint:predDepData.Checkpoint,Supported:"No",Assigned:!1,ReleaseStartDate:me.ReleaseRecord.get("ReleaseStartDate"),ReleaseDate:me.ReleaseRecord.get("ReleaseDate"),Edited:!1};me._addSuccDep(us,succDep)}),addedTeamDepsDone(),void 0):(me.PredDepGrid.setLoading(!1),me._alert("ERROR","Project "+project.get("Name")+" has no user stories, cannot continue"),void 0)})})})}if(""===predDepRecord.get("FormattedID")||""===predDepRecord.get("UserStoryName"))return me._alert("ERROR","A UserStory is not selected"),void 0;if(""===predDepRecord.get("Description"))return me._alert("ERROR","The description is empty"),void 0;if(""===predDepRecord.get("Checkpoint"))return me._alert("ERROR","Select When the dependency is needed by"),void 0;var predecessors=predDepRecord.get("Predecessors");if(0===predecessors.length)return me._alert("ERROR","You must specify a team you depend on"),void 0;if(_.find(predecessors,function(p){return""===p.PID}))return me._alert("ERROR","All Team Names must be valid"),void 0;me.PredDepGrid.setLoading(!0);var predDepData=predDepRecord.data,tmpNewUSRecord=me.UserStoryStore.findExactRecord("FormattedID",predDepData.FormattedID),newUSRecord;tmpNewUSRecord.get("ObjectID")!=predDepRecord.get("ObjectID")?me._loadUserStory(tmpNewUSRecord.get("ObjectID"),function(usRecord){newUSRecord=usRecord,loadOriginalParent()}):loadOriginalParent()}}}}}},{text:"",width:30,xtype:"fastgridcolumn",tdCls:"iconCell",resizable:!1,renderer:function(value,meta,predDepRecord){return meta.tdAttr='data-qtip="Delete Dependency"',{xtype:"container",width:20,cls:"delete-button intel-editor-cell",listeners:{click:{element:"el",fn:function(){me._confirm("Confirm","Delete Dependency?",function(msg){if("yes"===msg.toLowerCase()){var scroll=me.PredDepGrid.view.getEl().getScrollTop();me.PredDepGrid.setLoading(!0),me._loadUserStory(predDepRecord.get("ObjectID"),function(usRecord){var lastAction=function(){me.CustomPredDepStore.remove(predDepRecord),me.PredDepGrid.setLoading(!1)};if(usRecord){var predDepData=predDepRecord.data,realDepsData=me._parseDependenciesFromUserStory(usRecord).Predecessors,realDepData=me._removeDepFromList(predDepData.DependencyID,realDepsData),realTeamDeps=realDepData?realDepData.Predecessors||[]:[];realTeamDeps.forEach(function(teamDepData){if(""!==teamDepData.PID){var project=me.ValidProjects[teamDepData.PID];me._loadUserStoryByFID(teamDepData.USID,project.get("_ref"),function(us){if(us){var succDepData={FormattedID:teamDepData.USID,DependencyID:predDepData.DependencyID};me._removeSuccDep(us,succDepData)}})}}),realDepData?me._removePredDep(usRecord,realDepData,lastAction):lastAction()}else lastAction()})}})}}}}}}];me.AddPredDepButton=me.add({xtype:"container",items:[{xtype:"button",text:"+ Add Dependency",style:"margin:10px 0 10px 0",listeners:{click:function(){if(me.DependenciesReleaseUserStories.length){if(me.CustomPredDepStore){var model=Ext.create("IntelPredDep",{DependencyID:1*new Date+""+1e7*Math.random(),ObjectID:"",FormattedID:"",UserStoryName:"",Description:"",Checkpoint:"",Predecessors:[me._newTeamDep()],Edited:!0});me.CustomPredDepStore.insert(0,[model]),me.PredDepGrid.view.getEl().setScrollTop(0),me.PredDepGrid.getSelectionModel().select(model)}}else me._alert("ERROR","No User Stories for this Release!")}}}]}),me.PredDepGrid=me.add({xtype:"rallygrid",title:"Dependencies We Have on Other Teams",minHeight:150,maxHeight:500,scroll:"vertical",columnCfgs:predDepColumnCfgs,plugins:["fastcellediting"],viewConfig:{xtype:"scrolltableview",stripeRows:!0,preserveScrollOnRefresh:!0,getRowClass:function(predDepRecord){var cls="intel-row-"+(10+(35*predDepRecord.get("Predecessors").length||35))+"px";return cls}},listeners:{edit:function(editor,e){var predDepRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;if(value!==originalValue){"Description"===field&&(value=me._htmlEscape(value),predDepRecord.set(field,value));var previousEdit=predDepRecord.get("Edited");predDepRecord.set("Edited",!0);var userStoryRecord;"UserStoryName"===field?(userStoryRecord=_.find(me.DependenciesReleaseUserStories,function(us){return us.get("Name")===value}),userStoryRecord?predDepRecord.set("FormattedID",userStoryRecord.get("FormattedID")):(predDepRecord.set("UserStoryName",originalValue),predDepRecord.set("Edited",previousEdit))):"FormattedID"===field&&(userStoryRecord=_.find(me.DependenciesReleaseUserStories,function(us){return us.get("FormattedID")===value}),userStoryRecord?predDepRecord.set("UserStoryName",userStoryRecord.get("Name")):(predDepRecord.set("UserStoryName",originalValue),predDepRecord.set("Edited",previousEdit)))}}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,store:me.CustomPredDepStore}),me.CustomSuccDepStore=Ext.create("Intel.data.FastStore",{data:Ext.clone(me.DependenciesParsedData.Successors.slice(0)),autoSync:!0,model:"IntelSuccDep",proxy:{type:"fastsessionproxy",id:"SuccDepProxy"+Math.random()},limit:1/0,sorters:[depSorter],intelUpdate:function(){var succDepStore=me.CustomSuccDepStore,customSuccDepRecs=succDepStore.getRange(),realSuccDepsData=me.DependenciesParsedData.Successors.slice(0),remoteChanged=!1,key;console.log("syncing succDeps with current userStories",customSuccDepRecs,realSuccDepsData),succDepStore.suspendEvents(!0);for(var i=0;customSuccDepRecs.length>i;++i){var depRec=customSuccDepRecs[i],depID=depRec.get("DependencyID"),realDep=me._removeDepFromList(depID,realSuccDepsData),dirtyType=me._getDirtyType(depRec,realDep);if("Edited"!==dirtyType)if("Deleted"===dirtyType||"New"===dirtyType)succDepStore.remove(depRec);else{for(key in realDep)if(!_.isEqual(depRec.get(key),realDep[key])){remoteChanged=!0;break}if(remoteChanged){depRec.beginEdit();for(key in realDep)depRec.set(key,realDep[key]);depRec.endEdit()}}}realSuccDepsData.forEach(function(realDep){console.log("adding succDep",realDep),succDepStore.add(Ext.create("IntelSuccDep",Ext.clone(realDep)))}),succDepStore.resumeEvents()}}),me.CustomSuccDepStore.intelUpdate();var succDepColumnCfgs=[{text:"Requested By",dataIndex:"SuccProjectID",width:160,resizable:!1,sortable:!0,renderer:function(pid){var project=me.ValidProjects[pid];return project?project.get("Name"):pid}},{text:"Req Team US#",dataIndex:"SuccFormattedID",width:85,resizable:!1,sortable:!0},{text:"Req Team UserStory",dataIndex:"SuccUserStoryName",flex:1,resizable:!1,sortable:!0},{text:"Dependency Description",dataIndex:"Description",flex:1,resizable:!1,editor:!1,sortable:!0},{text:"Needed By",dataIndex:"Checkpoint",width:80,resizable:!1,editor:!1,sortable:!0},{text:"Supported",dataIndex:"Supported",width:80,resizable:!1,tdCls:"intel-editor-cell",editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["Sup"],data:[{Sup:"Yes"},{Sup:"No"}]}),editable:!1,displayField:"Sup",listeners:{focus:function(combo){combo.expand()}}},renderer:function(val,meta){return meta.tdCls="No"==val?"intel-not-supported-cell":"intel-supported-cell",val},sortable:!0},{text:"Sup US#",dataIndex:"FormattedID",tdCls:"intel-editor-cell",width:80,resizable:!1,editor:{xtype:"intelcombobox",width:120,store:Ext.create("Ext.data.Store",{fields:["FormattedID"],data:_.map(me.DependenciesReleaseUserStories,function(usr){return{FormattedID:usr.get("FormattedID")}}),sorters:{property:"FormattedID"}}),displayField:"FormattedID"},sortable:!0,renderer:function(val){return val?val:"-"}},{text:"Sup UserStory",dataIndex:"UserStoryName",flex:1,resizable:!1,tdCls:"intel-editor-cell",editor:{xtype:"intelcombobox",store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.DependenciesReleaseUserStories,function(usr){return{Name:usr.get("Name")}}),sorters:{property:"Name"}}),displayField:"Name"},sortable:!0,renderer:function(val){return val?val:"-"}},{text:"",dataIndex:"Edited",width:30,xtype:"fastgridcolumn",tdCls:"iconCell",resizable:!1,renderer:function(value,meta,succDepRecord){return succDepRecord.get("FormattedID")?(meta.tdAttr='data-qtip="Remove User Story"',{xtype:"container",width:20,cls:"minus-button intel-editor-cell",listeners:{click:{element:"el",fn:function(){succDepRecord.set("Edited",!0),succDepRecord.set("Assigned",!1),succDepRecord.set("FormattedID",""),succDepRecord.set("UserStoryName","")}}}}):""}},{text:"",dataIndex:"Edited",width:30,xtype:"fastgridcolumn",tdCls:"iconCell",resizable:!1,renderer:function(value,meta,succDepRecord){var realDepData=me._removeDepFromList(succDepRecord.get("DependencyID"),me.DependenciesParsedData.Successors.slice(0)),dirtyType=me._getDirtyType(succDepRecord,realDepData);return"Edited"!==dirtyType?"":(meta.tdAttr='data-qtip="Undo"',{xtype:"container",width:20,cls:"undo-button intel-editor-cell",listeners:{click:{element:"el",fn:function(){var depID=succDepRecord.get("DependencyID"),realDep=me._removeDepFromList(depID,me.DependenciesParsedData.Successors.slice(0));succDepRecord.beginEdit(!0);for(var key in realDep)succDepRecord.set(key,realDep[key]);succDepRecord.endEdit()}}}})}},{text:"",width:30,xtype:"fastgridcolumn",tdCls:"iconCell",resizable:!1,renderer:function(value,meta,succDepRecord){var realDepData=me._removeDepFromList(succDepRecord.get("DependencyID"),me.DependenciesParsedData.Successors.slice(0)),dirtyType=me._getDirtyType(succDepRecord,realDepData);return"Edited"!==dirtyType?"":(meta.tdAttr='data-qtip="Resave"',{xtype:"container",width:20,cls:"save-button intel-editor-cell",listeners:{click:{element:"el",fn:function(){function loadOriginalParent(){me._loadUserStory(succDepRecord.get("ObjectID"),function(oldUSRecord){var oldRealDepData,oldRealDepsData;oldUSRecord&&(oldRealDepsData=me._parseDependenciesFromUserStory(oldUSRecord).Successors,oldRealDepData=me._removeDepFromList(succDepData.DependencyID,oldRealDepsData),newUSRecord=newUSRecord||oldUSRecord),succDepData.ObjectID=newUSRecord.get("ObjectID");var lastAction=function(){succDepRecord.set("Edited",!1),me.SuccDepGrid.setLoading(!1)},nextAction=function(){me._addSuccDep(newUSRecord,succDepData,lastAction)},alertAndDelete=function(msg){me._alert("ERROR",msg),me._removeSuccDep(newUSRecord,succDepData,function(){me.SuccDepGrid.setLoading(!1);var scroll=me.SuccDepGrid.view.getEl().getScrollTop();me.CustomSuccDepStore.remove(succDepRecord),me.SuccDepGrid.view.getEl().setScrollTop(scroll)})},project=me.ValidProjects[succDepData.SuccProjectID];me._loadUserStoryByFID(succDepData.SuccFormattedID,project.get("_ref"),function(us){if(us){var deps=me._getDependencies(us),rppData=deps.Preds[succDepData.DependencyID];if(rppData){for(var predDepData={DependencyID:succDepData.DependencyID,FormattedID:us.get("FormattedID"),UserStoryName:us.get("Name"),Description:rppData.Desc,Checkpoint:rppData.CP,Status:rppData.Sta,Predecessors:rppData.Preds||[],Edited:!1},predecessors=predDepData.Predecessors,i=0;predecessors.length>i;++i)if(predecessors[i].PID==me.ProjectRecord.get("ObjectID"))return predecessors[i].Sup=succDepData.Supported,predecessors[i].USID=newUSRecord.get("FormattedID"),predecessors[i].USName=newUSRecord.get("Name"),predecessors[i].A=succDepData.Assigned,me._addPredDep(us,predDepData),oldRealDepData&&oldUSRecord.get("ObjectID")!==newUSRecord.get("ObjectID")?me._removeSuccDep(oldUSRecord,oldRealDepData,nextAction):nextAction(),void 0;alertAndDelete("Successor removed your dependency. Deleting this dependency now")}else alertAndDelete("Successor removed this dependency. Deleting your dependency now")}else alertAndDelete("Successor UserStory has been deleted. Deleting Dependency Now")})})}me.SuccDepGrid.setLoading(!0);var succDepData=succDepRecord.data,tmpNewUSRecord=me.UserStoryStore.findExactRecord("FormattedID",succDepRecord.FormattedID),newUSRecord;tmpNewUSRecord&&tmpNewUSRecord.get("ObjectID")!=succDepRecord.get("ObjectID")?me._loadUserStory(tmpNewUSRecord.get("ObjectID"),function(usRecord){newUSRecord=usRecord,loadOriginalParent()}):loadOriginalParent()}}}})}}];me.SuccDepGrid=me.add({xtype:"rallygrid",title:"Dependencies Other Teams Have on Us",minHeight:150,maxHeight:800,scroll:"vertical",columnCfgs:succDepColumnCfgs,plugins:["fastcellediting"],viewConfig:{xtype:"scrolltableview",stripeRows:!0,preserveScrollOnRefresh:!0,getRowClass:function(){return"intel-row-35px"}},listeners:{beforeedit:function(editor,e){var succDepRecord=e.record;return"No"==succDepRecord.get("Supported")&&"Supported"!=e.field?!1:void 0},edit:function(editor,e){var grid=e.grid,succDepRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue,previousEdit=succDepRecord.get("Edited");succDepRecord.set("Edited",!0);var userStoryRecord;"UserStoryName"===field?(userStoryRecord=_.find(me.DependenciesReleaseUserStories,function(us){return us.get("Name")===value}),userStoryRecord?(succDepRecord.set("FormattedID",userStoryRecord.get("FormattedID")),succDepRecord.set("Assigned",!0)):(succDepRecord.set("UserStoryName",originalValue),succDepRecord.set("Edited",previousEdit))):"FormattedID"===field?(userStoryRecord=_.find(me.DependenciesReleaseUserStories,function(us){return us.get("FormattedID")===value}),userStoryRecord?(succDepRecord.set("UserStoryName",userStoryRecord.get("Name")),succDepRecord.set("Assigned",!0)):(succDepRecord.set("FormattedID",originalValue),succDepRecord.set("Edited",previousEdit))):"Supported"===field&&"No"==value&&(succDepRecord.set("Assigned",!1),succDepRecord.set("FormattedID",""),succDepRecord.set("UserStoryName",""))}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomSuccDepStore})}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name70221",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .x-grid-row.intel-row-35px>.x-grid-cell{height:35px !important}.x-grid-row.intel-row-45px>.x-grid-cell{height:45px !important}.x-grid-row.intel-row-80px>.x-grid-cell{height:80px !important}.x-grid-row.intel-row-115px>.x-grid-cell{height:115px !important}.x-grid-row.intel-row-150px>.x-grid-cell{height:150px !important}.x-grid-row.intel-row-185px>.x-grid-cell{height:185px !important}.x-grid-row.intel-row-220px>.x-grid-cell{height:220px !important}.x-grid-row.intel-row-255px>.x-grid-cell{height:255px !important}.x-grid-row.intel-row-290px>.x-grid-cell{height:290px !important}.x-grid-row.intel-row-325px>.x-grid-cell{height:325px !important}.x-grid-row.intel-row-360px>.x-grid-cell{height:360px !important}.x-grid-row .intel-editor-cell{cursor:pointer !important}.x-grid-row .intel-editor-cell *{cursor:pointer !important}.pred-dep-header{display:inline-block !important;line-height:100% !important;font-weight:500 !important}.grey-row .x-grid-cell{background-color:rgba(224,224,224,0.15) !important}.grey-row.x-grid-row-selected .x-grid-cell{background-color:rgba(224,224,224,0.25) !important}.red-row .x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.red-row.x-grid-row-selected .x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.green-row .x-grid-cell{background-color:rgba(0,255,0,0.15) !important}.green-row.x-grid-row-selected .x-grid-cell{background-color:rgba(0,255,0,0.25) !important}.x-grid-row .red-cell.x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.x-grid-row-selected .red-cell.x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.x-grid-row .yellow-cell.x-grid-cell{background-color:rgba(230,230,0,0.15) !important}.x-grid-row-selected .yellow-cell.x-grid-cell{background-color:rgba(230,230,0,0.25) !important}.x-grid-body .x-grid-body{background-color:rgba(0,0,0,0) !important}.rally-grid .x-grid-body{border-top:0 !important}.x-grid-row.intel-team-dep-row .x-grid-cell,.x-grid-row-hover.intel-team-dep-row.x-grid-cell,.x-grid-row-selected.intel-team-dep-row .x-grid-cell{background-color:rgba(0,0,0,0) !important}.x-grid-row .intel-not-supported-cell.x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.x-grid-row-selected .intel-not-supported-cell.x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.x-grid-row .intel-supported-cell.x-grid-cell{background-color:rgba(0,255,0,0.15) !important}.x-grid-row-selected .intel-supported-cell.x-grid-cell{background-color:rgba(0,255,0,0.25) !important}.undo-button{background-image:url(http://png-4.findicons.com/files/icons/2315/default_icon/256/undo.png) !important}.delete-button{background-image:url(http://superadm.com/wp-content/uploads/2014/05/delete.png) !important}.save-button{background-image:url(http://www.iconpng.com/png/windows8_icons2/save.png) !important}.minus-button{background-image:url(http://www.pubzi.com/f/minus-sign.svg) !important}.plus-button{background-image:url(http://ilstream.com/images/plus-icon.gif) !important}.iconCell,.iconCell *{padding:0px !important;margin:0px !important}.undo-button,.delete-button,.save-button,.minus-button,.plus-button{left:0px !important;top:0px !important;height:20px !important;width:20px !important;background-size:20px !important;padding:0px !important;margin:5px 3px 0px 3px !important}
    </style>
</head>
<body>
</body>
</html>
