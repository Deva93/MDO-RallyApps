<!DOCTYPE html>
<html>
<head>
    <title>Random App Name70221</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:"absolute",_showError:function(text){this.errMessage&&this.remove(this.errMessage),this.errMessage=this.add({xtype:"text",text:text})},_loadModels:function(cb){var me=this;Rally.data.ModelFactory.getModel({type:"Project",success:function(model){me.Project=model,Rally.data.ModelFactory.getModel({type:"PortfolioItem/Milestone",success:function(model){me.Milestone=model,cb()}})}})},_loadProject:function(project,cb){var me=this;me.Project.load(project.ObjectID,{fetch:["ObjectID","Children","Parent","Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:function(record,operation){operation.wasSuccessful()?cb(record):me._showError("failed to retreive project: "+project.ObjectID)}})},_loadMilestone:function(milestone,cb){var me=this;me.Milestone.load(milestone.ObjectID,{fetch:["ObjectID","Parent","Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:function(record,operation){operation.wasSuccessful()?cb(record):me._showError("failed to retreive milestone: "+milestone.ObjectID)}})},_loadReleases:function(cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,limit:1/0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:me.TrainRecord.data.ObjectID},{property:"Name",operator:"contains",value:me.TrainRecord.data.Name.split(" ART ")[0]}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),me.MatrixReleaseStore=releaseStore,cb()},single:!0}}})},_loadMatrixFeatures:function(cb){var me=this;me.MatrixProductHash={},Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,limit:1/0,fetch:["Name","ObjectID","Project","Parent","FormattedID","UserStories","c_TeamCommits","DragAndDropRank"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:me.ReleaseRecord.data.Name}],listeners:{load:{fn:function(featureStore,featureRecords){console.log("features loaded:",featureRecords),me.MatrixFeatureStore=featureStore;var finished=-1,done=function(){++finished==featureRecords.length&&cb()};done(),featureRecords.forEach(function(fr){var frData=fr.data;frData.Parent?me._loadMilestone(frData.Parent,function(milestoneRecord){var p=milestoneRecord.data.Parent;me.MatrixProductHash[frData.ObjectID]=p&&p.Name?p.Name:"",done()}):(me.MatrixProductHash[frData.ObjectID]="",done())})},single:!0}}})},_loadMatrixUserStoryBreakdown:function(cb){var me=this;me.MatrixUserStoryBreakdown={},me.MatrixProjectMap={};var fRecords=me.MatrixFeatureStore.getRecords(),finished=-1,done=function(){++finished==fRecords.length&&(console.log("Stories loaded:",me.MatrixUserStoryBreakdown),cb())};done(),fRecords.forEach(function(fRecord){Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",fetch:["ObjectID","Project","Name","Feature"],limit:1/0,autoLoad:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:me.ReleaseRecord.data.Name},{property:"Feature.ObjectID",value:fRecord.data.ObjectID}],listeners:{load:{fn:function(storyStore,storyRecords){storyRecords.forEach(function(sr){var PName=sr.data.Project.Name,FName=fRecord.data.Name;me.MatrixUserStoryBreakdown[PName]||(me.MatrixUserStoryBreakdown[PName]={}),me.MatrixUserStoryBreakdown[PName][FName]||(me.MatrixUserStoryBreakdown[PName][FName]=0),++me.MatrixUserStoryBreakdown[PName][FName],me.MatrixProjectMap[PName]=sr.data.Project.ObjectID}),done()},single:!0}}})})},_defineModels:function(){Ext.define("IntelFeature",{extend:"Ext.data.Model",fields:[{name:"Rank",type:"string"},{name:"FormattedID",type:"string"},{name:"ObjectID",type:"string"},{name:"FeatureName",type:"string"},{name:"ProductName",type:"string"}]})},_reloadingStores:!0,_reloadMatrixStores:function(){var me=this;me.MatrixFeatureStore&&me.MatrixFeatureStore.load({callback:function(){me.featureTCAECache={},me.CustomMatrixStore&&me.CustomMatrixStore.load()}})},_projectInWhichTrain:function(projectRecord,cb){var me=this;projectRecord||cb();var split=projectRecord.data.Name.split(" ART ");if(split.length>1)cb(projectRecord);else{var parent=projectRecord.data.Parent;parent?me._loadProject(parent,function(parentRecord){me._projectInWhichTrain(parentRecord,cb)}):cb()}},_getCurrentOrFirstRelease:function(){var me=this,d=new Date,rs=me.MatrixReleaseStore.getRecords();if(rs.length){for(var i=0;rs.length>i;++i)if(new Date(rs[i].data.ReleaseDate)>=d&&d>=new Date(rs[i].data.ReleaseStartDate))return rs[i];return rs[0]}},launch:function(){var me=this;me._defineModels(),setInterval(function(){me._reloadMatrixStores()},1e4),me._showError("Loading Data..."),me._loadModels(function(){var scopeProject=me.getContext().getProject();me._loadProject(scopeProject,function(scopeProjectRecord){me._projectInWhichTrain(scopeProjectRecord,function(trainRecord){trainRecord?(me.TrainRecord=trainRecord,console.log("train loaded:",trainRecord),me._loadReleases(function(){var currentRelease=me._getCurrentOrFirstRelease();currentRelease?(me.ReleaseRecord=currentRelease,console.log("release loaded",currentRelease),me._loadMatrixFeatures(function(){me._loadMatrixUserStoryBreakdown(function(){me.removeAll(),me._loadMatrixGrid()})})):(me.removeAll(),console.log("This ART has no releases"))})):(me.removeAll(),me._showError("Please scope to an ART"))})})})},_loadMatrixGrid:function(){function getTeamCommit(featureRecord,ProjectName){var tcs=featureRecord.data.c_TeamCommits,featureID=featureRecord.data.ObjectID,projectID=me.MatrixProjectMap[ProjectName],this_tc;try{var parsed_tcs;me.featureTCAECache[featureID]?parsed_tcs=me.featureTCAECache[featureID]:(parsed_tcs=JSON.parse(tcs)||{},me.featureTCAECache[featureID]=parsed_tcs),this_tc=parsed_tcs[projectID]||{}}catch(e){me.featureTCAECache[featureID]=this_tc={}}return this_tc}function setExpected(featureRecord,ProjectName,value){var tcs=featureRecord.data.c_TeamCommits,featureID=featureRecord.data.ObjectID,projectID=me.MatrixProjectMap[ProjectName];try{me.featureTCAECache[featureID]?tcs=me.featureTCAECache[featureID]:(tcs=JSON.parse(tcs)||{},me.featureTCAECache[featureID]=tcs)}catch(e){me.featureTCAECache[featureID]=this_tc={}}tcs[projectID]||(tcs[projectID]={}),tcs[projectID].Expected=value,featureRecord.set("c_TeamCommits",JSON.stringify(tcs,null,"	")),featureRecord.save()}var me=this;me.featureTCAECache={};var customMatrixRecords=_.map(me.MatrixFeatureStore.getRecords(),function(featureRecord){return{Rank:featureRecord.get("DragAndDropRank"),FormattedID:featureRecord.get("FormattedID"),ObjectID:featureRecord.get("ObjectID"),FeatureName:featureRecord.get("Name"),ProductName:me.MatrixProductHash[featureRecord.get("ObjectID")]}});me.CustomMatrixStore=Ext.create("Ext.data.Store",{data:customMatrixRecords,model:"IntelFeature",autoSync:!0,limit:1/0,proxy:{type:"sessionstorage",id:"Session-proxy-"+Math.random()}});var defColumnCfgs=[{text:"Rank",dataIndex:"Rank",width:50,editor:!1,sortable:!0,resizable:!1,renderer:function(oid,meta,f1){var rank=1,f1OID=f1.data.ObjectID;f1=me.MatrixFeatureStore.findRecord("ObjectID",f1OID);var f1DADR=f1.data.DragAndDropRank;return me.MatrixFeatureStore.getRecords().forEach(function(f2){f2.get("ObjectID")!=f1OID&&f1DADR>f2.get("DragAndDropRank")&&++rank}),rank}},{text:"F#",dataIndex:"FormattedID",width:50,editor:!1,resizable:!1,sortable:!0,renderer:function(FID){var feature=me.MatrixFeatureStore.findRecord("FormattedID",FID);if(feature.get("Project")){var pid=feature.get("Project")._ref.split("/project/")[1];return'<a href="https://rally1.rallydev.com/#/'+pid+"d/detail/portfolioitem/feature/"+feature.get("ObjectID")+'">'+FID+"</a>"}return name}},{text:"Feature",dataIndex:"FeatureName",width:250,editor:!1,resizable:!1,sortable:!0},{text:"Product",dataIndex:"ProductName",width:100,editor:!1,resizable:!1,sortable:!0}],columnCfgs=[].concat(defColumnCfgs);Object.keys(me.MatrixUserStoryBreakdown).sort().forEach(function(ProjectName){columnCfgs.push({text:ProjectName,dataIndex:"ObjectID",width:50,editor:"textfield",align:"center",tdCls:"intel-editor-cell",sortable:!1,resizable:!1,renderer:function(oid,metaData,matrixRecord,row,col){var featureRecord=me.MatrixFeatureStore.findRecord("ObjectID",matrixRecord.get("ObjectID")),count=me.MatrixUserStoryBreakdown[ProjectName][featureRecord.data.Name]||0,tcae=getTeamCommit(featureRecord,ProjectName),Expected=tcae.Expected||!1,Commitment=tcae.Commitment||"Undecided";return"Undecided"===Commitment&&(metaData.tdCls+=" intel-team-commits-WHITE"),"N/A"===Commitment&&(metaData.tdCls+=" intel-team-commits-GREY"),"Committed"===Commitment&&(metaData.tdCls+=" intel-team-commits-GREEN"),"Not Committed"===Commitment&&(metaData.tdCls+=" intel-team-commits-RED"),Expected&&(metaData.tdCls+="-YELLOW"),count}})}),me.MatrixReleasePicker=me.add({xtype:"combobox",x:0,y:0,store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.MatrixReleaseStore.getRecords(),function(r){return{Name:r.get("Name")}})}),displayField:"Name",fieldLabel:"Release:",editable:!1,value:me.ReleaseRecord.get("Name"),listeners:{select:function(combo,records){me.ReleaseRecord.get("Name")!==records[0].get("Name")&&(me.ReleaseRecord=me.MatrixReleaseStore.findRecord("Name",records[0].get("Name")),me._loadMatrixFeatures(function(){me._loadMatrixUserStoryBreakdown(function(){me.removeAll(),me._loadMatrixGrid(),me.setLoading(!0),setTimeout(function(){me.setLoading(!1)},2e3)})}))}}}),me.MatrixProductPicker=me.add({xtype:"combobox",x:300,y:0,fieldLabel:"Product Filter",store:Ext.create("Ext.data.Store",{fields:["ProductName"],data:_.map(_.reduce(Object.keys(me.MatrixProductHash),function(items,ObjectID){var projectName=me.MatrixProductHash[ObjectID];return-1==items.indexOf(projectName)&&items.push(projectName),items},["All Products"]),function(name){return{ProductName:name}})}),displayField:"ProductName",editable:!1,value:"All Products",listeners:{select:function(combo,records){var value=records[0].get("ProductName");me.CustomMatrixStore.filters.getRange().forEach(function(filter){me.CustomMatrixStore.removeFilter(filter)}),"All Products"!==value&&me.CustomMatrixStore.addFilter(new Ext.util.Filter({filterFn:function(matrixRecord){return matrixRecord.get("ProductName")===value}}))}}}),me.MatrixLegend=me.add({xtype:"container",layout:"table",columns:5,width:800,x:600,y:0,border:!0,frame:!1,items:_.map(["Committed","Not Committed","N/A","Undefined","Expected"],function(name){var color;return"Undecided"===name&&(color="white"),"N/A"===name&&(color="grey"),"Committed"===name&&(color="green"),"Not Committed"===name&&(color="red"),"Expected"===name&&(color="yellow"),{xtype:"container",width:160,border:!1,frame:!1,html:'<div class="intel-legend-item">'+name+': <div style="background-color:'+color+'" class="intel-legend-dot"></div></div>'}})}),me.MatrixGrid=me.add({xtype:"rallygrid",x:0,y:50,height:1200,width:_.reduce(columnCfgs,function(item,sum){return sum+item.width},20),scroll:"both",resizable:!1,columnCfgs:columnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],listeners:{beforeedit:function(editor,e){var ProjectName=e.column.text,matrixRecord=e.record,featureRecord=me.MatrixFeatureStore.findRecord("ObjectID",matrixRecord.get("ObjectID")),tcae=getTeamCommit(featureRecord,ProjectName);return setExpected(featureRecord,ProjectName,!tcae.Expected),matrixRecord.commit(),!1}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:me.getContext(),store:me.CustomMatrixStore})}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name70221",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .x-grid-row .intel-editor-cell{cursor:pointer !important}.x-grid-row .intel-editor-cell *{cursor:pointer !important}.x-grid-cell.intel-team-commits-WHITE{background-color:rgba(0,0,0,0) !important}.x-grid-row-over:not(.x-grid-row-selected) .x-grid-cell.intel-team-commits-WHITE{background-color:#ecf8fb !important}.x-grid-cell.intel-team-commits-RED{background-color:rgba(255,0,0,0.5) !important}.x-grid-row-selected .x-grid-cell.intel-team-commits-RED,.x-grid-row-over .x-grid-cell.intel-team-commits-RED{background-color:rgba(255,0,0,0.7) !important}.x-grid-cell.intel-team-commits-GREEN{background-color:rgba(0,255,0,0.5) !important}.x-grid-row-selected .x-grid-cell.intel-team-commits-GREEN,.x-grid-row-over .x-grid-cell.intel-team-commits-GREEN{background-color:rgba(0,255,0,0.7) !important}.x-grid-cell.intel-team-commits-GREY{background-color:rgba(224,224,224,0.5) !important}.x-grid-row-selected .x-grid-cell.intel-team-commits-GREY,.x-grid-row-over .x-grid-cell.intel-team-commits-GREY{background-color:rgba(224,224,224,0.7) !important}.x-grid-cell.intel-team-commits-WHITE-YELLOW{background-image:-webkit-gradient(linear, right top, left bottom, color-stop(.5, rgba(251,255,0,0.5)), color-stop(.5, rgba(0,0,0,0))) !important;background-image:-o-linear-gradient(right top, rgba(0,0,0,0) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-moz-linear-gradient(right top, rgba(0,0,0,0) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-webkit-linear-gradient(right top, rgba(0,0,0,0) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-ms-linear-gradient(right top, rgba(0,0,0,0) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:linear-gradient(to right top, rgba(0,0,0,0) 75%, rgba(251,255,0,0.5) 75%) !important}.x-grid-cell.intel-team-commits-RED-YELLOW{background-image:-webkit-gradient(linear, right top, left bottom, color-stop(.5, rgba(251,255,0,0.5)), color-stop(.5, rgba(255,0,0,0.5))) !important;background-image:-o-linear-gradient(right top, rgba(255,0,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-moz-linear-gradient(right top, rgba(255,0,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-webkit-linear-gradient(right top, rgba(255,0,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-ms-linear-gradient(right top, rgba(255,0,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:linear-gradient(to right top, rgba(255,0,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important}.x-grid-cell.intel-team-commits-GREEN-YELLOW{background-image:-webkit-gradient(linear, right top, left bottom, color-stop(.5, rgba(251,255,0,0.5)), color-stop(.5, rgba(0,255,0,0.5))) !important;background-image:-o-linear-gradient(right top, rgba(0,255,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-moz-linear-gradient(right top, rgba(0,255,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-webkit-linear-gradient(right top, rgba(0,255,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-ms-linear-gradient(right top, rgba(0,255,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:linear-gradient(to right top, rgba(0,255,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important}.x-grid-cell.intel-team-commits-GREY-YELLOW{background-image:-webkit-gradient(linear, right top, left bottom, color-stop(.5, rgba(251,255,0,0.5)), color-stop(.5, rgba(224,224,224,0.5))) !important;background-image:-o-linear-gradient(right top, rgba(224,224,224,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-moz-linear-gradient(right top, rgba(224,224,224,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-webkit-linear-gradient(right top, rgba(224,224,224,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-ms-linear-gradient(right top, rgba(224,224,224,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:linear-gradient(to right top, rgba(224,224,224,0.5) 75%, rgba(251,255,0,0.5) 75%) !important}.intel-legend-dot{width:16px;height:16px;border-radius:8px;border:1px solid black;display:inline-block;vertical-align:middle}.intel-legend-item{font-size:1.2em;text-align:center}
    </style>
</head>
<body>
</body>
</html>
