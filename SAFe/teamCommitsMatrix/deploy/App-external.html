<!DOCTYPE html>
<html>
<head>
    <title>ART Commit Matrix</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.0.1/q.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("IntelVelocity",{extend:"Ext.data.Model",fields:[{name:"Name",type:"string"},{name:"PlannedVelocity",type:"string"},{name:"RealVelocity",type:"string"}]}),Ext.define("IntelTeamCommits",{extend:"Ext.data.Model",fields:[{name:"Name",type:"string"},{name:"ObjectID",type:"string"},{name:"FormattedID",type:"string"},{name:"Commitment",type:"string"},{name:"Objective",type:"string"},{name:"Product",type:"string"},{name:"PlannedEnd",type:"string"}]}),Ext.define("IntelRisk",{extend:"Ext.data.Model",fields:[{name:"RiskID",type:"string"},{name:"ObjectID",type:"number"},{name:"FormattedID",type:"string"},{name:"FeatureName",type:"string"},{name:"Description",type:"string"},{name:"Impact",type:"string"},{name:"Status",type:"string"},{name:"Contact",type:"string"},{name:"Checkpoint",type:"string"},{name:"Edited",type:"boolean"}]}),Ext.define("IntelDepTeam",{extend:"Ext.data.Model",fields:[{name:"TID",type:"string"},{name:"PID",type:"string"},{name:"Sup",type:"string"},{name:"USID",type:"string"},{name:"USName",type:"string"},{name:"A",type:"boolean"}]}),Ext.define("IntelPredDep",{extend:"Ext.data.Model",fields:[{name:"ObjectID",type:"number"},{name:"DependencyID",type:"string"},{name:"FormattedID",type:"string"},{name:"UserStoryName",type:"string"},{name:"Description",type:"string"},{name:"Checkpoint",type:"string"},{name:"Status",type:"string"},{name:"Predecessors",type:"auto"},{name:"Edited",type:"boolean"}]}),Ext.define("IntelSuccDep",{extend:"Ext.data.Model",fields:[{name:"ObjectID",type:"number"},{name:"DependencyID",type:"string"},{name:"SuccUserStoryName",type:"string"},{name:"SuccFormattedID",type:"string"},{name:"SuccProjectID",type:"string"},{name:"UserStoryName",type:"string"},{name:"FormattedID",type:"string"},{name:"ReleaseStartDate",type:"string"},{name:"ReleaseDate",type:"string"},{name:"Description",type:"string"},{name:"Checkpoint",type:"string"},{name:"Supported",type:"string"},{name:"Assigned",type:"boolean"},{name:"Edited",type:"boolean"}]}),Ext.define("IntelRiskWithProject",{extend:"Ext.data.Model",fields:[{name:"ProjectName",type:"string"},{name:"ProjectOID",type:"string"},{name:"RiskID",type:"string"},{name:"ObjectID",type:"number"},{name:"FormattedID",type:"string"},{name:"FeatureName",type:"string"},{name:"Description",type:"string"},{name:"Impact",type:"string"},{name:"Status",type:"string"},{name:"Contact",type:"string"},{name:"Checkpoint",type:"string"},{name:"Edited",type:"boolean"}]}),Ext.define("IntelPredDepWithProject",{extend:"Ext.data.Model",fields:[{name:"ProjectName",type:"string"},{name:"ProjectOID",type:"string"},{name:"ObjectID",type:"number"},{name:"DependencyID",type:"string"},{name:"FormattedID",type:"string"},{name:"UserStoryName",type:"string"},{name:"Description",type:"string"},{name:"Checkpoint",type:"string"},{name:"Status",type:"string"},{name:"Predecessors",type:"auto"},{name:"Edited",type:"boolean"}]});
                Ext.define("WindowListener",{__initWindowEventListener:function(eventName){var me=this;me._windowListeners||(me._windowListeners={}),me._windowListeners[eventName]=[],window.parent["on"+eventName]=function(event){for(var listeners=me._windowListeners[eventName],i=0,len=listeners.length;len>i;++i)listeners[i](event)}},_addWindowEventListener:function(eventName,fn){var me=this;me._windowListeners&&me._windowListeners[eventName]||me.__initWindowEventListener(eventName),me._windowListeners[eventName].push(fn)},_fireParentWindowEvent:function(eventName){var me=this;if(me._windowListeners&&me._windowListeners[eventName])for(var listeners=me._windowListeners[eventName],i=0,len=listeners.length;len>i;++i)listeners[i]()}});
                Ext.define("IframeResize",{requires:["WindowListener"],__applyIframeResize:function(){for(var w=window,p=w.parent,pd=w.parent.document,l=w.location,iframe=pd.querySelector('iframe[src="'+l.pathname+l.search+'"]'),ip1=iframe.parentNode,ip2=iframe.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode,height=0,next=this.down();next;)height+=next.getHeight()+1*next.getEl().getMargin("tb")+1*next.getEl().getPadding("tb"),next=next.next();height+=150,ip1.style.height=height+"px",ip2.style.height=height+"px",iframe.style.height=height+"px"},_initIframeResize:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me.__applyIframeResize()})}});
                Ext.define("PrettyAlert",{requires:["WindowListener"],_alert:function(title,str){Ext.MessageBox.alert(title||"",str||"").setY(this.__msgBoxY),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20)},_confirm:function(title,str,fn){Ext.MessageBox.confirm(title||"",str||"",fn||function(){}).setY(this.__msgBoxY),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20)},__applyMessageBoxConfig:function(){var w=window,p=w.parent,pd=w.parent.document,l=w.location,iframe=pd.querySelector('iframe[src="'+l.pathname+l.search+'"]'),ph=p.getWindowHeight(),ps=p.getScrollY(),ofy=ps+iframe.getBoundingClientRect().top,iyOffset=Math.floor(ph/2-ofy+ps-50);this.__msgBoxY=0>iyOffset?0:iyOffset},_initPrettyAlert:function(){var me=this;me._addWindowEventListener&&(me._addWindowEventListener("resize",function(){me.__applyMessageBoxConfig()}),me._addWindowEventListener("scroll",function(){me.__applyMessageBoxConfig()}))}});
                Ext.define("IntelWorkweek",{_getWorkweek:function(date){var oneDay=864e5,yearStart=new Date(date.getFullYear(),0,1),dayIndex=yearStart.getDay(),ww01Start=yearStart-dayIndex*oneDay,timeDiff=date-ww01Start,dayDiff=timeDiff/oneDay,ww=Math.floor(dayDiff/7)+1,leap=0===date.getFullYear()%4,weekCount=leap&&dayIndex>=5||!leap&&6===dayIndex?53:52;return ww>weekCount?1:ww},_getWeekCount:function(date){var leap=0===date.getFullYear()%4,day=new Date(date.getFullYear(),0,1).getDay();return leap&&day>=5||!leap&&6===day?53:52},_getWorkweeks:function(startDate,endDate){var i,sd_week=this._getWorkweek(startDate),ed_week=this._getWorkweek(endDate),week_count=this._getWeekCount(startDate),weeks=[];if(sd_week>ed_week){for(i=sd_week;week_count>=i;++i)weeks.push("ww"+i);for(i=1;ed_week>=i;++i)weeks.push("ww"+i)}else for(i=sd_week;ed_week>=i;++i)weeks.push("ww"+i);return weeks}});
                Ext.define("ReleaseQuery",{_loadReleasesInTheFuture:function(projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID},{property:"ReleaseDate",operator:">=",value:(new Date).toISOString()}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),deferred.resolve(releaseStore)},single:!0}}}),deferred.promise},_loadReleasesWithName:function(releaseName,trainName){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:releaseName},{property:"Project.Name",operator:"contains",value:trainName},{property:"Project.Children.Name",operator:"=",value:""},{property:"Project.Name",operator:"!contains",value:" ART"}],listeners:{load:{fn:function(store,records){console.log("releasesWithName loaded:",records),deferred.resolve(store)},single:!0}}}),deferred.promise},_getScopedRelease:function(releaseRecords,projectOID,appPrefs){var me=this,d=new Date,rs=releaseRecords,prefOID=appPrefs&&appPrefs.projs[projectOID]&&appPrefs.projs[projectOID].Release;return prefOID&&_.find(rs,function(r){return r.data.ObjectID==prefOID})||_.find(rs,function(r){return new Date(r.data.ReleaseDate)>=d&&d>=new Date(r.data.ReleaseStartDate)})||_.reduce(rs,function(best,r){if(null===best)return r;var d1=new Date(best.data.ReleaseStartDate),d2=new Date(r.data.ReleaseStartDate),now=new Date;return Math.abs(d1-now)<Math.abs(d2-now)?best:r},null)}});
                Ext.define("Intel.data.proxy.SessionStorage",{extend:"Ext.data.proxy.SessionStorage",alias:"proxy.fastsessionproxy",constructor:function(cfg){var me=this;me.callParent(arguments)},create:function(operation,callback,scope){var me=this,records=operation.records,length=records.length,ids=me.getIds(),id,record,i;for(operation.setStarted(),void 0===me.isHierarchical&&(me.isHierarchical=!!records[0].isNode,me.isHierarchical&&me.getStorageObject().setItem(me.getTreeKey(),!0)),i=0;length>i;i++)record=records[i],record.phantom?(record.phantom=!1,id=me.getNextId()):id=record.getId(),record.beginEdit(),me.setRecord(record,id),record.endEdit(!0),record.commit(!0),ids.push(id);me.setIds(ids),operation.setCompleted(),operation.setSuccessful(),"function"==typeof callback&&callback.call(scope||me,operation)},update:function(operation,callback,scope){var records=operation.records,length=records.length,ids=this.getIds(),record,id,i;for(operation.setStarted(),i=0;length>i;i++)record=records[i],this.setRecord(record),record.commit(!0),id=record.getId(),void 0!==id&&-1==Ext.Array.indexOf(ids,id)&&ids.push(id);this.setIds(ids),operation.setCompleted(),operation.setSuccessful(),"function"==typeof callback&&callback.call(scope||this,operation)}});
                Ext.define("Intel.data.FastStore",{extend:"Ext.data.Store",alias:"store.faststore",constructor:function(cfg){var me=this;me.callParent(arguments)},afterEdit:function(record,modifiedFieldNames){var me=this,i,shouldSync;if(me.autoSync&&!me.autoSyncSuspended)for(i=modifiedFieldNames.length;i--;)if(record.fields.get(modifiedFieldNames[i]).persist){me.sync();break}me.onUpdate(record,Ext.data.Model.EDIT,modifiedFieldNames)}});
                Ext.define("Intel.grid.plugin.CellEditing",{alias:"plugin.fastcellediting",extend:"Ext.grid.plugin.CellEditing",constructor:function(){this.callParent(arguments)},triggerEvent:"cellclick",onEditComplete:function(ed,value,startValue){var me=this,activeColumn=me.getActiveColumn(),context=me.context,record;if(activeColumn){if(record=context.record,me.setActiveEditor(null),me.setActiveColumn(null),me.setActiveRecord(null),context.value=value,!me.validateEdit())return me.editing=!1,void 0;record.beginEdit(),record.isEqual(value,startValue)||record.set(activeColumn.dataIndex,value),context.view.focusRow(context.rowIdx,100),me.fireEvent("edit",me,context),me.editing=!1,record.endEdit()}}});
                Ext.define("Intel.view.ScrollTable",{extend:"Ext.view.Table",alias:"widget.scrolltableview",constructor:function(cfg){var me=this;me.callParent(arguments)},refresh:function(){var me=this,targetEl,targetParent,oldDisplay,nextSibling,dom,records,el=me.getEl(),scroll=el&&el.getScrollTop();me.rendered&&!me.isDestroyed&&(me.hasListeners.beforerefresh&&me.fireEvent("beforerefresh",me)===!1||(targetEl=me.getTargetEl(),records=me.getViewRange(),dom=targetEl.dom,me.preserveScrollOnRefresh||(targetParent=dom.parentNode,oldDisplay=dom.style.display,dom.style.display="none",nextSibling=dom.nextSibling,targetParent.removeChild(dom)),me.refreshCounter?me.clearViewEl():(me.fixedNodes=targetEl.dom.childNodes.length,me.refreshCounter=1),me.tpl.append(targetEl,me.collectData(records,me.all.startIndex)),1>records.length?(this.store.loading||me.deferEmptyText&&!me.hasFirstRefresh||Ext.core.DomHelper.insertHtml("beforeEnd",targetEl.dom,me.emptyText),me.all.clear()):(me.collectNodes(targetEl.dom),me.updateIndexes(0)),me.hasFirstRefresh&&(me.refreshSelmodelOnRefresh!==!1?me.selModel.refresh():me.selModel.pruneIf()),me.hasFirstRefresh=!0,me.preserveScrollOnRefresh||(targetParent.insertBefore(dom,nextSibling),dom.style.display=oldDisplay),Ext.suspendLayouts(),this.refreshSize(),me.fireEvent("refresh",me),Ext.resumeLayouts(!0),me.viewReady||(me.viewReady=!0,me.fireEvent("viewready",me))),scroll&&me.preserveScrollOnRefresh&&el.setScrollTop(scroll))},onRemove:function(ds,records,indexes){var me=this,fireItemRemove=me.hasListeners.itemremove,i,record,index,el=me.getEl(),scroll=el&&el.getScrollTop();if(me.all.getCount()){if(0===me.dataSource.getCount()){if(fireItemRemove)for(i=indexes.length-1;i>=0;--i)me.fireEvent("itemremove",records[i],indexes[i])}else{for(i=indexes.length-1;i>=0;--i)record=records[i],index=indexes[i],me.doRemove(record,index),fireItemRemove&&me.fireEvent("itemremove",record,index);me.updateIndexes(indexes[0])}this.refreshSize(),scroll&&me.preserveScrollOnRefresh&&el.setScrollTop(scroll)}},onUpdate:function(ds,record){var me=this,index,node,el=me.getEl(),scroll=el&&el.getScrollTop();if(me.viewReady){if(index=me.dataSource.indexOf(record),index>-1&&(node=me.bufferRender([record],index)[0],me.getNode(record)))return me.all.replaceElement(index,node,!0),me.updateIndexes(index,index),me.selModel.onUpdate(record),me.hasListeners.itemupdate&&me.fireEvent("itemupdate",record,index,node),node;scroll&&me.preserveScrollOnRefresh&&el.setScrollTop(scroll)}},onAdd:function(store,records,index){var me=this,nodes,el=me.getEl(),scroll=el&&el.getScrollTop();me.rendered&&(0===me.all.getCount()?(me.refresh(),nodes=me.all.slice()):(nodes=me.doAdd(records,index),me.refreshSelmodelOnRefresh!==!1&&me.selModel.refresh(),me.updateIndexes(index)),me.hasListeners.itemadd&&me.fireEvent("itemadd",records,index,nodes),scroll&&me.preserveScrollOnRefresh&&el.setScrollTop(scroll))},scrollRowIntoView:function(row){return 0===row?(this.getEl().setScrollTop(0),void 0):(row=this.getNode(row,!0),row&&Ext.fly(row).scrollIntoView(this.el,!1),void 0)}});
                Ext.define("CommitMatrix",{extend:"Rally.app.App",mixins:["ReleaseQuery","IntelWorkweek"],layout:"absolute",autoScroll:!1,_showError:function(text){this.errMessage&&this.remove(this.errMessage),this.errMessage=this.add({xtype:"text",text:text})},_loadModels:function(cb){var me=this;Rally.data.ModelFactory.getModel({type:"Project",success:function(model){me.Project=model,Rally.data.ModelFactory.getModel({type:"PortfolioItem/Milestone",success:function(model){me.Milestone=model,cb()}})}})},_loadProject:function(project,cb){var me=this;me.Project.load(project.ObjectID,{fetch:["ObjectID","Children","Parent","Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:function(record,operation){operation.wasSuccessful()?cb(record):me._showError("failed to retreive project: "+project.ObjectID)}})},_loadMilestone:function(milestone,cb){var me=this;me.Milestone.load(milestone.ObjectID,{fetch:["ObjectID","Parent","Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:function(record,operation){operation.wasSuccessful()?cb(record):me._showError("failed to retreive milestone: "+milestone.ObjectID)}})},_loadMatrixFeatures:function(cb){var me=this;me.MatrixProductHash={},Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,limit:1/0,fetch:["Name","ObjectID","Project","Parent","FormattedID","UserStories","c_TeamCommits","DragAndDropRank","PlannedEndDate"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:me.ReleaseRecord.data.Name}],listeners:{load:{fn:function(featureStore,featureRecords){console.log("features loaded:",featureRecords),me.MatrixFeatureStore=featureStore;var finished=-1,done=function(){++finished==featureRecords.length&&cb()};done(),featureRecords.forEach(function(fr){var frData=fr.data;frData.Parent?me._loadMilestone(frData.Parent,function(milestoneRecord){var p=milestoneRecord.data.Parent;me.MatrixProductHash[frData.ObjectID]=p&&p.Name?p.Name:"",done()}):(me.MatrixProductHash[frData.ObjectID]="",done())})},single:!0}}})},_loadMatrixUserStoryBreakdown:function(cb){var me=this;me.MatrixUserStoryBreakdown={},me.MatrixProjectMap={};var fRecords=me.MatrixFeatureStore.getRecords(),finished=-1,done=function(){++finished==fRecords.length&&(console.log("Stories loaded:",me.MatrixUserStoryBreakdown),cb())};done(),fRecords.forEach(function(fRecord){Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",fetch:["ObjectID","Project","Name","Feature","FormattedID","PlanEstimate"],limit:1/0,autoLoad:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:me.ReleaseRecord.data.Name},{property:"Feature.ObjectID",value:fRecord.data.ObjectID}],listeners:{load:{fn:function(storyStore,storyRecords){storyRecords.forEach(function(sr){var PName=sr.data.Project.Name,FName=fRecord.data.Name;me.MatrixUserStoryBreakdown[PName]||(me.MatrixUserStoryBreakdown[PName]={}),me.MatrixUserStoryBreakdown[PName][FName]||(me.MatrixUserStoryBreakdown[PName][FName]=[]),me.MatrixUserStoryBreakdown[PName][FName].push(sr),me.MatrixProjectMap[PName]=sr.data.Project.ObjectID}),done()},single:!0}}})})},_getProjectsInScope:function(){var projects="__PROJECT_OIDS_IN_SCOPE__";return projects=projects.match(/^\d+/)?projects.split(","):[this.context.getProject().ObjectID],projectsInScope={},_.each(projects,function(projectID){projectsInScope[projectID]=!0}),projectsInScope},_addDefaultProjects:function(cb){function addDefaults(projects){_.each(projects,function(p){msub[p.data.Name]||(msub[p.data.Name]={},_.each(feats,function(f){msub[p.data.Name][f.data.Name]=[],mpm[p.data.Name]=p.data.ObjectID}))})}var processedProjects={},me=this,cached=me._cachedDefaults,inScope=me._getProjectsInScope(),msub=me.MatrixUserStoryBreakdown,feats=me.MatrixFeatureStore.getRange(),mpm=me.MatrixProjectMap,curProjRef="/project/"+me.getContext().getProject().ObjectID;cached&&(addDefaults(cached),cb&&cb()),Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","Parent","ObjectID","TeamMembers"],limit:1/0,context:{workspace:"/workspace/"+this.getContext().getWorkspace().ObjectID,project:null}}).load({callback:function(projects){projects=_.filter(projects,function(project){return inScope[project.data.ObjectID]&&project.data.TeamMembers.Count>0}),addDefaults(projects),me._cachedDefaults=projects,console.log("default projects",projects),cb&&cb()}})},_defineModels:function(){Ext.define("IntelFeature",{extend:"Ext.data.Model",fields:[{name:"Rank",type:"string"},{name:"FormattedID",type:"string"},{name:"ObjectID",type:"string"},{name:"FeatureName",type:"string"},{name:"ProductName",type:"string"},{name:"PlannedEndDate",type:"string"}]})},_isReloadRefresh:!1,_reloadMatrixStores:function(){var me=this;me._loadMatrixFeatures(function(){if(me.featureTCAECache={},me.CustomMatrixStore){var scroll=me.MatrixGrid.view.getEl().getScrollTop();me._isReloadRefresh=!0,me.CustomMatrixStore.load({callback:function(){me.MatrixGrid.view.getEl().setScrollTop(scroll),setTimeout(function(){me._isReloadRefresh=!1},10)}})}})},_projectInWhichTrain:function(projectRecord,cb){var me=this;projectRecord||cb();var split=projectRecord.data.Name.split(" ART");if(split.length>1)cb(projectRecord);else{var parent=projectRecord.data.Parent;parent?me._loadProject(parent,function(parentRecord){me._projectInWhichTrain(parentRecord,cb)}):cb()}},_alert:function(title,str){var me=this;Ext.MessageBox.alert(title,str).setY(me._msgBoxY),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},10)},_getIframe:function(){var w=window,p=w.parent,pd=w.parent.document,l=w.location;return pd.querySelector('iframe[src="'+l.pathname+l.search+'"]')},_applyMessageBoxConfig:function(){var me=this,w=window,p=w.parent,iframe=me._getIframe(),ph=p.getWindowHeight(),ps=p.getScrollY(),ofy=ps+iframe.getBoundingClientRect().top,iyOffset=Math.floor(ph/2-ofy+ps-50);me._msgBoxY=0>iyOffset?0:iyOffset},_changeGridHeight:function(){var me=this,w=window,p=w.parent,iframe=me._getIframe(),ph=p.getWindowHeight(),ps=p.getScrollY(),ofy=ps+iframe.getBoundingClientRect().top,height=Math.max(ph-ofy-150,200);me._gridHeight=height,me.MatrixGrid&&me.MatrixGrid.setHeight(height)},_getDistanceFromBottomOfScreen:function(innerY){var me=this,w=window,p=w.parent,iframe=me._getIframe(),ph=p.getWindowHeight(),ps=p.getScrollY(),ofy=ps+iframe.getBoundingClientRect().top,actualY=ofy+innerY;return ph-actualY},_changeGridWidth:function(){var me=this,mg=me.MatrixGrid;mg&&mg.setWidth(Math.min(_.reduce(mg.config.columnCfgs,function(item,sum){return sum+item.width},20),me.getWidth()-40))},_applyEventListeners:function(){function screenChanged(){me._applyMessageBoxConfig(),me._changeGridHeight(),me._changeGridWidth()}var me=this,p=window.parent;screenChanged(),p.onresize=screenChanged,p.onscroll=screenChanged},_loadAllData:function(cb){var me=this;me._loadMatrixFeatures(function(){me._loadMatrixUserStoryBreakdown(function(){me._addDefaultProjects(function(){cb&&cb()})})})},launch:function(){var me=this;return me._showError("Loading Data..."),me.getContext().getPermissions().isProjectEditor(me.getContext().getProject())?(Ext.tip.QuickTipManager.init(),Ext.apply(Ext.tip.QuickTipManager.getQuickTip(),{showDelay:1e3}),me._defineModels(),me._applyEventListeners(),setInterval(function(){me._reloadMatrixStores()},1e4),me._loadModels(function(){var scopeProject=me.getContext().getProject();me._loadProject(scopeProject,function(scopeProjectRecord){me._projectInWhichTrain(scopeProjectRecord,function(trainRecord){trainRecord?(me.TrainRecord=trainRecord,console.log("train loaded:",trainRecord),me._loadReleasesInTheFuture(me.TrainRecord).then(function(releaseStore){me.ReleaseStore=releaseStore;var currentRelease=me._getScopedRelease(me.ReleaseStore.getRange(),me.TrainRecord.data.ObjectID,me.AppPrefs);currentRelease?(me.ReleaseRecord=currentRelease,console.log("release loaded",currentRelease),me._loadAllData(function(){me.removeAll(),me._loadMatrixGrid()})):(me.removeAll(),me._showError("This ART has no releases"))})):(me.removeAll(),me._showError("Please scope to an ART"))})})}),void 0):(me.removeAll(),me._showError("You do not have permissions to edit this project"),void 0)},_clearToolTip:function(){var me=this;me.tooltip&&(me.tooltip.panel.hide(),me.tooltip.triangle.hide(),me.tooltip.panel.destroy(),me.tooltip.triangle.destroy(),delete me.tooltip)},_loadMatrixGrid:function(){function getTeamCommit(featureRecord,ProjectName){var tcs=featureRecord.data.c_TeamCommits,featureID=featureRecord.data.ObjectID,projectID=me.MatrixProjectMap[ProjectName],this_tc;try{var parsed_tcs;me.featureTCAECache[featureID]?parsed_tcs=me.featureTCAECache[featureID]:(parsed_tcs=JSON.parse(atob(tcs))||{},me.featureTCAECache[featureID]=parsed_tcs),this_tc=parsed_tcs[projectID]||{}}catch(e){me.featureTCAECache[featureID]=this_tc={}}return this_tc}function setExpected(featureRecord,ProjectName,value){var tcs=featureRecord.get("c_TeamCommits"),featureID=featureRecord.data.ObjectID,projectID=me.MatrixProjectMap[ProjectName];try{me.featureTCAECache[featureID]?tcs=me.featureTCAECache[featureID]:(tcs=JSON.parse(atob(tcs))||{},me.featureTCAECache[featureID]=tcs)}catch(e){me.featureTCAECache[featureID]=tcs={}}tcs[projectID]||(tcs[projectID]={}),tcs[projectID].Expected=value;var str=btoa(JSON.stringify(tcs,null,"	"));str.length>=32768&&(me._alert("ERROR","TeamCommits field for "+featureRecord.get("FormattedID")+" ran out of space! Cannot save"),cb&&cb()),featureRecord.set("c_TeamCommits",str),featureRecord.save()}var me=this,mode="Details";me.featureTCAECache={};var customMatrixRecords=_.map(me.MatrixFeatureStore.getRecords(),function(featureRecord){var ed=featureRecord.get("PlannedEndDate");return{Rank:featureRecord.get("DragAndDropRank"),FormattedID:featureRecord.get("FormattedID"),ObjectID:featureRecord.get("ObjectID"),FeatureName:featureRecord.get("Name"),ProductName:me.MatrixProductHash[featureRecord.get("ObjectID")],PlannedEndDate:ed?"WW"+me._getWorkweek(new Date(ed)):"-"}});me.CustomMatrixStore=Ext.create("Ext.data.Store",{data:customMatrixRecords,model:"IntelFeature",autoSync:!0,limit:1/0,proxy:{type:"sessionstorage",id:"Session-proxy-"+Math.random()}});var defColumnCfgs=[{text:"Rank",dataIndex:"Rank",width:50,editor:!1,sortable:!0,resizable:!1,draggable:!1,menuDisabled:!0,locked:!0,renderer:function(oid,meta,f1){var rank=1,f1OID=f1.data.ObjectID;f1=me.MatrixFeatureStore.findRecord("ObjectID",f1OID);var f1DADR=f1.data.DragAndDropRank;return me.MatrixFeatureStore.getRecords().forEach(function(f2){f2.get("ObjectID")!=f1OID&&f1DADR>f2.get("DragAndDropRank")&&++rank}),rank}},{text:"F#",dataIndex:"FormattedID",width:50,editor:!1,resizable:!1,draggable:!1,menuDisabled:!0,sortable:!0,locked:!0,renderer:function(FID){var feature=me.MatrixFeatureStore.findRecord("FormattedID",FID);if(feature.get("Project")){var pid=feature.get("Project")._ref.split("/project/")[1];return'<a href="https://rally1.rallydev.com/#/'+pid+"d/detail/portfolioitem/feature/"+feature.get("ObjectID")+'" target="_blank">'+FID+"</a>"}return name}},{text:"Feature",dataIndex:"FeatureName",width:250,editor:!1,resizable:!1,draggable:!1,menuDisabled:!0,locked:!0,sortable:!0,renderer:function(value,metaData){return metaData.tdAttr='data-qtip="'+value+'"',value}},{text:"Product",dataIndex:"ProductName",width:60,editor:!1,resizable:!1,draggable:!1,menuDisabled:!0,locked:!0,sortable:!0},{text:"Planned End",dataIndex:"PlannedEndDate",width:60,editor:!1,resizable:!1,draggable:!1,menuDisabled:!0,locked:!0,sortable:!0}],columnCfgs=[].concat(defColumnCfgs);Object.keys(me.MatrixUserStoryBreakdown).sort().forEach(function(ProjectName){columnCfgs.push({text:ProjectName,dataIndex:"ObjectID",width:50,editor:"textfield",draggable:!1,menuDisabled:!0,align:"center",tdCls:"intel-editor-cell",sortable:!1,resizable:!1,tooltip:ProjectName,tooltipType:"title",renderer:function(oid,metaData,matrixRecord,row,col){var featureRecord=me.MatrixFeatureStore.findRecord("ObjectID",matrixRecord.get("ObjectID")),array=me.MatrixUserStoryBreakdown[ProjectName][featureRecord.data.Name]||[],count=array.length,tcae=getTeamCommit(featureRecord,ProjectName),Expected=tcae.Expected||!1,Commitment=tcae.Commitment||"Undecided";return"Undecided"===Commitment&&(metaData.tdCls+=" intel-team-commits-WHITE"),"N/A"===Commitment&&(metaData.tdCls+=" intel-team-commits-GREY"),"Committed"===Commitment&&(metaData.tdCls+=" intel-team-commits-GREEN"),"Not Committed"===Commitment&&(metaData.tdCls+=" intel-team-commits-RED"),Expected&&(metaData.tdCls+="-YELLOW"),count}})}),me.MatrixReleasePicker=me.add({xtype:"combobox",x:0,y:0,store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.ReleaseStore.getRecords(),function(r){return{Name:r.get("Name")}})}),displayField:"Name",fieldLabel:"Release:",editable:!1,value:me.ReleaseRecord.get("Name"),listeners:{select:function(combo,records){me.ReleaseRecord.get("Name")!==records[0].get("Name")&&(me.ReleaseRecord=me.ReleaseStore.findRecord("Name",records[0].get("Name")),me._clearToolTip(),me.setLoading(!0),setTimeout(function(){me._loadAllData(function(){me.removeAll(),me._loadMatrixGrid(),me.setLoading(!1)})},0))}}}),me.MatrixProductPicker=me.add({xtype:"combobox",x:0,y:30,fieldLabel:"Product Filter",store:Ext.create("Ext.data.Store",{fields:["ProductName"],data:_.map(_.reduce(Object.keys(me.MatrixProductHash),function(items,ObjectID){var projectName=me.MatrixProductHash[ObjectID];return-1==items.indexOf(projectName)&&items.push(projectName),items},["All Products"]),function(name){return{ProductName:name}})}),displayField:"ProductName",editable:!1,value:"All Products",listeners:{select:function(combo,records){var value=records[0].get("ProductName");me.CustomMatrixStore.filters.getRange().forEach(function(filter){me.CustomMatrixStore.removeFilter(filter)}),"All Products"!==value&&me.CustomMatrixStore.addFilter(new Ext.util.Filter({filterFn:function(matrixRecord){return matrixRecord.get("ProductName")===value}})),me._clearToolTip()}}}),me.ModePicker=me.add({xtype:"combobox",x:0,y:60,fieldLabel:"Click Mode",store:Ext.create("Ext.data.Store",{fields:["Mode"],data:[{Mode:"Flag"},{Mode:"Details"}]}),displayField:"Mode",editable:!1,value:mode,listeners:{select:function(combo,records){var value=records[0].get("Mode");value!==mode&&(mode=value,me._clearToolTip())}}}),me.MatrixLegend=me.add({xtype:"container",layout:"table",columns:5,width:600,x:300,y:0,border:!0,frame:!1,items:_.map(["Committed","Not Committed","N/A","Undefined","Expected"],function(name){var color;return"Undecided"===name&&(color="white"),"N/A"===name&&(color="rgba(224, 224, 224, 0.50)"),"Committed"===name&&(color="rgba(0, 255, 0, 0.50)"),"Not Committed"===name&&(color="rgba(255, 0, 0, 0.50)"),"Expected"===name&&(color="rgba(251, 255, 0, 0.50)"),{xtype:"container",width:120,border:!1,frame:!1,html:'<div class="intel-legend-item">'+name+': <div style="background-color:'+color+'" class="intel-legend-dot"></div></div>'}})}),me.MatrixGrid=me.add({xtype:"grid",x:0,y:100,width:Math.min(_.reduce(columnCfgs,function(item,sum){return sum+item.width},20),me.getWidth()-40),height:me._gridHeight,scroll:"both",resizable:!1,columns:columnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{preserveScrollOnRefresh:!0},listeners:{sortchange:function(){me._clearToolTip()},beforeedit:function(editor,e){var ProjectName=e.column.text,matrixRecord=e.record;if("Flag"===mode){var featureRecord=me.MatrixFeatureStore.findRecord("ObjectID",matrixRecord.get("ObjectID")),tcae=getTeamCommit(featureRecord,ProjectName);setExpected(featureRecord,ProjectName,!tcae.Expected),matrixRecord.commit()}return!1},afterrender:function(grid){var view=grid.view.normalView;view.getEl().on("scroll",function(){me._isReloadRefresh||me._clearToolTip()}),grid.mon(view,{uievent:function(type,view,cell,row,col,e){if("Details"===mode&&"mousedown"===type){var matrixRecord=me.CustomMatrixStore.getAt(row),ProjectName=view.getGridColumns()[col].text,featureRecord=me.MatrixFeatureStore.findRecord("ObjectID",matrixRecord.get("ObjectID")),tcae=getTeamCommit(featureRecord,ProjectName),pos=cell.getBoundingClientRect();if(me.tooltip&&(me.tooltip.panel.hide(),me.tooltip.triangle.hide(),me.tooltip.panel.destroy(),me.tooltip.triangle.destroy(),me.tooltip.row==row&&me.tooltip.col==col))return delete me.tooltip,void 0;var panelWidth=400,theHTML="<p><b>"+("Committed"==tcae.Commitment?"Objective: ":"Comment: ")+"</b>"+(tcae.Objective||"")+"<p><b>PlanEstimate: </b>"+_.reduce(me.MatrixUserStoryBreakdown[ProjectName][featureRecord.data.Name]||[],function(sum,sr){return sum+(sr.get("PlanEstimate")||0)},0)+'<p><b>UserStories: </b><div style="max-height:200px;overflow-y:auto;"><ol>';(me.MatrixUserStoryBreakdown[ProjectName][featureRecord.data.Name]||[]).forEach(function(sr){theHTML+='<li><a href="https://rally1.rallydev.com/#/'+sr.data.Project.ObjectID+"d/detail/userstory/"+sr.get("ObjectID")+'" target="_blank">'+sr.get("FormattedID")+"</a>: "+sr.get("Name").substring(0,40)+(sr.get("Name").length>40?"...":"")+"</li>"}),theHTML+="</ol></div>";var dbs=me._getDistanceFromBottomOfScreen(pos.top);me.tooltip={row:row,col:col,panel:Ext.widget("container",{floating:!0,width:panelWidth,autoScroll:!1,id:"MatrixTooltipPanel",cls:"intel-tooltip",focusOnToFront:!1,shadow:!1,renderTo:Ext.getBody(),html:theHTML,listeners:{afterrender:function(panel){var upsideDown=panel.getHeight()+40>dbs;panel.setPosition(pos.left-panelWidth,upsideDown?pos.bottom-panel.getHeight():pos.top)}}}),triangle:Ext.widget("container",{floating:!0,width:0,height:0,focusOnToFront:!1,shadow:!1,renderTo:Ext.getBody(),listeners:{afterrender:function(panel){setTimeout(function(){var upsideDown=Ext.get("MatrixTooltipPanel").getHeight()+40>dbs;upsideDown?(panel.removeCls("intel-tooltip-triangle"),panel.addCls("intel-tooltip-triangle-up"),panel.setPosition(pos.left-10,pos.bottom-10)):(panel.removeCls("intel-tooltip-triangle-up"),panel.addCls("intel-tooltip-triangle"),panel.setPosition(pos.left-10,pos.top))},10)}}})}}}})}},enableEditing:!1,store:me.CustomMatrixStore})}});

            Rally.launchApp('CommitMatrix', {
                name:"ART Commit Matrix",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .x-grid-row .intel-editor-cell{cursor:pointer !important}.x-grid-row .intel-editor-cell *{cursor:pointer !important}.x-grid-cell.intel-team-commits-RED{background-color:rgba(255,0,0,0.5) !important}.x-grid-row-selected .x-grid-cell.intel-team-commits-RED,.x-grid-row-over .x-grid-cell.intel-team-commits-RED{background-color:rgba(255,0,0,0.7) !important}.x-grid-cell.intel-team-commits-GREEN{background-color:rgba(0,255,0,0.5) !important}.x-grid-row-selected .x-grid-cell.intel-team-commits-GREEN,.x-grid-row-over .x-grid-cell.intel-team-commits-GREEN{background-color:rgba(0,255,0,0.7) !important}.x-grid-cell.intel-team-commits-GREY{background-color:rgba(224,224,224,0.5) !important}.x-grid-row-selected .x-grid-cell.intel-team-commits-GREY,.x-grid-row-over .x-grid-cell.intel-team-commits-GREY{background-color:rgba(224,224,224,0.7) !important}.x-grid-cell.intel-team-commits-WHITE-YELLOW{background-image:-webkit-gradient(linear, right top, left bottom, color-stop(.5, rgba(251,255,0,0.5)), color-stop(.5, rgba(0,0,0,0))) !important;background-image:-o-linear-gradient(right top, rgba(0,0,0,0) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-moz-linear-gradient(right top, rgba(0,0,0,0) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-webkit-linear-gradient(right top, rgba(0,0,0,0) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-ms-linear-gradient(right top, rgba(0,0,0,0) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:linear-gradient(to right top, rgba(0,0,0,0) 75%, rgba(251,255,0,0.5) 75%) !important}.x-grid-cell.intel-team-commits-RED-YELLOW{background-image:-webkit-gradient(linear, right top, left bottom, color-stop(.5, rgba(251,255,0,0.5)), color-stop(.5, rgba(255,0,0,0.5))) !important;background-image:-o-linear-gradient(right top, rgba(255,0,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-moz-linear-gradient(right top, rgba(255,0,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-webkit-linear-gradient(right top, rgba(255,0,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-ms-linear-gradient(right top, rgba(255,0,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:linear-gradient(to right top, rgba(255,0,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important}.x-grid-cell.intel-team-commits-GREEN-YELLOW{background-image:-webkit-gradient(linear, right top, left bottom, color-stop(.5, rgba(251,255,0,0.5)), color-stop(.5, rgba(0,255,0,0.5))) !important;background-image:-o-linear-gradient(right top, rgba(0,255,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-moz-linear-gradient(right top, rgba(0,255,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-webkit-linear-gradient(right top, rgba(0,255,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-ms-linear-gradient(right top, rgba(0,255,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:linear-gradient(to right top, rgba(0,255,0,0.5) 75%, rgba(251,255,0,0.5) 75%) !important}.x-grid-cell.intel-team-commits-GREY-YELLOW{background-image:-webkit-gradient(linear, right top, left bottom, color-stop(.5, rgba(251,255,0,0.5)), color-stop(.5, rgba(224,224,224,0.5))) !important;background-image:-o-linear-gradient(right top, rgba(224,224,224,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-moz-linear-gradient(right top, rgba(224,224,224,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-webkit-linear-gradient(right top, rgba(224,224,224,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:-ms-linear-gradient(right top, rgba(224,224,224,0.5) 75%, rgba(251,255,0,0.5) 75%) !important;background-image:linear-gradient(to right top, rgba(224,224,224,0.5) 75%, rgba(251,255,0,0.5) 75%) !important}.intel-legend-dot{width:12px;height:12px;border-radius:6px;border:1px solid black;display:inline-block;vertical-align:middle}.intel-legend-item{font-size:1em;text-align:center}.intel-tooltip{padding:10px;background-color:#C0D9FA;border-radius:8px;z-index:500}.intel-tooltip-triangle{border-left:10px solid transparent;border-right:10px solid transparent;border-top:10px solid #C0D9FA;height:0px;width:0px;z-index:500}.intel-tooltip-triangle-up{border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:10px solid #C0D9FA;height:0px;width:0px;z-index:500}.x-column-header-inner .x-column-header-text{white-space:normal !important;line-height:15px}.x-column-header-inner{text-align:center;height:100 !important}
    </style>
</head>
<body>
</body>
</html>
