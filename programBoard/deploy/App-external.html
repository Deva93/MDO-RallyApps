<!DOCTYPE html>
<html>
<head>
    <title>Random App Name70221</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:"absolute",height:2100,width:1600,_showError:function(text){this.errMessage&&this.remove(this.errMessage),this.errMessage=this.add({xtype:"text",text:text})},_loadModels:function(cb){var me=this;Rally.data.ModelFactory.getModel({type:"Project",scope:me,success:function(model){me.Project=model,Rally.data.ModelFactory.getModel({type:"HierarchicalRequirement",scope:me,success:function(model){me.UserStory=model,cb()}})}})},_loadProject:function(project,cb){var me=this;me.Project.load(project.ObjectID,{fetch:["ObjectID","Releases","Children","Parent","Name","_ref"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:function(record,operation){operation.wasSuccessful()?cb(record):me._showError("failed to retreive project: "+project.ObjectID)}})},_loadReleases:function(cb){var me=this,filterString=Ext.create("Rally.data.wsapi.Filter",{property:"Project.ObjectID",value:me.ProjectRecord.data.ObjectID}),filterString2,f2;if(me.TrainRecord){var teamName=me.ProjectRecord.data.Name,trainName=me.TrainRecord.data.Name.split(" ART ")[0],trainNames=teamName.split(trainName)[1].split("-");trainNames[0]?trainNames.push(trainName):trainNames[0]=trainName,trainNames.forEach(function(trainName){f2=Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"contains",value:trainName}),filterString2=filterString2?filterString2.or(f2):f2}),filterString=filterString.and(filterString2)}else filterString2=Ext.create("Rally.data.wsapi.Filter",{property:"ReleaseDate",operator:">=",value:(new Date).toISOString()}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Name",operator:"!contains",value:" "})),filterString=filterString.and(filterString2);filterString=""+filterString;var store=Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Dummy",value:"value"}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),me.ReleaseStore=releaseStore,cb()},single:!0}}});store._hydrateModelAndLoad=function(options){var deferred=new Deft.Deferred;this.hydrateModel().then({success:function(model){this.proxy.encodeFilters=function(){return filterString},this.load(options).then({success:Ext.bind(deferred.resolve,deferred),failure:Ext.bind(deferred.reject,deferred)})},scope:this})},store.load()},_projectInWhichTrain:function(projectRecord,cb){var me=this;projectRecord||cb();var split=projectRecord.data.Name.split(" ART ");if(split.length>1)cb(projectRecord);else{var parent=projectRecord.data.Parent;parent?me._loadProject(parent,function(parentRecord){me._projectInWhichTrain(parentRecord,cb)}):cb()}},_getCurrentOrFirstRelease:function(){var me=this,d=new Date,rs=me.ReleaseStore.getRecords();if(rs.length){for(var i=0;rs.length>i;++i)if(new Date(rs[i].data.ReleaseDate)>=d&&d>=new Date(rs[i].data.ReleaseStartDate))return rs[i];return rs[0]}},_loadValidProjects:function(cb){function loadChildren(project,_cb){Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,remoteSort:!1,limit:1/0,fetch:["Name","ObjectID","Parent"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Parent.ObjectID",value:project.get("ObjectID")}],listeners:{load:{fn:function(projectStore,projectRecords){if(0===projectRecords.length)scrums.push(project),_cb();else{var finished=0,done=function(){++finished===projectRecords.length&&_cb()};projectRecords.forEach(function(c){loadChildren(c,function(){done()})})}},single:!0}}})}var me=this,scrums=[];Ext.create("Rally.data.wsapi.Store",{model:"Project",autoLoad:!0,remoteSort:!1,pageSize:1,limit:1,fetch:["Name","ObjectID"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:"All Scrums"}],listeners:{load:{fn:function(ps,recs){loadChildren(recs[0],function(){me.ValidProjects=scrums,me.ProjectNames=_.map(scrums,function(s){return{Name:s.get("Name")}}),console.log("valid scrums loaded:",scrums),cb()})},single:!0}}})},_loadTeamCommitsUserStories:function(cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",fetch:["ObjectID","Feature","Name","_ref"],limit:1/0,autoLoad:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:me.ReleaseRecord.get("Name")},{property:"Feature",operator:"!=",value:null},{property:"Project.Name",value:me.ProjectRecord.get("Name")}],listeners:{load:{fn:function(storyStore,storyRecords){console.log("Stories loaded:",storyRecords),me.TeamCommitsStoryStore=storyStore,cb()},single:!0}}})},_loadTeamCommitsFeatures:function(cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,limit:1/0,remoteSort:!1,fetch:["Name","ObjectID","FormattedID","c_TeamCommits"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:me.ReleaseRecord.get("Name")}],listeners:{load:{fn:function(featureStore,featureRecords){console.log("features loaded:",featureRecords),me.TeamCommitsFeatureStore=featureStore,cb()},single:!0}}})},_loadVelocityIterations:function(cb){var me=this,startDate=Rally.util.DateTime.toIsoString(me.ReleaseRecord.get("ReleaseStartDate")),endDate=Rally.util.DateTime.toIsoString(me.ReleaseRecord.get("ReleaseDate"));Ext.create("Rally.data.WsapiDataStore",{model:"Iteration",autoLoad:!0,limit:1/0,fetch:["Name","EndDate","StartDate","PlannedVelocity"],context:{workspace:me.getContext().getWorkspace()._ref,project:me.getContext().getProject()._ref},filters:[{property:"EndDate",operator:">=",value:startDate},{property:"StartDate",operator:"<=",value:endDate},{}],remoteSort:!1,listeners:{load:function(store){console.log("VelocityIterations loaded:",store.getRecords()),me.VelocityIterationStore=store,cb()},single:!0}})},_loadVelocityUserStories:function(cb){var me=this,startDate=Rally.util.DateTime.toIsoString(me.ReleaseRecord.get("ReleaseStartDate")),endDate=Rally.util.DateTime.toIsoString(me.ReleaseRecord.get("ReleaseDate"));Ext.create("Rally.data.WsapiDataStore",{model:"HierarchicalRequirement",autoLoad:!0,limit:1/0,fetch:["Name","Iteration","PlanEstimate"],context:{workspace:me.getContext().getWorkspace()._ref,project:me.getContext().getProject()._ref},filters:[{property:"Iteration.EndDate",operator:">=",value:startDate},{property:"Iteration.StartDate",operator:"<=",value:endDate},{property:"PlanEstimate",operator:"!=",value:null}],remoteSort:!1,listeners:{load:function(store){console.log("VelocityUserStoryStore loaded:",store.getRecords()),me.VelocityUserStoryStore=store,cb()},single:!0}})},_loadRisksFeatures:function(cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,limit:1/0,remoteSort:!1,fetch:["Name","ObjectID","FormattedID","c_Risks"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Release.Name",value:me.ReleaseRecord.get("Name")}],listeners:{load:{fn:function(featureStore,featureRecords){console.log("risks features loaded:",featureRecords),me.RisksFeatureStore=featureStore,me._parseRisksData(),cb()},single:!0}}})},_parseRisksData:function(){function getRisks(featureRecord){var risks,riskString=featureRecord.get("c_Risks");if(""===riskString)risks={};else try{risks=JSON.parse(riskString)}catch(e){risks={}}return risks}var me=this,projectID=me.ProjectRecord.get("ObjectID"),array=[];_.each(me.RisksFeatureStore.getRecords(),function(featureRecord){var risks=getRisks(featureRecord);if(risks[projectID])for(var riskID in risks[projectID]){var risk=risks[projectID][riskID];array.push({RiskID:riskID,FormattedID:featureRecord.get("FormattedID"),FeatureName:featureRecord.get("Name"),Description:risk.Desc,Impact:risk.Imp,Status:risk.Sta,Contact:risk.Cont,Checkpoint:risk.CP,Edited:!1})}}),me.RisksParsedData=array},_loadRandomUserStory:function(ProjectRef,cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",autoLoad:!0,limit:1,pageSize:1,fetch:["Name","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:ProjectRef},listeners:{load:{fn:function(userStoryStore,userStoryRecords){cb(userStoryRecords.pop())},single:!0}}})},_loadUserStoryByFID:function(FormattedID,ProjectRef,cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",autoLoad:!0,limit:1,pageSize:1,fetch:["Name","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:ProjectRef},filters:[{property:"FormattedID",value:FormattedID}],listeners:{load:{fn:function(userStoryStore,userStoryRecords){cb(userStoryRecords.pop())},single:!0}}})},_loadDependenciesUserStories:function(cb){var me=this,f1=Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:me.ProjectRecord.get("Name")}).and(Ext.create("Rally.data.wsapi.Filter",{property:"c_Dependencies",operator:"!=",value:""})),f2=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:me.ReleaseRecord.get("Name")}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:me.ProjectRecord.get("Name")})),filterString=""+f1.or(f2),store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1/0,remoteSort:!1,fetch:["Name","ObjectID","Release","Project","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Dummy",value:"value"}],listeners:{load:{fn:function(userStoryStore,userStoryRecords){console.log("dependencies release user stories loaded:",userStoryRecords),me.DependenciesUserStoryStore=userStoryStore,me._buildDependenciesData(),cb()},single:!0}}});store._hydrateModelAndLoad=function(options){var deferred=new Deft.Deferred;this.hydrateModel().then({success:function(model){this.proxy.encodeFilters=function(){return filterString},this.load(options).then({success:Ext.bind(deferred.resolve,deferred),failure:Ext.bind(deferred.reject,deferred)})},scope:this})},store.load()},_getDependencies:function(userStoryRecord){var me=this,dependencies,dependencyString=userStoryRecord.get("c_Dependencies");if(""===dependencyString)dependencies={Preds:{},Succs:[]};else try{dependencies=JSON.parse(dependencyString)}catch(e){dependencies={Preds:{},Succs:[]}}return dependencies},_buildDependenciesData:function(){var me=this;me.DependenciesReleaseUserStories=_.filter(me.DependenciesUserStoryStore.getRecords(),function(usr){return usr.get("Release")&&usr.get("Release").Name===me.ReleaseRecord.get("Name")});var predDepsList=[],succDepsList=[];_.each(me.DependenciesUserStoryStore.getRecords(),function(userStoryRecord){var deps=me._getDependencies(userStoryRecord),preds=deps.Preds,succs=deps.Succs;for(var predDepID in preds){var predDep=preds[predDepID];predDepsList.push({DependencyID:predDepID,FormattedID:userStoryRecord.get("FormattedID"),UserStoryName:userStoryRecord.get("Name"),Description:predDep.Desc,Checkpoint:predDep.CP,Status:predDep.Sta,Predecessors:predDep.Preds,Edited:!1})}for(var i=0;succs.length>i;++i){var succDep=succs[i],FormattedID,UserStoryName;succDep.A?(FormattedID=userStoryRecord.get("FormattedID"),UserStoryName=userStoryRecord.get("Name")):FormattedID=UserStoryName="",succDepsList.push({DependencyID:succDep.ID,PredUserStoryName:succDep.PUSName,PredFormattedID:succDep.PUSID,PredProjectName:succDep.PPID,Description:succDep.Desc,Checkpoint:succDep.CP,Supported:succDep.Sup,Assigned:succDep.A,FormattedID:FormattedID,UserStoryName:UserStoryName,_realFormattedID:userStoryRecord.get("FormattedID"),_realUserStoryName:userStoryRecord.get("Name"),Edited:!1})}}),me.DependenciesParsedData={Predecessors:predDepsList,Successors:succDepsList}},_defineModels:function(){Ext.define("IntelRisk",{extend:"Ext.data.Model",fields:[{name:"RiskID",type:"string"},{name:"FormattedID",type:"string"},{name:"FeatureName",type:"string"},{name:"Description",type:"string"},{name:"Impact",type:"string"},{name:"Status",type:"string"},{name:"Contact",type:"string"},{name:"Checkpoint",type:"string"},{name:"Edited",type:"boolean"}]}),Ext.define("IntelPredDep",{extend:"Ext.data.Model",fields:[{name:"DependencyID",type:"string"},{name:"FormattedID",type:"string"},{name:"UserStoryName",type:"string"},{name:"Description",type:"string"},{name:"Checkpoint",type:"string"},{name:"Status",type:"string"},{name:"Predecessors",type:"string"},{name:"Edited",type:"boolean"}]}),Ext.define("IntelDepTeam",{extend:"Ext.data.Model",fields:[{name:"TID",type:"string"},{name:"PID",type:"string"},{name:"Sup",type:"string"},{name:"USID",type:"string"},{name:"USName",type:"string"},{name:"A",type:"boolean"}]}),Ext.define("IntelSuccDep",{extend:"Ext.data.Model",fields:[{name:"DependencyID",type:"string"},{name:"PredUserStoryName",type:"string"},{name:"PredFormattedID",type:"string"},{name:"PredProjectName",type:"string"},{name:"UserStoryName",type:"string"},{name:"FormattedID",type:"string"},{name:"_realUserStoryName",type:"string"},{name:"_realFormattedID",type:"string"},{name:"Description",type:"string"},{name:"Checkpoint",type:"string"},{name:"Supported",type:"string"},{name:"Assigned",type:"boolean"},{name:"Edited",type:"boolean"}]}),Ext.define("IntelCustomProxy",{extend:"Ext.data.proxy.Memory",alias:"proxy.intelcustomproxy",keyField:"ID",create:function(operation){var me=this;try{operation.getRecords().forEach(function(record){me.data.push(record.data)})}catch(e){console.log(e)}this.updateOperation.apply(this,arguments)},update:function(operation){var me=this;try{operation.getRecords().forEach(function(record){for(var i=0;me.data.length>i;++i)if(me.data[i][me.keyField]===record.data[me.keyField])return me.data[i]=record.data,void 0})}catch(e){console.log(e)}this.updateOperation.apply(this,arguments)},destroy:function(operation){var me=this;try{operation.getRecords().forEach(function(record){for(var i=0;me.data.length>i;++i)if(me.data[i][me.keyField]===record.data[me.keyField])return me.data.splice(i,1),void 0})}catch(e){console.log(e)}this.updateOperation.apply(this,arguments)}})},_loadRisksStores:!0,_loadTeamCommitsStores:!0,_loadDependenciesStores:!0,_loadVelocityStores:!0,_isEditing:!1,_reloadVelocityStores:function(){var me=this;me.VelocityIterationStore&&me._loadVelocityStores&&me.VelocityIterationStore.load({callback:function(records,operation){me.VelocityUserStoryStore&&me._loadVelocityStores&&me.VelocityUserStoryStore.load({callback:function(records,operation){me._isEditing||me.CustomVelocityStore&&me._loadVelocityStores&&me.CustomVelocityStore.load()}})}})},_reloadTeamCommitsStores:function(){var me=this;me.TeamCommitsStoryStore&&me._loadTeamCommitsStores&&me.TeamCommitsStoryStore.load({callback:function(records,operation){me.TeamCommitsFeatureStore&&me._loadTeamCommitsStores&&me.TeamCommitsFeatureStore.load({callback:function(records,operation){me._isEditing||me.CustomTeamCommitsStore&&me._loadTeamCommitsStores&&me.CustomTeamCommitsStore.load()}})}})},_reloadRisksStores:function(){var me=this;me.RisksFeatureStore&&me._loadRisksStores&&me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData(),me.RisksCache={},me._isEditing||me.CustomRisksStore&&me._loadRisksStores&&me.CustomRisksStore.load()}})},_reloadDependenciesStores:function(){var me=this;me.DependenciesUserStoryStore&&me._loadDependenciesStores&&me.DependenciesUserStoryStore.load({callback:function(records,operation){me._buildDependenciesData(),me._isEditing||(me.CustomPredDepStore&&me._loadDependenciesStores&&me.CustomPredDepStore.load(),me.CustomSuccDepStore&&me._loadDependenciesStores&&me.CustomSuccDepStore.load())}})},_reloadEverything:function(){var me=this;me.removeAll(),me._loadRisksStores=!0,me._loadTeamCommitsStores=!0,me._loadDependenciesStores=!0,me._loadVelocityStores=!0,me._isEditing=!1,me._loadReleasePicker(),me._loadTeamCommitsUserStories(function(){me._loadTeamCommitsFeatures(function(){me._loadTeamCommitsGrid()})}),me._loadVelocityUserStories(function(){me._loadVelocityIterations(function(){me._loadVelocityGrid()})}),me._loadRisksFeatures(function(){me._loadRisksGrid()}),me._loadDependenciesUserStories(function(){me._loadDependenciesGrids()})},launch:function(){var me=this;me._showError("Loading Data..."),me._defineModels(),setInterval(function(){me._reloadVelocityStores()},1e4),setInterval(function(){me._reloadTeamCommitsStores()},1e4),setInterval(function(){me._reloadRisksStores()},1e4),setInterval(function(){me._reloadDependenciesStores()},1e4),me._loadModels(function(){me._loadValidProjects(function(){var scopeProject=me.getContext().getProject();me._loadProject(scopeProject,function(scopeProjectRecord){me.ProjectRecord=_.find(me.ValidProjects,function(validProject){return validProject.data.ObjectID===scopeProjectRecord.data.ObjectID}),me.ProjectRecord?me._projectInWhichTrain(me.ProjectRecord,function(trainRecord){me.TrainRecord=trainRecord,console.log("train loaded:",trainRecord),me._loadReleases(function(){var currentRelease=me._getCurrentOrFirstRelease();currentRelease?(me.ReleaseRecord=currentRelease,console.log("release loaded",currentRelease),me._reloadEverything()):(me.removeAll(),console.log("This team has no releases"))})}):(me.removeAll(),me._showError("Please scope to a valid team for release planning"))})})})},_loadReleasePicker:function(){var me=this;me.ReleasePicker=me.add({xtype:"combobox",x:0,y:0,store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.ReleaseStore.getRecords(),function(r){return{Name:r.get("Name")}})}),displayField:"Name",fieldLabel:"Release:",editable:!1,value:me.ReleaseRecord.get("Name"),listeners:{select:function(combo,records){me.ReleaseRecord.get("Name")!==records[0].get("Name")&&(me.ReleaseRecord=me.ReleaseStore.findRecord("Name",records[0].get("Name")),me._reloadEverything())}}})},_loadTeamCommitsGrid:function(){function getTeamCommit(featureRecord){var tcs=featureRecord.get("c_TeamCommits"),projectID=me.ProjectRecord.get("ObjectID"),this_tc;try{this_tc=JSON.parse(tcs)[projectID]||{}}catch(e){this_tc={}}return this_tc.status||"Undecided"}function setTeamCommit(featureRecord,value){var tcs=featureRecord.get("c_TeamCommits"),projectID=me.ProjectRecord.get("ObjectID");try{tcs=JSON.parse(tcs)||{}}catch(e){tcs={}}tcs[projectID]||(tcs[projectID]={}),tcs[projectID].status=value,featureRecord.set("c_TeamCommits",JSON.stringify(tcs,null,"	")),featureRecord.save()}function getStoryCount(featureObjectID){var count=0,uss=me.TeamCommitsStoryStore.getRecords();return uss.forEach(function(us){us.get("Feature")&&us.get("Feature").ObjectID==featureObjectID&&++count}),count}var me=this,customTeamCommitsRecords=_.map(me.TeamCommitsFeatureStore.getRecords(),function(featureRecord){return{TeamCommits:getTeamCommit(featureRecord),Name:featureRecord.get("Name"),FormattedID:featureRecord.get("FormattedID"),ObjectID:featureRecord.get("ObjectID")}});me.CustomTeamCommitsStore=Ext.create("Rally.data.custom.Store",{data:customTeamCommitsRecords,autoSync:!0,limit:1/0,proxy:{type:"intelcustomproxy",keyField:"ObjectID"},listeners:{load:function(customTeamCommitsStore,currentTeamCommitsRecords){console.log("syncing teamCommits with features",currentTeamCommitsRecords,me.TeamCommitsFeatureStore.getRecords()),currentTeamCommitsRecords.forEach(function(teamCommitsRecord){var featureRecord=me.TeamCommitsFeatureStore.findRecord("ObjectID",teamCommitsRecord.get("ObjectID"));if(featureRecord){var newVal=getTeamCommit(featureRecord);newVal!=teamCommitsRecord.get("TeamCommits")&&(teamCommitsRecord.set("TeamCommits",newVal),console.log("updated teamCommits record",teamCommitsRecord,featureRecord))}})}}});var columnCfgs=[{text:"F#",dataIndex:"FormattedID",width:80,editor:!1,sortable:!0},{text:"Feature",dataIndex:"Name",width:240,editor:!1},{text:"Stories",dataIndex:"ObjectID",sortable:!0,editor:!1,doSort:function(direction){var ds=this.up("grid").getStore(),field=this.getSortParam();ds.sort({sorterFn:function(f1,f2){var diff=getStoryCount(f1.get("ObjectID"))-getStoryCount(f2.get("ObjectID"));return 0===diff?0:("ASC"==direction?1:-1)*(diff>0?1:-1)}})},width:80,renderer:function(oid){return getStoryCount(oid)}},{dataIndex:"TeamCommits",text:"Status",width:160,tdCls:"intel-editor-cell",sortable:!0,resizable:!1,doSort:function(direction){var ds=this.up("grid").getStore();ds.sort({sorterFn:function(f1,f2){var oid1=f1.get("ObjectID"),oid2=f2.get("ObjectID"),realF1=me.TeamCommitsFeatureStore.findRecord("ObjectID",oid1,0,!1,!0,!0),realF2=me.TeamCommitsFeatureStore.findRecord("ObjectID",oid2,0,!1,!0,!0),r1=getTeamCommit(realF1),r2=getTeamCommit(realF2);return r1==r2?0:("ASC"==direction?1:-1)*(r2>r1?-1:1)}})},editor:{xtype:"combobox",width:160,store:Ext.create("Ext.data.Store",{fields:["Status"],data:[{Status:"Undecided"},{Status:"N/A"},{Status:"Committed"},{Status:"Not Committed"}]}),editable:!1,displayField:"Status",listeners:{focus:function(combo){combo.expand()}}}}];me.TeamCommitsGrid=me.add({xtype:"rallygrid",title:"Team Commits",width:580,height:300,x:0,y:50,scroll:"vertical",columnCfgs:columnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0,getRowClass:function(customTeamCommitsRecords,index,rowParams,store){var val=customTeamCommitsRecords.get("TeamCommits");return"N/A"==val?"grey-row":"Committed"==val?"green-row":"Not Committed"==val?"red-row":void 0}},listeners:{beforeedit:function(){me._isEditing=!0},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var grid=e.grid,teamCommitsRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;me._isEditing=!1,value!=originalValue&&me._loadTeamCommitsStores&&(me._isEditing=!0,me._loadTeamCommitsStores=!1,me.TeamCommitsGrid.setLoading(!0),me.TeamCommitsFeatureStore.load({callback:function(records,operation){var oid=teamCommitsRecord.get("ObjectID"),realFeature=me.TeamCommitsFeatureStore.findRecord("ObjectID",oid,0,!1,!0,!0);realFeature?setTeamCommit(realFeature,value):console.log("ERROR: realFeature not found, ObjectID: "+oid),me.TeamCommitsFeatureStore.load({callback:function(records,operation){me._isEditing=!1,me._loadTeamCommitsStores=!0,me.TeamCommitsGrid.setLoading(!1)}})}}))}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomTeamCommitsStore})},_loadVelocityGrid:function(){var me=this,iterationGroups=_.groupBy(me.VelocityUserStoryStore.getRecords(),function(us){return us.get("Iteration").Name}),iterationGroupTotals=_.sortBy(_.map(_.keys(iterationGroups),function(key){return{Name:key,PlannedVelocity:iterationGroups[key][0].get("Iteration").PlannedVelocity||0,RealVelocity:_.reduce(iterationGroups[key],function(sum,us){return sum+us.get("PlanEstimate")},0)}}),"Name"),columnCfgs=[{text:"Iteration",dataIndex:"Name",width:150,editor:"textfield",resizable:!0,sortable:!0},{text:"Estimated",dataIndex:"PlannedVelocity",width:100,tdCls:"intel-editor-cell",xtype:"numbercolumn",editor:"textfield",resizable:!1,sortable:!0},{text:"Planned",dataIndex:"RealVelocity",xtype:"numbercolumn",width:100,editor:!1,resizable:!1,sortable:!0}];me.CustomVelocityStore=Ext.create("Rally.data.custom.Store",{data:iterationGroupTotals,autoSync:!0,limit:1/0,proxy:{type:"intelcustomproxy",keyField:"Name"},listeners:{load:function(customVelocityStore,velocityRecords){console.log("syncing velocity with current iterations",velocityRecords,me.VelocityIterationStore.getRecords()),velocityRecords.forEach(function(velocityRecord){var iterationName=velocityRecord.data.Name,iteration=me.VelocityIterationStore.findRecord("Name",iterationName,0,!1,!0,!0);velocityRecord.data.PlannedVelocity=iteration.get("PlannedVelocity")||0,velocityRecord.commit()})}}}),me.VelocityGrid=me.add({xtype:"rallygrid",title:"Velocity",height:300,x:680,y:50,showPagingToolbar:!1,showRowActionsColumn:!1,viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0},listeners:{beforeedit:function(editor,e){return me._isEditing=!0,!0},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var grid=e.grid,velocityRecord=e.record,value=e.value,originalValue=e.originalValue;if(me._isEditing=!1,value&&value!==originalValue){value=1*value||0;var iterationName=velocityRecord.data.Name,iteration=me.VelocityIterationStore.findRecord("Name",iterationName,0,!1,!0,!0);iteration.set("PlannedVelocity",value),iteration.save(),velocityRecord.set("PlannedVelocity",value)}}},plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],enableEditing:!1,context:this.getContext(),columnCfgs:columnCfgs,store:me.CustomVelocityStore})},_loadRisksGrid:function(){function getWorkweeks(){var i,oneDay=864e5,startDate=me.ReleaseRecord.get("ReleaseStartDate"),endDate=me.ReleaseRecord.get("ReleaseDate"),sd_year=new Date(startDate.getFullYear(),0,0),sd_diff=startDate-sd_year,sd_day=sd_diff/oneDay,sd_week=Math.ceil(sd_day/7),ed_year=new Date(endDate.getFullYear(),0,0),ed_diff=endDate-ed_year,ed_day=ed_diff/oneDay,ed_week=Math.ceil(ed_day/7),weeks=[];if(sd_week>ed_week){for(i=sd_week;52>=i;++i)weeks.push({Week:"ww"+i});for(i=0;ed_week>=i;++i)weeks.push({Week:"ww"+i})}else for(i=sd_week;ed_week>=i;++i)weeks.push({Week:"ww"+i});return weeks}function removeRiskFromList(riskID,riskList){for(var i=0;riskList.length>i;++i)if(riskList[i].RiskID==riskID)return riskList.splice(i,1)[0]}function getRisks(featureRecord){var FID=featureRecord.data.ObjectID,risks=featureRecord.data.c_Risks;if(me.RisksCache[FID])return me.RisksCache[FID];try{risks=JSON.parse(risks)||{}}catch(e){risks={}}return me.RisksCache[FID]=risks,risks}function removeRisk(featureRecord,riskData){var FID=featureRecord.data.ObjectID,risks=getRisks(featureRecord);risks[projectID]&&(delete risks[projectID][riskData.RiskID],me.RisksCache[FID]=risks,featureRecord.set("c_Risks",JSON.stringify(risks,null,"	")),featureRecord.save(),console.log("removed risk from feature:",featureRecord,riskData,risks))}function addRisk(featureRecord,riskData){var FID=featureRecord.data.ObjectID,risks=getRisks(featureRecord);risks[projectID]||(risks[projectID]={});var copy={CP:riskData.Checkpoint,Cont:riskData.Contact,Desc:riskData.Description,Imp:riskData.Impact,Sta:riskData.Status};risks[projectID][riskData.RiskID]=copy,me.RisksCache[FID]=risks,featureRecord.set("c_Risks",JSON.stringify(risks,null,"	")),featureRecord.save(),console.log("added risk to feature:",featureRecord,riskData,risks)}function getDirtyType(localRiskRecord,realRiskData){var riskData=localRiskRecord.data;return realRiskData?riskData.Edited?"Edited":"Unchanged":riskData.Edited?"New":"Deleted"}var me=this,projectID=me.ProjectRecord.get("ObjectID"),workweeks=getWorkweeks();me.RisksCache={},me.CustomRisksStore=Ext.create("Rally.data.custom.Store",{data:me.RisksParsedData,autoSync:!0,model:"IntelRisk",limit:1/0,proxy:{type:"intelcustomproxy",keyField:"RiskID"},listeners:{load:function(customRisksStore,currentRisksRecords){var realRisksDatas=me.RisksParsedData.slice(0);console.log("syncing risks with current features",currentRisksRecords,realRisksDatas);for(var i=0;currentRisksRecords.length>i;++i){var currentRisksRecord=currentRisksRecords[i],realRiskData=removeRiskFromList(currentRisksRecord.get("RiskID"),realRisksDatas),dirtyType=getDirtyType(currentRisksRecord,realRiskData);"New"!==dirtyType&&"Edited"!==dirtyType&&("Deleted"==dirtyType?customRisksStore.remove(currentRisksRecord):(currentRisksRecord.data=realRiskData,currentRisksRecord.commit()))}realRisksDatas.forEach(function(realRiskData){console.log("adding real risk",realRiskData),customRisksStore.add(Ext.create("IntelRisk",realRiskData))})}}});var columnCfgs=[{text:"F#",dataIndex:"FormattedID",tdCls:"intel-editor-cell",width:80,editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["FormattedID"],data:_.map(me.RisksFeatureStore.getRecords(),function(fr){return{FormattedID:fr.get("FormattedID")}})}),enableKeyEvents:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filterBy(function(item){return 0===item.get("FormattedID").indexOf(me.getRawValue())})}},focus:function(combo){combo.expand()}},displayField:"FormattedID"},resizable:!1,sortable:!0},{text:"Feature",dataIndex:"FeatureName",tdCls:"intel-editor-cell",width:240,editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.RisksFeatureStore.getRecords(),function(fr){return{Name:fr.get("Name")}})}),enableKeyEvents:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filterBy(function(item){return 0===item.get("Name").indexOf(me.getRawValue())})}},focus:function(combo){combo.expand()}},displayField:"Name"},resizable:!1,sortable:!0},{text:"Risk Description",dataIndex:"Description",tdCls:"intel-editor-cell",width:200,editor:"textfield",resizable:!1,sortable:!0,renderer:function(val,meta){return val||"-"}},{text:"Impact",dataIndex:"Impact",tdCls:"intel-editor-cell",width:200,resizable:!1,sortable:!0,editor:"textfield",renderer:function(val,meta){return val||"-"}},{text:"Status",dataIndex:"Status",tdCls:"intel-editor-cell",width:100,editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Status"],data:[{Status:"Undefined"},{Status:"Resolved"},{Status:"Owned"},{Status:"Accepted"},{Status:"Mitigated"}]}),editable:!1,displayField:"Status",listeners:{focus:function(combo){combo.expand()}}},resizable:!1,sortable:!0,renderer:function(val,meta){return val||"-"}},{text:"Contact",dataIndex:"Contact",tdCls:"intel-editor-cell",width:160,editor:"textfield",sortable:!0,resizable:!1,renderer:function(val,meta){return val||"-"}},{text:"Checkpoint",dataIndex:"Checkpoint",tdCls:"intel-editor-cell",width:80,resizable:!1,editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["Week"],data:workweeks}),editable:!1,displayField:"Week",listeners:{focus:function(combo){combo.expand()}}},sortable:!0,renderer:function(val,meta){return val||"-"}},{text:"",width:80,xtype:"actioncolumn",resizable:!1,defaultRenderer:function(v,meta,riskRecord,rowIdx,colIdx,store,view){var _me_col=this,prefix=Ext.baseCSSPrefix,scope=_me_col.origScope||_me_col,items=_me_col.items,len=items.length,i=0,item,ret,disabled,tooltip;ret=Ext.isFunction(me.origRenderer)?me.origRenderer.apply(scope,arguments)||"":"",meta.tdCls+=" "+Ext.baseCSSPrefix+"action-col-cell";var realRiskData=removeRiskFromList(riskRecord.get("RiskID"),me.RisksParsedData.slice(0)),dirtyType=getDirtyType(riskRecord,realRiskData);if("Edited"!==dirtyType)return"";for(;len>i;i++)item=items[i],disabled=item.disabled||(item.isDisabled?item.isDisabled.call(item.scope||scope,view,rowIdx,colIdx,item,riskRecord):!1),tooltip=disabled?null:item.tooltip||(item.getTip?item.getTip.apply(item.scope||scope,arguments):null),item.hasActionConfiguration||(item.stopSelection=_me_col.stopSelection,item.disable=Ext.Function.bind(_me_col.disableAction,_me_col,[i],0),item.enable=Ext.Function.bind(_me_col.enableAction,_me_col,[i],0),item.hasActionConfiguration=!0),ret+=Ext.String.format('<div class="{0}action-col-{1} {2} intel-button-cell">Undo</div>',prefix,i,Ext.isFunction(item.getClass)?item.getClass.apply(item.scope||scope,arguments):item.iconCls||_me_col.iconCls||"");return ret},handler:function(grid,row,col){var store=grid.getStore(),riskRecord=store.getAt(row);riskRecord.set("Edited",!1),store.load()}},{text:"",width:80,xtype:"actioncolumn",resizable:!1,defaultRenderer:function(v,meta,riskRecord,rowIdx,colIdx,store,view){var _me_col=this,prefix=Ext.baseCSSPrefix,scope=_me_col.origScope||_me_col,items=_me_col.items,len=items.length,i=0,item,ret,disabled,tooltip;ret=Ext.isFunction(me.origRenderer)?me.origRenderer.apply(scope,arguments)||"":"",meta.tdCls+=" "+Ext.baseCSSPrefix+"action-col-cell";
var realRiskData=removeRiskFromList(riskRecord.get("RiskID"),me.RisksParsedData.slice(0)),dirtyType=getDirtyType(riskRecord,realRiskData);if("New"===dirtyType)dirtyType="Save";else{if("Edited"!==dirtyType)return"";dirtyType="Resave"}for(;len>i;i++)item=items[i],disabled=item.disabled||(item.isDisabled?item.isDisabled.call(item.scope||scope,view,rowIdx,colIdx,item,riskRecord):!1),tooltip=disabled?null:item.tooltip||(item.getTip?item.getTip.apply(item.scope||scope,arguments):null),item.hasActionConfiguration||(item.stopSelection=_me_col.stopSelection,item.disable=Ext.Function.bind(_me_col.disableAction,_me_col,[i],0),item.enable=Ext.Function.bind(_me_col.enableAction,_me_col,[i],0),item.hasActionConfiguration=!0),ret+=Ext.String.format('<div class="{0}action-col-{1} {2} intel-button-cell">{3}</div>',prefix,i,Ext.isFunction(item.getClass)?item.getClass.apply(item.scope||scope,arguments):item.iconCls||_me_col.iconCls||"",dirtyType);return ret},handler:function(grid,row,col){var store=grid.getStore(),riskRecord=store.getAt(row);if(me._loadRisksStores){if(!riskRecord.get("Checkpoint"))return alert("You must set the Checkpoint date for this risk"),void 0;if(!riskRecord.get("Description"))return alert("You must set the Description date for this risk"),void 0;if(!riskRecord.get("Impact"))return alert("You must set the Impact date for this risk"),void 0;if(!riskRecord.get("Status"))return alert("You must set the Status date for this risk"),void 0;if(!riskRecord.get("Contact"))return alert("You must set the Contact date for this risk"),void 0;me._loadRisksStores=!1,me.RisksGrid.setLoading(!0),me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData();var riskRecordData=riskRecord.data,realRiskData=removeRiskFromList(riskRecordData.RiskID,me.RisksParsedData.slice(0));if(realRiskData&&realRiskData.FormattedID!=riskRecordData.FormattedID){console.log("moving risk to new feature",realRiskData.FormattedID,riskRecordData.FormattedID);var oldFeatureRecord=me.RisksFeatureStore.findRecord("FormattedID",realRiskData.FormattedID,0,!1,!0,!0);oldFeatureRecord&&removeRisk(oldFeatureRecord,realRiskData)}var newFeatureRecord=me.RisksFeatureStore.findRecord("FormattedID",riskRecordData.FormattedID,0,!1,!0,!0);newFeatureRecord&&addRisk(newFeatureRecord,riskRecordData),riskRecord.set("Edited",!1),me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData(),me._loadRisksStores=!0,me.RisksGrid.setLoading(!1)}})}})}}},{text:"",width:80,xtype:"actioncolumn",resizable:!1,defaultRenderer:function(v,meta,riskRecord,rowIdx,colIdx,store,view){var _me_col=this,prefix=Ext.baseCSSPrefix,scope=_me_col.origScope||_me_col,items=_me_col.items,len=items.length,i=0,item,ret,disabled,tooltip;for(ret=Ext.isFunction(me.origRenderer)?me.origRenderer.apply(scope,arguments)||"":"",meta.tdCls+=" "+Ext.baseCSSPrefix+"action-col-cell";len>i;i++)item=items[i],disabled=item.disabled||(item.isDisabled?item.isDisabled.call(item.scope||scope,view,rowIdx,colIdx,item,riskRecord):!1),tooltip=disabled?null:item.tooltip||(item.getTip?item.getTip.apply(item.scope||scope,arguments):null),item.hasActionConfiguration||(item.stopSelection=_me_col.stopSelection,item.disable=Ext.Function.bind(_me_col.disableAction,_me_col,[i],0),item.enable=Ext.Function.bind(_me_col.enableAction,_me_col,[i],0),item.hasActionConfiguration=!0),ret+=Ext.String.format('<div class="{0}action-col-{1} {2} intel-button-cell">Delete</div>',prefix,i,Ext.isFunction(item.getClass)?item.getClass.apply(item.scope||scope,arguments):item.iconCls||_me_col.iconCls||"");return ret},handler:function(grid,row,col){var store=grid.getStore(),riskRecord=store.getAt(row);me._loadRisksStores&&confirm("Confirm Risk Deletion")&&(me._loadRisksStores=!1,me.RisksGrid.setLoading(!0),me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData();var riskRecordData=riskRecord.data,realRiskData=removeRiskFromList(riskRecordData.RiskID,me.RisksParsedData.slice(0));if(realRiskData&&realRiskData.FormattedID!=riskRecordData.FormattedID){var oldFeatureRecord=me.RisksFeatureStore.findRecord("FormattedID",realRiskData.FormattedID,0,!1,!0,!0);oldFeatureRecord&&removeRisk(oldFeatureRecord,realRiskData)}var newFeatureRecord=me.RisksFeatureStore.findRecord("FormattedID",riskRecordData.FormattedID,0,!1,!0,!0);newFeatureRecord&&removeRisk(newFeatureRecord,riskRecordData),me.CustomRisksStore.remove(riskRecord),me.RisksFeatureStore.load({callback:function(records,operation){me._parseRisksData(),me._loadRisksStores=!0,me.RisksGrid.setLoading(!1)}})}}))}}];me.AddRiskButton=me.add({xtype:"button",text:"+ Add Risk",x:0,y:380,width:80,style:"margin-bottom:10px",listeners:{click:function(){var randomFeature=me.RisksFeatureStore.first();if(me.CustomRisksStore){me.CustomRisksStore.suspendEvents();var model=Ext.create("IntelRisk",{RiskID:1*new Date+""+1e7*Math.random(),FormattedID:randomFeature.get("FormattedID"),FeatureName:randomFeature.get("Name"),Description:"",Impact:"",Status:"",Contact:"",Checkpoint:"",Edited:!0});me.CustomRisksStore.add(model),me.CustomRisksStore.resumeEvents(),me.RisksGrid.reconfigure(me.CustomRisksStore)}}}}),me.RisksGrid=me.add({xtype:"rallygrid",title:"Risks",width:_.reduce(columnCfgs,function(sum,c){return sum+c.width},20),height:300,x:0,y:420,scroll:"both",columnCfgs:columnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0,getRowClass:function(){return"intel-row-30px"}},listeners:{beforeedit:function(){me._isEditing=!0},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var grid=e.grid,risksRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;if(me._isEditing=!1,value!==originalValue){var rData=risksRecord.data,previousEdit=rData.Edited;rData.Edited=!0;var featureRecord;"FeatureName"===field?(featureRecord=me.RisksFeatureStore.findRecord("Name",value,0,!1,!0,!0),featureRecord?rData.FormattedID=featureRecord.get("FormattedID"):(rData.FeatureName=originalValue,rData.Edited=previousEdit)):"FormattedID"===field&&(featureRecord=me.RisksFeatureStore.findRecord("FormattedID",value,0,!1,!0,!0),featureRecord?rData.FeatureName=featureRecord.get("Name"):(rData.FormattedID=originalValue,rData.Edited=previousEdit)),risksRecord.commit()}}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomRisksStore})},_loadDependenciesGrids:function(){function getWorkweeks(){var i,oneDay=864e5,startDate=me.ReleaseRecord.get("ReleaseStartDate"),endDate=me.ReleaseRecord.get("ReleaseDate"),sd_year=new Date(startDate.getFullYear(),0,0),sd_diff=startDate-sd_year,sd_day=sd_diff/oneDay,sd_week=Math.ceil(sd_day/7),ed_year=new Date(endDate.getFullYear(),0,0),ed_diff=endDate-ed_year,ed_day=ed_diff/oneDay,ed_week=Math.ceil(ed_day/7),weeks=[];if(sd_week>ed_week){for(i=sd_week;52>=i;++i)weeks.push({Week:"ww"+i});for(i=0;ed_week>=i;++i)weeks.push({Week:"ww"+i})}else for(i=sd_week;ed_week>=i;++i)weeks.push({Week:"ww"+i});return weeks}function removeDepFromList(dependencyID,dependencyList){for(var i=0;dependencyList.length>i;++i)if(dependencyList[i].DependencyID==dependencyID)return dependencyList.splice(i,1)[0]}function removePredDep(userStoryRecord,predDepData){var dependencies=me._getDependencies(userStoryRecord);delete dependencies.Preds[predDepData.DependencyID],userStoryRecord.set("c_Dependencies",JSON.stringify(dependencies,null,"	")),userStoryRecord.save(),console.log("removed pred from userStory:",userStoryRecord,predDepData,dependencies)}function removeSuccDep(userStoryRecord,succDepData){for(var dependencies=me._getDependencies(userStoryRecord),succs=dependencies.Succs,i=0;succs.length>i;++i)if(succs[i].ID===succDepData.DependencyID)return succs.splice(i,1),userStoryRecord.set("c_Dependencies",JSON.stringify(dependencies,null,"	")),userStoryRecord.save(),console.log("removed succ from userStory:",userStoryRecord,succDepData,dependencies),void 0}function addPredDep(userStoryRecord,predDepData){var dependencies=me._getDependencies(userStoryRecord),copy={Desc:predDepData.Description,CP:predDepData.Checkpoint,Sta:predDepData.Status,Preds:predDepData.Predecessors};dependencies.Preds[predDepData.DependencyID]=copy,userStoryRecord.set("c_Dependencies",JSON.stringify(dependencies,null,"	")),userStoryRecord.save(),console.log("added predecessor to userStory:",userStoryRecord,predDepData,dependencies)}function addSuccDep(userStoryRecord,succDepData){for(var dependencies=me._getDependencies(userStoryRecord),succs=dependencies.Succs,copy={ID:succDepData.DependencyID,PUSID:succDepData.PredFormattedID,PUSName:succDepData.PredUserStoryName,PPID:succDepData.PredProjectName,Desc:succDepData.Description,CP:succDepData.Checkpoint,Sup:succDepData.Supported,A:succDepData.Assigned},replaced=!1,i=0;succs.length>i;++i)if(succs[i].ID===copy.ID){succs[i]=copy,replaced=!0;break}replaced||succs.push(copy),userStoryRecord.set("c_Dependencies",JSON.stringify(dependencies,null,"	")),userStoryRecord.save(),console.log("added succ to userStory:",userStoryRecord,succDepData,dependencies)}function getPredecessorsObject(predDepRecord){var predecessors;try{predecessors=predDepRecord.get?JSON.parse(predDepRecord.get("Predecessors"))||[]:JSON.parse(predDepRecord.Predecessors)||[]}catch(e){predecessors=[]}return predecessors}function getDirtyType(localDepRecord,realDepData){var localDepData=localDepRecord.data;return realDepData?localDepData.Edited?"Edited":"Unchanged":localDepData.Edited?"New":"Deleted"}var me=this;me.PredDepTeamStores={},me.CustomPredDepStore=Ext.create("Ext.data.Store",{data:me.DependenciesParsedData.Predecessors.slice(0),autoSync:!0,model:"IntelPredDep",proxy:{type:"intelcustomproxy",keyField:"DependencyID"},limit:1/0,listeners:{load:function(customPredDepStore,customPredDepRecs){var realPredDepsData=me.DependenciesParsedData.Predecessors.slice(0);console.log("syncing predDeps with current userStories",customPredDepRecs,realPredDepsData);for(var i=0;customPredDepRecs.length>i;++i){var depRec=customPredDepRecs[i],depID=depRec.get("DependencyID"),realDep=removeDepFromList(depID,realPredDepsData),dirtyType=getDirtyType(depRec,realDep);"New"!==dirtyType&&"Edited"!==dirtyType&&("Deleted"==dirtyType?customPredDepStore.remove(depRec):(depRec.data=realDep,depRec.commit()))}realPredDepsData.forEach(function(realDep){console.log("adding predDep",realDep),customPredDepStore.add(Ext.create("IntelPredDep",realDep))})}}});var predDepColumnCfgs=[{text:"US#",dataIndex:"FormattedID",tdCls:"intel-editor-cell",width:80,resizable:!1,editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["FormattedID"],data:_.map(me.DependenciesReleaseUserStories,function(usr){return{FormattedID:usr.get("FormattedID")}}),sorters:{property:"FormattedID"}}),enableKeyEvents:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filters.getRange().forEach(function(filter){me.store.removeFilter(filter)}),me.store.filterBy(function(item){return item.get("FormattedID").indexOf(me.getRawValue())>-1})}},focus:function(combo){combo.expand()}},displayField:"FormattedID"},sortable:!0},{text:"UserStory",dataIndex:"UserStoryName",width:160,resizable:!1,tdCls:"intel-editor-cell",editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.DependenciesReleaseUserStories,function(usr){return{Name:usr.get("Name")}}),sorters:{property:"Name"}}),enableKeyEvents:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filters.getRange().forEach(function(filter){me.store.removeFilter(filter)}),me.store.filterBy(function(item){return item.get("Name").indexOf(me.getRawValue())>-1})}},focus:function(combo){combo.expand()}},displayField:"Name"},sortable:!0},{text:"Dependency Description",dataIndex:"Description",width:160,resizable:!1,tdCls:"intel-editor-cell",editor:"textfield",sortable:!0,renderer:function(val){return val||"-"}},{dataIndex:"Checkpoint",width:80,resizable:!1,tdCls:"intel-editor-cell",text:"Checkpoint",editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["Week"],data:getWorkweeks()}),editable:!1,displayField:"Week",listeners:{focus:function(combo){combo.expand()}}},renderer:function(val){return val||"-"},sortable:!0},{text:"Teams Depended On",items:[{xtype:"text",width:100,text:""},{xtype:"text",width:200,text:"Team Name"},{xtype:"text",width:80,text:"Supported"},{xtype:"text",width:80,text:"US#"},{xtype:"text",width:160,text:"UserStory"}],dataIndex:"Predecessors",width:700,resizable:!1,sortable:!1,renderer:function(val,meta,predDepRecord){var id=Ext.id();return Ext.defer(function(){var predecessors=getPredecessorsObject(predDepRecord),el=Ext.get(id);if(el&&el.isVisible()){var panel,depID=predDepRecord.get("DependencyID");delete me.PredDepTeamStores[depID],predecessors.length||(predecessors.push({TID:1*new Date+""+1e7*Math.random(),PID:"",Sup:"No",USID:"",USName:"",A:!1}),predDepRecord.data.Predecessors=JSON.stringify(predecessors,null,"	")),me.PredDepTeamStores[depID]=Ext.create("Ext.data.Store",{data:predecessors,autoSync:!0,limit:1/0,model:"IntelDepTeam",proxy:{type:"intelcustomproxy",keyField:"TID"},listeners:{load:function(depTeamStore,depTeamRecords){var predecessors=getPredecessorsObject(predDepRecord);console.log("syncing depTeamRecords with current dependencies",depTeamRecords,predecessors);Outer:for(var i=0;depTeamRecords.length>i;++i)for(var depTeamRecord=depTeamRecords[i],realTeamDep,j=0;predecessors.length>j;++j)if(predecessors[j].TID===depTeamRecord.get("TID")){realTeamDep=predecessors.splice(j,1)[0],depTeamRecord.data=realTeamDep,depTeamRecord.commit();continue Outer}predecessors.forEach(function(realTeamDep){console.log("adding IntelDepTeam",realTeamDep),depTeamStore.add(Ext.create("IntelDepTeam",realTeamDep))})}}});var defaultHandler={element:"el",fn:function(a){a.stopPropagation()}},teamColumnCfgs=[{dataIndex:"PID",width:200,resizable:!1,renderer:function(val,meta,predDepRecord){var projectRecord=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("ObjectID")==val});return val&&projectRecord?projectRecord.get("Name"):(meta.tdCls+="intel-editor-cell","Select Team")},editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Name"],data:me.ProjectNames,sorters:{property:"Name"}}),enableKeyEvents:!0,ignoreNoChange:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filters.getRange().forEach(function(filter){me.store.removeFilter(filter)}),me.store.filterBy(function(item){return item.get("Name").indexOf(me.getRawValue())>-1})}},focus:function(combo){combo.expand()}},displayField:"Name"}},{dataIndex:"Sup",width:80,resizable:!1,editor:!1,renderer:function(val,meta,teamDepRecord){return teamDepRecord.get("USID")&&(meta.tdCls="No"==val?"intel-not-supported-cell":"intel-supported-cell"),val}},{dataIndex:"USID",width:80,resizable:!1,editor:!1,renderer:function(val,meta,depTeamRecord){return depTeamRecord.get("A")?val:"-"}},{dataIndex:"USName",width:160,resizable:!1,editor:!1,renderer:function(val,meta,depTeamRecord){return depTeamRecord.get("A")?val:"-"}},{width:80,resizable:!1,renderer:function(val,meta,depTeamRecord,row,col,store){var id=Ext.id();return Ext.defer(function(){var el=Ext.get(id);if(el&&el.isVisible()&&(Ext.widget("button",{renderTo:id,text:"Delete",width:70,handler:function(){for(var predecessors=getPredecessorsObject(predDepRecord),i=0;predecessors.length>i;++i)if(predecessors[i].TID===depTeamRecord.get("TID")){predecessors.splice(i,1);break}predDepRecord.set("Predecessors",JSON.stringify(predecessors,null,"	")),me.PredDepTeamStores[depID].remove(depTeamRecord),predDepRecord.set("Edited",!0)}}),panel&&store.findExact("TID",depTeamRecord.get("TID"))===store.count()-1)){var grid=panel.down("rallygrid");grid.setHeight(_.reduce(grid.items,function(sum,i){return sum+i.getHeight()}))}},5),Ext.String.format('<div id="{0}"></div>',id)}}];panel=Ext.widget("panel",{renderTo:id,layout:"hbox",pack:"start",align:"stretch",border:!1,bodyStyle:"background:rgba(0,0,0,0);padding:0;margin:0",items:[{xtype:"button",text:"+ Add Team",padding:3,margin:"0 5 0 0 ",width:80,handler:function(){if(me.PredDepTeamStores[depID]){var model=Ext.create("IntelDepTeam",{TID:1*new Date+""+1e7*Math.random(),PID:"",Sup:"No",USID:"",USName:"",A:!1});me.PredDepTeamStores[depID].add(model);var predecessors=getPredecessorsObject(predDepRecord);predecessors.push(model.data),predDepRecord.set("Predecessors",JSON.stringify(predecessors,null,"	")),predDepRecord.set("Edited",!0)}}},{xtype:"rallygrid",width:_.reduce(teamColumnCfgs,function(sum,i){return sum+i.width},0),rowLines:!1,flex:1,columnCfgs:teamColumnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{stripeRows:!1,getRowClass:function(teamDepRecord,index,rowParams,store){return teamDepRecord.get("PID")?void 0:"intel-no-team-dep-selected"}},listeners:{beforeedit:function(editor,e){return e.value?!1:(me._isEditing=!0,void 0)},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var depTeamRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue,i;me._isEditing=!1,console.log("teamDepEdit",field,value,originalValue);var previousEdit=predDepRecord.get("Edited");predDepRecord.set("Edited",!0);var predecessors=getPredecessorsObject(predDepRecord);if("PID"===field){var projectRecord=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("Name")==value});if(!projectRecord)return depTeamRecord.set("PID",originalValue),predDepRecord.set("Edited",previousEdit),void 0;for(i=0;predecessors.length>i;++i)if(predecessors[i].PID===""+projectRecord.get("ObjectID"))return alert(value+" already included in this dependency"),depTeamRecord.set("PID",originalValue),predDepRecord.set("Edited",previousEdit),void 0;if(projectRecord.get("ObjectID")===me.ProjectRecord.get("ObjectID"))return alert("You cannot depend on yourself"),depTeamRecord.set("PID",originalValue),predDepRecord.set("Edited",previousEdit),void 0;depTeamRecord.set("PID",projectRecord.get("ObjectID"))}for(i=0;predecessors.length>i;++i)if(predecessors[i].TID===depTeamRecord.get("TID")){predecessors[i]=depTeamRecord.data,predDepRecord.set("Predecessors",JSON.stringify(predecessors,null,"	"));break}}},hideHeaders:!0,showRowActionsColumn:!1,scroll:!1,showPagingToolbar:!1,enableEditing:!1,context:me.getContext(),store:me.PredDepTeamStores[depID]}],listeners:{mousedown:defaultHandler,mousemove:defaultHandler,mouseout:defaultHandler,mouseover:defaultHandler,mouseup:defaultHandler,mousewheel:defaultHandler,scroll:defaultHandler,click:defaultHandler,dblclick:defaultHandler}})}},5),Ext.String.format('<div id="{0}"></div>',id)}},{text:"",width:80,resizable:!1,renderer:function(val,meta,predDepRecord,r,c,s){var id=Ext.id();return Ext.defer(function(){var realPredDepData=removeDepFromList(predDepRecord.get("DependencyID"),me.DependenciesParsedData.Predecessors.slice(0)),dirtyType=getDirtyType(predDepRecord,realPredDepData);dirtyType="Edited"===dirtyType?"Undo":"";var el=Ext.get(id);el&&el.isVisible()&&dirtyType.length&&Ext.widget("button",{renderTo:id,text:dirtyType,width:70,handler:function(){predDepRecord.set("Edited",!1),s.load()}})},5),Ext.String.format('<div id="{0}"></div>',id)}},{text:"",width:80,resizable:!1,renderer:function(val,meta,predDepRecord){var id=Ext.id();return Ext.defer(function(){var realPredDepData=removeDepFromList(predDepRecord.get("DependencyID"),me.DependenciesParsedData.Predecessors.slice(0)),dirtyType=getDirtyType(predDepRecord,realPredDepData);dirtyType="New"===dirtyType?"Save":"Edited"===dirtyType?"Resave":"";var el=Ext.get(id);el&&el.isVisible()&&dirtyType.length&&Ext.widget("button",{renderTo:id,text:dirtyType,width:70,handler:function(){if(me._loadDependenciesStores){if(""===predDepRecord.get("Description"))return alert("Cannot Save: Description is empty"),void 0;if(""===predDepRecord.get("Checkpoint"))return alert("Cannot Save: Checkpoint is empty"),void 0;var predecessors=getPredecessorsObject(predDepRecord);if(0===predecessors.length)return alert("Cannot Save: Must specify a team you depend on"),void 0;for(var i=0;predecessors.length>i;++i)if(""===predecessors[i].PID)return alert("Cannot Save: All Team Names must be valid"),void 0;me._loadDependenciesStores=!1,me.PredDepGrid.setLoading(!0),me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){if(operation.wasSuccessful()){me._buildDependenciesData();var predDepData=predDepRecord.data,realPredDeps=me.DependenciesParsedData.Predecessors.slice(0),realDepData=removeDepFromList(predDepData.DependencyID,realPredDeps),addedTeamDeps=[],removedTeamDeps=[],updatedTeamDeps=[],localPredTeams=getPredecessorsObject(predDepData),realPredTeams=getPredecessorsObject(realDepData);Outer:for(var i=0;localPredTeams.length>i;++i){for(var j=0;realPredTeams.length>j;++j)if(localPredTeams[i].TID===realPredTeams[j].TID){updatedTeamDeps.push(realPredTeams.splice(j,1)[0]);continue Outer}addedTeamDeps.push(localPredTeams[i])}removedTeamDeps=realPredTeams;var addedTeamDepsFinished=-1,addedTeamDepsCallbacks=[],addedTeamDepsDone=function(){if(++addedTeamDepsFinished===addedTeamDeps.length){var updatedTeamDepsFinished=-1,updatedTeamDepsCallbacks=[],updatedTeamDepsDone=function(){if(++updatedTeamDepsFinished===updatedTeamDeps.length){if(removedTeamDeps.forEach(function(teamDepData){var project=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("ObjectID")==teamDepData.PID});me._loadUserStoryByFID(teamDepData.USID,project.get("_ref"),function(us){us&&removeSuccDep(us,predDepData)})}),addedTeamDepsCallbacks.forEach(function(cb){cb()}),updatedTeamDepsCallbacks.forEach(function(cb){cb()}),predDepData.Predecessors=JSON.stringify(localPredTeams,null,"	"),realDepData&&realDepData.FormattedID!=predDepData.FormattedID){console.log("moving predDep to new user story",realDepData.FormattedID,predDepData.FormattedID);var oldUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",realDepData.FormattedID,0,!1,!0,!0);oldUserStoryRecord&&removePredDep(oldUserStoryRecord,realDepData)}var newUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",predDepData.FormattedID,0,!1,!0,!0);newUserStoryRecord&&addPredDep(newUserStoryRecord,predDepData),predDepRecord.set("Edited",!1),me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData(),me._loadDependenciesStores=!0,me.PredDepGrid.setLoading(!1)}})}};updatedTeamDepsDone(),updatedTeamDeps.forEach(function(teamDepData){var project=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("ObjectID")==teamDepData.PID});me._loadUserStoryByFID(teamDepData.USID,project.get("_ref"),function(us){us?(updatedTeamDepsCallbacks.push(function(){for(var deps=me._getDependencies(us),succs=deps.Succs,i=0;succs.length>i;++i)if(succs[i].ID==predDepData.DependencyID)return succs[i].PUSName=predDepData.UserStoryName,succs[i].PUSID=predDepData.FormattedID,succs[i].CP=predDepData.Checkpoint,succs[i].Desc=predDepData.Description,us.set("c_Dependencies",JSON.stringify(deps,null,"	")),us.save(),void 0;var succDep={DependencyID:predDepData.DependencyID,PredUserStoryName:predDepData.UserStoryName,PredFormattedID:predDepData.FormattedID,PredProjectName:me.ProjectRecord.get("Name"),Description:predDepData.Description,Checkpoint:predDepData.Checkpoint,UserStoryName:teamDepData.USName,FormattedID:teamDepData.USID,Supported:teamDepData.Sup,Assigned:teamDepData.A,Edited:!1};addSuccDep(us,succDep)}),updatedTeamDepsDone()):me._loadRandomUserStory(project.get("_ref"),function(us){return us?(updatedTeamDepsCallbacks.push(function(){for(var i=0;localPredTeams.length>i;++i)if(localPredTeams[i].TID===teamDepData.TID){localPredTeams[i].USID=us.get("FormattedID"),localPredTeams[i].USName=us.get("Name"),localPredTeams[i].A=!1;break}var succDep={DependencyID:predDepData.DependencyID,PredUserStoryName:predDepData.UserStoryName,PredFormattedID:predDepData.FormattedID,PredProjectName:me.ProjectRecord.get("Name"),Description:predDepData.Description,Checkpoint:predDepData.Checkpoint,UserStoryName:"",FormattedID:"",Supported:teamDepData.Sup,Assigned:!1,Edited:!1};addSuccDep(us,succDep)}),updatedTeamDepsDone(),void 0):(me._loadDependenciesStores=!0,me.PredDepGrid.setLoading(!1),alert("Project "+project.get("Name")+" has no user stories, cannot continue"),void 0)})})})}};addedTeamDepsDone(),addedTeamDeps.forEach(function(teamDepData){var project=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("ObjectID")==teamDepData.PID});me._loadRandomUserStory(project.get("_ref"),function(us){return us?(addedTeamDepsCallbacks.push(function(){teamDepData.USID=us.get("FormattedID"),teamDepData.USName=us.get("Name");var succDep={DependencyID:predDepData.DependencyID,PredUserStoryName:predDepData.UserStoryName,PredFormattedID:predDepData.FormattedID,PredProjectName:me.ProjectRecord.get("Name"),UserStoryName:"",FormattedID:"",Description:predDepData.Description,Checkpoint:predDepData.Checkpoint,Supported:"No",Assigned:!1,Edited:!1};addSuccDep(us,succDep)}),addedTeamDepsDone(),void 0):(me._loadDependenciesStores=!0,me.PredDepGrid.setLoading(!1),alert("Project "+project.get("Name")+" has no user stories, cannot continue"),void 0)})})}else me._loadDependenciesStores=!0,me.PredDepGrid.setLoading(!1),alert("Error: Could not delete Dependency!")}})}}})},5),Ext.String.format('<div id="{0}"></div>',id)}},{text:"",width:80,resizable:!1,renderer:function(val,meta,predDepRecord){var id=Ext.id();return Ext.defer(function(){var el=Ext.get(id);el&&el.isVisible()&&Ext.widget("button",{renderTo:id,text:"Delete",width:70,handler:function(){me._loadDependenciesStores&&confirm("Confirm Dependency Deletion")&&(me.PredDepGrid.setLoading(!0),me._loadDependenciesStores=!1,me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){if(operation.wasSuccessful()){me._buildDependenciesData();var predDeps=me.DependenciesParsedData.Predecessors.slice(0),predDepData=predDepRecord.data,realDepData=removeDepFromList(predDepData.DependencyID,predDeps),realTeamDeps=getPredecessorsObject(realDepData);if(realTeamDeps.forEach(function(teamDepData){if(""!==teamDepData.PID){var project=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("ObjectID")==teamDepData.PID});me._loadUserStoryByFID(teamDepData.USID,project.get("_ref"),function(us){us&&removeSuccDep(us,predDepData)})}}),realDepData&&realDepData.FormattedID!=predDepData.FormattedID){console.log("moving predDep to new user story",realDepData.FormattedID,predDepData.FormattedID);var oldUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",realDepData.FormattedID,0,!1,!0,!0);oldUserStoryRecord&&removePredDep(oldUserStoryRecord,realDepData)}var newUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",predDepData.FormattedID,0,!1,!0,!0);newUserStoryRecord&&removePredDep(newUserStoryRecord,predDepData),me.CustomPredDepStore.remove(predDepRecord),me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData(),me.CustomPredDepStore.load({callback:function(){me._loadDependenciesStores=!0,me.PredDepGrid.setLoading(!1)}})}})}else me._loadDependenciesStores=!0,me.PredDepGrid.setLoading(!1),alert("Error: Could not delete Dependency!")}}))}})},5),Ext.String.format('<div id="{0}"></div>',id)}}];me.AddPredDepButton=me.add({xtype:"button",text:"+ Add Dependency",style:"margin-bottom:10px",x:0,y:760,listeners:{click:function(){var randomUserStory=me.DependenciesReleaseUserStories[0];if(me.CustomPredDepStore){var model=Ext.create("IntelPredDep",{DependencyID:1*new Date+""+1e7*Math.random(),FormattedID:randomUserStory.get("FormattedID"),UserStoryName:randomUserStory.get("Name"),Description:"",Checkpoint:"",Predecessors:"",Edited:!0});me.CustomPredDepStore.add(model)}}}}),me.PredDepGrid=me.add({xtype:"rallygrid",title:"Predecessor Dependencies",width:1600,height:400,x:0,y:800,scroll:"both",columnCfgs:predDepColumnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0},listeners:{beforeedit:function(){me._isEditing=!0},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var grid=e.grid,predDepRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;if(me._isEditing=!1,console.log("predDep edit:",predDepRecord,field,value,originalValue),value!==originalValue){var previousEdit=predDepRecord.get("Edited");predDepRecord.set("Edited",!0);var userStoryRecord;"UserStoryName"===field?(userStoryRecord=_.find(me.DependenciesReleaseUserStories,function(us){return us.get("Name")===value}),userStoryRecord?predDepRecord.set("FormattedID",userStoryRecord.get("FormattedID")):(predDepRecord.set("UserStoryName",originalValue),predDepRecord.set("Edited",previousEdit))):"FormattedID"===field&&(userStoryRecord=_.find(me.DependenciesReleaseUserStories,function(us){return us.get("FormattedID")===value}),userStoryRecord?predDepRecord.set("UserStoryName",userStoryRecord.get("Name")):(predDepRecord.set("FormattedID",originalValue),predDepRecord.set("Edited",previousEdit)))}}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomPredDepStore}),me.CustomSuccDepStore=Ext.create("Ext.data.Store",{data:me.DependenciesParsedData.Successors.slice(0),autoSync:!0,model:"IntelSuccDep",proxy:{type:"intelcustomproxy",keyField:"DependencyID"},limit:1/0,listeners:{load:function(customSuccDepStore,customSuccDepRecs){var realSuccDepsData=me.DependenciesParsedData.Successors.slice(0);console.log("syncing succDeps with current userStories",customSuccDepRecs,realSuccDepsData);for(var i=0;customSuccDepRecs.length>i;++i){var depRec=customSuccDepRecs[i],depID=depRec.get("DependencyID"),realDep=removeDepFromList(depID,realSuccDepsData),dirtyType=getDirtyType(depRec,realDep);"New"!==dirtyType&&"Edited"!==dirtyType&&("Deleted"===dirtyType?customSuccDepStore.remove(depRec):(depRec.data=realDep,depRec.commit()))}realSuccDepsData.forEach(function(realDep){console.log("adding succDep",realDep),customSuccDepStore.add(Ext.create("IntelSuccDep",realDep))})}}});var succDepColumnCfgs=[{text:"Predecesor Project",dataIndex:"PredProjectName",width:160,resizable:!1,sortable:!0},{text:"Predecesor US#",dataIndex:"PredFormattedID",width:80,resizable:!1,sortable:!0},{text:"Predecesor UserStory",dataIndex:"PredUserStoryName",width:160,resizable:!1,sortable:!0},{text:"Dependency Description",dataIndex:"Description",width:160,resizable:!1,editor:!1,sortable:!0},{text:"Checkpoint",dataIndex:"Checkpoint",width:80,resizable:!1,editor:!1,sortable:!0},{text:"Supported",dataIndex:"Supported",width:80,resizable:!1,tdCls:"intel-editor-cell",editor:{xtype:"combobox",width:80,store:Ext.create("Ext.data.Store",{fields:["Sup"],data:[{Sup:"Yes"},{Sup:"No"}]}),editable:!1,displayField:"Sup",listeners:{focus:function(combo){combo.expand()}}},renderer:function(val,meta){return meta.tdCls="No"==val?"intel-not-supported-cell":"intel-supported-cell",val},sortable:!0},{text:"Supporting US#",dataIndex:"FormattedID",tdCls:"intel-editor-cell",width:120,resizable:!1,editor:{xtype:"combobox",width:120,store:Ext.create("Ext.data.Store",{fields:["FormattedID"],data:_.map(me.DependenciesReleaseUserStories,function(usr){return{FormattedID:usr.get("FormattedID")}}),sorters:{property:"FormattedID"}}),enableKeyEvents:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filters.getRange().forEach(function(filter){me.store.removeFilter(filter)}),me.store.filterBy(function(item){return item.get("FormattedID").indexOf(me.getRawValue())>-1})}},focus:function(combo){combo.expand()}},displayField:"FormattedID"},sortable:!0,renderer:function(val){return val?val:"-"
}},{text:"UserStory",dataIndex:"UserStoryName",width:160,resizable:!1,tdCls:"intel-editor-cell",editor:{xtype:"combobox",store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.DependenciesReleaseUserStories,function(usr){return{Name:usr.get("Name")}}),sorters:{property:"Name"}}),enableKeyEvents:!0,queryMode:"local",listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var me=this;me.store.filters.getRange().forEach(function(filter){me.store.removeFilter(filter)}),me.store.filterBy(function(item){return item.get("Name").indexOf(me.getRawValue())>-1})}},focus:function(combo){combo.expand()}},displayField:"Name"},sortable:!0,renderer:function(val){return val?val:"-"}},{text:"",width:130,resizable:!1,renderer:function(val,meta,succDepRecord){var id=Ext.id();return Ext.defer(function(){var currentFID=succDepRecord.get("FormattedID"),btnText=""===currentFID?"":"Remove UserStory",el=Ext.get(id);el&&el.isVisible()&&btnText.length&&Ext.widget("button",{renderTo:id,text:btnText,padding:3,width:120,handler:function(){succDepRecord.set("Edited",!0),succDepRecord.set("Assigned",!1),succDepRecord.set("FormattedID",""),succDepRecord.set("UserStoryName","")}})},5),Ext.String.format('<div id="{0}"></div>',id)}},{text:"",width:80,resizable:!1,renderer:function(val,meta,succDepRecord,r,c,s){var id=Ext.id();return Ext.defer(function(){var realSuccDepData=removeDepFromList(succDepRecord.get("DependencyID"),me.DependenciesParsedData.Successors.slice(0)),dirtyType=getDirtyType(succDepRecord,realSuccDepData);dirtyType="Edited"===dirtyType?"Undo":"";var el=Ext.get(id);el&&el.isVisible()&&dirtyType.length&&Ext.widget("button",{renderTo:id,text:dirtyType,width:70,handler:function(){s.remove(succDepRecord),s.load()}})},5),Ext.String.format('<div id="{0}"></div>',id)}},{text:"",width:80,resizable:!1,renderer:function(val,meta,succDepRecord){var id=Ext.id();return Ext.defer(function(){var realSuccDepData=removeDepFromList(succDepRecord.get("DependencyID"),me.DependenciesParsedData.Successors.slice(0)),dirtyType=getDirtyType(succDepRecord,realSuccDepData);dirtyType="Edited"===dirtyType?"Update":"";var el=Ext.get(id);el&&el.isVisible()&&dirtyType.length&&Ext.widget("button",{renderTo:id,text:dirtyType,width:70,handler:function(){me._loadDependenciesStores&&(me._loadDependenciesStores=!1,me.SuccDepGrid.setLoading(!0),me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){if(operation.wasSuccessful()){me._buildDependenciesData();var succDepData=succDepRecord.data,realSuccDeps=me.DependenciesParsedData.Successors.slice(0),realDepData=removeDepFromList(succDepData.DependencyID,realSuccDeps),project=_.find(me.ValidProjects,function(projectRecord){return projectRecord.get("Name")==succDepData.PredProjectName});if(!project)return me._loadDependenciesStores=!0,me.SuccDepGrid.setLoading(!1),alert("could not find project "+succDepData.PredProjectName),void 0;succDepData.FormattedID&&(succDepData._realFormattedID=succDepData.FormattedID,succDepData._realUserStoryName=succDepData.UserStoryName);var reloadDeps=function(){me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData(),me._loadDependenciesStores=!0,me.SuccDepGrid.setLoading(!1)}})},alertAndDelete=function(msg){alert(msg),console.log("removing succDep from user story",realDepData._realFormattedID,succDepData._realFormattedID);var userStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",realDepData._realFormattedID,0,!1,!0,!0);userStoryRecord&&removeSuccDep(userStoryRecord,realDepData),me.DependenciesUserStoryStore.load({callback:function(userStoryRecords,operation){me._buildDependenciesData(),me._loadDependenciesStores=!0,me.SuccDepGrid.setLoading(!1),me.CustomSuccDepStore.remove(succDepRecord)}})};me._loadUserStoryByFID(succDepData.PredFormattedID,project.get("_ref"),function(us){if(us){var deps=me._getDependencies(us),preds=deps.Preds,predDep=preds[succDepData.DependencyID];if(predDep){var predecessors;try{predecessors=JSON.parse(predDep.Preds)}catch(e){predecessors=[]}for(var i=0;predecessors.length>i;++i)if(predecessors[i].PID==me.ProjectRecord.get("ObjectID")){if(predecessors[i].Sup=succDepData.Supported,predecessors[i].USID=succDepData._realFormattedID,predecessors[i].USName=succDepData._realUserStoryName,predecessors[i].A=succDepData.Assigned,predDep.Preds=JSON.stringify(predecessors,null,"	"),us.set("c_Dependencies",JSON.stringify(deps,null,"	")),us.save(),realDepData&&realDepData._realFormattedID!=succDepData._realFormattedID){console.log("moving succDep to new user story",realDepData._realFormattedID,succDepData._realFormattedID);var oldUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",realDepData._realFormattedID,0,!1,!0,!0);oldUserStoryRecord&&removeSuccDep(oldUserStoryRecord,realDepData)}var newUserStoryRecord=me.DependenciesUserStoryStore.findRecord("FormattedID",succDepData._realFormattedID,0,!1,!0,!0);return newUserStoryRecord&&addSuccDep(newUserStoryRecord,succDepData),succDepRecord.set("Edited",!1),reloadDeps(),void 0}alertAndDelete("Successor removed this dependency. Deleting your dependency now")}else alertAndDelete("Successor removed this dependency. Deleting your dependency now")}else alertAndDelete("Successor UserStory has been deleted. Deleting Dependency Now")})}else me._loadDependenciesStores=!0,me.SuccDepGrid.setLoading(!1),alert("Error: Could not update Dependency!")}}))}})},5),Ext.String.format('<div id="{0}"></div>',id)}}];me.SuccDepGrid=me.add({xtype:"rallygrid",title:"Successor Dependencies",width:1600,height:400,x:0,y:1240,scroll:"both",columnCfgs:succDepColumnCfgs,plugins:[Ext.create("Ext.grid.plugin.CellEditing",{triggerEvent:"cellclick"})],viewConfig:{stripeRows:!0,preserveScrollOnRefresh:!0},listeners:{beforeedit:function(editor,e){return"No"==e.record.get("Supported")&&"Supported"!=e.field?!1:(me._isEditing=!0,!0)},canceledit:function(){me._isEditing=!1},edit:function(editor,e){var grid=e.grid,succDepRecord=e.record,field=e.field,value=e.value,originalValue=e.originalValue;if(me._isEditing=!1,console.log("succDep edit:",succDepRecord,field,value,originalValue),value!==originalValue){var previousEdit=succDepRecord.get("Edited");succDepRecord.set("Edited",!0);var userStoryRecord;"UserStoryName"===field?(userStoryRecord=_.find(me.DependenciesReleaseUserStories,function(us){return us.get("Name")===value}),userStoryRecord?(succDepRecord.set("FormattedID",userStoryRecord.get("FormattedID")),succDepRecord.set("Assigned",!0)):(succDepRecord.set("UserStoryName",originalValue),succDepRecord.set("Edited",previousEdit))):"FormattedID"===field?(userStoryRecord=_.find(me.DependenciesReleaseUserStories,function(us){return us.get("FormattedID")===value}),userStoryRecord?(succDepRecord.set("UserStoryName",userStoryRecord.get("Name")),succDepRecord.set("Assigned",!0)):(succDepRecord.set("FormattedID",originalValue),succDepRecord.set("Edited",previousEdit))):"Supported"===field&&"No"==value&&(succDepRecord.set("Edited",!0),succDepRecord.set("Assigned",!1),succDepRecord.set("FormattedID",""),succDepRecord.set("UserStoryName",""))}}},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,context:this.getContext(),store:me.CustomSuccDepStore})}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name70221",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .x-grid-row.intel-row-30px .x-grid-cell{height:35px !important}.x-grid-row .intel-editor-cell{cursor:pointer !important}.x-grid-row .intel-editor-cell *{cursor:pointer !important}.intel-button-cell{cursor:pointer !important;background:#3f84a4 !important;color:white !important;border-radius:3px !important;position:relative !important;line-height:25px;text-align:center;height:25px !important}.grey-row .x-grid-cell{background-color:rgba(224,224,224,0.15) !important}.grey-row.x-grid-row-selected .x-grid-cell{background-color:rgba(224,224,224,0.25) !important}.red-row .x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.red-row.x-grid-row-selected .x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.green-row .x-grid-cell{background-color:rgba(0,255,0,0.15) !important}.green-row.x-grid-row-selected .x-grid-cell{background-color:rgba(0,255,0,0.25) !important}.x-grid-row .red-cell.x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.x-grid-row-selected .red-cell.x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.intel-team-dep-not-selected .x-grid-cell,.x-grid-row-selected .intel-team-dep-not-selected .x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.intel-team-dep-not-selected.x-grid-row-selected .x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.x-grid-row.intel-no-team-dep-selected .x-grid-cell{background-color:rgba(224,224,224,0.15) !important}.x-grid-row-hover.intel-no-team-dep-selected .x-grid-cell,.x-grid-row-selected.intel-no-team-dep-selected .x-grid-cell{background-color:rgba(224,224,224,0.25) !important}.x-grid-row .intel-not-supported-cell.x-grid-cell{background-color:rgba(255,0,0,0.15) !important}.x-grid-row-selected .intel-not-supported-cell.x-grid-cell{background-color:rgba(255,0,0,0.25) !important}.x-grid-row .intel-supported-cell.x-grid-cell{background-color:rgba(0,255,0,0.15) !important}.x-grid-row-selected .intel-supported-cell.x-grid-cell{background-color:rgba(0,255,0,0.25) !important}
    </style>
</head>
<body>
</body>
</html>
