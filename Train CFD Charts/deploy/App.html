<!DOCTYPE html>
<html>
<head>
    <title>TrainCFDCharts</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.0.1/q.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("WindowListener",{__initWindowEventListener:function(eventName){var me=this;me._windowListeners||(me._windowListeners={}),me._windowListeners[eventName]=[],window.parent["on"+eventName]=function(event){for(var listeners=me._windowListeners[eventName],i=0,len=listeners.length;len>i;++i)listeners[i](event)}},_addWindowEventListener:function(eventName,fn){var me=this;me._windowListeners&&me._windowListeners[eventName]||me.__initWindowEventListener(eventName),me._windowListeners[eventName].push(fn)},_fireParentWindowEvent:function(eventName){var me=this;if(me._windowListeners&&me._windowListeners[eventName])for(var listeners=me._windowListeners[eventName],i=0,len=listeners.length;len>i;++i)listeners[i]()}});
                Ext.define("IframeResize",{requires:["WindowListener"],__applyIframeResize:function(){for(var w=window,p=w.parent,pd=w.parent.document,l=w.location,iframe=pd.querySelector('iframe[src="'+l.pathname+l.search+'"]'),ip1=iframe.parentNode,ip2=iframe.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode,height=0,next=this.down();next;)height+=next.getHeight()+1*next.getEl().getMargin("t")+1*next.getEl().getMargin("b"),next=next.next();height+=50,ip1.style.height=height+"px",ip2.style.height=height+"px",iframe.style.height=height+"px"},_initIframeResize:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me.__applyIframeResize()})}});
                Ext.define("PrettyAlert",{requires:["WindowListener"],_alert:function(title,str){Ext.MessageBox.alert(title||"",str||"").setY(this.__msgBoxY),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20)},_confirm:function(title,str,fn){Ext.MessageBox.confirm(title||"",str||"",fn||function(){}).setY(this.__msgBoxY),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20)},__applyMessageBoxConfig:function(){var w=window,p=w.parent,pd=w.parent.document,l=w.location,iframe=pd.querySelector('iframe[src="'+l.pathname+l.search+'"]'),ph=p.getWindowHeight(),ps=p.getScrollY(),ofy=ps+iframe.getBoundingClientRect().top,iyOffset=Math.floor(ph/2-ofy+ps-50);this.__msgBoxY=0>iyOffset?0:iyOffset},_initPrettyAlert:function(){var me=this;me._addWindowEventListener&&(me._addWindowEventListener("resize",function(){me.__applyMessageBoxConfig()}),me._addWindowEventListener("scroll",function(){me.__applyMessageBoxConfig()}))}});
                Ext.define("IntelWorkweek",{_getWorkweek:function(date){var oneDay=864e5,yearStart=new Date(date.getFullYear(),0,1),dayIndex=yearStart.getDay(),ww01Start=yearStart-dayIndex*oneDay,timeDiff=date-ww01Start,dayDiff=timeDiff/oneDay,ww=Math.floor(dayDiff/7)+1,leap=0===date.getFullYear()%4,weekCount=leap&&dayIndex>=5||!leap&&6===dayIndex?53:52;return ww>weekCount?1:ww},_getWeekCount:function(date){var leap=0===date.getFullYear()%4,day=new Date(date.getFullYear(),0,1).getDay();return leap&&day>=5||!leap&&6===day?53:52},_getWorkweeks:function(startDate,endDate){var i,sd_week=this._getWorkweek(startDate),ed_week=this._getWorkweek(endDate),week_count=this._getWeekCount(startDate),weeks=[];if(sd_week>ed_week){for(i=sd_week;week_count>=i;++i)weeks.push("ww"+i);for(i=1;ed_week>=i;++i)weeks.push("ww"+i)}else for(i=sd_week;ed_week>=i;++i)weeks.push("ww"+i);return weeks}});
                Ext.define("ReleaseQuery",{_loadReleasesInTheFuture:function(projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID},{property:"ReleaseDate",operator:">=",value:(new Date).toISOString()}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),deferred.resolve(releaseStore)},single:!0}}}),deferred.promise},_loadReleasesWithName:function(releaseName,trainName){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:releaseName},{property:"Project.Name",operator:"contains",value:trainName},{property:"Project.Children.Name",operator:"=",value:""},{property:"Project.Name",operator:"!contains",value:" ART"}],listeners:{load:{fn:function(store,records){console.log("releasesWithName loaded:",records),deferred.resolve(store)},single:!0}}}),deferred.promise},_getScopedRelease:function(releaseRecords,projectOID,appPrefs){var me=this,d=new Date,rs=releaseRecords,prefOID=appPrefs&&appPrefs.projs[projectOID]&&appPrefs.projs[projectOID].Release;return prefOID&&_.find(rs,function(r){return r.data.ObjectID==prefOID})||_.find(rs,function(r){return new Date(r.data.ReleaseDate)>=d&&d>=new Date(r.data.ReleaseStartDate)})||_.reduce(rs,function(best,r){if(null===best)return r;var d1=new Date(best.data.ReleaseStartDate),d2=new Date(r.data.ReleaseStartDate),now=new Date;return Math.abs(d1-now)<Math.abs(d2-now)?best:r},null)}});
                Ext.define("FastCfdCalculator",{extend:"Rally.data.lookback.SnapshotStore",scheduleStates:["Undefined","Defined","In-Progress","Completed","Accepted"],constructor:function(){this.callParent(arguments)},_getDates:function(){for(var dates=[],curDay=this.startDate,day=864e5;this.endDate>=curDay;){var n=curDay.getDay();0!==n&&6!==n&&dates.push(curDay),curDay=new Date(1*curDay+day)}return dates},_dateToStringDisplay:function(date){return Ext.Date.format(date,"m/d/Y")},_getIndexHelper:function(d,ds){for(var curVal=ds.length/2,curInt=curVal>>0,div=curVal/2,lastInt=-1;curInt!==lastInt;){if(ds[curInt]===d)return curInt;ds[curInt]>d?curVal-=div:curVal+=div,div/=2,lastInt=curInt,curInt=curVal>>0}return curInt},_getIndexOnOrBefore:function(d,ds){if(0===ds.length)return-1;var pos=this._getIndexHelper(d,ds);return 0===pos?d>=ds[pos]?pos:-1:d>=ds[pos]?pos:pos-1},_getIndexOnOrAfter:function(d,ds){if(0===ds.length)return-1;var pos=this._getIndexHelper(d,ds);return pos===ds.length-1?ds[pos]>=d?pos:-1:ds[pos]>=d?pos:pos+1},runCalculation:function(items){if(!this.scheduleStates||!this.startDate||!this.endDate)return console.log("invalid constructor config",this),void 0;for(var dates=this._getDates(),day=864e5,dateMapTemplate=_.map(Array(dates.length),function(){return 0}),totals=_.reduce(this.scheduleStates,function(map,ss){return map[ss]=dateMapTemplate.slice(),map},{}),itemIndex=0,len=items.length;len>itemIndex;++itemIndex){var item=items[itemIndex].raw,iStart=new Date(item._ValidFrom),iEnd=new Date(item._ValidTo),state=item.ScheduleState,pe=item.PlanEstimate;if(pe&&iStart/day>>0!==iEnd/day>>0){var startIndex=this._getIndexOnOrAfter(iStart,dates),endIndex=this._getIndexOnOrBefore(iEnd,dates);if(-1!==startIndex&&-1!==endIndex)for(var i=startIndex;endIndex>=i;++i)totals[state][i]+=pe}}return{categories:_.map(dates,function(d){return this._dateToStringDisplay(d)},this),series:_.reduce(this.scheduleStates,function(ar,ss){return ar.concat([{name:ss,type:"area",dashStyle:"Solid",data:totals[ss]}])},[])}}});
                Ext.define("ChartUpdater",{requires:["IntelWorkweek"],__tooltipfunc:function(){return"<b>100% Complete</b><br /><b>"+this.x+"</b> ("+window.Datemap[this.point.x]+")"},_updateChartData:function(data,opts){var me=this,now=new Date;opts&&opts.noDatemap||(window.Datemap=[]);var total=new Date(data.categories[0])>now?0:_.reduce(data.series,function(sum,s){return sum+(s.data[s.data.length-1]||0)},0)||0,idealTrend,ratio;if(opts&&opts.noTrends||(idealTrend={type:"spline",dashStyle:"Solid",name:"Ideal",data:Array(data.categories.length)},ratio=total/(data.categories.length-1)||0,idealTrend.data=_.map(idealTrend.data,function(e,i){return Math.round(100*(0+i*ratio))/100})),_.each(data.categories,function(c,i,a){var d=new Date(c);a[i]="WW"+me._getWorkweek(d),opts&&opts.noDatemap||(window.Datemap[i]=c),d>now&&_.each(data.series,function(s,j){s.data=s.data.slice(0,i).concat(_.map(Array(a.length-i),function(){return 0}))})}),!opts||!opts.noTrends){var s=_.find(data.series,function(s){return"Accepted"===s.name}),i,len,projectedTrend={type:"spline",dashStyle:"Solid",name:"Projected",data:s.data.slice()},begin=0,end=projectedTrend.data.length-1;for(i=1;projectedTrend.data.length>i;++i)if(null!==projectedTrend.data[i]&&0!==projectedTrend.data[i]){begin=i-1;break}for(i=end;i>=begin;--i)if(0!==projectedTrend.data[i]){end=i;break}for(ratio=end===begin?0:(projectedTrend.data[end]-0)/(end-begin),projectedTrend.data=_.map(projectedTrend.data,function(p,j){return j>=begin?Math.round(100*(0+(j-begin)*ratio))/100:p}),i=1,len=projectedTrend.data.length;len>i;++i)if(projectedTrend.data[i]>=total){projectedTrend.data[i]={color:"red",marker:{enabled:!0,lineWidth:4,symbol:"circle",fillColor:"red",lineColor:"red"},y:projectedTrend.data[i]};break}data.series.push(projectedTrend),data.series.push(idealTrend)}return data}});
                console={log:function(){}},preferenceName="intel-ART-CFD",Ext.define("TrainCfdCharts",{extend:"Rally.app.App",requires:["FastCfdCalculator"],mixins:["WindowListener","PrettyAlert","IframeResize","IntelWorkweek","ReleaseQuery","ChartUpdater"],minWidth:910,_chartColors:["#ABABAB","#E57E3A","#E5D038","#0080FF","#3A874F","#000000","#26FF00"],_defaultChartConfig:{chart:{defaultSeriesType:"area",zoomType:"xy"},xAxis:{tickmarkPlacement:"on",title:{text:"Days",margin:10},labels:{y:20}},yAxis:{title:{text:"Points"},labels:{x:-5,y:4}},tooltip:{formatter:function(){return"<b>"+this.x+"</b> ("+window.Datemap[this.point.x]+")<br />"+this.series.name+": "+this.y}},plotOptions:{series:{marker:{enabled:!1,states:{hover:{enabled:!0}}},groupPadding:.01},area:{stacking:"normal",lineColor:"#666666",lineWidth:2,marker:{enabled:!1}}}},_getConfiguredChartTicks:function(startDate,endDate,width){var pixelTickWidth=40,ticks=Math.floor(width/pixelTickWidth),days=Math.floor((1*endDate-1*startDate)/(432e6/7)),interval=5*Math.floor(Math.floor(days/ticks)/5);return 5>interval?5:interval},_loadModels:function(cb){Rally.data.ModelFactory.getModel({type:"Project",scope:this,success:function(model){this.Project=model,cb()}})},_loadProject:function(project,cb){var me=this;me.Project.load(project.ObjectID,{fetch:["ObjectID","Releases","Children","Parent","Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:function(record,operation){operation.wasSuccessful()?cb(record):(me._alert("ERROR","failed to retreive project: "+project.ObjectID),cb())}})},_loadSnapshotStores:function(){var me=this,promises=[];return me.AllSnapshots=[],me.TeamStores={},me.ReleasesWithName.forEach(function(releaseRecord){var deferred=Q.defer();promises.push(deferred.promise),Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null},sort:{_ValidFrom:1},compress:!0,find:{_TypeHierarchy:-51038,Children:null,PlanEstimate:{$gte:0},Release:releaseRecord.get("ObjectID")},fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState","PlanEstimate"],listeners:{load:function(store,records){records.length>0&&(me.TeamStores[releaseRecord.data.Project.Name]=records,me.AllSnapshots=me.AllSnapshots.concat(records)),deferred.resolve()},single:!0}})}),Q.all(promises).then(function(){console.log("all snapshots done",me.AllSnapshots,me.TeamStores)})},_loadAllChildReleases:function(){var me=this,releaseName=me.ReleaseRecord.data.Name,trainName=me.TrainRecord.data.Name.split(" ART")[0];return me._loadReleasesWithName(releaseName,trainName).then(function(releaseStore){me.ReleasesWithName=releaseStore.getRange()})},_loadPreferences:function(cb){var me=this,uid=me.getContext().getUser().ObjectID;Rally.data.PreferenceManager.load({appID:me.getAppId(),filterByName:preferenceName+uid,success:function(prefs){prefs=prefs[preferenceName+uid];try{prefs=JSON.parse(prefs)}catch(e){prefs={projs:{}}}me.AppPrefs=prefs,console.log("loaded prefs",prefs),cb()}})},_savePreferences:function(prefs,cb){var me=this,s={},uid=me.getContext().getUser().ObjectID;prefs={projs:prefs.projs},s[preferenceName+uid]=JSON.stringify(prefs),console.log("saving prefs",prefs),Rally.data.PreferenceManager.update({appID:me.getAppId(),settings:s,success:cb,scope:me})},_projectInWhichTrain:function(projectRecord,cb){var me=this;projectRecord||cb();var split=projectRecord.data.Name.split(" ART");if(split.length>1)cb(projectRecord);else{var parent=projectRecord.data.Parent;parent?me._loadProject(parent,function(parentRecord){me._projectInWhichTrain(parentRecord,cb)}):cb()}},_resizeWhenRendered:function(){var me=this;setTimeout(function(){me._fireParentWindowEvent("resize")},0)},_reloadEverything:function(){var me=this;me.setLoading(!0),me._loadAllChildReleases().then(function(){me._loadSnapshotStores().then(function(){me.removeAll(),me.setLoading(!1),me._renderReleasePicker(),me._renderCharts()})})},_loadReleases:function(){var me=this;me._loadReleasesInTheFuture(me.TrainRecord).then(function(releaseStore){me.ReleaseStore=releaseStore;var currentRelease=me._getScopedRelease(me.ReleaseStore.getRange(),me.TrainRecord.data.ObjectID,me.AppPrefs);currentRelease?(me.ReleaseRecord=currentRelease,console.log("release loaded",currentRelease),me._reloadEverything()):(me.setLoading(!1),me._alert("ERROR","This ART has no valid releases"))})},launch:function(){var me=this;me._initPrettyAlert(),me._initIframeResize(),me.setLoading(!0),Rally&&Rally.sdk&&Rally.sdk.dependencies&&Rally.sdk.dependencies.Analytics&&Rally.sdk.dependencies.Analytics.load(function(){me._loadPreferences(function(){me._loadModels(function(){var scopeProject=me.getContext().getProject();me._loadProject(scopeProject,function(scopeProjectRecord){me._projectInWhichTrain(scopeProjectRecord,function(trainRecord){trainRecord?(me.TrainRecord=trainRecord,console.log("train loaded:",trainRecord),me._loadReleases()):(me.removeAll(),me._alert("ERROR",'Project "'+scopeProject.Name+'" not a train or sub-project of train'))})})})})})},_renderReleasePicker:function(){var me=this;me.ReleasePicker=me.add({xtype:"combobox",margin:"0 0 10 0",store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.ReleaseStore.getRecords(),function(r){return{Name:r.get("Name")}})}),displayField:"Name",fieldLabel:"Release:",editable:!1,value:me.ReleaseRecord.get("Name"),listeners:{select:function(combo,records){if(me.ReleaseRecord.get("Name")!==records[0].get("Name")){me.ReleaseRecord=me.ReleaseStore.findExactRecord("Name",records[0].get("Name"));var pid=me.TrainRecord.data.ObjectID;me.AppPrefs.projs[pid]||(me.AppPrefs.projs[pid]={}),me.AppPrefs.projs[pid].Release=me.ReleaseRecord.data.ObjectID,me._savePreferences(me.AppPrefs,function(){me._reloadEverything()})}},focus:function(combo){combo.expand()}}})},_renderCharts:function(){var me=this;if(0===me.AllSnapshots.length)return me._alert("ERROR",me.TrainRecord.data.Name+" has no data for release: "+me.ReleaseRecord.data.Name),void 0;me.panel=me.add({xtype:"container",layout:"column",width:"100%"}),me.trainPanel=me.panel.add({xtype:"container",layout:"column",columnWidth:1});var calc=Ext.create("FastCfdCalculator",{startDate:me.ReleaseRecord.get("ReleaseStartDate"),endDate:me.ReleaseRecord.get("ReleaseDate")});me.trainPanel.add({xtype:"panel",html:"",columnWidth:.16}),me.trainPanel.add({xtype:"rallychart",columnWidth:.66,loadMask:!1,chartColors:me._chartColors,chartData:me._updateChartData(calc.runCalculation(me.AllSnapshots)),chartConfig:Ext.Object.merge({chart:{height:400},legend:{borderWidth:0,width:500,itemWidth:100},title:{text:me.TrainRecord.get("Name")},subtitle:{text:me.ReleaseRecord.get("Name")},xAxis:{tickInterval:me._getConfiguredChartTicks(me.ReleaseRecord.get("ReleaseStartDate"),me.ReleaseRecord.get("ReleaseDate"),.66*me.getWidth())}},me._defaultChartConfig),listeners:{afterrender:me._resizeWhenRendered.bind(me)}}),me.trainPanel.add({xtype:"panel",html:"",columnWidth:.16});for(var projectName in me.TeamStores)me.panel.add({xtype:"rallychart",columnWidth:.32,loadMask:!1,height:360,padding:"20px 0 0 0",chartColors:me._chartColors,chartData:me._updateChartData(calc.runCalculation(me.TeamStores[projectName]),{noDatemap:!0}),chartConfig:Ext.Object.merge({chart:{height:300},legend:{enabled:!1},title:{text:null},subtitle:{text:projectName},xAxis:{tickInterval:me._getConfiguredChartTicks(me.ReleaseRecord.get("ReleaseStartDate"),me.ReleaseRecord.get("ReleaseDate"),.32*me.getWidth())}},me._defaultChartConfig),listeners:{afterrender:me._resizeWhenRendered.bind(me)}})}});

            Rally.launchApp('TrainCfdCharts', {
                name:"TrainCFDCharts",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
