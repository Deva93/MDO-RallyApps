<!DOCTYPE html>
<html>
<head>
    <title>.</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_showError:function(text){this.add({xtype:"text",text:text})},_loadModels:function(cb){Rally.data.ModelFactory.getModel({type:"Project",scope:this,success:function(model){this.Project=model,cb()}})},_loadProject:function(project,cb){var me=this;me.Project.load(project.ObjectID,{fetch:["ObjectID","Releases","Children","Parent","Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:function(record,operation){operation.wasSuccessful()?cb(record):(me._showError("failed to retreive project: "+project.ObjectID),cb())}})},_loadReleases:function(cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",operator:"contains",value:me.TrainRecord.get("Name").split(" ART ")[0]},{property:"Project.ObjectID",value:me.TrainRecord.get("ObjectID")}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),me.ReleaseStore=releaseStore,cb()},single:!0}}})},_loadReleasesWithName:function(cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Project","Name","ObjectID"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:me.ReleaseRecord.get("Name")},{property:"Project.Name",operator:"contains",value:me.TrainRecord.get("Name").split(" ART ")[0]}],listeners:{load:{fn:function(store,records){console.log("Releases loaded:",records),me.ReleasesWithName=records,cb()},single:!0}}})},_loadSnapshotStore:function(cb){var me=this;me.AllSnapshots=[],me.TeamStores={};var finished=-1,done=function(){++finished==me.ReleasesWithName.length&&(console.log("all snapshots done",me.AllSnapshots,me.TeamStores),cb())};done(),me.ReleasesWithName.forEach(function(releaseRecord){Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,compress:!0,context:{workspace:me.getContext().getWorkspace()._ref,project:releaseRecord.get("Project")._ref},find:{_TypeHierarchy:{$in:["HierarchicalRequirement","Defect"]},Release:releaseRecord.get("ObjectID")},fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState","PlanEstimate"],listeners:{load:function(store,records){records.length>0&&(records=_.map(records,function(ss){return ss.raw}),me.TeamStores[releaseRecord.get("Project").Name]=records,me.AllSnapshots=me.AllSnapshots.concat(records)),done()}}})})},_projectInWhichTrain:function(projectRecord,cb){var me=this;projectRecord||cb();var split=projectRecord.data.Name.split(" ART ");if(split.length>1)cb(projectRecord);else{var parent=projectRecord.data.Parent;parent?me._loadProject(parent,function(parentRecord){me._projectInWhichTrain(parentRecord,cb)}):cb()}},_getCurrentOrFirstRelease:function(){var me=this,d=new Date,rs=me.ReleaseStore.getRecords();if(rs.length){for(var i=0;rs.length>i;++i)if(new Date(rs[i].data.ReleaseDate)>=d&&d>=new Date(rs[i].data.ReleaseStartDate))return rs[i];return rs[0]}},_defineClasses:function(){Ext.define("Intel.TrainCFDCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{stateFieldValues:["Undefined","Defined","In-Progress","Completed","Accepted"]},getMetrics:function(){return _.map(this.getStateFieldValues(),function(stateFieldValue){return{as:stateFieldValue,allowedValues:[stateFieldValue],groupByField:"ScheduleState",f:"groupBySum",field:"PlanEstimate",display:"area"}},this)}})},_getWorkweek:function(date){var oneDay=864e5,yearStart=new Date(date.getFullYear(),0,1),dayIndex=yearStart.getDay(),ww01Start=yearStart-dayIndex*oneDay,timeDiff=date-ww01Start,dayDiff=timeDiff/oneDay;return Math.floor(dayDiff/7)+1},_getWeekCount:function(date){var leap=0===date.getFullYear()%4,day=new Date(date.getFullYear(),0,1).getDay();return leap&&day>=5||!leap&&6===day?53:52},_getWorkweeks:function(){var me=this,i,start=me.ReleaseRecord.get("ReleaseStartDate"),end=me.ReleaseRecord.get("ReleaseDate"),sd_week=me._getWorkweek(start),ed_week=me._getWorkweek(end),week_count=me._getWeekCount(start),weeks=[];if(sd_week>ed_week){for(i=sd_week;week_count>=i;++i)weeks.push({Week:"ww"+i});for(i=1;ed_week>=i;++i)weeks.push({Week:"ww"+i})}else for(i=sd_week;ed_week>=i;++i)weeks.push({Week:"ww"+i});return weeks},launch:function(){var me=this;me._defineClasses(),me._showError("Loading Data..."),me._loadModels(function(){var scopeProject=me.getContext().getProject();me._loadProject(scopeProject,function(scopeProjectRecord){me._projectInWhichTrain(scopeProjectRecord,function(trainRecord){trainRecord?(me.TrainRecord=trainRecord,console.log("train loaded:",trainRecord),me._loadReleases(function(){var currentRelease=me._getCurrentOrFirstRelease();currentRelease?(me.ReleaseRecord=currentRelease,console.log("release loaded",currentRelease),me._loadReleasesWithName(function(){me._loadSnapshotStore(function(){me._renderStuff()})})):(me.removeAll(),me._showError("This ART has no valid releases"))})):(me.removeAll(),me._showError('Project "'+scopeProject.Name+'" not a train or sub-project of train'))})})})},_fixData:function(chartData){var me=this,currentDate=new Date;return chartData.categories.forEach(function(e,i,a){new Date(e)>currentDate&&chartData.series.forEach(function(e){for(var j=i;e.data.length>j;++j)e.data[j]=0}),a[i]="WW"+me._getWorkweek(new Date(e))}),chartData},_renderStuff:function(){var me=this;return 0===me.AllSnapshots.length?(me.removeAll(),me._showError(me.TrainRecord.get("Name")+" has no data for release: "+me.ReleaseRecord.get("Name")),void 0):(Rally&&Rally.sdk&&Rally.sdk.dependencies&&Rally.sdk.dependencies.Analytics?Rally.sdk.dependencies.Analytics.load(function(){me.removeAll(),me.ReleasePicker=me.add({xtype:"combobox",margin:"0 0 10 0",store:Ext.create("Ext.data.Store",{fields:["Name"],data:_.map(me.ReleaseStore.getRecords(),function(r){return{Name:r.get("Name")}})}),displayField:"Name",fieldLabel:"Release:",editable:!1,value:me.ReleaseRecord.get("Name"),listeners:{select:function(combo,records){me.ReleaseRecord.get("Name")!==records[0].get("Name")&&(me.ReleaseRecord=me.ReleaseStore.findRecord("Name",records[0].get("Name")),setTimeout(function(){me._loadReleasesWithName(function(){me._loadSnapshotStore(function(){me.removeAll(),me._renderStuff()})})},0))},focus:function(combo){combo.expand()}}}),me.panel=me.add({xtype:"container",layout:"column",width:"100%"}),me.trainPanel=me.panel.add({xtype:"container",layout:"column",columnWidth:1});var calc=Ext.create("Intel.TrainCFDCalculator",{startDate:me.ReleaseRecord.get("ReleaseStartDate"),endDate:me.ReleaseRecord.get("ReleaseDate")});me.trainPanel.add({xtype:"panel",html:"",columnWidth:.16}),me.trainPanel.add({xtype:"rallychart",columnWidth:.66,loadMask:!1,chartData:me._fixData(calc.runCalculation(me.AllSnapshots)),chartColors:["#ABABAB","#E57E3A","#E5D038","#0080FF","#3A874F"],chartConfig:{chart:{zoomType:"xy",height:400,width:900},legend:{borderWidth:0},title:{text:me.TrainRecord.get("Name")},subtitle:{text:me.ReleaseRecord.get("Name")},xAxis:{tickmarkPlacement:"on",tickInterval:5,title:{text:"WorkWeek"},labels:{rotation:-45}},yAxis:[{title:{text:"Plan Estimate (Points)"}}],plotOptions:{series:{marker:{enabled:!1}},area:{stacking:"normal"}}}}),me.trainPanel.add({xtype:"panel",html:"",columnWidth:.16});for(var projectName in me.TeamStores)me.panel.add({xtype:"rallychart",chartData:me._fixData(calc.runCalculation(me.TeamStores[projectName])),columnWidth:.33,loadMask:!1,height:400,padding:"50px 0 0 0",chartColors:["#ABABAB","#E57E3A","#E5D038","#0080FF","#3A874F"],chartConfig:{chart:{zoomType:"xy",height:300},legend:{enabled:!1},title:{text:null},subtitle:{text:projectName},xAxis:{tickmarkPlacement:"on",tickInterval:10,title:{text:"WorkWeek"},labels:{rotation:-45}},yAxis:[{title:{text:"Plan Estimate (Points)"}}],plotOptions:{series:{marker:{enabled:!1}},area:{stacking:"normal"}}}})}):(me.removeAll(),me._showError("Cannot load Rally Analytics")),void 0)}});

            Rally.launchApp('CustomApp', {
                name:".",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
