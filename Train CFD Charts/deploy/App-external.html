<!DOCTYPE html>
<html>
<head>
    <title>.</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_showError:function(text){this.add({xtype:"text",text:text})},_loadProjectModel:function(cb){Rally.data.ModelFactory.getModel({type:"Project",scope:this,success:function(model){this.Project=model,cb()}})},_loadProject:function(project,cb){var me=this;me.Project.load(project.ObjectID,{fetch:["ObjectID","Releases","Children","Parent","Name","_ref"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:function(record,operation){operation.wasSuccessful()?cb(record):me._showError("failed to retreive project: "+project.ObjectID)}})},_loadReleaseStore:function(releaseName,trainName,cb){var me=this;Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,fetch:["ObjectID","Project","Name","_ref"],filters:[{property:"Name",value:releaseName}],context:{workspace:me.getContext().getWorkspace()._ref,project:null},limit:1/0,listeners:{load:function(store,records){me.Releases=[],records.forEach(function(record){var name=record.get("Project").Name;name&&-1!=name.indexOf(trainName)&&me.Releases.push(record)}),console.log("Releases loaded: ",me.Releases),cb()}}})},_projectInWhichTrain:function(projectRecord,cb){var me=this;projectRecord||cb();var split=projectRecord.get("Name").split(" ART ");if(split.length>1)cb(projectRecord);else{var parent=projectRecord.get("Parent");parent?me._loadProject(parent,function(parentRecord){me._projectInWhichTrain(parentRecord,cb)}):cb()}},_getScrumRecords:function(projectRecord,cb){var me=this,projects=[],finished=0,trainName=me.trainRecord.get("Name").split(" ART ")[0];me.Releases.forEach(function(releaseRecord){me._loadProject(releaseRecord.get("Project"),function(projectRecord){-1!=projectRecord.get("Name").indexOf(trainName)&&projects.push(projectRecord),++finished==me.Releases.length&&cb(projects)})})},_defineClasses:function(){Ext.define("Intel.trainRelease.CFDCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{stateFieldValues:["Undefined","Defined","In-Progress","Completed","Accepted"]},constructor:function(config){this.initConfig(config),this.callParent(arguments)},getMetrics:function(){return _.map(this.getStateFieldValues(),function(stateFieldValue){return{as:stateFieldValue,allowedValues:[stateFieldValue],groupByField:"ScheduleState",f:"groupBySum",field:"PlanEstimate",display:"area"}},this)}}),Ext.define("Rally.ui.chart.ChartFix",{extend:"Rally.ui.chart.Chart",_haveDataToRender:function(){return!0}})},_timeboxScopeValid:function(timeboxScope){var me=this;me._loadProjectModel(function(){var scopeProject=me.getContext().getProject();me._loadProject(scopeProject,function(scopeProjectRecord){scopeProjectRecord?me._projectInWhichTrain(scopeProjectRecord,function(trainRecord){trainRecord?(me.trainRecord=trainRecord,console.log("train loaded:",trainRecord),me.releaseRecord=timeboxScope.record,console.log("Release name: ",me.releaseRecord.get("Name")),me._loadReleaseStore(me.releaseRecord.get("Name"),me.trainRecord.get("Name").split(" ART ")[0],function(){me._renderCharts()})):me._showError('Project "'+scopeProject.Name+'" not a train or sub-project of train')}):me._showError("could not load project: "+scopeProject.Name)})})},launch:function(){var me=this;me._defineClasses();var timeboxScope=me.getContext().getTimeboxScope();timeboxScope&&"release"==timeboxScope.type?me._timeboxScopeValid(timeboxScope):me._showError("please scope page to a release timebox")},onTimeboxScopeChange:function(timeboxScope){this._timeboxScopeValid(timeboxScope)},_renderCharts:function(){var me=this,trainRecord=me.trainRecord,releaseRecord=this.releaseRecord,startDate=new Date(releaseRecord.get("ReleaseStartDate")),endDate=new Date(releaseRecord.get("ReleaseDate"));console.log(startDate,endDate),me._getScrumRecords(trainRecord,function(scrumRecords){console.log("scrums loaded: ",scrumRecords);var scrumIDs=[];scrumRecords.forEach(function(scrumRecord){scrumIDs.push(scrumRecord.get("ObjectID"))});var releaseIDs=[];me.Releases.forEach(function(releaseRecord){releaseIDs.push(releaseRecord.get("ObjectID"))}),me.panel&&me.remove(me.panel),me.trainPanel&&me.remove(me.trainPanel),me.panel=me.add({xtype:"container",layout:"column",width:"100%"}),me.trainPanel=me.panel.add({xtype:"container",layout:"column",columnWidth:1}),me._getTrainChart(scrumIDs,releaseIDs,startDate,endDate,me.trainPanel),me.Releases.forEach(function(releaseRecord,index){scrumRecords.forEach(function(scrumRecord){scrumRecord.get("ObjectID")==releaseRecord.get("Project").ObjectID&&me._getScrumChart(scrumRecord,releaseRecord.get("ObjectID"),startDate,endDate,me.panel)})})})},_filterDataByDate:function(data,startDate,endDate){function getWorkWeek(date){var start=new Date(date.getFullYear(),0,0),diff=date-start,oneDay=864e5,day=diff/oneDay;return Math.floor(day/7)}for(var currentDate=new Date,c=data.categories,s=data.series,k,index=c.length-1;index>=0;--index){var d=new Date(data.categories[index]);if(startDate>d||d>endDate){for(k=0;s.length>k;++k)s[k].data.splice(index,1);c.splice(index,1)}if(d>currentDate)for(k=0;s.length>k;++k)s[k].data[index]=0;c[index]="WW"+getWorkWeek(d)}return data},_getTrainChart:function(scrumIDs,releaseIDs,startDate,endDate,panel){var me=this,releaseRecord=me.releaseRecord;Ext.create("Rally.ui.chart.Chart",{columnWidth:.66,storeType:"Rally.data.lookback.SnapshotStore",storeConfig:{find:{_TypeHierarchy:{$in:["Defect","HierarchicalRequirement"]},_ProjectHierarchy:{$in:scrumIDs},Release:{$in:releaseIDs}},fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState","PlanEstimate"],context:{workspace:me.getContext().getWorkspace()._ref},limit:1/0},calculatorType:"Intel.trainRelease.CFDCalculator",calculatorConfig:{startDate:startDate,endDate:endDate},chartColors:["#ABABAB","#E57E3A","#E5D038","#0080FF","#3A874F"],chartConfig:{chart:{zoomType:"xy",height:400,width:900},legend:{borderWidth:0},title:{text:"Train: "+me.trainRecord.get("Name")},subtitle:{text:"Release: "+releaseRecord.get("Name")},xAxis:{tickmarkPlacement:"on",tickInterval:5,title:{text:"WorkWeek"},labels:{rotation:-45}},yAxis:[{title:{text:"Plan Estimate (Points)"}}],plotOptions:{series:{marker:{enabled:!1}},area:{stacking:"normal"}}},listeners:{readyToRender:function(item){var data=item.getChartData();item.setChartData(me._filterDataByDate(data,startDate,endDate));var goodData=!1;Outer:for(var i=0;data.series.length>i;++i)for(var values=data.series[i].data,j=0;values.length>j;++j){if(null===values[j])break Outer;if(0!==values[j]){goodData=!0;break Outer}}goodData?(console.log("train data successfully aggregated",item),panel.add({xtype:"panel",html:"",columnWidth:.16}),panel.add(item),panel.add({xtype:"panel",html:"",columnWidth:.16})):(console.log("showing no data error",item),panel.add({xtype:"text",text:"Train "+me.trainRecord.get("Name")+" has nothing in release "+releaseRecord.get("Name")}))}}})},_getScrumChart:function(scrumRecord,releaseID,startDate,endDate,panel){var me=this,scrumID=scrumRecord.get("ObjectID"),scrumName=scrumRecord.get("Name"),releaseRecord=me.releaseRecord;Ext.create("Rally.ui.chart.Chart",{columnWidth:.33,height:400,padding:"50px 0 0 0",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:{find:{_TypeHierarchy:{$in:["Defect","HierarchicalRequirement"]},_ProjectHierarchy:scrumID,Release:releaseID},fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState","PlanEstimate"],context:{workspace:me.getContext().getWorkspace()._ref},limit:1/0},calculatorType:"Intel.trainRelease.CFDCalculator",calculatorConfig:{startDate:startDate,endDate:endDate},chartColors:["#ABABAB","#E57E3A","#E5D038","#0080FF","#3A874F"],chartConfig:{chart:{zoomType:"xy",height:300},legend:{enabled:!1},title:{text:null},subtitle:{text:"Scrum: "+scrumName},xAxis:{tickmarkPlacement:"on",tickInterval:10,title:{text:"WorkWeek"},labels:{rotation:-45}},yAxis:[{title:{text:"Plan Estimate (Points)"}}],plotOptions:{series:{marker:{enabled:!1}},area:{stacking:"normal"}}},listeners:{readyToRender:function(item){var data=item.getChartData();item.setChartData(me._filterDataByDate(data,startDate,endDate));for(var goodData=!1,i=0;data.series.length>i;++i)for(var values=data.series[i].data,j=0;values.length>j;++j){if(null===values[j])return;0!==values[j]&&(goodData=!0)}goodData&&(console.log("passed scrum: ",item),panel.add(item))}}})}});

            Rally.launchApp('CustomApp', {
                name:".",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
