<!DOCTYPE html>
<html>
<head>
    <title>SanityDashboard</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var newscope=!0;Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",width:600,layout:{type:"vbox"},scopeType:"release",launch:function(){console.log("Starting load of all components for Sanity Dashboard"),this.add({xtype:"container",itemId:"ribbon",width:1400,height:350,hidden:!0,border:1,layout:{type:"hbox",align:"stretch",pack:"center",margin:"20px"},style:{borderColor:"#AAA",borderStyle:"solid"}},{xtype:"container",itemId:"gridsContainer",padding:5,layout:{type:"hbox",align:"top"},items:[{xtype:"container",itemId:"gridsLeft",width:695,border:1,style:{borderColor:"#AAA",borderStyle:"solid"}},{xtype:"container",itemId:"gridsRight",width:695,border:1,style:{borderColor:"#AAA",borderStyle:"solid"}}]}),this.callParent(arguments)},onScopeChange:function(scope){console.log("Scope changed to",scope,this),this.down("#ribbon").removeAll(),this.globalGridCount=[],this.globalGridMap={C1:"",C2:"",C3:"",C4:"",C5:"",C6:"",C7:""},this.globalStoryCount=[],this.globalTeamCount={},this._gridsLoaded=!1,this.down("#gridsLeft").removeAll(),this.down("#gridsRight").removeAll(),this._loadReleaseDetails(scope),this._buildGrids(scope),this.readyFired=!1,this._chartsReady=!1,window.newscope=!0},_refreshGrids:function(){console.log("Refreshing Grids");var filter=[this.getContext().getTimeboxScope().getQueryFilter()],gridContainerLeft=this.down("#gridsLeft"),gridContainerRight=this.down("#gridsRight");gridContainerLeft.down("#C1").filter(filter,!0,!0),gridContainerLeft.down("#C3").filter(filter,!0,!0),gridContainerLeft.down("#C5").filter(filter,!0,!0),gridContainerLeft.down("#C7").filter(filter,!0,!0),gridContainerLeft.down("#C2").filter(filter,!0,!0),gridContainerRight.down("#C4").filter(filter,!0,!0),gridContainerRight.down("#C6").filter(filter,!0,!0)},_loadReleaseDetails:function(scope){var release=scope.getRecord(),project=this.getContext().getProject();console.log("Release",release),console.log("Project ",project),console.log(project.Name);var releaseStore=Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,fetch:["Name","Project"],context:this.getContext().getProject(),filters:[{property:"Project.ObjectID",operator:"=",value:project.ObjectID}],listeners:{load:function(records){console.log("Found releases",records)}}});if(release){var releaseModel=release.self;releaseModel.load(Rally.util.Ref.getOidFromRef(release),{fetch:["Notes"],success:function(record){},scope:this})}},_buildCharts:function(){_.every(this.globalGridCount,function(elem){return 0===elem})?this.down("#ribbon").add({xtype:"component",html:'<b><font color="green" size=18>Congrats! The Train is healthy for this release</font></b>'}):(console.log("Now building charts"),this.down("#ribbon").add({xtype:"component",layout:{align:"stretch",pack:"center",margin:"40px"},html:"&emsp;&emsp;&emsp;&emsp;"}),this._buildRibbon(),this.down("#ribbon").add({xtype:"component",layout:{align:"stretch",pack:"center",margin:"40px"},html:"&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;"}),this._buildPieChart(),this._chartsReady=!0)},_buildRibbon:function(){function compare(a,b){return a.x<b.x?-1:a.x>b.x?1:0}var linkid='<app class="jump {state}">{title}:&emsp;<a href="#C{name}">{count}</a><p></app>',tempobj=this.globalStoryCount.sort(compare),newhtml="<br>",line;console.log("Building ribbon");for(var i=0;8>i;i++)line=linkid.replace("{name}",tempobj[i].x).replace("{title}",tempobj[i].name).replace("{count}",tempobj[i].y),line=0===tempobj[i].y?line.replace("{state}","healthy"):line.replace("{state}","unhealthy"),newhtml=newhtml.concat(line);this.down("#ribbon").add({xtype:"component",layout:{align:"stretch",pack:"center",margin:"40px"},itemId:"ribbondata",html:newhtml})},_buildPieChart:function(){var tempobj=_.map(this.globalStoryCount,function(value){return[value.name,value.y]});this.down("#ribbon").add({xtype:"rallychart",flex:1,layout:{},scope:this,chartConfig:{chart:{plotBackgroundColor:null,plotBorderWidth:0,plotShadow:!1},title:{text:null},tooltip:{enabled:!1},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {y}",style:{color:"black"}},startAngle:-90,endAngle:90}}},chartData:{series:[{type:"pie",name:"Grid Count",innerSize:"40%",data:tempobj}]}})},_buildGrids:function(scope){var grids=[{title:"Blocked Stories",model:"User Story",listeners:{scope:this},columns:["FormattedID","Name",{text:"Teams",dataIndex:"Project"},"Blocked","BlockedReason"],side:"Left",pageSize:3,filters:function(){return Ext.create("Rally.data.wsapi.Filter",{property:"blocked",operator:"=",value:"true"})},chartnum:"C1"},{title:"Unsized Stories with Features",model:"User Story",listeners:{scope:this},columns:["FormattedID","Name",{text:"Teams",dataIndex:"Project"},"Feature","PlanEstimate"],side:"Left",pageSize:3,filters:function(){var featureFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Feature",operator:"!=",value:"null"}),noPlanEstimateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"=",value:"null"});return featureFilter.and(noPlanEstimateFilter)},chartnum:"C2"},{title:"Unsized Stories with Release",model:"User Story",listeners:{scope:this},columns:["FormattedID","Name",{text:"Teams",dataIndex:"Project"},"PlanEstimate"],side:"Left",pageSize:3,filters:function(){var releaseFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release",operator:"!=",value:"null"}),noPlanEstimateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"=",value:"null"});return releaseFilter.and(noPlanEstimateFilter)},chartnum:"C3"},{title:"Features with no stories",model:"PortfolioItem/Feature",listeners:{scope:this},columns:["FormattedID","Name","PlannedEndDate"],side:"Right",pageSize:3,filters:function(){var userstoryFilter=Ext.create("Rally.data.wsapi.Filter",{property:"UserStories.ObjectID",operator:"contains",value:"null"}),noPlanEstimateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PlannedEndDate",operator:"<",value:"NextWeek"});return userstoryFilter.and(noPlanEstimateFilter)},chartnum:"C4"},{title:"Stories attached to Feature without Iteration",model:"UserStory",listeners:{scope:this},columns:["FormattedID","Name","Feature","Iteration"],side:"Left",pageSize:3,filters:function(){var featureFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Feature",operator:"!=",value:"null"}),noPlanEstimateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operator:"=",value:"null"});return featureFilter.and(noPlanEstimateFilter)},chartnum:"C5"},{title:"Features with unaccepted stories in past sprints",model:"UserStory",listeners:{scope:this},columns:[{text:"Feature",dataIndex:"Feature",flex:3,renderer:function(value){return value.FormattedID.link("https://rally1.rallydev.com/#/"+value.Project.ObjectID+"d/detail/portfolioitem/feature/"+value.ObjectID)}},"FormattedID","Name",{text:"Teams",dataIndex:"Project"},"ScheduleState"],side:"Right",pageSize:3,filters:function(){var featureFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Feature",operator:"!=",value:"null"}),enddateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.EndDate",operator:"<",value:"Today"}),unacceptedFilter=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:"<",value:"Accepted"});return featureFilter.and(unacceptedFilter).and(enddateFilter)},chartnum:"C6"},{title:"Improperly Sized Stories",model:"User Story",listeners:{scope:this},columns:["FormattedID","Name",{text:"Teams",dataIndex:"Project"},"PlanEstimate"],side:"Left",pageSize:3,filters:function(){var noPlanEstimateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"null"}),planSizeOne=Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"1"}),planSizeTwo=Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"2"}),planSizeFour=Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"4"}),planSizeEight=Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"8"}),planSizeSixteen=Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"16"});return noPlanEstimateFilter.and(planSizeOne).and(planSizeTwo).and(planSizeFour).and(planSizeEight).and(planSizeSixteen)},chartnum:"C7"},{title:"Stories with Iteration in Release but no Release scoped",model:"User Story",listeners:{scope:this},columns:["FormattedID","Name",{text:"Teams",dataIndex:"Project"},"Release"],side:"Left",pageSize:3,filters:function(){var releaseFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release",operator:"!=",value:"null"}),releaseDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.ReleaseDate",operator:">",value:"today"}),iterationFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operator:"=",value:"null"});return releaseFilter.and(releaseDateFilter).and(iterationFilter)},chartnum:"C8"}],allPromises=[];console.log("App scope ",scope),_.each(grids,function(grid){promise=this._addGrid(grid.title,grid.model,grid.columns,grid.filters,grid.side,grid.chartnum,scope),promise.then({success:function(count,key){this.globalGridCount.push(count[0]),this.globalGridMap[count[1]]=count[0],this.globalStoryCount.push(count[2])},error:function(error){console.log("single: error",error)},scope:this}).always(function(){}),allPromises.push(promise)},this),Deft.promise.Promise.all(allPromises).then({success:function(){console.log("All grids have loaded"),this._gridsLoaded=!0,this.down("#ribbon").show(),this._buildCharts(),window.newscope=!1},failure:function(error){console.log("all error!",error)},scope:this})},_addGrid:function(myTitle,myModel,myColumns,myFilters,gridSide,cnum,scope){var linkid="<a id={name}>{title}</a>",deferred=Ext.create("Deft.Deferred"),gridContainer=this.down("#grids"+gridSide),grid=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygrid",itemId:cnum,title:linkid.replace("{name}",cnum).replace("{title}",myTitle),columnCfgs:myColumns,showPagingToolbar:!0,emptyText:"This search is healthy",enableBulkEdit:!0,pagingToolbarCfg:{pageSizes:[15,25,100],autoRender:!0,resizable:!0},storeConfig:{model:myModel,autoLoad:{start:0,limit:15},pageSize:15,pagingToolbarCfg:{pageSizes:[15,25,100],autoRender:!0,resizable:!0},filters:[this.getContext().getTimeboxScope().getQueryFilter(),myFilters()],listeners:{load:function(store){var tempcount=store.getTotalCount(),elem={name:myTitle,x:cnum.charAt(1),y:tempcount};0===tempcount?this.shouldiaddgrid=!0:gridContainer.add(grid),window.newscope&&deferred.resolve([store.getTotalCount(),cnum+"",elem]),console.log("Loaded grid",cnum)}},scope:this},style:{borderColor:"#AAA",borderStyle:"dotted",borderWidth:"2px"},padding:10,syncRowHeight:!1,scope:this});return this.shouldiaddgrid&&(grid.setBodyStyle("backgroundColor","#00ff00"),grid.setBodyStyle("textDecoration","overline")),this._gridsLoaded?(this._refreshGrids(),!0):deferred.promise}});

            Rally.launchApp('CustomApp', {
                name:"SanityDashboard",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app{margin:0;padding:0;overflow-x:scroll;overflow-y:hidden}.app .jump{font-family:Helvetica, Arial;font-weight:bold;font-size:16px}
    </style>
</head>
<body>
</body>
</html>
