<!DOCTYPE html>
<html>
<head>
    <title>Sanity Dashboard</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.js"></script>
    <script type="text/javascript" src="https://mdoproceffrpt/cdn/highcharts/highcharts-v4.0.4-modified.js"></script>
    <script type="text/javascript" src="https://code.highcharts.com/modules/heatmap.src.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.0.1/q.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("IntelRallyApp",{alias:"widget.intelrallyapp",extend:"Rally.app.App",_loadModels:function(){var me=this,promises=[],models={Project:"Project",UserStory:"HierarchicalRequirement",Feature:"PortfolioItem/Feature",Milestone:"PortfolioItem/Milestone"};return _.each(models,function(modelType,modelName){var deferred=Q.defer();Rally.data.WsapiModelFactory.getModel({type:modelType,success:function(loadedModel){me[modelName]=loadedModel,deferred.resolve()}}),promises.push(deferred.promise)}),Q.all(promises)},_loadProject:function(oid){var me=this,deferred=Q.defer();return oid?me.Project?(me.Project.load(oid,{fetch:["ObjectID","Releases","Children","Parent","Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:deferred.resolve}),deferred.promise):me._loadModels().then(function(){return me._loadProject(oid)}):Q.resolve()},_loadFeature:function(oid,projectRef){var me=this,deferred=Q.defer();return oid?me.Feature?(me.Feature.load(oid,{fetch:["Name","ObjectID","FormattedID","c_TeamCommits","c_Risks","Project","PlannedEndDate","Parent"],context:{workspace:me.getContext().getWorkspace()._ref,project:projectRef},callback:deferred.resolve}),deferred.promise):me._loadModels().then(function(){return me._loadFeature(oid,projectRef)}):Q.resolve()},_loadUserStory:function(oid,projectRef){var me=this,deferred=Q.defer();return oid?me.UserStory?(me.UserStory.load(oid,{fetch:["Name","ObjectID","Release","Project","Feature","FormattedID","Predecessors","Successors","c_Dependencies","Iteration","PlanEstimate"],context:{workspace:me.getContext().getWorkspace()._ref,project:projectRef},callback:deferred.resolve}),deferred.promise):me._loadModels().then(function(){return me._loadUserStory(oid,projectRef)}):Q.resolve()},_loadMilestone:function(oid,projectRef){var me=this,deferred=Q.defer();return oid?me.Milestone?(me.Milestone.load(oid,{fetch:["ObjectID","Parent","Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:projectRef},callback:deferred.resolve}),deferred.promise):me._loadModels().then(function(){return me._loadMilestone(oid)}):Q.resolve()},_loadRootProject:function(projectRecord){if(!projectRecord)return Q.reject("Invalid arguments: LRP");var me=this,n=projectRecord.data.Name;return"All Scrums"===n||"All Scrums Sandbox"===n?Q(projectRecord):projectRecord.data.Parent?me._loadProject(projectRecord.data.Parent.ObjectID).then(function(parentRecord){return me._loadRootProject(parentRecord)}):Q.reject("Please Scope to a valid team for Release Planning")},_loadTopProject:function(projectRecord){if(!projectRecord)return Q.reject("Invalid arguments: LTP");var me=this,n=projectRecord.data.Name;return projectRecord.data.Parent?me._loadProject(projectRecord.data.Parent.ObjectID).then(function(parentRecord){return me._loadTopProject(parentRecord)}):Q(projectRecord)},_projectInWhichTrain:function(projectRecord){if(projectRecord){var me=this,split=projectRecord.data.Name.split(" ART");if(split.length>1)return Q(projectRecord);var parent=projectRecord.data.Parent;return parent?me._loadProject(parent.ObjectID).then(function(parentRecord){return me._projectInWhichTrain(parentRecord)}):Q.reject("Project not in a train")}return Q.reject("Invalid arguments: PIWT")},_loadAllTrains:function(rootProjectRecord){if(!rootProjectRecord)return Q.reject("Invalid arguments: LAT");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Project",remoteSort:!1,limit:1/0,fetch:["Name","ObjectID"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",operator:"contains",value:" ART"},{property:"Name",operator:"All Scrums Sandbox"===rootProjectRecord.data.Name?"contains":"!contains",value:"Test"}]});return me._reloadStore(store).then(function(store){return console.log("AllTrainRecords loaded",store.data.items),Q(store)})},_loadRandomUserStory:function(projectRef){if(!projectRef)return Q.reject("Invalid arguments: LRUS");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:5,pageSize:5,fetch:["Name","CreationDate","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},sorters:[{property:"CreationDate",direction:"DESC"}],filters:[{property:"Project",value:projectRef}]});return me._reloadStore(store).then(function(store){var records=store.data.items;return records.length?Q(records[Math.floor(Math.random()*records.length)]):Q(void 0)})},_loadUserStoryByFID:function(formattedID,projectRef){if(!formattedID||!projectRef)return Q.reject("Invalid arguments: LUSBFID");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1,pageSize:1,fetch:["Name","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},filters:[{property:"FormattedID",value:formattedID},{property:"Project",value:projectRef}]});return me._reloadStore(store).then(function(store){return Q(store.data.items.pop())})},_loadProjectByName:function(name){if(!name)return Q.reject("Invalid arguments: LPBN");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Project",limit:1,pageSize:1,fetch:["Name","ObjectID"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:name}]});return me._reloadStore(store).then(function(store){return Q(store.data.items.pop())})},_getFeatureFilter:function(trainRecord,releaseRecord){if(!trainRecord||!releaseRecord)throw"invalid arguments: GFF";var me=this,trainName=trainRecord.data.Name.split(" ART")[0],relSplit=releaseRecord.data.Name.split(" "),coreFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:releaseRecord.data.Name});return trainName=2==relSplit.length?relSplit[1]:trainName,"Test ART (P&E)"==trainRecord.data.Name?Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:"Test ART (P&E)"}).and(coreFilter):Ext.create("Rally.data.wsapi.Filter",{property:"Project.Parent.Name",value:trainName+" POWG Portfolios"}).or(Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:trainName+" POWG Portfolios"})).and(coreFilter)},_getProductFilter:function(trainRecord){if(!trainRecord)throw"invalid arguments: GPF";var me=this,trainName=trainRecord.data.Name.split(" ART")[0];return"Test"===trainName?Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:"Test ART (P&E)"}):Ext.create("Rally.data.wsapi.Filter",{property:"Project.Parent.Name",value:trainName+" POWG Portfolios"}).or(Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:trainName+" POWG Portfolios"}))},_loadProducts:function(trainRecord){if(!trainRecord)return Q.reject("Invalid arguments: LPROD");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Product",limit:1/0,remoteSort:!1,fetch:["Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[me._getProductFilter(trainRecord)]});return me._reloadStore(store).then(function(store){return console.log("Products loaded",store.data.items),Q(store)})},_addValidProjectsToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;curProj.data.TeamMembers.Count>0&&(hash[curProj.data.ObjectID]=curProj);for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me._addValidProjectsToList(projTree[childProjRef],hash)},_loadValidProjects:function(rootProjectRecord){if(!rootProjectRecord)return Q.reject("Invalid arguments: LVP");var me=this,validProjects={},projTree={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","Parent","ObjectID","TeamMembers"],limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){for(var projects=store.data.items,i=0,len=projects.length;len>i;++i){var project=projects[i],thisRef=project.data.ObjectID,parentRef=project.data.Parent?project.data.Parent.ObjectID:void 0;projTree[thisRef]||(projTree[thisRef]={}),projTree[thisRef].ProjectRecord=project,parentRef&&(projTree[parentRef]||(projTree[parentRef]={}),projTree[parentRef][thisRef]=projTree[thisRef])}return me._addValidProjectsToList(projTree[rootProjectRecord.data.ObjectID],validProjects),console.log("valid projects",validProjects),Q(validProjects)})},_allChildProjectToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;hash[curProj.data.ObjectID]=curProj;for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me._allChildProjectToList(projTree[childProjRef],hash)},_loadAllChildrenProjects:function(rootProjectRecord){if(!rootProjectRecord)return Q.reject("Invalid arguments: LACP");var me=this,childrenProjects={},projTree={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","Parent","ObjectID"],limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){for(var projects=store.data.items,i=0,len=projects.length;len>i;++i){var project=projects[i],thisRef=project.data.ObjectID,parentRef=project.data.Parent?project.data.Parent.ObjectID:void 0;projTree[thisRef]||(projTree[thisRef]={}),projTree[thisRef].ProjectRecord=project,parentRef&&(projTree[parentRef]||(projTree[parentRef]={}),projTree[parentRef][thisRef]=projTree[thisRef])}return me._allChildProjectToList(projTree[rootProjectRecord.data.ObjectID],childrenProjects),console.log("childrenProjects",childrenProjects),Q(childrenProjects)})},_allLeafProjectsToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;0===curProj.data.Children.Count&&(hash[curProj.data.ObjectID]=curProj);for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me._allLeafProjectsToList(projTree[childProjRef],hash)},_loadAllLeafProjects:function(rootProjectRecord){if(!rootProjectRecord)return Q.reject("Invalid arguments: LALP");var me=this,childrenProjects={},projTree={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","Parent","ObjectID","Children"],limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){for(var projects=store.data.items,i=0,len=projects.length;len>i;++i){var project=projects[i],thisRef=project.data.ObjectID,parentRef=project.data.Parent?project.data.Parent.ObjectID:void 0;projTree[thisRef]||(projTree[thisRef]={}),projTree[thisRef].ProjectRecord=project,parentRef&&(projTree[parentRef]||(projTree[parentRef]={}),projTree[parentRef][thisRef]=projTree[thisRef])}return me._allLeafProjectsToList(projTree[rootProjectRecord.data.ObjectID],childrenProjects),console.log("childrenProjects",childrenProjects),Q(childrenProjects)})},_reloadStore:function(store){var deferred=Q.defer();return store.load({callback:function(records,operation,success){success?deferred.resolve(store):deferred.reject(operation.getError()||"Could not load data")}}),deferred.promise}});
                Ext.define("WorkweekDropdown",{extend:"Ext.data.Model",fields:[{name:"Workweek",type:"string"},{name:"DateVal",type:"number"}]});
                Ext.define("WindowListener",{__initWindowEventListener:function(eventName){var me=this;me._windowListeners||(me._windowListeners={}),me._windowListeners[eventName]=[],window.parent["on"+eventName]=function(event){for(var listeners=me._windowListeners[eventName],i=0,len=listeners.length;len>i;++i)listeners[i](event)}},_addWindowEventListener:function(eventName,fn){var me=this;me._windowListeners&&me._windowListeners[eventName]||me.__initWindowEventListener(eventName),me._windowListeners[eventName].push(fn)},_fireParentWindowEvent:function(eventName){var me=this;if(me._windowListeners&&me._windowListeners[eventName])for(var listeners=me._windowListeners[eventName],i=0,len=listeners.length;len>i;++i)listeners[i]()}});
                Ext.define("IframeResize",{requires:["WindowListener"],_applyIframeResizeToContents:function(){for(var w=window,p=w.parent,pd=w.parent.document,l=w.location,iframe=pd.querySelector('iframe[src="'+l.pathname+l.search+'"]'),ip1=iframe.parentNode,ip2=iframe.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode,height=0,next=this.down();next;)height+=next.getHeight()+1*next.getEl().getMargin("tb")+1*next.getEl().getPadding("tb"),next=next.next();height+=150,ip1.style.height=height+"px",ip2.style.height=height+"px",iframe.style.height=height+"px"},_initIframeResizeToContents:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me._applyIframeResizeToContents()})},_applyIframeResizeToWindow:function(){var loc=window.location,iframe=Ext.get(window.parent.document.querySelector('iframe[src="'+loc.pathname+loc.search+'"]')),i=iframe.dom,portlet=iframe.up(".x-portlet"),portalColumn=portlet.up(".x-portal-column"),dashboard=portlet.up("#mydash_portlet");height=window.parent.innerHeight-70,height-=200,iframe.style.height=height+"px",ip1.style.height=height+"px",height+=30,ip2.style.height=height+"px"},_initIframeResizeToWindow:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me._applyIframeResizeToWindow()}),me._applyIframeResizeToWindow()},_fixRallyDashboard:function(){for(var me=this,loc=window.location,iframe=Ext.get(window.parent.document.querySelector('iframe[src="'+loc.pathname+loc.search+'"]')),portlet=iframe.up(".x-portlet"),portalColumn=portlet.up(".x-portal-column"),dashboard=portlet.up("#mydash_portlet"),i=iframe.dom,innerHeight=window.parent.innerHeight;;){if(i.style.width=window.parent.innerWidth-4+"px",i.style.padding="0",i.style.margin="0","mydash_portlet"===i.id)break;i=i.parentNode}dashboard.dom.style.height=innerHeight-65+"px",portlet.dom.style.height=innerHeight-105+"px",iframe.dom.parentNode.style.height=innerHeight-135+"px",iframe.dom.style.height=innerHeight-135+"px",dashboard.dom.style.padding="0 2px 0 2px"},_initFixRallyDashboard:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me._fixRallyDashboard()}),me._fixRallyDashboard()},_disableResizeHandle:function(){var me=this,loc=window.location,iframe=Ext.get(window.parent.document.querySelector('iframe[src="'+loc.pathname+loc.search+'"]')),portlet=iframe.up(".x-portlet"),handle=portlet.down(".x-resizable-handle");handle&&(handle.hide(),handle.dom.onshow=function(){handle&&handle.hide()})},_initDisableResizeHandle:function(){var me=this;me._addWindowEventListener&&me._addWindowEventListener("resize",function(){me._disableResizeHandle()}),me._disableResizeHandle()}});
                Ext.define("PrettyAlert",{__getMessageBoxY:function(){var w=window,p=w.parent,pd=w.parent.document,l=w.location,iframe=pd.querySelector('iframe[src="'+l.pathname+l.search+'"]'),ph=p.getWindowHeight(),ps=p.getScrollY(),ofy=ps+iframe.getBoundingClientRect().top,iyOffset=Math.floor(ph/2-ofy+ps-50);return 0>iyOffset?0:iyOffset},_alert:function(title,str){1>arguments.length||(1===arguments.length&&(str=title,title=""),Ext.MessageBox.alert(title,str).setY(this.__getMessageBoxY()),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20))},_confirm:function(title,str,fn){2>arguments.length||(2===arguments.length&&(fn=str,str=title,title=""),"function"!=typeof fn&&(fn=function(){}),Ext.MessageBox.confirm(title,str,fn).setY(this.__getMessageBoxY()),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20))}});
                (function(){var intel_ww={},SECOND=1e3,MINUTE=60*SECOND,HOUR=60*MINUTE,DAY=24*HOUR,WEEK=7*DAY;Ext.define("IntelWorkweek",{_getWorkweek:function(_date){var date=new Date(_date),yearStart=new Date(date.getFullYear(),0,1),dayIndex=yearStart.getDay(),ww01Start=new Date(yearStart-dayIndex*DAY),utcDateMillis=Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()),ww01Millis=Date.UTC(ww01Start.getFullYear(),ww01Start.getMonth(),ww01Start.getDate()),timeDiff=utcDateMillis-ww01Millis,ww=Math.floor(timeDiff/WEEK)+1,leap=0===date.getFullYear()%4,weekCount=leap&&dayIndex>=5||!leap&&6===dayIndex?53:52;return ww>weekCount?1:ww},_getWeekCount:function(_date){var date=new Date(_date),leap=0===date.getFullYear()%4,day=new Date(date.getFullYear(),0,1).getDay();return leap&&day>=5||!leap&&6===day?53:52},_roundDateDownToWeekStart:function(_date){var date=new Date(_date),day=date.getDay(),monthDate=date.getDate(),month=date.getMonth(),year=date.getFullYear(),sundayMidday=new Date(1*new Date(year,month,monthDate)-(day*DAY-.5*DAY));return new Date(sundayMidday.getFullYear(),sundayMidday.getMonth(),sundayMidday.getDate())},_getWorkweekDates:function(startDate,endDate){for(var startWeekDate=this._roundDateDownToWeekStart(startDate),endWeekDate=this._roundDateDownToWeekStart(endDate),startMillis=Date.UTC(startWeekDate.getFullYear(),startWeekDate.getMonth(),startWeekDate.getDate()),endMillis=Date.UTC(endWeekDate.getFullYear(),endWeekDate.getMonth(),endWeekDate.getDate()),totalWeeks=Math.floor((endMillis-startMillis)/WEEK)+1,weeks=Array(totalWeeks),i=0;totalWeeks>i;++i){var sundayMidday=new Date(1*startWeekDate+(WEEK*i+12*HOUR));weeks[i]=new Date(sundayMidday.getFullYear(),sundayMidday.getMonth(),sundayMidday.getDate())}return weeks},_workweekToDate:function(ww,year){var yearStart=new Date(year,0,1),dayIndex=yearStart.getDay(),ww01StartMidday=new Date(yearStart-(dayIndex*DAY-.5*DAY)),sundayMidday=new Date(1*ww01StartMidday+(ww-1)*WEEK);return new Date(sundayMidday.getFullYear(),sundayMidday.getMonth(),sundayMidday.getDate())},_getWorkWeeksForDropdown:function(releaseStartDate,releaseEndDate){for(var workweeks=this._getWorkweekDates(releaseStartDate,releaseEndDate),data=Array(workweeks.length),i=0,len=workweeks.length;len>i;++i)data[i]={Workweek:"ww"+this._getWorkweek(workweeks[i]),DateVal:1*workweeks[i]};return data}})})();
                Ext.define("ReleaseQuery",{_loadAllReleases:function(projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),deferred.resolve(releaseStore)},single:!0}}}),deferred.promise},_loadReleasesInTheFuture:function(projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID},{property:"ReleaseDate",operator:">=",value:(new Date).toISOString()}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),deferred.resolve(releaseStore)},single:!0}}}),deferred.promise},_loadReleasesWithName:function(releaseName,nameContains){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project","TeamMembers"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:releaseName},{property:"Project.Name",operator:"contains",value:nameContains},{property:"Project.Children.Name",operator:"=",value:""},{property:"Project.Name",operator:"!contains",value:" ART"}],listeners:{load:{fn:function(store,records){console.log("releasesWithName loaded:",records),deferred.resolve(store)},single:!0}}}),deferred.promise},_loadReleaseByNameForProject:function(releaseName,projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:releaseName},{property:"Project",value:projectRecord.data._ref}],listeners:{load:{fn:function(store,records){deferred.resolve(records.pop())},single:!0}}}),deferred.promise},_loadReleasesByNameContainsForProject:function(releaseName,projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",operator:"contains",value:releaseName},{property:"Project",value:projectRecord.data._ref}],listeners:{load:{fn:function(store,records){deferred.resolve(records)},single:!0}}}),deferred.promise},_loadReleasesAfterGivenDate:function(projectRecord,givenDate){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID},{property:"ReleaseDate",operator:">=",value:new Date(givenDate).toISOString()}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),deferred.resolve(releaseStore)},single:!0}}}),deferred.promise},_getScopedRelease:function(releaseRecords,projectOID,appPrefs){var me=this,d=new Date,rs=releaseRecords,prefOID=appPrefs&&appPrefs.projs&&appPrefs.projs[projectOID]&&appPrefs.projs[projectOID].Release;return prefOID&&_.find(rs,function(r){return r.data.ObjectID==prefOID})||_.find(rs,function(r){return new Date(r.data.ReleaseDate)>=d&&d>=new Date(r.data.ReleaseStartDate)})||_.reduce(rs,function(best,r){if(null===best)return r;var d1=new Date(best.data.ReleaseStartDate),d2=new Date(r.data.ReleaseStartDate),now=new Date;return Math.abs(d1-now)<Math.abs(d2-now)?best:r},null)}});
                Ext.define("Intel.form.field.ComboBox",{extend:"Ext.form.field.ComboBox",alias:["widget.intelcombo","widget.intelcombobox"],constructor:function(options){options=options||{},options=Ext.merge({enableKeyEvents:!0,queryMode:"local",ignoreNoChange:!0,allowBlank:!1,listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var combo=this;combo.store.clearFilter(),combo.store.filterBy(function(item){return null!==item.data[combo.displayField].match(RegExp(combo.getRawValue(),"i"))})}},focus:function(combo){combo.store.clearFilter(),combo.setValue(""),combo.expand()}}},options),this.callParent([options])}});
                Ext.define("Intel.form.field.FixedComboBox",{extend:"Ext.form.field.ComboBox",alias:["widget.intelfixedcombo","widget.intelfixedcombobox"],constructor:function(options){options=options||{},options=Ext.merge({editable:!1,allowBlank:!1,queryMode:"local",listeners:{focus:function(combo){combo.setValue(""),combo.expand()}}},options),this.callParent([options])}});
                Ext.define("Intel.form.field.ReleasePicker",{extend:"Intel.form.field.FixedComboBox",alias:["widget.intelreleasepicker"],constructor:function(options){options.releases&&options.currentRelease&&(options.displayField="Name",options.value=options.currentRelease.data.Name,options.store=Ext.create("Ext.data.Store",{fields:["Name"],sorters:[function(o1,o2){return o1.data.Name>o2.data.Name?-1:1}],data:_.map(options.releases,function(r){return{Name:r.data.Name}})}),options.fieldLabel=options.fieldLabel||"Release:",options.editable=options.editable||!1,options.width=options.width||240,options.labelWidth=options.labelWidth||50,this.callParent([options]))}});
                console={log:function(){}},Ext.define("SanityDashboard",{extend:"IntelRallyApp",cls:"app",mixins:["WindowListener","PrettyAlert","IframeResize","IntelWorkweek","ReleaseQuery"],minWidth:1100,items:[{xtype:"container",id:"controlsContainer",layout:"hbox"},{xtype:"container",id:"ribbon",cls:"ribbon",layout:"column",items:[{xtype:"container",width:445,id:"pie"},{xtype:"container",columnWidth:.999,id:"heatmap"}]},{xtype:"container",id:"gridsContainer",cls:"grids-container",layout:"column",items:[{xtype:"container",columnWidth:.495,id:"gridsLeft",cls:"grids-left"},{xtype:"container",columnWidth:.495,id:"gridsRight",cls:"grids-right"}]}],_prefName:"sanity-dashboard-pref",_colors:["#5DA5DA","#FAA43A","#60BD68","#F17CB0","#B2912F","#B276B2","#DECF3F","#F15854","#4D4D4D"],_removeAllItems:function(){var me=this;Ext.getCmp("controlsContainer").removeAll(),Ext.getCmp("pie").removeAll(),Ext.getCmp("heatmap").removeAll(),Ext.getCmp("gridsLeft").removeAll(),Ext.getCmp("gridsRight").removeAll()},_reloadEverything:function(){var me=this;return me.setLoading("Loading Grids"),me._removeAllItems(),me._loadReleasePicker(),me._loadTeamPicker(),me._buildGrids().then(function(){return me.setLoading("Loading Piechart and Heatmap"),me._buildRibbon()}).then(function(){me.setLoading(!1)}).fail(function(reason){return me.setLoading(!1),Q.reject(reason)})},_loadPreferences:function(){var me=this,uid=me.getContext().getUser().ObjectID,deferred=Q.defer();return Rally.data.PreferenceManager.load({appID:me.getAppId(),filterByName:me._prefName+uid,success:function(prefs){var appPrefs=prefs[me._prefName+uid];try{appPrefs=JSON.parse(appPrefs)}catch(e){appPrefs={projs:{}}}console.log("loaded prefs",appPrefs),deferred.resolve(appPrefs)},failure:deferred.reject}),deferred.promise},_savePreferences:function(prefs){var me=this,s={},uid=me.getContext().getUser().ObjectID,deferred=Q.defer();return prefs={projs:prefs.projs},s[me._prefName+uid]=JSON.stringify(prefs),console.log("saving prefs",prefs),Rally.data.PreferenceManager.update({appID:this.getAppId(),settings:s,success:deferred.resolve,failure:deferred.reject}),deferred.promise},launch:function(){var me=this;me._initDisableResizeHandle(),me._initFixRallyDashboard(),me.setLoading("Loading Configuration"),me._loadModels().then(function(){var scopeProject=me.getContext().getProject();return me._loadProject(scopeProject.ObjectID)}).then(function(scopeProjectRecord){return me.ProjectRecord=scopeProjectRecord,me._projectInWhichTrain(me.ProjectRecord)}).then(function(trainRecord){return trainRecord?(me._isScopedToTrain=trainRecord.data.ObjectID!=me.ProjectRecord.data.ObjectID?!1:!0,me.TrainRecord=trainRecord,me._loadAllLeafProjects(me.TrainRecord)):Q.reject("Not Scoped in a train!")}).then(function(leafProjects){return me.LeafProjects=leafProjects,me.CurrentTeam=me._isScopedToTrain?null:me.ProjectRecord,me._loadProducts(me.TrainRecord)}).then(function(productStore){return me.Products=productStore.getRange(),me._loadPreferences()}).then(function(appPrefs){me.AppPrefs=appPrefs;var twelveWeeks=10368e5;return me._loadReleasesAfterGivenDate(me.ProjectRecord,1*new Date-twelveWeeks)}).then(function(releaseStore){me.ReleaseStore=releaseStore;var currentRelease=me._getScopedRelease(me.ReleaseStore.data.items,me.ProjectRecord.data.ObjectID,me.AppPrefs);return currentRelease?(me.ReleaseRecord=currentRelease,console.log("release loaded",currentRelease),me._reloadEverything()):Q.reject("This project has no releases.")}).fail(function(reason){me.setLoading(!1),me._alert("ERROR",reason||"")}).done()},_releasePickerSelected:function(combo,records){var me=this,pid=me.ProjectRecord.data.ObjectID;me.ReleaseRecord.data.Name!==records[0].data.Name&&(me.setLoading(!0),me.ReleaseRecord=me.ReleaseStore.findExactRecord("Name",records[0].data.Name),"object"!=typeof me.AppPrefs.projs[pid]&&(me.AppPrefs.projs[pid]={}),me.AppPrefs.projs[pid].Release=me.ReleaseRecord.data.ObjectID,me._savePreferences(me.AppPrefs).then(function(){return me._reloadEverything()}).fail(function(reason){me._alert("ERROR",reason||""),me.setLoading(!1)}).done())},_loadReleasePicker:function(){var me=this;Ext.getCmp("controlsContainer").add({xtype:"intelreleasepicker",labelWidth:80,width:240,releases:me.ReleaseStore.data.items,currentRelease:me.ReleaseRecord,listeners:{change:function(combo,newval,oldval){0===newval.length&&combo.setValue(oldval)},select:me._releasePickerSelected.bind(me)}})},_teamPickerSelected:function(combo,records){var me=this,recName=records[0].data.Name;if(!(!me.CurrentTeam&&"All"==recName||me.CurrentTeam&&me.CurrentTeam.data.Name==recName))return me.CurrentTeam="All"==recName?null:_.find(me.LeafProjects,function(p){return p.data.Name==recName}),me._reloadEverything()},_loadTeamPicker:function(){var me=this;Ext.getCmp("controlsContainer").add({xtype:"intelcombobox",width:200,padding:"0 0 0 40px",fieldLabel:"Team:",labelWidth:50,store:Ext.create("Ext.data.Store",{fields:["Name"],data:[{Name:"All"}].concat(_.map(_.sortBy(me.LeafProjects,function(s){return s.data.Name}),function(p){return{Name:p.data.Name}}))}),displayField:"Name",value:me.CurrentTeam?me.CurrentTeam.data.Name:"All",listeners:{select:me._teamPickerSelected.bind(me)}})},_hideHighchartsLinks:function(){$(".highcharts-container > svg > text:last-child").hide()},_getCountForTeamAndGrid:function(project,grid){var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"UserStory",limit:1,pageSize:1,remoteSort:!1,fetch:!1,context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:me.CurrentTeam?grid.originalConfig.filters:[grid.originalConfig.filters[0].and(Ext.create("Rally.data.wsapi.Filter",{property:"Project",value:project.data._ref}))]});return me.CurrentTeam&&me.CurrentTeam.data.ObjectID!=project.data.ObjectID?Q(0):me._reloadStore(store).then(function(store){return store.totalCount})},_getHeatMapConfig:function(){var me=this,userStoryGrids=_.filter(Ext.getCmp("gridsContainer").query("rallygrid"),function(grid){return"UserStory"==grid.originalConfig.model}).reverse(),chartData=[],promises=[];return _.each(userStoryGrids,function(grid,gindex){_.each(_.sortBy(me.LeafProjects,function(p){return p.data.Name}),function(project,pindex){promises.push(me._getCountForTeamAndGrid(project,grid).then(function(gridCount){return chartData.push([pindex,gindex,gridCount])}))})}),window._selectTeam=function(value){var team=_.find(me.LeafProjects,function(p){return 0===p.data.Name.indexOf(value)});me.CurrentTeam=me.CurrentTeam&&team.data.ObjectID==me.CurrentTeam.data.ObjectID?null:team,me._reloadEverything()},window._selectId=function(gridId){location.href="#"+gridId},Q.all(promises).then(function(){return{chart:{type:"heatmap",height:340,marginTop:10,marginLeft:130,marginBottom:80},title:{text:null},xAxis:{categories:_.sortBy(_.map(me.LeafProjects,function(project){return project.data.Name.split("-")[0].trim()}),function(p){return p}),labels:{style:{width:100},formatter:function(){var text=this.value;return me.CurrentTeam&&0===me.CurrentTeam.data.Name.indexOf(this.value)&&(text='<span class="curteam">'+this.value+"</span>"),'<a class="heatmap-xlabel" onclick="_selectTeam(\''+this.value+"');\">"+text+"</a>"},useHTML:!0,rotation:-45}},yAxis:{categories:_.map(userStoryGrids,function(grid){return grid.originalConfig.title}),title:null,labels:{formatter:function(){var text=this.value,index=_.indexOf(this.axis.categories,text),gridID=userStoryGrids[index].originalConfig.id,styleAttr='style="background-color:'+me._colors[userStoryGrids.length-index-1]+'"';return'<div class="heatmap-ylabel"'+styleAttr+" onclick=\"_selectId('"+gridID+"')\">"+text+"</div>"},useHTML:!0}},colorAxis:{min:0,minColor:"#FFFFFF",maxColor:"#ec5b5b"},plotOptions:{series:{point:{events:{click:function(e){var point=this,team=_.sortBy(me.LeafProjects,function(p){return p.data.Name})[point.x],grid=userStoryGrids[point.y];me.CurrentTeam&&me.CurrentTeam.data.ObjectID==team.data.ObjectID?location.href="#"+grid.originalConfig.id:(me.CurrentTeam=team,setTimeout(function(){me._reloadEverything().then(function(){location.href="#"+grid.originalConfig.id}).done()},0))}}}}},legend:{enabled:!1},tooltip:{enabled:!1},series:[{name:"Errors per Violation per Team",borderWidth:1,data:chartData,dataLabels:{enabled:!0,color:"black",style:{textShadow:"none"}}}]}})},_getPieChartConfig:function(){var me=this,chartData=_.map(Ext.getCmp("gridsContainer").query("rallygrid"),function(grid){return{name:grid.originalConfig.title,y:grid.store.totalCount,href:"#"+grid.originalConfig.id}});return{chart:{height:345,marginLeft:-15,plotBackgroundColor:null,plotBorderWidth:0,plotShadow:!1},title:{text:null},tooltip:{enabled:!1},plotOptions:{pie:{dataLabels:{enabled:!0,distance:25,crop:!1,overflow:"none",format:"<b>{point.name}</b>: {y}",style:{cursor:"pointer",color:"black"}},startAngle:10,endAngle:170,center:["0%","50%"]}},series:[{type:"pie",name:"Grid Count",innerSize:"25%",size:260,point:{events:{click:function(e){location.href=e.point.href,e.preventDefault()}}},data:chartData}]}},_buildRibbon:function(){var me=this;return Highcharts.setOptions({colors:me._colors}),$("#pie").highcharts(me._getPieChartConfig()),me._getHeatMapConfig().then(function(chartConfig){$("#heatmap").highcharts(chartConfig),me._hideHighchartsLinks()}).fail(function(reason){me._alert("ERROR",reason)})},_addGrid:function(gridConfig){var me=this,gridTitleLink='<a id="'+gridConfig.id+'">'+gridConfig.title+"</a>"+'<span style="float:right;font-weight:bold;font-size:0.8rem;"><a href="#controlsContainer">Top</a></span>',deferred=Q.defer(),grid=Ext.create("Rally.ui.grid.Grid",{title:gridTitleLink,columnCfgs:gridConfig.columns,showPagingToolbar:!0,originalConfig:gridConfig,showRowActionsColumn:!0,emptyText:" ",enableBulkEdit:!0,pagingToolbarCfg:{pageSizes:[10,15,25,100],autoRender:!0,resizable:!1},storeConfig:{model:gridConfig.model,autoLoad:{start:0,limit:10},pageSize:10,context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:gridConfig.filters,listeners:{load:function(store){if(store.getRange().length)grid.addCls("grid-unhealthy sanity-grid"),grid.gridContainer=Ext.getCmp("grids"+gridConfig.side),deferred.resolve(grid);else{var goodGrid=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygrid",cls:" sanity-grid grid-healthy",title:gridTitleLink,originalConfig:gridConfig,emptyText:"0 Problems!",store:Ext.create("Rally.data.custom.Store",{data:[]}),showPagingToolbar:!1,showRowActionsColumn:!1});goodGrid.gridContainer=Ext.getCmp("grids"+gridConfig.side),deferred.resolve(goodGrid)}}}}});return deferred.promise},_buildGrids:function(){var me=this,releaseName=me.ReleaseRecord.data.Name,releaseDate=new Date(me.ReleaseRecord.data.ReleaseDate).toISOString(),releaseStartDate=new Date(me.ReleaseRecord.data.ReleaseStartDate).toISOString(),trainName=me.TrainRecord.data.Name.split(" ART")[0],defaultUserStoryColumns=[{text:"FormattedID",dataIndex:"FormattedID",editor:!1},{text:"Name",dataIndex:"Name",editor:!1}].concat(me.CurrentTeam?[]:[{text:"Team",dataIndex:"Project",editor:!1}]),defaultFeatureColumns=[{text:"FormattedID",dataIndex:"FormattedID",editor:!1},{text:"Name",dataIndex:"Name",editor:!1},{text:"PlannedEndDate",dataIndex:"PlannedEndDate",editor:!1}],releaseNameFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:releaseName}),userStoryProjectFilter=me.CurrentTeam?Ext.create("Rally.data.wsapi.Filter",{property:"Project",value:me.CurrentTeam.data._ref}):Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",operator:"contains",value:trainName}),featureProductFilter=_.reduce(me.Products,function(filter,product){var thisFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Parent.Parent.Name",value:product.data.Name});return filter?filter.or(thisFilter):thisFilter},null),gridConfigs=[{showIfLeafProject:!0,title:"Blocked Stories",id:"grid-blocked-stories",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"Blocked",dataIndex:"Blocked"},{text:"BlockedReason",dataIndex:"BlockedReason",tdCls:"editor-cell"}]),side:"Left",filters:[Ext.create("Rally.data.wsapi.Filter",{property:"blocked",value:"true"}).and(releaseNameFilter).and(userStoryProjectFilter)]},{showIfLeafProject:!0,title:"Unsized Stories",id:"grid-unsized-stories",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"PlanEstimate",dataIndex:"PlanEstimate",tdCls:"editor-cell"}]),side:"Left",filters:[Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"=",value:null}).and(releaseNameFilter).and(userStoryProjectFilter)]},{showIfLeafProject:!0,title:"Improperly Sized Stories",id:"grid-improperly-sized-stories",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"PlanEstimate",dataIndex:"PlanEstimate",tdCls:"editor-cell"}]),side:"Left",filters:[Ext.create("Rally.data.wsapi.Filter",{property:"Children.ObjectID",value:null}).and(Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:null})).and(Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"1"})).and(Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"2"})).and(Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"4"})).and(Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"8"})).and(Ext.create("Rally.data.wsapi.Filter",{property:"PlanEstimate",operator:"!=",value:"16"})).and(releaseNameFilter).and(userStoryProjectFilter)]},{showIfLeafProject:!0,title:"Stories in Release without Iteration",id:"grid-stories-in-release-without-iteration",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"Iteration",dataIndex:"Iteration",tdCls:"editor-cell"}]),side:"Left",filters:[Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",value:null}).and(releaseNameFilter).and(userStoryProjectFilter)]},{showIfLeafProject:!0,title:"Stories in Iteration not attached to Release",id:"grid-stories-in-iteration-not-attached-to-release",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"Iteration",dataIndex:"Iteration",tdCls:"editor-cell"},{text:"Release",dataIndex:"Release",tdCls:"editor-cell"}]),side:"Right",filters:[Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.StartDate",operator:"<",value:releaseDate}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.EndDate",operator:">",value:releaseStartDate})).and(Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:null})).and(Ext.create("Rally.data.wsapi.Filter",{property:"Feature.Release.Name",value:null})).and(userStoryProjectFilter)]},{showIfLeafProject:!0,title:"Unaccepted Stories in Past Iterations",id:"grid-unaccepted-stories-in-past-iterations",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"Iteration",dataIndex:"Iteration",editor:!1},{text:"ScheduleState",dataIndex:"ScheduleState",tdCls:"editor-cell"}]),side:"Right",filters:[Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.EndDate",operator:"<",value:"Today"}).and(Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:"<",value:"Accepted"})).and(releaseNameFilter).and(userStoryProjectFilter)]},{showIfLeafProject:!0,title:"Stories with End Date past Feature End Date",id:"grid-stories-with-end-past-feature-end",model:"UserStory",columns:defaultUserStoryColumns.concat([{text:"Iteration",dataIndex:"Iteration",editor:!1},{text:"Feature",dataIndex:"Feature",editor:!1}]),side:"Right",filters:[Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.EndDate",operator:">",value:releaseDate}).and(releaseNameFilter).and(userStoryProjectFilter)]},{showIfLeafProject:!1,title:"Features with no stories",id:"grid-features-with-no-stories",model:"PortfolioItem/Feature",columns:defaultFeatureColumns,side:"Right",filters:[Ext.create("Rally.data.wsapi.Filter",{property:"UserStories.ObjectID",value:null}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:releaseName})).and(featureProductFilter)]}];return Q.all(_.map(gridConfigs,function(gridConfig){return me.CurrentTeam&&!gridConfig.showIfLeafProject?Q():me._addGrid(gridConfig)})).then(function(grids){_.each(grids,function(grid){grid&&grid.gridContainer.add(grid)}),console.log("All grids have loaded")}).fail(function(reason){me._alert("ERROR:",reason)})}});

            Rally.launchApp('SanityDashboard', {
                name:"Sanity Dashboard",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app{margin:0;padding:0;width:100%;overflow-x:hidden !important}.ribbon{margin:10px 0 0 0;padding:0;width:98%;height:350px;border:1px solid #AAA}.grids-container{margin:10px 0 0 0;padding:0;position:relative !important;width:98%}.grids-container .grids-left{margin-right:5px;position:absolute !important;left:0}.grids-container .grids-right{margin-left:5px;position:absolute !important;right:0}.sanity-grid{border:2px solid #AAA;padding:0;margin:0 0 5px 0}.grid-healthy.sanity-grid .x-panel-header{font-weight:bold;background-color:rgba(0,255,0,0.4) !important}.grid-unhealthy.sanity-grid .x-panel-header{font-weight:bold;background-color:rgba(255,0,0,0.4) !important}.sanity-grid .grid-pager{margin:3px !important}.sanity-grid .editor-cell,.sanity-grid .editor-cell *{cursor:pointer !important}.sanity-grid.rally-grid .x-grid-row-over .editable.rally-edit-cell:not(.editor-cell):hover{background-image:none}.highcharts-container{overflow:visible !important}.my-heatmap-tooltip{z-index:10000;border-radius:2px;padding:5px;border:1px solid gray;background:lightgray}.heatmap-xlabel{white-space:nowrap;z-index:100;cursor:pointer}.heatmap-xlabel:hover{color:blue}.heatmap-xlabel .curteam{font-weight:bolder;font-size:1.1em}.heatmap-ylabel{white-space:normal;width:124px;height:35px;text-align:center;display:flex;border-bottom-left-radius:5px;border-top-left-radius:5px;justify-content:center;align-items:center;font-size:0.65rem;cursor:pointer;padding:0 2px 0 2px;margin:0}
    </style>
</head>
<body>
</body>
</html>
