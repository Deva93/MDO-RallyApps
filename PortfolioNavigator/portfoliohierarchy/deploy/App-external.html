<!DOCTYPE html>
<html>
<head>
    <title>Portfolio Hierarchy</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.0.1/q.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("IntelRallyApp",{alias:"widget.intelrallyapp",extend:"Rally.app.App",_loadModels:function(){var me=this,promises=[],models={Project:"Project",UserStory:"HierarchicalRequirement",Feature:"PortfolioItem/Feature",Milestone:"PortfolioItem/Milestone"};return _.each(models,function(modelType,modelName){var deferred=Q.defer();Rally.data.WsapiModelFactory.getModel({type:modelType,success:function(loadedModel){me[modelName]=loadedModel,deferred.resolve()}}),promises.push(deferred.promise)}),Q.all(promises)},_loadProject:function(oid){var me=this,deferred=Q.defer();return oid?me.Project?(me.Project.load(oid,{fetch:["ObjectID","Releases","Children","Parent","Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},callback:deferred.resolve}),deferred.promise):me._loadModels().then(function(){return me._loadProject(oid)}):Q.resolve()},_loadFeature:function(oid,projectRef){var me=this,deferred=Q.defer();return oid?me.Feature?(me.Feature.load(oid,{fetch:["Name","ObjectID","FormattedID","c_TeamCommits","c_Risks","Project","PlannedEndDate","Parent"],context:{workspace:me.getContext().getWorkspace()._ref,project:projectRef},callback:deferred.resolve}),deferred.promise):me._loadModels().then(function(){return me._loadFeature(oid,projectRef)}):Q.resolve()},_loadUserStory:function(oid,projectRef){var me=this,deferred=Q.defer();return oid?me.UserStory?(me.UserStory.load(oid,{fetch:["Name","ObjectID","Release","Project","Feature","FormattedID","Predecessors","Successors","c_Dependencies","Iteration","PlanEstimate"],context:{workspace:me.getContext().getWorkspace()._ref,project:projectRef},callback:deferred.resolve}),deferred.promise):me._loadModels().then(function(){return me._loadUserStory(oid,projectRef)}):Q.resolve()},_loadMilestone:function(oid,projectRef){var me=this,deferred=Q.defer();return oid?me.Milestone?(me.Milestone.load(oid,{fetch:["ObjectID","Parent","Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:projectRef},callback:deferred.resolve}),deferred.promise):me._loadModels().then(function(){return me._loadMilestone(oid)}):Q.resolve()},_loadRootProject:function(projectRecord){if(!projectRecord)return Q.reject("Invalid arguments: LRP");var me=this,n=projectRecord.data.Name;return"All Scrums"===n||"All Scrums Sandbox"===n?Q(projectRecord):projectRecord.data.Parent?me._loadProject(projectRecord.data.Parent.ObjectID).then(function(parentRecord){return me._loadRootProject(parentRecord)}):Q.reject('You do not have viewer access to "All Scrums"!')},_loadTopProject:function(projectRecord){if(!projectRecord)return Q.reject("Invalid arguments: LTP");var me=this,n=projectRecord.data.Name;return projectRecord.data.Parent?me._loadProject(projectRecord.data.Parent.ObjectID).then(function(parentRecord){return me._loadTopProject(parentRecord)}):Q(projectRecord)},_projectInWhichTrain:function(projectRecord){if(projectRecord){var me=this,split=projectRecord.data.Name.split(" ART");if(split.length>1)return Q(projectRecord);var parent=projectRecord.data.Parent;return parent?me._loadProject(parent.ObjectID).then(function(parentRecord){return me._projectInWhichTrain(parentRecord)}):Q.reject("Project not in a train")}return Q.reject("Invalid arguments: PIWT")},_loadAllTrains:function(rootProjectRecord){if(!rootProjectRecord)return Q.reject("Invalid arguments: LAT");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Project",remoteSort:!1,limit:1/0,fetch:["Name","ObjectID"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",operator:"contains",value:" ART"},{property:"Name",operator:"All Scrums Sandbox"===rootProjectRecord.data.Name?"contains":"!contains",value:"Test"}]});return me._reloadStore(store).then(function(store){return console.log("AllTrainRecords loaded",store.data.items),Q(store)})},_loadRandomUserStory:function(projectRef){if(!projectRef)return Q.reject("Invalid arguments: LRUS");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:5,pageSize:5,fetch:["Name","CreationDate","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},sorters:[{property:"CreationDate",direction:"DESC"}],filters:[{property:"Project",value:projectRef}]});return me._reloadStore(store).then(function(store){var records=store.data.items;return records.length?Q(records[Math.floor(Math.random()*records.length)]):Q(void 0)})},_getUserStoryInReleaseTimeFrameFilter:function(releaseRecord){var me=this,twoWeeks=12096e5,releaseStartPadding=new Date(1*new Date(releaseRecord.data.ReleaseStartDate)+twoWeeks).toISOString(),releaseEndPadding=new Date(1*new Date(releaseRecord.data.ReleaseDate)-twoWeeks).toISOString();return Ext.create("Rally.data.wsapi.Filter",{property:"Release.ReleaseStartDate",operator:"<",value:releaseStartPadding}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Release.ReleaseDate",operator:">",value:releaseEndPadding})).or(Ext.create("Rally.data.wsapi.Filter",{property:"Feature.Release.ReleaseStartDate",operator:"<",value:releaseStartPadding}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Feature.Release.ReleaseDate",operator:">",value:releaseEndPadding})))},_loadRandomUserStoryFromRelease:function(projectRef,releaseName){if(!projectRef||!releaseName)return Q.reject("Invalid arguments: LRUSFR");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:5,pageSize:5,fetch:["Name","CreationDate","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},sorters:[{property:"CreationDate",direction:"DESC"}],filters:[Ext.create("Rally.data.wsapi.Filter",{property:"Project",value:projectRef}).and(Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:releaseName}).or(Ext.create("Rally.data.wsapi.Filter",{property:"Feature.Release.Name",value:releaseName})))]});return me._reloadStore(store).then(function(store){var records=store.data.items;return records.length?Q(records[Math.floor(Math.random()*records.length)]):Q(void 0)})},_loadRandomUserStoryFromReleaseTimeframe:function(projectRef,releaseRecord){if(!projectRef||!releaseRecord)return Q.reject("Invalid arguments: LRUSFR");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:5,pageSize:5,fetch:["Name","CreationDate","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},sorters:[{property:"CreationDate",direction:"DESC"}],filters:[Ext.create("Rally.data.wsapi.Filter",{property:"Project",value:projectRef}).and(me._getUserStoryInReleaseTimeFrameFilter(releaseRecord))]});return me._reloadStore(store).then(function(store){var records=store.data.items;return records.length?Q(records[Math.floor(Math.random()*records.length)]):Q(void 0)})},_loadUserStoryByFID:function(formattedID,projectRef){if(!formattedID||!projectRef)return Q.reject("Invalid arguments: LUSBFID");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"HierarchicalRequirement",limit:1,pageSize:1,fetch:["Name","Project","ObjectID","FormattedID","Predecessors","Successors","c_Dependencies"],context:{workspace:me.getContext().getWorkspace()._ref,project:void 0},filters:[{property:"FormattedID",value:formattedID},{property:"Project",value:projectRef}]});return me._reloadStore(store).then(function(store){return Q(store.data.items.pop())})},_loadProjectByName:function(name){if(!name)return Q.reject("Invalid arguments: LPBN");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"Project",limit:1,pageSize:1,fetch:["Name","ObjectID"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:name}]});return me._reloadStore(store).then(function(store){return Q(store.data.items.pop())})},_getFeatureFilter:function(trainRecord,releaseRecord){if(!trainRecord||!releaseRecord)throw"invalid arguments: GFF";var me=this,trainName=trainRecord.data.Name.split(" ART")[0],relSplit=releaseRecord.data.Name.split(" "),coreFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:releaseRecord.data.Name});return trainName=2==relSplit.length?relSplit[1]:trainName,"Test ART (P&E)"==trainRecord.data.Name?Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:"Test ART (P&E)"}).and(coreFilter):Ext.create("Rally.data.wsapi.Filter",{property:"Project.Parent.Name",value:trainName+" POWG Portfolios"}).or(Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:trainName+" POWG Portfolios"})).and(coreFilter)},_getProductFilter:function(trainRecord){if(!trainRecord)throw"invalid arguments: GPF";var me=this,trainName=trainRecord.data.Name.split(" ART")[0];return"Test"===trainName?Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:"Test ART (P&E)"}):Ext.create("Rally.data.wsapi.Filter",{property:"Project.Parent.Name",value:trainName+" POWG Portfolios"}).or(Ext.create("Rally.data.wsapi.Filter",{property:"Project.Name",value:trainName+" POWG Portfolios"}))},_loadProducts:function(trainRecord){if(!trainRecord)return Q.reject("Invalid arguments: LPROD");var me=this,store=Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Product",limit:1/0,remoteSort:!1,fetch:["Name"],context:{workspace:me.getContext().getWorkspace()._ref,project:null},filters:[me._getProductFilter(trainRecord)]});return me._reloadStore(store).then(function(store){return console.log("Products loaded",store.data.items),Q(store)})},_addValidProjectsToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;curProj.data.TeamMembers.Count>0&&(hash[curProj.data.ObjectID]=curProj);for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me._addValidProjectsToList(projTree[childProjRef],hash)},_loadValidProjects:function(rootProjectRecord){if(!rootProjectRecord)return Q.reject("Invalid arguments: LVP");var me=this,validProjects={},projTree={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","Parent","ObjectID","TeamMembers"],limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){for(var projects=store.data.items,i=0,len=projects.length;len>i;++i){var project=projects[i],thisRef=project.data.ObjectID,parentRef=project.data.Parent?project.data.Parent.ObjectID:void 0;projTree[thisRef]||(projTree[thisRef]={}),projTree[thisRef].ProjectRecord=project,parentRef&&(projTree[parentRef]||(projTree[parentRef]={}),projTree[parentRef][thisRef]=projTree[thisRef])}return me._addValidProjectsToList(projTree[rootProjectRecord.data.ObjectID],validProjects),console.log("valid projects",validProjects),Q(validProjects)})},_allChildProjectToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;hash[curProj.data.ObjectID]=curProj;for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me._allChildProjectToList(projTree[childProjRef],hash)},_loadAllChildrenProjects:function(rootProjectRecord){if(!rootProjectRecord)return Q.reject("Invalid arguments: LACP");var me=this,childrenProjects={},projTree={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","Parent","ObjectID"],limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){for(var projects=store.data.items,i=0,len=projects.length;len>i;++i){var project=projects[i],thisRef=project.data.ObjectID,parentRef=project.data.Parent?project.data.Parent.ObjectID:void 0;projTree[thisRef]||(projTree[thisRef]={}),projTree[thisRef].ProjectRecord=project,parentRef&&(projTree[parentRef]||(projTree[parentRef]={}),projTree[parentRef][thisRef]=projTree[thisRef])}return me._allChildProjectToList(projTree[rootProjectRecord.data.ObjectID],childrenProjects),console.log("childrenProjects",childrenProjects),Q(childrenProjects)})},_allLeafProjectsToList:function(projTree,hash){var me=this,curProj=projTree.ProjectRecord;0===curProj.data.Children.Count&&(hash[curProj.data.ObjectID]=curProj);for(var childProjRef in projTree)"ProjectRecord"!==childProjRef&&me._allLeafProjectsToList(projTree[childProjRef],hash)},_loadAllLeafProjects:function(rootProjectRecord){if(!rootProjectRecord)return Q.reject("Invalid arguments: LALP");var me=this,childrenProjects={},projTree={},store=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","Parent","ObjectID","Children"],limit:1/0,context:{workspace:me.getContext().getWorkspace()._ref,project:null}});return me._reloadStore(store).then(function(store){for(var projects=store.data.items,i=0,len=projects.length;len>i;++i){var project=projects[i],thisRef=project.data.ObjectID,parentRef=project.data.Parent?project.data.Parent.ObjectID:void 0;projTree[thisRef]||(projTree[thisRef]={}),projTree[thisRef].ProjectRecord=project,parentRef&&(projTree[parentRef]||(projTree[parentRef]={}),projTree[parentRef][thisRef]=projTree[thisRef])}return me._allLeafProjectsToList(projTree[rootProjectRecord.data.ObjectID],childrenProjects),console.log("childrenProjects",childrenProjects),Q(childrenProjects)})},_reloadStore:function(store){var deferred=Q.defer();return store.load({callback:function(records,operation,success){success?deferred.resolve(store):deferred.reject(operation.getError()||"Could not load data")}}),deferred.promise}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("WorkweekDropdown",{extend:"Ext.data.Model",fields:[{name:"Workweek",type:"string"},{name:"DateVal",type:"number"}]})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("PrettyAlert",{__getMessageBoxY:function(){var me=this,bottomEl=window.frameElement?Ext.get(window.frameElement):me.el,ph=window.parent.getWindowHeight(),ps=window.parent.getScrollY(),ofy=ps+bottomEl.dom.getBoundingClientRect().top,iyOffset=Math.floor(ph/2-ofy+ps-50);return 0>iyOffset?0:iyOffset},_alert:function(title,str){1>arguments.length||(1===arguments.length&&(str=title,title=""),Ext.MessageBox.alert(title,str).setY(this.__getMessageBoxY()),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20))},_confirm:function(title,str,fn){2>arguments.length||(2===arguments.length&&(fn=str,str=title,title=""),"function"!=typeof fn&&(fn=function(){}),Ext.MessageBox.confirm(title,str,fn).setY(this.__getMessageBoxY()),setTimeout(function(){for(var x=Ext.MessageBox.down("button");x.isHidden();)x=x.nextSibling();x.focus()},20))}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("ReleaseQuery",{_loadAllReleases:function(projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),deferred.resolve(releaseStore)},single:!0}}}),deferred.promise},_loadReleasesInTheFuture:function(projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID},{property:"ReleaseDate",operator:">=",value:(new Date).toISOString()}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),deferred.resolve(releaseStore)},single:!0}}}),deferred.promise},_loadReleasesWithName:function(releaseName,nameContains){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project","TeamMembers"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:releaseName},{property:"Project.Name",operator:"contains",value:nameContains},{property:"Project.Children.Name",operator:"=",value:""},{property:"Project.Name",operator:"!contains",value:" ART"}],listeners:{load:{fn:function(store,records){console.log("releasesWithName loaded:",records),deferred.resolve(store)},single:!0}}}),deferred.promise},_loadReleaseByNameForProject:function(releaseName,projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",value:releaseName},{property:"Project",value:projectRecord.data._ref}],listeners:{load:{fn:function(store,records){deferred.resolve(records.pop())},single:!0}}}),deferred.promise},_loadReleasesByNameContainsForProject:function(releaseName,projectRecord){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Name",operator:"contains",value:releaseName},{property:"Project",value:projectRecord.data._ref}],listeners:{load:{fn:function(store,records){deferred.resolve(records)},single:!0}}}),deferred.promise},_loadReleasesAfterGivenDate:function(projectRecord,givenDate){var deferred=Q.defer();return Ext.create("Rally.data.wsapi.Store",{model:"Release",limit:1/0,autoLoad:!0,fetch:["Name","ObjectID","ReleaseDate","ReleaseStartDate","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},filters:[{property:"Project.ObjectID",value:projectRecord.data.ObjectID},{property:"ReleaseDate",operator:">=",value:new Date(givenDate).toISOString()}],listeners:{load:{fn:function(releaseStore,releaseRecords){console.log("releases loaded:",releaseRecords),deferred.resolve(releaseStore)},single:!0}}}),deferred.promise},_getScopedRelease:function(releaseRecords,projectOID,appPrefs){var me=this,d=new Date,rs=releaseRecords,prefOID=appPrefs&&appPrefs.projs&&appPrefs.projs[projectOID]&&appPrefs.projs[projectOID].Release;return prefOID&&_.find(rs,function(r){return r.data.ObjectID==prefOID})||_.find(rs,function(r){return new Date(r.data.ReleaseDate)>=d&&d>=new Date(r.data.ReleaseStartDate)})||_.reduce(rs,function(best,r){if(null===best)return r;var d1=new Date(best.data.ReleaseStartDate),d2=new Date(r.data.ReleaseStartDate),now=new Date;return Math.abs(d1-now)<Math.abs(d2-now)?best:r},null)}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("AsyncQueue",{QueueOfFuncs:{},_dequeue:function(queueName){var me=this;if(queueName=queueName||"undefined",me.QueueOfFuncs[queueName]){if(me.QueueOfFuncs[queueName].shift(),!me.QueueOfFuncs[queueName].length)return;me.QueueOfFuncs[queueName][0].call(me,me._dequeue.bind(me,queueName))}},_enqueue:function(callback,queueName){var me=this;return queueName=queueName||"undefined","function"!=typeof callback?console.log("ERR: not a function",callback):(me.QueueOfFuncs[queueName]&&me.QueueOfFuncs[queueName].length?me.QueueOfFuncs[queueName].push(callback):(me.QueueOfFuncs[queueName]=[callback],callback.call(me,me._dequeue.bind(me,queueName))),void 0)}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("UserAppPreferences",{_prefName:"intel-user-app-preferences",_loadPreferences:function(){var me=this,deferred=Q.defer();return Rally.data.PreferenceManager.load({filterByUser:!0,filterByName:me._prefName,success:function(prefs){var appPrefs=prefs[me._prefName];try{appPrefs=JSON.parse(appPrefs)}catch(e){appPrefs={projs:{},refresh:30}}console.log("loaded prefs",appPrefs),deferred.resolve(appPrefs)},failure:deferred.reject}),deferred.promise},_savePreferences:function(prefs){var me=this,s={},deferred=Q.defer();return prefs={projs:prefs.projs,refresh:prefs.refresh},s[me._prefName]=JSON.stringify(prefs),console.log("saving prefs",prefs),Rally.data.PreferenceManager.update({filterByUser:!0,settings:s,success:deferred.resolve,failure:deferred.reject}),deferred.promise}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Intel.form.field.ComboBox",{extend:"Ext.form.field.ComboBox",alias:["widget.intelcombo","widget.intelcombobox"],constructor:function(options){options=options||{},options=Ext.merge({enableKeyEvents:!0,queryMode:"local",ignoreNoChange:!0,allowBlank:!1,listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var combo=this;combo.store.clearFilter(),combo.store.filterBy(function(item){return null!==item.data[combo.displayField].match(RegExp(combo.getRawValue(),"i"))})}},focus:function(combo){combo.store.clearFilter(),combo.setValue(""),combo.expand()}}},options),this.callParent([options])}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Intel.form.field.FixedComboBox",{extend:"Ext.form.field.ComboBox",alias:["widget.intelfixedcombo","widget.intelfixedcombobox"],constructor:function(options){options=options||{},options=Ext.merge({editable:!1,allowBlank:!1,queryMode:"local",listeners:{focus:function(combo){combo.setValue(""),combo.expand()}}},options),this.callParent([options])}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Intel.form.field.PiProjectComboBox",{extend:"Intel.form.field.ComboBox",alias:["widget.intelPIprojectcombo"],requires:["IntelRallyApp"],constructor:function(options){var me=this,app=Rally.getApp();options=options||{},options=Ext.merge({displayField:"Name",enableKeyEvents:!0,queryMode:"local",ignoreNoChange:!0,allowBlank:!1,validator:function(value){return me.isHidden()?!0:!!_.find(me.ChildProjects,function(proj){return proj.data.Name===value})},listeners:{keyup:function(a,b){if(!(b.keyCode>=37&&40>=b.keyCode)){var combo=this;combo.store.clearFilter(),combo.store.filterBy(function(item){return null!==item.data[combo.displayField].match(RegExp(combo.getRawValue(),"i"))})}},focus:function(combo){combo.store.clearFilter(),combo.expand()}}},options),me.callParent([options]),app._loadProjectByName("All Releases").then(function(rootProject){return app._loadAllChildrenProjects(rootProject)}).then(function(childProjects){var data=[];me.ChildProjects=childProjects;for(var projOID in childProjects)data.push({Name:childProjects[projOID].data.Name});me.bindStore(Ext.create("Ext.data.Store",{sorters:[function(o1,o2){return o1.data.Name<o2.data.Name?-1:1}],fields:["Name"],data:data})),"number"==typeof me.value&&me.setValue(me.ChildProjects[me.value].data.Name)}).fail(function(reason){app._alert("ERROR",reason||"")}).done()}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.portfoliohierarchy.FittedUserStoryTreeItem",{extend:"Rally.ui.tree.UserStoryTreeItem",alias:"widget.fitteduserstorytreeitem",config:{displayedFields:["Name","Project","ScheduleState"]},getContentTpl:function(){var me=this;return Ext.create("Ext.XTemplate",'<tpl if="this.canDrag()"><div class="icon drag"></div></tpl>',"{[this.getActionsGear()]}",'<div class="textContent ellipses" style="max-width:65%;">',"{[this.getFormattedId()]} - ",'<span title="{Name}\nProject: {[this.getProjectName()]}">{Name}</span>',"</div>",'<div class="rightSide">',"{[this.getScheduleState()]}","</div>",{canDrag:function(){return me.getCanDrag()},getProjectName:function(){return me.getRecord().data.Project.Name},getActionsGear:function(){return me._buildActionsGearHtml()},getScheduleState:function(){return Rally.ui.renderer.RendererFactory.renderRecordField(me.getRecord(),"ScheduleState")},getFormattedId:function(){return Rally.ui.renderer.RendererFactory.renderRecordField(me.getRecord(),"FormattedID")}})}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.portfoliohierarchy.FittedPortfolioItemTreeItem",{extend:"Rally.ui.tree.PortfolioItemTreeItem",alias:"widget.fittedportfolioitemtreeitem",config:{displayedFields:["Name","Plan"]},getContentTpl:function(){var me=this;return Ext.create("Ext.XTemplate",'<tpl if="this.canDrag()"><div class="icon drag"></div></tpl>',"{[this.getActionsGear()]}",'<tpl if="this._renderPlanOnLowestLevelPortfolioItem()">','<div class="textContent ellipses" style="max-width: 65%;">',"{[this.getFormattedId()]} - ",'<span title="{Name}">{Name}</span>','<div class="textContent ellipses">{[this.getPlanData()]}</div>',"</div>","<tpl else>",'<div class="textContent ellipses" style="max-width: 65%;">',"{[this.getFormattedId()]} - ",'<span title="{Name}">{Name}</span>',"</div>","</tpl>",'<div class="rightSide">',"{[this.getPercentDone()]}","</div>",{canDrag:function(){return me.getCanDrag()},getActionsGear:function(){return me._buildActionsGearHtml()},getPercentDone:function(){return Rally.ui.renderer.RendererFactory.renderRecordField(me.getRecord(),"PercentDoneByStoryCount")},getFormattedId:function(){return Rally.ui.renderer.RendererFactory.renderRecordField(me.getRecord(),"FormattedID")},getPlanData:function(){var plan=me.getRecord().data.Plan,planName=plan&&plan.name?plan.name:"";return planName},_renderPlanOnLowestLevelPortfolioItem:function(){return me.getRecord().self.isLowestLevelPortfolioItem()}})}})})();
                (function(){var Ext=window.Ext4||window.Ext,console={log:function(){}};Ext.define("Intel.portfolioHierarchy",{extend:"IntelRallyApp",mixins:["Rally.Messageable","PrettyAlert","ReleaseQuery","UserAppPreferences"],_uid:__PROJECT_OID__+"-"+__USER_OID__,_prefName:"intel-portfolio-nav",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"container",itemId:"header_release",layout:"hbox"},{xtype:"container",itemId:"header_project",layout:"hbox"},{xtype:"container",itemId:"header_complete",layout:"hbox"},{xtype:"container",itemId:"bodyContainer"}],config:{defaultSettings:function(){var s={},str=__PROJECT_OID__+"-"+__USER_OID__;return s["Type"+str]="product",s["QueryFilter"+str]="",s["InferPortfolioLocation"+str]=!0,s["PortfolioLocation"+str]=__PROJECT_OID__,s}()},getSettingsFields:function(){var str=__PROJECT_OID__+"-"+__USER_OID__;return[{name:"Type"+str,xtype:"combo",editable:!1,label:"Type",store:["product","milestone","feature"],labelWidth:120,width:"100%"},{name:"QueryFilter"+str,xtype:"textfield",label:"Query Filter",labelWidth:120,width:"100%"},{name:"InferPortfolioLocation"+str,xtype:"rallycheckboxfield",label:"Infer Portfolio Location",labelWidth:120,width:"100%",bubbleEvents:["change"]},{name:"PortfolioLocation"+str,xtype:"intelPIprojectcombo",label:"Portfolio Location",labelWidth:120,width:"100%",listeners:{added:function(field,form){form.down("rallycheckboxfield").value?field.hide():field.show()}},handlesEvents:{change:function(checkbox,ischecked){ischecked?this.hide():this.show()}}}]},_refreshTree:function(){var me=this;me.down("#bodyContainer").removeAll(),me._loadPortfolioTree()},_reloadEverything:function(){var me=this;me.setLoading(!1),me._loadFilterOnRelease(),me._loadReleaseSelector(),me._loadFilterOnProject(),me._loadFilterOnComplete(),me._loadPortfolioTree()},launch:function(){var me=this;me.setLoading(!0),me._loadModels().then(function(){var scopeProject=me.getContext().getGlobalContext().getProject();return me._loadProject(scopeProject.ObjectID)}).then(function(scopeProjectRecord){return me.ProjectRecord=scopeProjectRecord,me._loadRandomUserStory(scopeProjectRecord.data._ref)}).then(function(userStory){return me.HasUserStories=!!userStory,me._loadTopProject(me.ProjectRecord)}).then(function(rootProject){return me._loadAllChildrenProjects(rootProject)}).then(function(childProjects){return me.ChildProjects=childProjects,me._projectInWhichTrain(me.ProjectRecord)}).fail(function(error){return"Project not in a train"!==error?Q.reject(error):void 0}).then(function(trainRecord){return me.TrainRecord=trainRecord,me._loadPreferences()}).then(function(appPrefs){var pid=me.ProjectRecord.data.ObjectID,prefs=appPrefs.projs[pid]||{};me.AppPrefs=appPrefs,me.PIType=me.getSetting("Type"+me._uid),me.QueryFilter=me.getSetting("QueryFilter"+me._uid),me.InferPortfolioLocation=me.getSetting("InferPortfolioLocation"+me._uid),me.PortfolioLocation=me.getSetting("PortfolioLocation"+me._uid),me.FilterOnRelease=prefs.FilterOnRelease||!1,me.FilterReleaseName=prefs.FilterReleaseName,me.FilterOnProject=prefs.FilterOnProject||!1,me.FilterOnComplete=prefs.FilterOnComplete||!1;var name=me.ProjectRecord.data.Name,field="number"==typeof me.PortfolioLocation?"ObjectID":"Name";if(me.InferPortfolioLocation)if(me.TrainRecord){var piName=me.TrainRecord.data.Name.split(" ART")[0]+" POWG Portfolios";me.PortfolioLocation=_.find(me.ChildProjects,function(p){return p.data.Name===piName})}else me.PortfolioLocation=me.ProjectRecord;else me.PortfolioLocation=_.find(me.ChildProjects,function(p){return p.data[field]===me.PortfolioLocation});return me.PortfolioLocation?me._loadAllReleases(me.ProjectRecord):Q.reject("Could not find Portfolio Location")}).then(function(releaseStore){me.ReleaseStore=releaseStore,me.ReleaseNames=[];for(var recs=releaseStore.data.items,i=0,len=recs.length;len>i;++i)me.ReleaseNames.push({Name:recs[i].data.Name});me.FilterReleaseName=me.FilterReleaseName||me.ReleaseNames[0].Name,me._reloadEverything()}).fail(function(reason){me.setLoading(!1),me._alert("ERROR",reason||"")}).done()},_onPreferenceChanged:function(field,newValue){var me=this,pid=me.ProjectRecord.data.ObjectID;return me[field]===newValue?Q():(me[field]=newValue,"object"!=typeof me.AppPrefs.projs[pid]&&(me.AppPrefs.projs[pid]={}),me.AppPrefs.projs[pid][field]=newValue,me._savePreferences(me.AppPrefs))},_onReleaseSelected:function(combo,records){var me=this;me._onPreferenceChanged("FilterReleaseName",records[0].data.Name).then(function(){me.FilterOnRelease&&me._refreshTree()}).fail(function(reason){me._alert("ERROR:",reason)}).done()},_loadReleaseSelector:function(){var me=this;me.down("#header_release").add({xtype:"intelfixedcombo",store:Ext.create("Ext.data.Store",{fields:["Name"],sorters:[function(o1,o2){return o1.data.Name<o2.data.Name?-1:1}],data:me.ReleaseNames}),hidden:!me.FilterOnRelease,displayField:"Name",value:me.FilterReleaseName,listeners:{select:me._onReleaseSelected.bind(me)}})},_onFilterOnReleaseChanged:function(checkBox){var me=this,value=checkBox.getValue(),box=me.down("#header_release").down("intelfixedcombo");value?box.show():box.hide(),me._onPreferenceChanged("FilterOnRelease",value).then(function(){me._refreshTree()}).fail(function(reason){me._alert("ERROR:",reason)}).done()},_loadFilterOnRelease:function(){var me=this;me.down("#header_release").add({xtype:"rallycheckboxfield",boxLabel:"Filter Features in Release",padding:"0 4px 0 0",value:me.FilterOnRelease,listeners:{change:me._onFilterOnReleaseChanged.bind(me)}})},_onFilterOnProjectChanged:function(checkBox){var me=this;me._onPreferenceChanged("FilterOnProject",checkBox.getValue()).then(function(){me._refreshTree()}).fail(function(reason){me._alert("ERROR:",reason)}).done()},_loadFilterOnProject:function(){var me=this;me.down("#header_project").add({xtype:"rallycheckboxfield",boxLabel:"Filter User Stories in Current Project",padding:"0 4px 0 0",hidden:!me.HasUserStories,value:me.FilterOnProject,listeners:{change:me._onFilterOnProjectChanged.bind(me)}})},_onFilterOnCompleteChanged:function(checkBox){var me=this;me._onPreferenceChanged("FilterOnComplete",checkBox.getValue()).then(function(){me._refreshTree()}).fail(function(reason){me._alert("ERROR:",reason)}).done()},_loadFilterOnComplete:function(){var me=this;me.down("#header_complete").add({xtype:"rallycheckboxfield",boxLabel:"Hide Completed Items",labelWidth:170,value:me.FilterOnComplete,listeners:{change:me._onFilterOnCompleteChanged.bind(me)}})},_onTreeItemSelected:function(treeItem){"fittedportfolioitemtreeitem"===treeItem.xtype&&this.publish("portfoliotreeitemselected",treeItem)},_getFilterOnCompleteFilter:function(ordinal){return Ext.create("Rally.data.wsapi.Filter",{property:"State.OrderIndex",operator:"<",value:0===ordinal?11:4}).or(Ext.create("Rally.data.wsapi.Filter",{property:"State",value:null}))},_getFilterOnReleaseFilter:function(){var me=this;return Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:me.FilterReleaseName})},_getFilterOnQueryFilter:function(){var me=this;try{return Rally.data.QueryFilter.fromQueryString(me.QueryFilter)}catch(e){return Ext.create("Rally.data.wsapi.Filter",{property:"ObjectID",operator:"!=",value:0})}},_getParentRecordFilter:function(parentRecord,ordinal){return Ext.create("Rally.data.wsapi.Filter",{property:(0===ordinal?"Feature":"Parent")+".ObjectID",value:parentRecord.data.ObjectID})},_getTopLevelStoreConfig:function(ordinal){var me=this,filters=[];return me.FilterOnComplete&&filters.push(me._getFilterOnCompleteFilter(ordinal)),me.FilterOnRelease&&0===ordinal&&filters.push(me._getFilterOnReleaseFilter()),me.QueryFilter&&filters.push(me._getFilterOnQueryFilter()),{limit:1/0,filters:filters,context:{project:me.PortfolioLocation.data._ref,projectScopeDown:!0,projectScopeUp:!1}}},_getChildLevelStoreConfig:function(tree,parentRecord,isPI,ordinal){var me=this,context={project:me.PortfolioLocation.data._ref,projectScopeDown:!0,projectScopeUp:!1},filters=[me._getParentRecordFilter(parentRecord,ordinal)];return me.FilterOnComplete&&isPI&&ordinal>0&&filters.push(me._getFilterOnCompleteFilter(ordinal)),isPI&&0!==ordinal||(me.FilterOnProject?(context.project=me.ProjectRecord.data._ref,context.projectScopeDown=!1):(context.project=void 0,context.projectScopeDown=void 0)),me.FilterOnRelease&&isPI&&1===ordinal&&filters.push(me._getFilterOnReleaseFilter()),me.QueryFilter&&filters.push(me._getFilterOnQueryFilter()),{limit:1/0,fetch:tree._getDefaultTopLevelFetchFields().concat(["Parent","Project","State"]),context:context,filters:filters}},_loadPortfolioTree:function(){var me=this,modelName="portfolioitem/"+me.PIType,ordinal="product"===me.PIType?2:"milestone"===me.PIType?1:0;me.down("#bodyContainer").add({xtype:"rallyportfoliotree",stateful:!0,stateId:me.getAppId()+"rallyportfoliotree",topLevelModel:modelName,topLevelStoreConfig:me._getTopLevelStoreConfig(ordinal),listeners:{itemselected:me._onTreeItemSelected.bind(me)},childItemsStoreConfigForParentRecordFn:function(parentRecord){var tree=this,isPI=tree._isPortfolioItem(parentRecord),ordinal=parentRecord.self.ordinal;return me._getChildLevelStoreConfig(tree,parentRecord,isPI,ordinal)},treeItemConfigForRecordFn:function(record){var tree=this,config=Rally.ui.tree.PortfolioTree.prototype.treeItemConfigForRecordFn.call(tree,record);return config.xtype=tree._isPortfolioItem(record)?"fittedportfolioitemtreeitem":"fitteduserstorytreeitem",config}})}})})();

            Rally.launchApp('Intel.portfolioHierarchy', {
                name:"Portfolio Hierarchy",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .portfolio-hierarchy-app{width:100% !important}.portfolio-hierarchy-app .rallytree{padding-top:5px;padding-bottom:20px}.portfolio-hierarchy-app .header{border-bottom:1px dotted #c6c6c6}.portfolio-hierarchy-app .filterInfo{float:right;padding-right:1px;border-right:1px solid #CCC;margin-right:5px;margin-top:2px;margin-bottom:2px}.portfolio-hierarchy-app .rally-help-icon{float:right}.portfolio-hierarchy-app .current-project-only-float{float:left}.portfolio-hierarchy-app .filter-on-release-float{float:left;margin-left:10px;margin-right:8px}
    </style>
</head>
<body>
</body>
</html>
