<!DOCTYPE html>
<html>
<head>
    <title>Portfolio CFD</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.apps.charts.rpm.cfd.CumulativeFlowChartApp",{extend:"Rally.app.App",cls:"portfolio-cfd-app",requires:["Rally.ui.combobox.ComboBox","Rally.util.Test","Rally.ui.chart.Chart"],layout:{type:"vbox",align:"left"},help:{cls:"portfolio-cfd-help-container",id:274},items:[{xtype:"container",itemId:"top",items:[{xtype:"container",itemId:"header",cls:"header"}],height:420,padding:"0 0 5 0"},{xtype:"container",itemId:"bottom",minHeight:100}],_defaultChartConfig:{chart:{defaultSeriesType:"area",zoomType:"xy"},colors:["#ABABAB","#E57E3A","#E5D038","#0080FF","#3A874F","#000000","#26FF00"],xAxis:{tickmarkPlacement:"on",tickInterval:5,title:{text:"Days",margin:10},labels:{y:20}},yAxis:{title:{text:"Points"},labels:{x:-5,y:4}},tooltip:{formatter:function(){return"<b>"+this.x+"</b> ("+window.Datemap[this.point.x]+")<br />"+this.series.name+": "+this.y}},legend:{itemWidth:100,width:500},plotOptions:{series:{marker:{enabled:!1,states:{hover:{enabled:!0}}},groupPadding:.01},area:{stacking:"normal",lineColor:"#666666",lineWidth:2,marker:{enabled:!1}}}},_defineClasses:function(){Ext.define("lameCalculator",{constructor:function(config){for(var k in config)this[k]=config[k];return this},_getDates:function(){for(var dates=[],curDay=this.startDate,day=864e5;this.endDate>=curDay;){var n=curDay.getDay();0!==n&&6!==n&&dates.push(curDay),curDay=new Date(1*curDay+day)}return dates},_dateToStringDisplay:function(date){return Ext.Date.format(date,"m/d/Y")},_getIndexHelper:function(d,ds){for(var curVal=ds.length/2,curInt=curVal>>0,div=curVal/2,lastInt=-1;curInt!==lastInt;){if(ds[curInt]===d)return curInt;ds[curInt]>d?curVal-=div:curVal+=div,div/=2,lastInt=curInt,curInt=curVal>>0}return curInt},_getIndexOnOrBefore:function(d,ds){if(0===ds.length)return-1;var pos=this._getIndexHelper(d,ds);return 0===pos?d>=ds[pos]?pos:-1:d>=ds[pos]?pos:pos-1},_getIndexOnOrAfter:function(d,ds){if(0===ds.length)return-1;var pos=this._getIndexHelper(d,ds);return pos===ds.length-1?ds[pos]>=d?pos:-1:ds[pos]>=d?pos:pos+1},runCalculation:function(items){if(!this.scheduleStates||!this.startDate||!this.endDate)return console.log("invalid constructor config",this),void 0;var dates=this._getDates(),day=864e5,totals=_.reduce(this.scheduleStates,function(map,ss){return map[ss]=_.map(Array(dates.length),function(){return 0}),map},{});return _.each(items,function(item){item=item.raw;var iStart=new Date(item._ValidFrom),iEnd=new Date(item._ValidTo),state=item.ScheduleState,pe=item.PlanEstimate;if(pe&&iStart/day>>0!==iEnd/day>>0){var startIndex=this._getIndexOnOrAfter(iStart,dates),endIndex=this._getIndexOnOrBefore(iEnd,dates);if(-1!==startIndex&&-1!==endIndex)for(var i=startIndex;endIndex>=i;++i)totals[state][i]+=pe}},this),{categories:_.map(dates,function(d){return this._dateToStringDisplay(d)},this),series:_.reduce(this.scheduleStates,function(ar,ss){return ar.concat([{name:ss,type:"area",dashStyle:"Solid",data:totals[ss]}])},[])}}})},_initModels:function(cb){Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){this.UserStory=model,cb()},scope:this})},_initScheduleStateValues:function(cb){var me=this;me.UserStory.getField("ScheduleState").getAllowedValueStore().load({callback:function(records,operation,success){me.ScheduleStateValues=Ext.Array.map(records,function(record){return record.get("StringValue")}),cb()}})},_subscribeToBus:function(){this.subscribe(this,"portfoliotreeitemselected",function(treeItem){this.currentPiRecord=treeItem.getRecord(),this._refreshComponents()},this)},launch:function(){var me=this;console.log("chart app launched"),me.down("#top").setWidth(me.getWidth()-20),me.down("#bottom").setWidth(me.getWidth()-20),me._defineClasses(),Rally&&Rally.sdk&&Rally.sdk.dependencies&&Rally.sdk.dependencies.Analytics&&Rally.sdk.dependencies.Analytics.load(function(){me._initModels(function(){me._initScheduleStateValues(function(){me._subscribeToBus(),me._drawHeader()})})})},_drawHeader:function(){var header=this.down("#header");header.add(this._buildHelpComponent()),header.add(this._buildCurrentProjectOnlyCheckbox()),header.add(this._buildShowGridCheckbox())},_buildHelpComponent:function(){return Ext.create("Ext.Component",{renderTpl:Rally.util.Help.getIcon({cls:Rally.util.Test.toBrowserTestCssClass(this.help.cls),id:this.help.id})})},_buildCurrentProjectOnlyCheckbox:function(){return Ext.create("Rally.ui.CheckboxField",{boxLabel:"Only Stories in Current Project",value:this.onlyStoriesInCurrentProject,listeners:{change:{fn:function(checkbox){this.onlyStoriesInCurrentProject=checkbox.getValue(),this._refreshComponents()},scope:this}},componentCls:"current-project-only-float",id:"only-stories-in-current-project-element"})},_buildShowGridCheckbox:function(){return Ext.create("Rally.ui.CheckboxField",{boxLabel:"Show Grid",value:this.showGrid,listeners:{change:{fn:function(checkbox){this.showGrid=checkbox.getValue(),this._refreshComponents()},scope:this}},componentCls:"show-grid-checkbox-only-float",id:"show-grid-checkbox-element"})},_refreshComponents:function(){function refreshChart(){me.chartMask=me.chartMask||new Ext.LoadMask(me.down("#top"),{msg:"Loading chart..."}),me.chartMask.show(),me._loadChartStore(function(store){me.chartMask.hide();var chartData=me._updateChartData(me._loadChartCalculator().runCalculation(store.getRange())),dynConf=me._loadDynamicConfigValues();chart?me._updateHighchart(chart,chartData,dynConf):me._showChart(chartData,dynConf)})}var grid=this.down("rallygrid"),chart=this.down("rallychart"),me=this;me.currentPiRecord&&(me._showOrHideCheckboxes(),me.showGrid?(grid&&grid.destroy(),me._loadGridStore(refreshChart)):(grid&&grid.destroy(),refreshChart()))},_showOrHideCheckboxes:function(){var piLevel=this.currentPiRecord.self.ordinal,currentProjectOnlyCheckbox=this.down("#only-stories-in-current-project-element");0===piLevel?currentProjectOnlyCheckbox.show():currentProjectOnlyCheckbox.hide()},_loadGridStore:function(cb){var piRecord=this.currentPiRecord,piData=piRecord.data,piLevel=piRecord.self.ordinal,filters=[],sorters=[];0===piLevel&&(sorters.push({property:"ScheduleState",direction:"ASC"}),this.onlyStoriesInCurrentProject&&filters.push({property:"Project.ObjectID",value:this.getContext().getProject().ObjectID})),this.gridMask=this.gridMask||new Ext.LoadMask(this.down("#bottom"),{msg:"Loading grid..."}),this.gridMask.show(),Ext.create("Rally.data.wsapi.Store",{model:0===piLevel?"HierarchicalRequirement":"PortfolioItem",limit:1/0,autoLoad:!0,remoteSort:!1,fetch:0===piLevel?["FormattedID","Name","PlanEstimate","Iteration","ScheduleState","Project","DirectChildrenCount"]:["FormattedID","Name","Project"],context:{workspace:this.getContext().getWorkspace()._ref,project:null},sorters:sorters,filters:filters.concat([{property:0===piLevel?"PortfolioItem.ObjectID":"Parent.ObjectID",value:piRecord.data.ObjectID}]),listeners:{load:{fn:function(store){this._showGrid(store,piLevel,cb)},scope:this,single:!0}}})},_showGrid:function(store,piLevel,cb){this.gridMask.hide();var grid=this.down("#bottom").add({xtype:"rallygrid",store:store,width:this.down("#bottom").getWidth()-5,columnCfgs:0===piLevel?[{dataIndex:"FormattedID",editor:!1,renderer:function(v,m,r){return'<a href="https://rally1.rallydev.com/#/'+r.data.Project.ObjectID+"d/detail/userstory/"+r.data.ObjectID+'" target="_blank">'+v+"</a>"}},"Name","PlanEstimate",{dataIndex:"Iteration",doSort:function(state){this.up("grid").getStore().sort({sorterFn:function(r1,r2){var i1=r1.data.Iteration?r1.data.Iteration.Name||"_":"_",i2=r2.data.Iteration?r2.data.Iteration.Name||"_":"_";return("ASC"===state?1:-1)*(i2>i1?-1:1)}})},renderer:function(v,m,r){return v?'<a href="https://rally1.rallydev.com/#/'+r.data.Iteration.Project.ObjectID+"d/detail/userstory/"+r.data.Iteration.ObjectID+'" target="_blank">'+v.Name+"</a>":void 0}},{dataIndex:"ScheduleState",editor:!1},{dataIndex:"Project",doSort:function(state){this.up("grid").getStore().sort({sorterFn:function(r1,r2){var i1=r1.data.Project?r1.data.Project.Name||"_":"_",i2=r2.data.Project?r2.data.Project.Name||"_":"_";return("ASC"===state?1:-1)*(i2>i1?-1:1)}})}},{dataIndex:"DirectChildrenCount",text:"Children",renderer:function(v,m,r){return'<a href="https://rally1.rallydev.com/#/'+r.data.Project._ref.split("/")[2]+"d/detail/userstory/"+r.data.ObjectID+'/children" target="_blank">'+v+"</a>"}}]:["FormattedID","Name","Project"],showRowActionsColumn:!1,selType:"checkboxmodel",selModel:"SIMPLE",enableEditing:!1,autoScroll:!0,height:500,showPagingToolbar:!1,listeners:{selectionchange:{fn:this._onSelectionChange,scope:this},add:{fn:function(){cb&&cb()}}}});grid.getSelectionModel().selectAll(!0)},_onSelectionChange:function(grid,selected){var me=this,chart=me.down("rallychart");me.chartMask.show(),me._loadChartStore(function(store){me.chartMask.hide();var chartData=me._updateChartData(me._loadChartCalculator().runCalculation(store.getRange()));dynConf=me._loadDynamicConfigValues(),me._updateHighchart(chart,chartData,dynConf)})},_showChart:function(chartData,dynamicConfig){var me=this;me.chartMask.hide(),me.down("#top").add({xtype:"rallychart",loadMask:!1,queryErrorMessage:"No data to display.<br /><br />Most likely, stories are either not yet available or started for this portfolio item.",aggregationErrorMessage:"No data to display.<br /><br />Check the data type setting for displaying data based on count versus plan estimate.",chartData:chartData,chartConfig:Ext.apply(me._defaultChartConfig,dynamicConfig),_renderChart:function(){var chartConfig=this.getChartConfig(),chartEl=this.down("#chart");if(chartEl){chartConfig.xAxis.categories=this.chartData.categories,chartConfig.series=this.chartData.series;var highChartConfig={xtype:"highchart",initAnimAfterLoad:!1,chartConfig:chartConfig};chartEl.add(highChartConfig),this._setChartReady()}}})},_loadChartStore:function(cb){Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,context:{workspace:this.getContext().getWorkspace()._ref,project:null},sort:{_ValidFrom:1},compress:!1,find:this._getStoreFindConfig(),fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState","PlanEstimate"],listeners:{load:cb}})},_getStoreFindConfig:function(){var grid=this.down("rallygrid"),piRecord=this.currentPiRecord;return{_ItemHierarchy:grid?{$in:_.map(grid.getSelectionModel().getSelection(),function(record){return record.get("ObjectID")})}:piRecord.data.ObjectID,Project:0===piRecord.self.ordinal&&this.onlyStoriesInCurrentProject?this.getContext().getProject().ObjectID:void 0,_TypeHierarchy:-51038,Children:null,PlanEstimate:{$gte:0}}},_loadChartCalculator:function(){var piData=this.currentPiRecord.data;return Ext.create("lameCalculator",{startDate:this._getChartStartDate(piData),endDate:this._getChartEndDate(piData),scheduleStates:this.ScheduleStateValues})},_getChartStartDate:function(piData){return new Date(piData.PlannedStartDate||piData.ActualStartDate||""+new Date)},_getChartEndDate:function(piData){return new Date(piData.PlannedEndDate||piData.ActualEndDate||""+new Date)},_loadDynamicConfigValues:function(){var piData=this.currentPiRecord.data;return{title:this._getChartTitle(piData),subtitle:this._getChartSubtitle(piData),xAxis:{tickInterval:this._getConfiguredChartTicks(this._getChartStartDate(piData),this._getChartEndDate(piData))}}},_getChartTitle:function(piData){var widthPerCharacter=10,totalCharacters=Math.floor(this.getWidth/widthPerCharacter),title="Portfolio Item Chart",align="center";return piData&&(title=piData.FormattedID+": "+piData.Name),title.length>totalCharacters&&(title=title.substring(0,totalCharacters)+"...",align="left"),{text:title,align:align,margin:30}},_getChartSubtitle:function(piData){var widthPerCharacter=6,totalCharacters=Math.floor(this.getWidth()/widthPerCharacter),startDateString=" ("+this._dateToStringDisplay(this._getChartStartDate(piData))+")",startDateType="",endDateString=" ("+this._dateToStringDisplay(this._getChartEndDate(piData))+")",endDateType="",template=Ext.create("Ext.XTemplate",'<tpl><span>{startDateString}</span><tpl if="tooBig">	<br/><tpl else>	&nbsp;&nbsp;&nbsp;</tpl><span>{endDateString}</span></tpl>');piData&&(piData.PlannedStartDate?startDateType="PlannedStartDate":piData.ActualStartDate&&(startDateType="ActualStartDate"),startDateString=startDateType?("PlannedStartDate"===startDateType?"Planned":"Actual")+" Start: WW"+this._getWorkweek(new Date(piData[startDateType]))+startDateString:"No start day set.",piData.PlannedEndDate?endDateType="PlannedEndDate":piData.ActualEndDate&&(endDateType="ActualEndDate"),endDateString=endDateType?("PlannedEndDate"===endDateType?"Planned":"Actual")+" End: WW"+this._getWorkweek(new Date(piData[endDateType]))+endDateString:"No end day set.");var formattedTitle=template.apply({startDateString:startDateString,endDateString:endDateString,tooBig:startDateString.length+endDateString.length+60>totalCharacters});return{text:formattedTitle,useHTML:!0,align:"center"}},_getConfiguredChartTicks:function(startDate,endDate){var pixelTickWidth=80,appWidth=this.getWidth(),ticks=Math.floor(appWidth/pixelTickWidth),days=Math.floor((1*endDate-1*startDate)/(432e6/7)),interval=5*Math.floor(Math.floor(days/ticks)/5);return 5>interval?5:interval},_updateChartData:function(data){var me=this,now=new Date;window.Datemap=[];var total=_.reduce(data.series,function(sum,s){return sum+(s.data[s.data.length-1]||0)},0)||0,idealTrend={type:"spline",dashStyle:"Solid",name:"Ideal",data:Array(data.categories.length)},ratio=total/(data.categories.length-1)||0;idealTrend.data=_.map(idealTrend.data,function(e,i){return Math.round(100*(0+i*ratio))/100}),_.each(data.categories,function(c,i,a){var d=new Date(c);a[i]="WW"+me._getWorkweek(d),window.Datemap[i]=c,d>now&&_.each(data.series,function(s,j){s.data=s.data.slice(0,i).concat(_.map(Array(a.length-i),function(){return 0}))})});var s=_.find(data.series,function(s){return"Accepted"===s.name}),i,projectedTrend={type:"spline",dashStyle:"Solid",name:"Projected",data:s.data.slice()},begin=0,end=projectedTrend.data.length-1;for(i=1;projectedTrend.data.length>i;++i)if(null!==projectedTrend.data[i]&&0!==projectedTrend.data[i]){begin=i-1;break}for(i=begin+1;projectedTrend.data.length>i;++i)if(0===projectedTrend.data[i]){end=i-1;break}for(ratio=end===begin?0:(projectedTrend.data[end]-0)/(end-begin),projectedTrend.data=_.map(projectedTrend.data,function(p,j){return j>=begin?Math.round(100*(0+(j-begin)*ratio))/100:p}),i=0;projectedTrend.data.length>i;++i)if(projectedTrend.data[i]>=total){projectedTrend.data[i]={dataLabels:{enabled:!0,backgroundColor:"white",borderColor:"black",borderRadius:3,borderWidth:1,formatter:function(){return"<b>100% Complete</b><br /><b>"+this.x+"</b> ("+window.Datemap[this.point.x]+")"},align:"center",y:-24},color:"red",marker:{enabled:!0,lineWidth:4,symbol:"circle",fillColor:"red",lineColor:"red"},y:projectedTrend.data[i]};break}return data.series.push(projectedTrend),data.series.push(idealTrend),data},_updateHighchart:function(chart,chartData,dynConf){var wrapper=chart.getChartWrapper(),wc=wrapper.chart,newSeries=chartData.series,y,x;wc.xAxis[0].update({categories:chartData.categories,tickInterval:dynConf.xAxis.tickInterval}),wc.setTitle(dynConf.title,dynConf.subtitle);for(var i=0;newSeries.length>i;++i){var newData=newSeries[i].data,oldData=wc.series[i],oldSerLen=oldData.points.length,newSerLen=newData.length;oldData.setData(newData,!1,!0,!1)}wc.redraw()},_getWorkweek:function(date){if(date instanceof Date){var me=this,oneDay=864e5,yearStart=new Date(date.getFullYear(),0,1),dayIndex=yearStart.getDay(),ww01Start=yearStart-dayIndex*oneDay,timeDiff=date-ww01Start,dayDiff=timeDiff/oneDay,ww=Math.floor(dayDiff/7)+1,leap=0===date.getFullYear()%4,day=new Date(date.getFullYear(),0,1).getDay(),weekCount=leap&&day>=5||!leap&&6===day?53:52;return ww>weekCount?ww-weekCount:ww}},_dateToStringDisplay:function(date){return Ext.Date.format(date,"m/d/Y")},_dateToString:function(date){return Ext.Date.format(date,"Y-m-d\\TH:i:s.u\\Z")}});

            Rally.launchApp('Rally.apps.charts.rpm.cfd.CumulativeFlowChartApp', {
                name:"Portfolio CFD",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .portfolio-cfd-app{width:100% !important;overflow-y:scroll !important}.portfolio-cfd-app .header{border-bottom:1px dotted #c6c6c6;line-height:1.1em}.portfolio-cfd-app .rally-help-icon{float:right;padding-left:1px;border-left:1px solid #CCC;margin-left:5px}.portfolio-cfd-app .current-project-only-float{float:left}.portfolio-cfd-app .show-grid-checkbox-only-float{float:left;margin-left:10px}
    </style>
</head>
<body>
</body>
</html>
